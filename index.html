<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>체육 수업 도우미 (온라인 버전)</title>
  <meta name="google-site-verification" content="BAb1Evt0W_EOPGPYxID08YyKTnsQ2D8uJvYpzfhxEfw" />
  <meta name="naver-site-verification" content="8e3626d5e947128b60282a78fdfe9a1a2e6a1d8b" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1971c2"/>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* 화면 크기에 따라 기본 폰트 크기를 조절하여 반응형 UI의 기반을 마련합니다. */
    html {
        font-size: 14px;
    }
    @media (max-width: 1200px) { html { font-size: 13px; } }
    @media (max-width: 992px) { html { font-size: 12px; } }
    @media (max-width: 768px) { html { font-size: 11px; } }

    :root{
      --bg-light: #f8f9fa; --sidebar-bg: #ffffff; --main-bg: #f8f9fa;
      --card-bg: #ffffff; --input-bg: #f1f3f5; --ink: #212529;
      --ink-muted: #868e96; --accent: hsl(209, 77%, 43%); --accent-dark: #1565c0; --accent-fg: #ffffff;
      --line: #dee2e6; --win: #2f9e44; --lose: #e03131; --draw: #f08c00;
      --focus: #1971c2;
      /* Tournament Bracket Colors */
      --completed-r0: rgba(255, 215, 0, 0.15); --completed-r0-border: rgba(204, 164, 0, 0.5); /* Final - Gold */
      --completed-r1: rgba(192, 192, 192, 0.15); --completed-r1-border: rgba(153, 153, 153, 0.5); /* Semi-Final - Silver */
      --completed-r2: rgba(205, 127, 50, 0.15); --completed-r2-border: rgba(164, 102, 40, 0.5); /* Quarter-Final - Bronze */
      --completed-r3: rgba(88, 166, 255, 0.1); --completed-r3-border: rgba(88, 166, 255, 0.5); /* Blue */
      --completed-r4: rgba(173, 139, 255, 0.1); --completed-r4-border: rgba(173, 139, 255, 0.5); /* Purple */
    }
    
    body[data-theme="dark"] {
      --bg-light: #121212; --sidebar-bg: #1e1e1e; --main-bg: #121212;
      --card-bg: #1e1e1e; --input-bg: #2c2c2c; --ink: #e0e0e0;
      --ink-muted: #888888; --accent: #64b5f6; --accent-dark: #42a5f5; --accent-fg: #121212;
      --line: #3c3c3c; --win: #66bb6a; --lose: #ef5350; --draw: #ffa726;
      --focus: #64b5f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: 'Noto Sans KR', sans-serif;
      color:var(--ink); background:var(--bg-light); font-size: 1rem; /* rem 단위로 변경 */
      transition: background-color .2s, color .2s;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        background-color: #1565c0;
        flex-shrink: 0;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .top-bar h1 {
        font-size: 1.3rem; /* rem 단위로 변경 */
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
    }
    .top-bar h1 svg {
        color: white;
    }
    .top-bar h1 .version {
        font-size: 0.75rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
        margin-left: -4px;
    }
    .app-container{ 
      display:flex; 
      flex-grow: 1;
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }
    
    /* 사이드바가 접힌 상태에서 app-container 조정 */
    .app-container.sidebar-collapsed {
      /* 메인 콘텐츠가 전체 너비를 차지하도록 조정 */
      flex-direction: row;
    }
    .sidebar{
      width: 340px; flex-shrink: 0; background: var(--sidebar-bg); border-right: 1px solid var(--line);
      display: flex; flex-direction: column; padding: 24px; gap: 20px;
      transition: width 0.3s ease;
      position: relative;
    }
    
    /* 사이드바 토글 버튼 */
    .sidebar-toggle {
      position: fixed !important;
      top: 50% !important;
      left: 0 !important;
      transform: translateY(-50%) !important;
      width: 12px !important;
      height: 30px !important;
      background: var(--accent) !important;
      border: 1px solid #ffffff !important;
      border-radius: 0 4px 4px 0 !important;
      color: white !important;
      cursor: pointer !important;
      z-index: 1000 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: all 0.3s ease !important;
      box-shadow: 1px 0 4px rgba(0,0,0,0.1) !important;
      visibility: visible !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }
    
    .sidebar-toggle:hover {
      background: var(--accent-hover, #1d4ed8);
      width: 16px;
    }
    
    /* 사이드바가 펼쳐진 상태에서 토글 버튼 위치 조정 */
    .sidebar:not(.collapsed) .sidebar-toggle {
      left: 340px !important;
    }
    
    /* 사이드바가 펼쳐진 상태에서 사이드바 스타일 확실히 설정 */
    .sidebar:not(.collapsed) {
      width: 340px !important;
      min-width: 340px !important;
      padding: 24px !important;
      border-right: 1px solid var(--line) !important;
      overflow: visible !important;
    }
    
    .sidebar-toggle svg {
      width: 16px;
      height: 16px;
      transition: transform 0.3s ease;
    }
    
    .sidebar.collapsed .sidebar-toggle svg {
      transform: rotate(180deg);
    }
    
    .sidebar.collapsed {
      width: 0 !important;
      min-width: 0 !important;
      padding: 0 !important;
      border-right: none !important;
      overflow: hidden !important;
    }
    
    /* 사이드바가 접힌 상태에서 토글 버튼 위치 */
    .sidebar.collapsed .sidebar-toggle {
      left: 0 !important;
      z-index: 1000 !important;
    }
    
    /* 수업 진도표 모드에서 사이드바 패딩 조정 */
    .progress-mode .sidebar {
      padding: 24px 24px 0 24px;
      gap: 0;
    }
    
    /* progress-mode에서도 토글 기능이 작동하도록 조정 */
    .progress-mode .sidebar.collapsed {
      width: 0;
      padding: 0;
      border-right: none;
      overflow: hidden;
    }
    .main-content{ 
      flex: 1; 
      display:flex; 
      flex-direction:column; 
      overflow-y: auto; 
    }
    
    .main-view { padding: 24px; flex-grow: 1; }
    
    .sidebar-header { font-size: 1.5rem; margin: 0 0 16px 0; padding-bottom: 16px; border-bottom: 1px solid var(--line); display: flex; align-items: center; gap: 10px; }
    .sidebar-header svg { color: var(--accent); }
    #sidebar-list-container { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; min-height: 0; overflow-y: auto; }
    .sidebar-footer { margin-top: auto; font-size: 0.85rem; color: var(--ink-muted); text-align: center; }

    .btn{ display:inline-flex; align-items:center; justify-content: center; gap:8px; padding:6px 12px; border-radius:8px; border:1px solid var(--line); background: var(--card-bg); color: var(--ink); cursor:pointer; font-weight:600; transition:.2s; }
    /* 아이콘 크기를 폰트 크기에 비례하도록 em 단위로 수정 */
    .btn svg { width: 1.15em; height: 1.15em; }
    .btn:hover { border-color: var(--ink-muted); background: var(--input-bg); }
    .btn.primary, .btn.active {background:var(--accent); color:var(--accent-fg); border-color:var(--accent)}
    .btn.primary:hover, .btn.active:hover { filter: brightness(1.1); }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    
    /* 상단바 버튼 스타일 */
    .top-bar .btn {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
    }
    .top-bar .btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .top-bar .btn.active {
        background: rgba(255, 255, 255, 0.9);
        color: #1565c0;
        border-color: white;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateY(-1px);
    }
    .top-bar .btn.active:hover {
        background: white;
        color: #1565c0;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    .top-bar .btn svg {
        color: inherit;
    }
    .top-bar .btn.active svg {
        color: #1565c0;
    }
    
    /* 모드 전환 버튼 특별 스타일 */
    .top-bar .mode-switch-btn {
        position: relative;
        overflow: hidden;
    }
    
    .top-bar .mode-switch-btn.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.3));
        z-index: -1;
    }
    
    .top-bar .mode-switch-btn.active {
        position: relative;
        z-index: 1;
    }
    
    /* 활성 버튼에 애니메이션 효과 */
    .top-bar .btn.active {
        animation: activePulse 2s infinite ease-in-out;
    }
    
    @keyframes activePulse {
        0%, 100% { 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        50% { 
            box-shadow: 0 4px 16px rgba(255, 255, 255, 0.4);
        }
    }
    
    /* 상단바 사용자 프로필 영역 */
    .top-bar #user-email {
        color: white;
        font-weight: 500;
    }
    .top-bar #logout-btn {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
    }
    .top-bar #logout-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
    }
    .btn.danger { background-color: var(--lose); color: white; border-color: var(--lose);}

    .field{margin-bottom:8px}
    .field label{display:block; font-size:0.9rem; color:var(--ink-muted); margin-bottom:6px}
    .field input, .field textarea, .field select{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:8px;
      background:var(--card-bg); font-size:1rem; color: var(--ink);
    }
    .field input:focus, .field textarea:focus { outline: 2px solid var(--focus); border-color: var(--focus); }
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .theme-toggle { background: none; border: 1px solid transparent; color: var(--ink-muted); cursor: pointer; padding: 6px; border-radius: 8px; line-height: 0; }
    .theme-toggle:hover { background: var(--input-bg); }
    
    /* 상단바 테마 토글 버튼 */
    .top-bar .theme-toggle {
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
    }
    .top-bar .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.5);
    }
    .top-bar .theme-toggle svg {
        color: white;
    }
    body[data-theme="dark"] .sun-icon { display: block; } body[data-theme="dark"] .moon-icon { display: none; }
    .sun-icon { display: none; } .moon-icon { display: block; }

    .placeholder-view { display: flex; align-items: center; justify-content: center; text-align: center; color: var(--ink-muted); height: 100%; }
    .placeholder-content { display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .placeholder-content svg { width: 4.5em; height: 4.5em; }
    .placeholder-content h3 { font-size: 1.5rem; margin: 0; color: var(--ink); }

    .list-card { padding: 12px; border: 1px solid var(--line); border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color .2s, border-color .2s; }
    .list-card:hover { background: var(--input-bg); }
    .list-card.active { border-color: var(--accent); background: color-mix(in srgb, var(--accent) 15%, transparent); }
    .list-card .name { font-weight: 600; }
    .list-card .details { font-size: 0.85rem; color: var(--ink-muted); }
    
    .hidden { display: none !important; }

    [data-tooltip] { position: relative; }
    [data-tooltip]::after {
        content: attr(data-tooltip); position: absolute; top: 100%; left: 50%;
        transform: translateX(-50%); background-color: #212529; color: #ffffff;
        padding: 8px 12px; /* 여백 증가 */ border-radius: 6px; font-size: 0.85rem; font-weight: 500;
        white-space: nowrap; opacity: 0; visibility: hidden; pointer-events: none;
        transition: opacity 0.2s, visibility 0.2s; z-index: 100; margin-top: 12px; /* 마우스 포인터와의 거리 확보 */
    }
    [data-tooltip-align="left"]::after {
        left: 0;
        transform: translateX(0);
    }
    [data-tooltip]:hover::after { opacity: 1; visibility: visible; }

    h2 { font-size: 1.25rem; font-weight: 700; margin-top: 0; margin-bottom: 1rem; }
    .section-box { border: 1px solid var(--line); background: var(--card-bg); padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
    
    /* Card styles */
    .card { 
        border: 1px solid var(--line); 
        background: var(--card-bg); 
        border-radius: 0.5rem; 
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card-header { 
        padding: 1rem 1.5rem; 
        border-bottom: 1px solid var(--line); 
        background: var(--bg-light);
        border-radius: 0.5rem 0.5rem 0 0;
    }
    .card-body { 
        padding: 1.5rem; 
    }
    
    /* 리그전 수업 모드에서 평면 스타일 적용 */
    .league-mode .section-box { 
        border: none; 
        background: transparent; 
        padding: 0; 
        border-radius: 0; 
        margin-bottom: 2rem; 
    }
    
    /* 리그전 수업 모드에서 경기 일정과 순위표 컨테이너도 평면 스타일 적용 */
    .league-mode #gamesTableContainer,
    .league-mode #rankingsTableContainer {
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 0;
        margin: 0 -24px;
    }
    
    .league-mode .paps-table-wrap {
        background: transparent;
        border: none;
        border-radius: 0;
    }
    
    /* PAPS 수업 모드에서 평면 스타일 적용 */
    .paps-mode .section-box { 
        border: none; 
        background: transparent; 
        padding: 0; 
        border-radius: 0; 
        margin-bottom: 2rem; 
    }
    
    .paps-mode .paps-table-wrap {
        background: transparent;
        border: none;
        border-radius: 0;
        overflow-x: auto;
    }
    
    /* PAPS 모드에서 테이블이 화면에 맞도록 추가 조정 */
    .paps-mode #paps-record-table {
        font-size: 0.8rem;
    }
    
    .paps-mode #paps-record-table th {
        font-size: 0.75rem;
        padding: 0.3rem 0.15rem;
    }
    
    .paps-mode #paps-record-table .paps-input {
        font-size: 0.9rem;
        padding: 0.1rem 0.2rem;
        max-width: 45px;
    }
    
    .paps-mode #paps-record-table .paps-input.name {
        max-width: 55px;
    }
    
    .paps-mode #paps-record-table .paps-input.number {
        max-width: 35px;
    }
    
    .paps-mode #paps-record-table .paps-input.rec,
    .paps-mode #paps-record-table .paps-input.height,
    .paps-mode #paps-record-table .paps-input.weight {
        max-width: 40px;
    }
    .styled-table { width: 100%; min-width: 800px; border-collapse: collapse; }
    .styled-table thead { background-color: var(--input-bg); }
    .styled-table th, .styled-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--line); }
    .styled-table th { font-size: 0.8rem; font-weight: 600; color: var(--ink-muted); }
    .styled-table tbody tr:nth-child(even) { background-color: var(--input-bg); }
    .styled-table tbody tr:hover { background-color: color-mix(in srgb, var(--accent) 15%, transparent); }
    .styled-table tbody tr.highlighted-row { background-color: color-mix(in srgb, var(--accent) 25%, transparent); }
    .score { 
        width: 100%; 
        text-align: center; 
        padding: 8px 12px; 
        border: 1px solid var(--line); 
        border-radius: 6px; 
        background: var(--card-bg); 
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }
    .score:focus {
        outline: none;
        border-color: var(--accent);
        background: var(--accent-subtle);
        box-shadow: 0 0 0 2px rgba(var(--accent-rgb), 0.2);
    }
    
    /* 숫자 입력 필드의 스피너 제거 */
    .score::-webkit-outer-spin-button,
    .score::-webkit-inner-spin-button {
        -webkit-appearance: none;
        appearance: none;
        margin: 0;
    }
    .score[type=number] {
        -moz-appearance: textfield;
        appearance: textfield;
    }
    .styled-table .rank-wins { color: var(--win); font-weight: 600; }
    .styled-table .rank-losses { color: var(--lose); font-weight: 600; }
    .styled-table .rank-points { color: var(--accent); font-weight: 700; }

    .action-buttons button { background: none; border: none; padding: 4px; cursor: pointer; color: var(--ink-muted); border-radius: 4px; line-height: 0; }
    .action-buttons button:hover { background: var(--input-bg); color: var(--ink); }
    .action-buttons button.has-note { color: var(--draw); }
    .action-buttons button svg { width: 1.15em; height: 1.15em; }

    .student-list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
    .student-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background-color: var(--input-bg); border-radius: 0.5rem; }
    .student-item > span { cursor: pointer; }
    .status-badge { padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
    .status-badge.completed { background-color: color-mix(in srgb, var(--win) 20%, transparent); color: var(--win); }
    .status-badge.pending { background-color: color-mix(in srgb, var(--draw) 20%, transparent); color: var(--draw); }
    .game-stats { display: flex; align-items: center; gap: 1rem; font-size: 0.9rem; color: var(--ink-muted); }
    .stat-item { display: flex; align-items: center; gap: 0.5rem; }
    .stat-value {
        font-weight: 700; font-size: 1rem; min-width: 28px; height: 28px;
        border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
    }
    .stat-total { background-color: color-mix(in srgb, var(--accent) 20%, transparent); color: var(--accent); }
    .stat-completed { background-color: color-mix(in srgb, var(--win) 20%, transparent); color: var(--win); }
    .stat-pending { background-color: color-mix(in srgb, var(--draw) 25%, transparent); color: var(--draw); }
    .game-number { 
        cursor: pointer; 
        transition: all 0.2s ease; 
        display: inline-block; 
        padding: 4px 8px;
        border-radius: 6px;
        background: var(--input-bg);
        border: 1px solid var(--line);
        min-width: 24px;
        text-align: center;
    }
    .game-number:hover {
        background: var(--accent-subtle);
        border-color: var(--accent);
        transform: scale(1.05);
    }
    .game-number.highlighted-number { 
        background: var(--accent);
        color: white;
        border-color: var(--accent);
        transform: scale(1.1);
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
     .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .stat-card {
        background: var(--input-bg);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }
    .stat-card .label {
        font-size: 0.8rem;
        color: var(--ink-muted);
        margin-bottom: 0.5rem;
        display: block;
    }
    .stat-card .value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--ink);
    }
    .stat-card .value .unit {
        font-size: 1rem;
        font-weight: 500;
        margin-left: 0.25rem;
    }

    .sidebar-form-group { display: flex; border: 1px solid var(--accent); border-radius: 8px; overflow: hidden; }
    .sidebar-form-group input { border: none !important; flex-grow: 1; padding: 10px 12px; }
    .sidebar-form-group input:focus { outline: none !important; }
    .sidebar-form-group .btn { border-radius: 0; border: none; border-left: 1px solid var(--accent); padding: 10px; }
    
    /* 메인 콘텐츠용 폼 그룹 스타일 */
    .form-group { display: flex; border: 1px solid var(--line); border-radius: 8px; overflow: hidden; }
    .form-group input { border: none !important; flex-grow: 1; padding: 10px 12px; }
    .form-group input:focus { outline: none !important; }
    .form-group .btn { border-radius: 0; border: none; border-left: 1px solid var(--line); padding: 10px; }
    /* settings-grid를 수정하여 버튼까지 한 줄에 표시 */
    .settings-grid { display: grid; grid-template-columns: repeat(2, 1fr) auto auto auto; gap: 16px; align-items: end; }
    .settings-grid .field { margin-bottom: 0; }
    .settings-grid-full { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; }
    .chip-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip-group label { display: inline-flex; align-items: center; padding: 8px 12px; border: 1px solid var(--line); border-radius: 20px; cursor: pointer; user-select: none; }
    .chip-group input[type="radio"] { display: none; }
    .chip-group label:has(input:checked) { background-color: var(--accent); color: var(--accent-fg); border-color: var(--accent); }
    .info-box { background: var(--input-bg); padding: 1rem; border-radius: 8px; margin-top: 1.5rem; color: var(--ink-muted); font-size: 13px;}
    .bracket-wrap{ position:relative; border-radius:10px; padding:16px; background-color: var(--card-bg); overflow-x: auto; }
    .svg-layer{position:absolute; inset:0; pointer-events:none}
    .rounds { display: flex; align-items: flex-start; gap: 60px; }
    .round { display: flex; flex-direction: column; justify-content: space-around; flex-grow: 1; min-width: 240px; }
    .round-title { font-weight: 700; font-size: 1rem; color: var(--ink-muted); text-align: center; margin-bottom: 16px; }
    .match-group { display: flex; flex-direction: column; justify-content: center; flex-grow: 1; gap: 16px; }
    .match{ 
        margin: 2px 0;
    }
    .match.completed.completed-r0 { background-color: var(--completed-r0); }
    .match.completed.completed-r1 { background-color: var(--completed-r1); }
    .match.completed.completed-r2 { background-color: var(--completed-r2); }
    .match.completed.completed-r3 { background-color: var(--completed-r3); }
    .match.completed.completed-r4 { background-color: var(--completed-r4); }
    .match.next-match {
        border-color: var(--accent);
        animation: pulse-glow 2s infinite ease-in-out;
    }
    .match.bye-match {
        background-color: var(--input-bg);
    }
    
        .team.lose {
            border-color: var(--ink-muted);
            opacity: 0.8;
        }

        .team {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--input-bg);
            border: 1px solid var(--line);
            border-radius: 6px;
            margin: 4px 0;
            font-weight: 500;
            color: var(--ink);
            transition: all 0.2s ease;
            cursor: grab;
            user-select: none;
        }

        .team:hover {
            border-color: var(--primary);
            background: var(--primary-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .team.dragging {
            opacity: 0.7;
            transform: scale(1.05);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .team.drag-over {
            background: var(--success-bg);
            transform: scale(1.02);
            border-color: var(--success);
        }


        .team.win {
            border-color: var(--win);
            background: var(--win-bg);
            color: var(--win);
        }

        .team.lose {
            border-color: var(--ink-muted);
            opacity: 0.8;
        }

        .team-name {
            font-weight: 500;
            font-size: 14px;
            flex: 1;
        }

        .team-score {
            width: 50px;
            text-align: center;
            padding: 4px 6px;
            border: 1px solid var(--line);
            border-radius: 4px;
            background: var(--card-bg);
            font-size: 12px;
            margin: 0 8px;
            -moz-appearance: textfield; /* Firefox */
            appearance: textfield; /* 표준 속성 */
        }

        .team-score::-webkit-outer-spin-button,
        .team-score::-webkit-inner-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }

        .team-score:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-bg);
        }

        .team-score:disabled {
            background-color: var(--input-bg);
            color: var(--ink-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .team-score:not(:disabled) {
            background-color: var(--card-bg);
            color: var(--ink);
            cursor: text;
        }

        .team-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }


    .team.bye-team {
        color: var(--ink-muted);
        font-style: italic;
        background-color: rgba(134, 142, 150, 0.1);
        border-radius: 4px;
        padding: 2px 6px;
    }
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--accent) 40%, transparent); }
        50% { box-shadow: 0 0 8px 4px color-mix(in srgb, var(--accent) 20%, transparent); }
        100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--accent) 0%, transparent); }
    }
    .teams{display:flex; flex-direction:column; gap:8px; align-items:stretch}
    .team{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius: 6px; }
    .team.win{ font-weight: 700; background: color-mix(in srgb, var(--win) 15%, transparent); }
    .team.lose{opacity: .6;}
    .rank-badge { margin-right: 8px; }
    .rank-badge svg { width: 1.25em; height: 1.25em; vertical-align: middle; }

    .floating-btn {
        position: fixed;
        right: 2rem;
        top: 50%;
        transform: translateY(-50%);
        z-index: 50;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .auth-container {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-grow: 1;
    }
    .auth-box {
        width: 100%;
        max-width: 400px;
        padding: 32px;
        background: var(--sidebar-bg);
        border: 1px solid var(--line);
        border-radius: 12px;
    }
    .auth-box h2 {
        text-align: center;
        margin-top: 0;
    }
    .auth-tabs {
        display: flex;
        border-bottom: 1px solid var(--line);
        margin-bottom: 24px;
    }
    .auth-tabs button {
        flex: 1;
        padding: 12px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        color: var(--ink-muted);
        border-bottom: 3px solid transparent;
    }
    .auth-tabs button.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
    }
    .auth-form .error-message {
        color: var(--lose);
        font-size: 0.9rem;
        margin-bottom: 12px;
        text-align: center;
    }
    .auth-form .success-message {
        color: var(--win);
        font-size: 0.9rem;
        margin-bottom: 12px;
        text-align: center;
    }
    .auth-form button {
        width: 100%;
        margin-top: 8px;
    }
    .auth-form .forgot-password-link {
        display: block;
        text-align: right;
        font-size: 0.9rem;
        color: var(--ink-muted);
        text-decoration: none;
        margin-top: -4px;
        margin-bottom: 12px;
    }
    .auth-form .forgot-password-link:hover {
        color: var(--accent);
    }

    .loader {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        color: white;
        font-size: 1.2rem;
    }
    
    .divider {
        display: flex;
        align-items: center;
        text-align: center;
        color: var(--ink-muted);
        font-size: 0.85rem;
        margin: 24px 0 16px;
    }
    .divider::before,
    .divider::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid var(--line);
    }
    .divider:not(:empty)::before { margin-right: .5em; }
    .divider:not(:empty)::after { margin-left: .5em; }
    
    .social-buttons {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 12px;
        justify-items: center;
    }
    .social-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: 1px solid var(--line);
        background-color: var(--card-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        padding: 0;
    }
    .social-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: var(--ink-muted);
    }
    .social-btn svg { width: 1.5em; height: 1.5em; }
    
    /* 방문자 통계 스타일 */
    .visitor-info {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--ink-muted);
    }
    
    /* 경기 일정 테이블 스타일 */
    .schedule-header {
        position: sticky;
        top: 0;
        background: var(--card-bg);
        z-index: 100;
        padding: 16px 0;
        border-bottom: 2px solid var(--line);
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .schedule-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--ink);
        margin: 0;
    }
    
    /* 경기 일정 테이블 스타일 */
    #gamesTableContent .styled-table {
        position: relative;
    }
    
    #gamesTableContent .styled-table thead th {
        background: var(--input-bg);
        white-space: nowrap; /* 텍스트 줄바꿈 방지 */
    }
    
    /* 경기 일정 테이블 컨테이너 */
    #gamesTableContent {
        overflow: visible;
        border-radius: 12px;
    }
    
    .games-table-container {
        position: relative;
    }
    
    .intro-highlight {
        animation: highlight-pulse 2s infinite ease-in-out;
    }
    @keyframes highlight-pulse {
        0% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--accent) 50%, transparent); }
        70% { box-shadow: 0 0 0 8px color-mix(in srgb, var(--accent) 0%, transparent); }
        100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--accent) 0%, transparent); }
    }
    .intro-arrow {
        display: none;
        position: absolute;
        width: 40px;
        height: 40px;
        right: -50px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        animation: blink-effect 1.2s infinite ease-in-out;
        z-index: 10;
    }
    .intro-container-active .intro-arrow {
        display: block;
    }
    .intro-arrow svg {
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
    }
    @keyframes blink-effect {
        50% {
            opacity: 0.2;
        }
    }

    .help-popup-content {
      line-height: 1.6;
    }
    .help-popup-content h3 {
        font-size: 1.1rem;
        font-weight: 700;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--line);
    }
    .help-popup-content ul {
        padding-left: 20px;
        margin-top: 0;
        margin-bottom: 1rem;
    }
    .help-popup-content li {
        margin-bottom: 0.5rem;
    }
    .help-popup-content code {
        background: var(--input-bg);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.9em;
    }
    

    /* SVG 아이콘 크기 반응형으로 통일 */
    .top-bar h1 svg { width: 2em; height: 2em; }
    .sidebar-header svg { width: 1.5em; height: 1.5em; }
    h2 svg { width: 1.25em; height: 1.25em; }
    .auth-box > div:first-child svg { width: 3.2em; height: 3.2em; }
    .theme-toggle svg { width: 1.4em; height: 1.4em; }
    .sidebar-form-group .btn svg { width: 1.5em; height: 1.5em; }
    .floating-btn svg, .mode-switch-btn svg { width: 1.5em; height: 1.5em; }
    .modal-box .btn svg { width: 1.2em; height: 1.2em; }
    

    /* 작은 화면 레이아웃 조정 */
    @media (max-width: 768px) {
        body {
            overflow: auto;
        }
        .app-container {
            flex-direction: column;
            overflow: visible;
        }
        .sidebar {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid var(--line);
            flex-shrink: 0;
            height: auto;
        }
        .main-content {
            overflow-y: visible;
        }
        .top-bar {
            flex-wrap: wrap;
            gap: 8px;
        }
        .sidebar-toggle {
            width: 10px !important;
            height: 25px !important;
            font-size: 8px !important;
        }
        .sidebar-toggle:hover {
            width: 12px !important;
        }
        .top-bar > .row {
            width: 100%;
            flex-basis: 100%;
            justify-content: flex-end;
        }
    }

    /* =====================
       PAPS 전용 스타일
       ===================== */
    .paps-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 12px; flex-wrap: wrap; }
    .paps-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .paps-event-group { display: flex; align-items: center; gap: 6px; }
    .paps-event-group select { width: 100%; }
    .paps-table-wrap { 
        overflow: visible; 
        max-width: 100%;
        border: 1px solid var(--line);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        background: var(--card-bg);
    }
    
    /* PAPS 테이블 전용 스타일 */
    #paps-record-table { 
        width: 100%; 
        min-width: 100%; 
        max-width: 100%;
        font-size: 0.9rem;
        table-layout: fixed;
    }
    #paps-record-table th { 
        text-align: center; 
        padding: 0.4rem 0.2rem; 
        font-size: 0.8rem;
        white-space: nowrap;
    }
    #paps-record-table td { 
        text-align: center; 
        padding: 0.2rem; 
        vertical-align: middle;
    }
    #paps-record-table .paps-input { 
        width: 100%; 
        max-width: 50px; 
        padding: 0.15rem 0.3rem; 
        border: 1px solid var(--line); 
        border-radius: 4px; 
        background: var(--card-bg); 
        text-align: center;
        font-size: 0.95rem;
    }
    #paps-record-table .paps-input.number { 
        max-width: 40px; 
    }
    #paps-record-table .paps-input.name { 
        max-width: 60px; 
    }
    #paps-record-table .paps-input.rec { 
        max-width: 45px; 
    }
    #paps-record-table .paps-input.height,
    #paps-record-table .paps-input.weight { 
        max-width: 45px; 
    }
    #paps-record-table .paps-input:focus { 
        outline: none; 
        border-color: var(--accent); 
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent);
    }
    #paps-record-table .paps-input[type="number"] {
        -moz-appearance: textfield;
        appearance: textfield;
    }
    #paps-record-table .paps-input[type="number"]::-webkit-outer-spin-button,
    #paps-record-table .paps-input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        appearance: none;
        margin: 0;
    }
    #paps-record-table .grade-cell { 
        font-weight: 600; 
        font-size: 0.85rem;
        width: 25px;
        min-width: 25px;
        max-width: 25px;
        padding: 0.15rem 0.1rem;
        text-align: center;
        white-space: nowrap;
    }
    #paps-record-table .bmi-cell { 
        font-weight: 600; 
        color: var(--accent);
        font-size: 0.85rem;
        width: 25px;
        min-width: 25px;
        max-width: 25px;
        padding: 0.15rem 0.1rem;
        text-align: center;
        white-space: nowrap;
    }
    #paps-record-table .overall-grade-cell { 
        font-weight: 700; 
        font-size: 0.9rem;
        background: var(--input-bg);
        width: 35px;
        min-width: 35px;
        max-width: 35px;
        padding: 0.15rem 0.1rem;
        text-align: center;
        white-space: nowrap;
    }
    .paps-chart-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
        gap: 16px; 
        padding: 16px 0;
    }
    .paps-chart-grid > div {
        background: var(--card-bg);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 16px;
        min-height: 300px;
    }
    .paps-chart-grid canvas {
        max-width: 100%;
        height: auto;
    }
    .paps-chip { padding: 4px 8px; border-radius: 999px; font-size: 12px; background: var(--input-bg); color: var(--ink-muted); }
    .paps-legend { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .grade-1 { background-color: color-mix(in srgb, var(--win) 35%, transparent); color: var(--win); }
    .grade-2 { background-color: color-mix(in srgb, var(--accent) 25%, transparent); color: var(--accent); }
    .grade-3 { background-color: color-mix(in srgb, var(--draw) 25%, transparent); color: var(--draw); }
    .grade-4 { background-color: color-mix(in srgb, var(--lose) 15%, transparent); color: var(--lose); }
    .grade-5 { background-color: color-mix(in srgb, var(--lose) 25%, transparent); color: var(--lose); }
    .grade-정상 { background-color: color-mix(in srgb, var(--win) 25%, transparent); color: var(--win); }
    .grade-과체중 { background-color: color-mix(in srgb, var(--draw) 25%, transparent); color: var(--draw); }
    .grade-마름, .grade-경도비만, .grade-고도비만 { background-color: color-mix(in srgb, var(--lose) 20%, transparent); color: var(--lose); }

    /* =====================
       엑셀 관리 섹션 스타일
       ===================== */
    .progress-excel-section {
        margin-top: 16px;
        padding: 16px;
        background: var(--card-bg);
        border-radius: 8px;
        border: 1px solid var(--line);
    }
    
    
    .progress-excel-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .progress-excel-buttons .btn {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        padding: 8px 12px;
        justify-content: flex-start;
    }
    
    .progress-excel-buttons .btn svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    /* =====================
       수업 진도표 전용 스타일
       ===================== */
    .progress-mode {
      --week-col-w: 320px;
      --cell-pad: 8px;
    }
    
    /* 수업 진도표 모드에서 사이드바 하단 표시 */
    .progress-mode .sidebar-footer {
      display: block !important;
    }
    
    
    /* 수업 진도표 모드에서 사이드바 리스트 컨테이너 숨기기 */
    .progress-mode #sidebar-list-container {
      display: none !important;
    }
    
    /* 수업 진도표 모드에서 반 목록 스타일 */
    .progress-mode .progress-class-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-grow: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 16px 0 0 0;
    }
    
    /* 수업 진도표 모드에서 사이드바 하단 여백 제거 */
    .progress-mode .sidebar-actions {
      display: none !important;
    }
    
    .progress-mode .progress-class-list.expanded {
      flex: 1;
      min-height: 0;
    }
    
    .progress-mode .progress-main-content {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .progress-mode .progress-right {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .progress-mode .progress-right-header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--line);
      padding: 16px;
      flex-shrink: 0;
    }
    
    .progress-mode .progress-setting-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      cursor: pointer;
      user-select: none;
    }
    
    .progress-mode .progress-setting-header .title {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--ink);
    }
    
    .progress-mode .progress-setting-toggle {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--ink-muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .progress-mode .progress-setting-toggle:hover {
      background: var(--input-bg);
      color: var(--ink);
    }
    
    .progress-mode .progress-setting-toggle.collapsed {
      transform: rotate(-90deg);
    }
    
    .progress-mode .progress-setting-controls {
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .progress-mode .progress-setting-controls.collapsed {
      max-height: 0;
      opacity: 0;
      margin-bottom: 0;
    }
    
    .progress-mode .progress-setting-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .progress-mode .progress-selected-class {
      font-size: 0.9rem;
      color: var(--ink-muted);
      margin-left: auto;
      font-weight: 600;
      background: var(--input-bg);
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--line);
    }
    
    .class-info-card {
      background: var(--card-bg);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
    }
    
    .class-info-header h3 {
      margin: 0 0 8px 0;
      font-size: 1rem;
      color: var(--ink);
      font-weight: 600;
    }
    
    .class-info-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }
    
    .info-label {
      color: var(--ink-muted);
      font-weight: 500;
    }
    
    .info-value {
      color: var(--ink);
      font-weight: 600;
    }
    
    .progress-mode .progress-setting-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .progress-mode .progress-setting-bar .title {
      font-weight: 700;
      margin-right: 8px;
    }
    
    .progress-mode .progress-right-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .progress-mode .progress-sheet-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .progress-mode .progress-sheet {
      overflow: auto;
      padding: 0;
      background: transparent;
    }
    
    .progress-mode .progress-sheet-weeks {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      min-height: 240px;
    }
    
    .progress-mode .progress-weeks {
      display: flex;
      gap: 12px;
      min-width: calc(var(--week-col-w) + 12px);
    }
    
    .progress-mode .progress-week-col {
      width: var(--week-col-w);
      min-width: var(--week-col-w);
      border: 1px solid var(--line);
      border-radius: 6px;
      overflow: hidden;
      background: var(--card-bg);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .progress-mode .progress-week-col .week-head {
      padding: 10px 12px;
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      color: #166534;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
    }
    
    body[data-theme="dark"] .progress-mode .progress-week-col .week-head {
      background: linear-gradient(135deg, #14532d 0%, #166534 100%);
      color: #dcfce7;
    }
    
    .progress-mode .progress-week-col .week-head .buttons {
      display: flex;
      gap: 4px;
    }
    
    .progress-mode .progress-week-col .week-head .title {
      font-weight: 700;
      color: #166534;
    }
    
    body[data-theme="dark"] .progress-mode .progress-week-col .week-head .title {
      color: #dcfce7;
    }
    
    .progress-mode .progress-week-col .week-head .add-next {
      border: 1px solid #166534;
      background: transparent;
      color: #166534;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }
    
    .progress-mode .progress-week-col .week-head .add-next:hover {
      background: #166534;
      border-color: #166534;
      color: #dcfce7;
    }
    
    .progress-mode .progress-week-col .week-head .remove-week {
      border: 1px solid #166534;
      background: transparent;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      color: #166534;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }
    
    .progress-mode .progress-week-col .week-head .remove-week:hover {
      background: var(--lose);
      border-color: var(--lose);
      color: white;
    }
    
    body[data-theme="dark"] .progress-mode .progress-week-col .week-head .add-next {
      border-color: #dcfce7;
      color: #dcfce7;
    }
    
    body[data-theme="dark"] .progress-mode .progress-week-col .week-head .add-next:hover {
      background: #dcfce7;
      color: #166534;
    }
    
    body[data-theme="dark"] .progress-mode .progress-week-col .week-head .remove-week {
      border-color: #dcfce7;
      color: #dcfce7;
    }
    
    .progress-mode .progress-session {
      padding: 12px;
      border-bottom: 1px solid var(--line);
      display: grid;
      gap: 8px;
      background: var(--card-bg);
    }
    
    .progress-mode .progress-session:last-child { 
      border-bottom: 0; 
    }
    
    .progress-mode .progress-session:nth-child(even) {
      background: var(--input-bg);
    }
    
    .progress-mode .progress-session .session-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .progress-mode .progress-session .session-title {
      font-size: 0.9rem;
      color: var(--ink);
      font-weight: 600;
    }
    
    .progress-mode .progress-session .session-date {
      padding: 6px 8px;
      border: 1px solid var(--line);
      border-radius: 4px;
      font-size: 0.8rem;
      width: 140px;
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--card-bg);
    }
    
    .progress-mode .progress-session .day-of-week {
      font-size: 0.75rem;
      color: var(--ink-muted);
      font-weight: 600;
      margin-left: 8px;
      min-width: 40px;
      text-align: center;
      display: inline-block;
      font-family: 'Noto Sans KR', sans-serif;
      padding: 2px 6px;
      background: var(--input-bg);
      border-radius: 3px;
    }
    
    .progress-mode .progress-session textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: 'Noto Sans KR', sans-serif;
      line-height: 1.6;
      font-weight: 400;
      background: var(--card-bg);
      color: var(--ink);
      transition: border-color 0.2s ease;
    }
    
    .progress-mode .progress-session textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(25, 113, 194, 0.1);
    }
    
    .progress-mode .progress-empty {
      padding: 24px;
      border: 1px dashed var(--line);
      border-radius: 8px;
      color: var(--ink-muted);
      background: var(--input-bg);
      text-align: center;
    }
    
    
    @media (max-width: 1100px) {
      .progress-mode .progress-session input[type="date"] { width: 120px; }
    }
    
    @media (max-width: 820px) {
      .progress-mode .progress-sheet-weeks {
        flex-direction: column;
      }
      .progress-mode .progress-weeks {
        flex-direction: column;
        min-width: auto;
      }
      .progress-mode .progress-week-col {
        width: 100%;
        min-width: auto;
      }
    }

  </style>
</head>
<body>
  <div id="loader" class="loader hidden">
    <div>데이터를 불러오는 중...</div>
  </div>

  <div id="auth-container" class="auth-container">
      <div class="auth-box">
          <div style="text-align: center; margin-bottom: 24px;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
              <h2 id="auth-title" style="margin-top: 8px;">체육 수업 도우미</h2>
          </div>
          <div class="auth-tabs">
              <button id="login-tab-btn" class="active" onclick="showAuthForm('login')">로그인</button>
              <button id="signup-tab-btn" onclick="showAuthForm('signup')">회원가입</button>
          </div>
          <form id="login-form" class="auth-form">
              <div class="field">
                  <input type="email" id="login-email" placeholder="이메일" required>
              </div>
              <div class="field">
                  <input type="password" id="login-password" placeholder="비밀번호" required>
              </div>
              <a href="#" id="forgot-password-link" class="forgot-password-link">비밀번호를 잊으셨나요?</a>
              <p id="login-error" class="error-message hidden"></p>
              <button type="submit" class="btn primary">로그인</button>
          </form>
          <form id="signup-form" class="auth-form hidden">
              <div class="field">
                  <input type="email" id="signup-email" placeholder="이메일" required>
              </div>
              <div class="field">
                  <input type="password" id="signup-password" placeholder="비밀번호 (6자 이상)" required>
              </div>
              <p id="signup-error" class="error-message hidden"></p>
              <button type="submit" class="btn primary">회원가입</button>
          </form>
          
          <form id="reset-form" class="auth-form hidden">
              <div class="field">
                  <input type="email" id="reset-email" placeholder="가입한 이메일 주소" required>
              </div>
              <p id="reset-message" class="hidden"></p>
              <button type="submit" class="btn primary">재설정 링크 발송</button>
               <a href="#" id="back-to-login-link" class="forgot-password-link" style="text-align: center; margin-top: 16px;">로그인으로 돌아가기</a>
          </form>
          
          <div class="divider">또는</div>
          <div class="social-buttons" style="justify-content: center;">
              <button type="button" id="google-login-btn" class="social-btn" data-tooltip="Google 계정으로 로그인">
                  <svg viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.519-3.487-11.187-8.261l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.011,35.618,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
              </button>
          </div>
      </div>
  </div>

  <div id="app-root" class="hidden" style="display:flex; flex-direction:column; height:100vh;">
      <header class="top-bar">
        <div style="display: flex; align-items: center; gap: 12px;">
          <h1>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
              <span>체육 수업 도우미</span>
              <span class="version">v2.2.1</span>
          </h1>
        </div>
        <div class="row">
            <div id="top-bar-actions" class="row">
                <button class="btn mode-switch-btn active" data-mode="progress" data-tooltip="수업 진도 관리 화면으로 전환합니다.">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                수업 진도 관리
                </button>
                <button class="btn mode-switch-btn" data-mode="league" data-tooltip="리그전 수업 화면으로 전환합니다.">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                리그전 수업
                </button>
                <button class="btn mode-switch-btn" data-mode="tournament" data-tooltip="토너먼트 수업 화면으로 전환합니다.">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8V6a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v2"/><path d="M18 16v2a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-2"/><path d="M6 12h12"/></svg>
                토너먼트 수업
                </button>
                <button class="btn mode-switch-btn" data-mode="paps" data-tooltip="PAPS 수업 화면으로 전환합니다.">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/><path d="M7 12h6"/></svg>
                PAPS 수업
                </button>
            </div>
             <div id="user-profile" class="row" style="margin-left: 16px;">
                <div id="login-status" class="login-status">
                    <span id="user-email" style="font-weight: 500;"></span>
                    <button id="logout-btn" class="btn">로그아웃</button>
                </div>
                <div id="guest-status" class="guest-status" style="display: none;">
                    <span style="color: var(--ink-muted); font-size: 0.9rem;">로컬 모드</span>
                    <button id="login-btn" class="btn primary" onclick="showLoginModal()">로그인</button>
                </div>
            </div>
            <button class="theme-toggle" id="theme-toggle-btn" data-tooltip="다크/라이트 모드 전환">
              <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
              <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
            <button class="btn" onclick="openHelpPopup()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                사용설명서
            </button>
        </div>
      </header>
      <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <button id="sidebar-toggle" class="sidebar-toggle" data-tooltip="사이드바 토글">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <polygon points="6,4 18,12 6,20"/>
                </svg>
            </button>
            <h2 class="sidebar-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                <span id="sidebarTitle"></span>
            </h2>
            <div id="sidebar-form-container"></div>
            <div id="sidebar-list-container"></div>
            <div class="sidebar-actions" style="border-top: 1px solid var(--line); padding-top: 16px; display: flex; flex-direction: column; gap: 8px;">
                
                <div id="league-excel-actions" class="row" style="justify-content: space-between;">
                    <button id="exportAllLeaguesBtn" class="btn" style="background:var(--win); color:white; flex:1;" data-tooltip="모든 반의 리그전 결과를 엑셀 파일 하나로 내보냅니다.">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="m11.5 16.5-3-3 3-3"/><path d="m8.5 13.5 7 .01"/></svg>
                        전체 반 엑셀로 내보내기
                    </button>
                    <label for="importAllLeaguesExcel" class="btn" style="flex:1;" data-tooltip="엑셀 파일에서 여러 반의 리그전 데이터를 가져옵니다.">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="m11.5 10.5 3 3-3 3"/><path d="m8.5 13.5-7 .01"/></svg>
                        전체 반 엑셀에서 가져오기
                    </label>
                    <input type="file" id="importAllLeaguesExcel" accept=".xlsx, .xls" class="hidden" />
                </div>
                <div id="paps-excel-actions" class="row" style="justify-content: space-between; display:none;">
                    <button id="exportAllPapsBtn" class="btn" style="background:var(--win); color:white; flex:1;" data-tooltip="모든 반의 PAPS 기록을 엑셀 파일 하나로 내보냅니다.">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="m11.5 16.5-3-3 3-3"/><path d="m8.5 13.5 7 .01"/></svg>
                        전체 반 엑셀로 내보내기
                    </button>
                    <label for="importAllPapsExcel" class="btn" style="flex:1;" data-tooltip="엑셀 파일에서 여러 반의 PAPS 데이터를 가져옵니다.">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="m11.5 10.5 3 3-3 3"/><path d="m8.5 13.5-7 .01"/></svg>
                        전체 반 엑셀에서 가져오기
                    </label>
                    <input type="file" id="importAllPapsExcel" accept=".xlsx, .xls" class="hidden" />
                </div>
            </div>
            <footer class="sidebar-footer">
                <div style="margin-bottom: 8px;">
                    <div class="visitor-info" style="justify-content: center; font-size: 0.8rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px;">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>총 방문자 수 : <span id="visitor-count" style="font-weight: 600; color: var(--accent);">-</span></span>
                    </div>
                </div>
                <div>만든이: 김신회(laguyo87@gmail.com)</div>
            </footer>
        </aside>
        <main class="main-content">
          <div class="main-view">
              <div id="content-wrapper"></div>
          </div>
        </main>
      </div>
      
      <button id="liveRankingBtn" class="btn primary floating-btn" onclick="openRankingPopup()" data-tooltip="실시간 순위표">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 10v9"/><path d="M12 4v15"/><path d="M18 7v12"/></svg>
      </button>

      <div id="rankingPopup" class="hidden" style="position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.5);">
        <div class="modal-box" style="background:var(--card-bg); padding: 24px; border-radius: 8px; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 id="popupTitle" style="font-size: 1.25rem; font-weight: 700; margin:0;"></h3>
                <div class="row">
                    <button class="btn" onclick="printLiveRankings()" data-tooltip="인쇄">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                    </button>
                    <button class="btn" onclick="closeRankingPopup()" data-tooltip="닫기">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>
            <div style="overflow-y: auto;">
               <table id="popupRankingsTable" class="styled-table"></table>
            </div>
        </div>
      </div>
      
      <div id="modal-container" class="hidden" style="position: fixed; inset: 0; z-index: 101; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.5);">
        <div class="modal-box" style="background:var(--card-bg); padding: 24px; border-radius: 8px; width: 100%; max-width: 450px;">
            <h3 id="modal-title" style="font-size: 1.25rem; font-weight: 700; margin-top:0; margin-bottom: 1rem;"></h3>
            <div id="modal-body" style="color: var(--ink-muted); margin-bottom: 1.5rem;"></div>
            <div id="modal-actions" style="display: flex; justify-content: flex-end; gap: 0.75rem;"></div>
        </div>
      </div>
  </div>
    
  <div id="helpPopup" class="hidden" style="position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.5);">
    <div class="modal-box" style="background:var(--card-bg); padding: 24px; border-radius: 8px; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-shrink: 0;">
            <h3 style="font-size: 1.25rem; font-weight: 700; margin:0;">프로그램 사용 설명서</h3>
            <button class="btn" onclick="closeHelpPopup()" data-tooltip="닫기">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="help-popup-content" style="overflow-y: auto;">
            <h3>1. 핵심 기능: 4가지 수업 모드</h3>
            <p>화면 상단의 <code>수업 진도 관리</code> / <code>리그전 수업</code> / <code>토너먼트 수업</code> / <code>PAPS 수업</code> 버튼으로 네 가지 모드를 전환할 수 있습니다. 데이터는 각 모드별로 따로 저장됩니다.</p>

            <h3>2. 수업 진도 관리 방법</h3>
            <p><strong>① 반 생성:</strong> 왼쪽 사이드바에서 '새로운 반 이름'을 입력하고 <code>+</code> 버튼을 눌러 반을 생성합니다.</p>
            <p><strong>② 수업 설정:</strong> 생성된 반을 선택한 후, 담당교사, 단원 내용, 주당 시간을 입력하고 <code>설정 저장</code>을 누릅니다.</p>
            <p><strong>③ 진도표 생성:</strong> 설정 저장 후 수업 기록 테이블이 자동으로 생성됩니다. 각 주차별로 수업 날짜와 내용을 기록할 수 있습니다.</p>
            <p><strong>④ 수정하기:</strong> 왼쪽 반 카드의 연필 아이콘을 클릭하면 수업 설정을 다시 수정할 수 있습니다.</p>

            <h3>3. 리그전 수업 방법</h3>
            <p><strong>① 반 생성:</strong> 왼쪽 사이드바에서 '새로운 반(팀) 이름'을 입력하고 <code>+</code> 버튼을 눌러 리그를 생성합니다.</p>
            <p><strong>② 학생 추가:</strong></p>
            <ul>
                <li>생성된 반을 선택한 후, '신규 선수 추가'에 학생 이름을 입력하고 '추가'합니다.</li>
                <li>'일괄 추가' 버튼으로 여러 명의 이름을 쉼표(,)로 구분해 한 번에 등록할 수 있습니다.</li>
            </ul>
            <p><strong>③ 경기 일정 생성:</strong> 학생 추가가 완료되면, <code>일정 생성</code> 버튼을 누르세요. 모든 학생이 한 번씩 맞붙는 리그전 대진표(라운드 로빈)가 자동으로 만들어집니다.</p>
            <p><strong>④ 점수 입력:</strong> 경기 일정 표에서 각 경기의 점수를 입력하면 자동으로 승점이 계산되고 '완료' 상태로 변경됩니다.</p>
            <p><strong>⑤ 순위 확인:</strong> 점수를 입력하면 순위표가 실시간으로 업데이트됩니다. 우측의 <code>실시간 순위표</code> 버튼으로 큰 팝업창에서 순위를 보거나 <code>순위표 인쇄</code> 버튼으로 인쇄할 수 있습니다.</p>

            <h3>4. 토너먼트 관리 방법</h3>
            <p><strong>① 토너먼트 생성:</strong> 왼쪽 사이드바에서 '새로운 토너먼트 이름'을 입력하고 <code>+</code> 버튼을 눌러 토너먼트를 생성합니다.</p>
            <p><strong>② 팀 추가 및 설정:</strong></p>
            <ul>
                <li>생성된 토너먼트를 선택 후, '참가 팀 관리'에서 팀 이름을 추가합니다.</li>
                <li>'토너먼트 설정'에서 경기 종목, 시드 배정 방식(입력 순 또는 무작위) 등을 설정하고 <code>설정 저장</code>을 누릅니다.</li>
            </ul>
            <p><strong>③ 대진표 관리:</strong> 팀을 추가/삭제하면 대진표가 자동으로 생성 및 업데이트됩니다. 경기 후 대진표의 점수 칸에 결과를 입력하면 승자가 자동으로 다음 라운드로 진출합니다. 최종 순위는 대진표에 메달 아이콘으로 표시됩니다.</p>

            <h3>5. PAPS 수업 관리 방법</h3>
            <p><strong>① PAPS 반 생성:</strong> 왼쪽 사이드바에서 '새로운 PAPS 반 이름'을 입력하고 <code>+</code> 버튼을 눌러 PAPS 반을 생성합니다.</p>
            <p><strong>② 학년 설정:</strong> 생성된 반을 선택한 후, 학년을 설정합니다. (초등학교 4-6학년, 중학교 1-3학년, 고등학교 1-3학년)</p>
            <p><strong>③ 종목 설정:</strong> 각 카테고리별로 측정 종목을 선택합니다:</p>
            <ul>
                <li><strong>심폐지구력:</strong> 왕복오래달리기, 오래달리기, 스텝검사</li>
                <li><strong>유연성:</strong> 앉아윗몸앞으로굽히기, 종합유연성검사</li>
                <li><strong>근력/근지구력:</strong> 악력, 팔굽혀펴기, 윗몸말아올리기</li>
                <li><strong>순발력:</strong> 제자리멀리뛰기, 50m 달리기</li>
                <li><strong>체지방:</strong> BMI (신장, 체중 입력)</li>
            </ul>
            <p><strong>④ 학생 추가:</strong></p>
            <ul>
                <li>'학생 추가' 버튼으로 개별 추가하거나, 엑셀 파일로 일괄 업로드할 수 있습니다.</li>
                <li>학생의 번호, 이름, 성별을 입력합니다.</li>
            </ul>
            <p><strong>⑤ 기록 입력:</strong> 기록입력 테이블에서 각 학생의 측정 기록을 입력합니다:</p>
            <ul>
                <li><strong>악력:</strong> 왼손과 오른손 각각의 기록을 입력할 수 있습니다.</li>
                <li><strong>팔굽혀펴기:</strong> 남학생은 팔굽혀펴기, 여학생은 무릎대고 팔굽혀펴기로 자동 표시됩니다.</li>
                <li><strong>체지방:</strong> 신장(cm)과 체중(kg)을 입력하면 BMI가 자동 계산됩니다.</li>
            </ul>
            <p><strong>⑥ 등급 확인:</strong> 기록을 입력하면 성별과 학년에 따른 PAPS 등급이 자동으로 계산되어 표시됩니다.</p>
            <p><strong>⑦ 데이터 내보내기:</strong> 엑셀 파일로 전체 데이터를 내보내거나, 그래프로 등급 분포를 확인할 수 있습니다.</p>

            <h3>6. 데이터 관리 및 기타 기능</h3>
            <ul>
                <li><strong>자동 저장:</strong> 모든 데이터는 로그인된 계정에 연결되어 클라우드에 실시간으로 자동 저장됩니다. 다른 기기에서 로그인해도 데이터를 그대로 사용할 수 있습니다.</li>
                <li><strong>테마 변경:</strong> 우측 상단의 해/달 아이콘으로 라이트/다크 모드를 전환할 수 있습니다.</li>
                <li><strong>엑셀 호환성:</strong> PAPS 데이터는 엑셀 파일로 내보내기/가져오기가 가능하여 기존 스프레드시트와 연동할 수 있습니다.</li>
            </ul>

            <h3>7. 주요 특징</h3>
            <ul>
                <li><strong>실시간 계산:</strong> 모든 점수와 등급이 실시간으로 자동 계산됩니다.</li>
                <li><strong>반응형 디자인:</strong> PC, 태블릿, 스마트폰 등 모든 기기에서 사용 가능합니다.</li>
                <li><strong>직관적 UI:</strong> 체육 교사가 쉽게 사용할 수 있도록 설계되었습니다.</li>
                <li><strong>PAPS 2024 기준:</strong> 최신 PAPS 평가 기준을 반영하여 정확한 등급을 제공합니다.</li>
            </ul>
        </div>
    </div>
  </div>
  


  <script type="module">
    // Firebase SDK import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    // ========================================
    // Firebase 설정
    // ========================================
    const firebaseConfig = {
      apiKey: "AIzaSyB2d_7WBaTIuXfyFceuAGqbKFjZWRelvY0",
      authDomain: "pe-helper-5739e.firebaseapp.com",
      projectId: "pe-helper-5739e",
      storageBucket: "pe-helper-5739e.firebasestorage.app",
      messagingSenderId: "859265361891",
      appId: "1:859265361891:web:dcc26b7bb6e6776210e2d6",
      measurementId: "G-5VCQKBNKZK"
    };

    try {
      console.log('=== Firebase 초기화 시작 ===');
      
      // Firebase 앱 초기화
      const app = initializeApp(firebaseConfig);
      console.log('Firebase 앱 초기화 완료');
      
      const auth = getAuth(app);
      console.log('Firebase Auth 초기화 완료');
      
      const db = getFirestore(app);
      console.log('Firebase Firestore 초기화 완료');
      
      // Firebase 연결 상태 확인
      console.log('=== Firebase 초기화 성공 ===');
      console.log('Auth 객체:', auth);
      console.log('Firestore 객체:', db);
      
      // Firestore 연결 테스트
      const testDoc = doc(db, 'test', 'connection');
      console.log('Firestore 테스트 문서 참조 생성됨:', testDoc);
      
      // 실제 연결 테스트 수행
      try {
        console.log('=== Firebase 연결 테스트 시작 ===');
        const testDoc = doc(db, 'test', 'connection');
        const testSnap = await getDoc(testDoc);
        console.log('Firebase 연결 테스트 성공:', testSnap.exists() ? '문서 존재' : '문서 없음');
      } catch (error) {
        console.error('Firebase 연결 테스트 실패:', error);
        console.error('오류 코드:', error.code);
        console.error('오류 메시지:', error.message);
      }

      window.firebase = { 
        auth, 
        db, 
        onAuthStateChanged, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut, 
        GoogleAuthProvider, 
        signInWithPopup, 
        doc, 
        setDoc, 
        getDoc, 
        sendPasswordResetEmail 
      };
      
      console.log('window.firebase 객체 설정 완료');
      
      // Firebase 초기화 완료 이벤트 발생
      window.dispatchEvent(new CustomEvent('firebaseReady'));
      console.log('firebaseReady 이벤트 발생');
      
    } catch (error) {
      console.error('=== Firebase 초기화 실패 ===');
      console.error('오류 상세:', error.message);
      console.error('오류 스택:', error.stack);
      console.error('오류 이름:', error.name);
      
      // Firebase 초기화 실패 이벤트 발생
      window.dispatchEvent(new CustomEvent('firebaseError', { detail: error }));
      console.log('firebaseError 이벤트 발생');
    }
  </script>
  
  <script>
    // ========================================
    // 버전 관리 시스템
    // ========================================
    const APP_VERSION = '2.2.1';
    const VERSION_KEY = 'pe_helper_version';
    
    // 버전 체크 및 캐시 무효화
    function checkVersion() {
      const storedVersion = localStorage.getItem(VERSION_KEY);
      if (storedVersion !== APP_VERSION) {
        // 새 버전이 감지되면 캐시 무효화
        console.log(`새 버전 감지: ${APP_VERSION} (이전: ${storedVersion})`);
        localStorage.setItem(VERSION_KEY, APP_VERSION);
        
        // 캐시 무효화를 위한 타임스탬프 추가
        const timestamp = Date.now();
        localStorage.setItem('cache_buster', timestamp);
        
        // 사용자에게 새 버전 알림
        if (storedVersion) {
          showVersionNotification(APP_VERSION, storedVersion);
        }
      }
    }
    
    // 버전 알림 표시
    function showVersionNotification(newVersion, oldVersion) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #1565c0;
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-family: 'Noto Sans KR', sans-serif;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
      `;
      
      notification.innerHTML = `
        <div style="font-weight: 700; margin-bottom: 8px;">🔄 새 버전 사용 가능</div>
        <div style="font-size: 14px; margin-bottom: 12px;">
          v${newVersion}이 출시되었습니다.<br>
          최신 기능을 사용하려면 새로고침해주세요.
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="this.parentElement.parentElement.remove()" 
                  style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
            나중에
          </button>
          <button onclick="window.location.reload(true)" 
                  style="background: white; border: none; color: #1565c0; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
            새로고침
          </button>
        </div>
      `;
      
      // CSS 애니메이션 추가
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(notification);
      
      // 10초 후 자동으로 사라지기
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 10000);
    }
    
    // 페이지 로드 시 버전 체크
    checkVersion();
    
    // 상단바 버전 표시 업데이트
    function updateVersionDisplay() {
      const versionElement = document.querySelector('.version');
      if (versionElement) {
        versionElement.textContent = `v${APP_VERSION}`;
      }
    }
    
    // 버전 표시 업데이트
    updateVersionDisplay();
    
    // ========================================
    // 앱 상태 및 전역 변수
    // ========================================
    let appMode = 'progress';
    let leagueData = { classes: [], students: [], games: [], selectedClassId: null };
    let tournamentData = { tournaments: [], activeTournamentId: null };
    let papsData = { classes: [], activeClassId: null };
    let progressClasses = [];
    let progressSelectedClassId = '';
    let currentUser = null;
    let dbDebounceTimer;
    const adminUid = "4LRORiF8UcXB6BYMrs5bZi2UEyy2"; // 관리자 UID가 여기에 입력되었습니다.
    
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // ========================================
    // 방문자 통계
    // ========================================
    async function updateVisitorCount() {
        try {
            console.log('=== 방문자 수 업데이트 시작 ===');
            
            if (!window.firebase || !window.firebase.db) {
                console.log('Firebase가 아직 초기화되지 않음, 방문자 수 업데이트 건너뜀');
                return;
            }
            
            // 세션 기반 방문자 카운트 (같은 세션에서는 중복 카운트 방지)
            const sessionKey = 'visitor_counted_' + new Date().toDateString();
            console.log('세션 키:', sessionKey);
            console.log('세션 스토리지 값:', sessionStorage.getItem(sessionKey));
            
            if (sessionStorage.getItem(sessionKey)) {
                console.log('이미 오늘 방문자 수가 카운트됨, 기존 카운트만 로드');
                // 기존 카운트만 로드
                await loadVisitorCount();
                return;
            }
            
            console.log('새로운 방문자로 카운트 시작');
            const visitorRef = window.firebase.doc(window.firebase.db, "stats", "visitors");
            const visitorSnap = await window.firebase.getDoc(visitorRef);
            
            let currentCount = 0;
            let startDate = null;
            
            if (visitorSnap.exists()) {
                const data = visitorSnap.data();
                currentCount = data.count || 0;
                startDate = data.startDate || null;
                console.log('기존 방문자 수:', currentCount, '시작 날짜:', startDate);
            } else {
                console.log('첫 방문자입니다');
            }
            
            // 첫 방문자라면 시작 날짜 설정
            if (!startDate) {
                startDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD 형식
                console.log('시작 날짜 설정:', startDate);
            }
            
            // 방문자 수 증가
            currentCount += 1;
            console.log('증가된 방문자 수:', currentCount);
            
            // Firebase에 저장
            console.log('Firebase에 저장 중...');
            await window.firebase.setDoc(visitorRef, {
                count: currentCount,
                startDate: startDate,
                lastUpdated: Date.now()
            });
            console.log('Firebase 저장 완료');
            
            // 세션에 카운트 완료 표시
            sessionStorage.setItem(sessionKey, 'true');
            console.log('세션 스토리지에 카운트 완료 표시');
            
            // 화면에 표시 (시작 날짜 포함)
            displayVisitorCount(currentCount, startDate);
            
            console.log('방문자 수 업데이트 완료:', currentCount);
        } catch (error) {
            console.error('방문자 수 업데이트 오류:', error);
            $('#visitor-count').textContent = '-';
        }
    }
    
    async function loadVisitorCount() {
        try {
            if (!window.firebase || !window.firebase.db) {
                console.log('Firebase가 아직 초기화되지 않음, 방문자 수 로드 건너뜀');
                return;
            }
            const visitorRef = window.firebase.doc(window.firebase.db, "stats", "visitors");
            const visitorSnap = await window.firebase.getDoc(visitorRef);
            
            if (visitorSnap.exists()) {
                const data = visitorSnap.data();
                const count = data.count || 0;
                const startDate = data.startDate || null;
                displayVisitorCount(count, startDate);
            } else {
                $('#visitor-count').textContent = '0';
            }
        } catch (error) {
            console.error('방문자 수 로드 오류:', error);
            $('#visitor-count').textContent = '-';
        }
    }
    
    function displayVisitorCount(count, startDate) {
        const countElement = $('#visitor-count');
        if (countElement) {
            countElement.textContent = count.toLocaleString();
        }
        
        // 수업 진도 관리 모드의 방문자 수도 업데이트
        const progressCountElement = $('#progress-visitor-count');
        if (progressCountElement) {
            progressCountElement.textContent = count.toLocaleString();
        }
    }
    
    // 방문자 수 테스트용 함수 (개발자 콘솔에서 사용)
    function resetVisitorCount() {
        sessionStorage.removeItem('visitor_counted_' + new Date().toDateString());
        console.log('방문자 수 카운트 세션 초기화됨. 페이지를 새로고침하면 방문자 수가 증가합니다.');
    }

    async function updateProgressVisitorCount() {
        try {
            const visitorRef = window.firebase.doc(window.firebase.db, "stats", "visitors");
            const visitorSnap = await window.firebase.getDoc(visitorRef);
            
            if (visitorSnap.exists()) {
                const data = visitorSnap.data();
                const count = data.count || 0;
                const progressCountElement = $('#progress-visitor-count');
                if (progressCountElement) {
                    progressCountElement.textContent = count.toLocaleString();
                }
            } else {
                const progressCountElement = $('#progress-visitor-count');
                if (progressCountElement) {
                    progressCountElement.textContent = '0';
                }
            }
        } catch (error) {
            console.error('진도 관리 모드 방문자 수 로드 오류:', error);
            const progressCountElement = $('#progress-visitor-count');
            if (progressCountElement) {
                progressCountElement.textContent = '-';
            }
        }
    }

    // ========================================
    // 인증 UI 및 로직
    // ========================================
    function showLoginModal() {
        // 로그인 화면으로 전환
        $('#auth-container').classList.remove('hidden');
        $('#app-root').classList.add('hidden');
        showAuthForm('login');
    }

    function updateLoginStatus() {
        const loginStatus = $('#login-status');
        const guestStatus = $('#guest-status');
        
        if (currentUser) {
            // 로그인된 상태
            loginStatus.style.display = 'flex';
            guestStatus.style.display = 'none';
            $('#user-email').textContent = currentUser.displayName || currentUser.email;
        } else {
            // 로그인하지 않은 상태
            loginStatus.style.display = 'none';
            guestStatus.style.display = 'flex';
        }
    }
    function showAuthForm(formName) {
        $('#login-form').classList.toggle('hidden', formName !== 'login');
        $('#signup-form').classList.toggle('hidden', formName !== 'signup');
        $('#reset-form').classList.toggle('hidden', formName !== 'reset');

        const isReset = formName === 'reset';
        $('.auth-tabs').classList.toggle('hidden', isReset);
        $('.divider').classList.toggle('hidden', isReset);
        $('.social-buttons').classList.toggle('hidden', isReset);

        $('#auth-title').textContent = isReset ? '비밀번호 재설정' : '체육 수업 도우미';

        $('#login-tab-btn').classList.toggle('active', formName === 'login');
        $('#signup-tab-btn').classList.toggle('active', formName === 'signup');

        $('#login-error').classList.add('hidden');
        $('#signup-error').classList.add('hidden');
        $('#reset-message').classList.add('hidden');
    }

    async function signInWithGoogle() {
        const { auth, GoogleAuthProvider, signInWithPopup } = window.firebase;
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
        } catch (error) {
            handleAuthError(error, 'login');
        }
    }

    function handleAuthError(error, type) {
        const messageElement = $(`#${type}-error`);
        let friendlyMessage = "오류가 발생했습니다. 다시 시도해주세요.";
        switch (error.code) {
            case 'auth/invalid-email': friendlyMessage = "유효하지 않은 이메일 형식입니다."; break;
            case 'auth/user-not-found': friendlyMessage = "가입되지 않은 이메일입니다."; break;
            case 'auth/wrong-password': friendlyMessage = "비밀번호가 틀렸습니다."; break;
            case 'auth/email-already-in-use': friendlyMessage = "이미 사용 중인 이메일입니다."; break;
            case 'auth/weak-password': friendlyMessage = "비밀번호는 6자 이상이어야 합니다."; break;
            case 'auth/popup-closed-by-user': friendlyMessage = "로그인 팝업이 닫혔습니다. 다시 시도해주세요."; break;
            default: friendlyMessage = "로그인에 실패했습니다. 잠시 후 다시 시도해주세요.";
        }
        messageElement.textContent = friendlyMessage;
        messageElement.classList.remove('hidden');
    }

    async function handlePasswordReset(e) {
        e.preventDefault();
        const { auth, sendPasswordResetEmail } = window.firebase;
        const email = $('#reset-email').value;
        const messageElement = $('#reset-message');

        messageElement.classList.remove('hidden', 'success-message', 'error-message');

        if (!email) {
            messageElement.textContent = '이메일을 입력해주세요.';
            messageElement.classList.add('error-message');
            messageElement.classList.remove('hidden');
            return;
        }

        try {
            await sendPasswordResetEmail(auth, email);
            messageElement.textContent = "비밀번호 재설정 이메일이 발송되었습니다. 받은편지함을 확인해주세요.";
            messageElement.classList.add('success-message');
        } catch (error) {
            let friendlyMessage = "오류가 발생했습니다. 다시 시도해주세요.";
            if (error.code === 'auth/user-not-found') {
                friendlyMessage = "가입되지 않은 이메일입니다.";
            } else if (error.code === 'auth/invalid-email') {
                friendlyMessage = "유효하지 않은 이메일 형식입니다.";
            }
            messageElement.textContent = friendlyMessage;
            messageElement.classList.add('error-message');
        } finally {
            messageElement.classList.remove('hidden');
        }
    }

    // ========================================
    // 데이터 동기화 (Firebase <-> 로컬)
    // ========================================
    async function saveDataToFirestore(retryCount = 0) {
      if (!currentUser) {
          console.log('사용자가 로그인되지 않음, 로컬 스토리지에 저장');
          saveToLocalStorage();
          return;
      }
      
      if (!window.firebase || !window.firebase.db) {
          console.error('Firebase가 초기화되지 않음, 저장 건너뜀');
          return;
      }
      
      clearTimeout(dbDebounceTimer);
      dbDebounceTimer = setTimeout(async () => {
          try {
              console.log('Firestore에 데이터 저장 시작, retryCount:', retryCount);
              
              const dataToSave = {
                  leagues: JSON.parse(JSON.stringify(leagueData)),
                  tournaments: JSON.parse(JSON.stringify(tournamentData)),
                  paps: JSON.parse(JSON.stringify(papsData)),
                  progress: {
                      classes: JSON.parse(JSON.stringify(progressClasses)),
                      selectedClassId: progressSelectedClassId
                  },
                  lastUpdated: Date.now()
              };

              if (dataToSave.tournaments && dataToSave.tournaments.tournaments) {
                  dataToSave.tournaments.tournaments.forEach(t => {
                      if (Array.isArray(t.rounds)) {
                          t.rounds = JSON.stringify(t.rounds);
                      }
                  });
              }

              const userDocRef = window.firebase.doc(window.firebase.db, "users", currentUser.uid);
              
              // 타임아웃 설정 (15초)
              const timeoutPromise = new Promise((_, reject) => {
                  setTimeout(() => reject(new Error('Firestore 저장 시간 초과')), 15000);
              });
              
              await Promise.race([
                  window.firebase.setDoc(userDocRef, dataToSave, { merge: true }),
                  timeoutPromise
              ]);
              
              console.log('Firestore 데이터 저장 성공');
              
              // 로컬 스토리지에도 백업
              try {
                  localStorage.setItem('leagueData', JSON.stringify(leagueData));
                  localStorage.setItem('tournamentData', JSON.stringify(tournamentData));
                  localStorage.setItem('papsData', JSON.stringify(papsData));
                  localStorage.setItem('progressData', JSON.stringify({
                      classes: progressClasses,
                      selectedClassId: progressSelectedClassId
                  }));
                  console.log('로컬 스토리지 백업 완료');
              } catch (backupError) {
                  console.warn('로컬 스토리지 백업 실패:', backupError);
              }
              
          } catch (error) {
              console.error("Firestore 저장 실패:", error);
              console.error("오류 상세:", error.message);
              console.error("오류 코드:", error.code);
              
              // 재시도 로직 (최대 3회)
              if (retryCount < 3) {
                  console.log(`데이터 저장 재시도 중... (${retryCount + 1}/3)`);
                  setTimeout(() => {
                      saveDataToFirestore(retryCount + 1);
                  }, 2000 * (retryCount + 1)); // 2초, 4초, 6초 간격으로 재시도
                  return;
              }
              
              // 최종 실패 시 사용자에게 알림
              const errorMessage = getFirebaseErrorMessage(error);
              console.error('데이터 저장 최종 실패:', errorMessage);
              
              // 사용자에게 알림 (너무 자주 알림이 뜨지 않도록 제한)
              if (!window.lastSaveErrorTime || Date.now() - window.lastSaveErrorTime > 30000) {
                  alert(`데이터 저장에 실패했습니다: ${errorMessage}\n오프라인 모드로 전환됩니다.`);
                  window.lastSaveErrorTime = Date.now();
              }
          }
      }, 1000);
    }

    async function loadDataFromFirestore(userId, retryCount = 0) {
        console.log('=== loadDataFromFirestore 호출됨 ===');
        console.log('userId:', userId);
        console.log('retryCount:', retryCount);
        console.log('window.firebase 존재:', !!window.firebase);
        console.log('window.firebase.db 존재:', !!(window.firebase && window.firebase.db));
        
        $('#loader').classList.remove('hidden');
        
        try {
            // Firebase 연결 상태 확인
            if (!window.firebase || !window.firebase.db) {
                throw new Error('Firebase가 초기화되지 않았습니다.');
            }
            
            console.log('Firebase 연결 상태 확인 완료');
            const userDocRef = window.firebase.doc(window.firebase.db, "users", userId);
            console.log('Firestore 문서 참조 생성됨:', userDocRef);
            console.log('문서 경로:', userDocRef.path);
            
            // 타임아웃 설정 (10초)
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Firestore 요청 시간 초과')), 10000);
            });
            
            console.log('Firestore getDoc 요청 시작...');
            const docSnap = await Promise.race([
                window.firebase.getDoc(userDocRef),
                timeoutPromise
            ]);
            
            console.log('=== Firestore 응답 받음 ===');
            console.log('docSnap:', docSnap);
            console.log('docSnap.exists():', docSnap.exists());
            console.log('docSnap.id:', docSnap.id);
            console.log('docSnap.ref:', docSnap.ref);

            if (docSnap.exists()) {
                const data = docSnap.data();
                console.log('=== Firestore 데이터 파싱 시작 ===');
                console.log('원본 데이터:', data);
                console.log('data.leagues:', data.leagues);
                console.log('data.tournaments:', data.tournaments);
                console.log('data.paps:', data.paps);
                console.log('data.progress:', data.progress);
                
                leagueData = data.leagues || { classes: [], students: [], games: [], selectedClassId: null };
                tournamentData = data.tournaments || { tournaments: [], activeTournamentId: null };
                papsData = data.paps || { classes: [], activeClassId: null };
                
                // progressClasses 데이터 로드
                if (data.progress) {
                    progressClasses = data.progress.classes || [];
                    progressSelectedClassId = data.progress.selectedClassId || '';
                    console.log('진도표 데이터 로드됨:', data.progress);
                    console.log('progressClasses 배열:', progressClasses);
                    console.log('progressClasses 길이:', progressClasses.length);
                } else {
                    progressClasses = [];
                    progressSelectedClassId = '';
                    console.log('진도표 데이터 없음, 초기화');
                }

                if (tournamentData.tournaments) {
                    tournamentData.tournaments.forEach(t => {
                        if (t.rounds && typeof t.rounds === 'string') {
                            try {
                                t.rounds = JSON.parse(t.rounds);
                            } catch (e) {
                                console.error("Rounds parsing error:", e);
                                t.rounds = []; 
                            }
                        } else if (t.rounds === undefined) {
                            t.rounds = [];
                        }
                    });
                }
                
                console.log('=== 데이터 로드 완료 ===');
                console.log('leagueData:', leagueData);
                console.log('tournamentData:', tournamentData);
                console.log('papsData:', papsData);
                console.log('progressClasses:', progressClasses);
                
                // 데이터 유효성 검사
                validateLoadedData();
            } else {
                console.log('Firestore 문서가 존재하지 않음, 새 사용자로 처리');
                leagueData = { classes: [], students: [], games: [], selectedClassId: null };
                tournamentData = { tournaments: [], activeTournamentId: null };
                papsData = { classes: [], activeClassId: null };
                progressClasses = [];
                progressSelectedClassId = '';
                await saveDataToFirestore();
            }
            
            // 데이터 로드 완료 후 렌더링
            console.log('데이터 로드 완료, 앱 렌더링 시작');
            setTimeout(() => {
                renderApp();
            }, 100); // 약간의 지연을 두어 DOM이 준비되도록 함
        } catch (error) {
            console.error("Firestore 불러오기 실패:", error);
            console.error("오류 상세:", error.message);
            console.error("오류 코드:", error.code);
            console.error("스택 트레이스:", error.stack);
            
            // 재시도 로직 (최대 3회)
            if (retryCount < 3) {
                console.log(`재시도 중... (${retryCount + 1}/3)`);
                setTimeout(() => {
                    loadDataFromFirestore(userId, retryCount + 1);
                }, 2000 * (retryCount + 1)); // 2초, 4초, 6초 간격으로 재시도
                return;
            }
            
            // 최종 실패 시 사용자에게 알림
            const errorMessage = getFirebaseErrorMessage(error);
            console.error('=== 최종 데이터 로딩 실패 ===');
            console.error('오류 메시지:', errorMessage);
            console.error('사용자 UID:', userId);
            console.error('재시도 횟수:', retryCount);
            
            const retryAction = confirm(`데이터를 불러오는 데 실패했습니다: ${errorMessage}\n\n다시 시도하시겠습니까?`);
            if (retryAction) {
                console.log('사용자가 수동 재시도 선택');
                setTimeout(() => {
                    loadDataFromFirestore(userId, 0);
                }, 1000);
                return;
            }
            
            // 오프라인 모드로 전환
            console.log('오프라인 모드로 전환합니다.');
            loadFallbackData();
            
            // 오프라인 모드에서도 렌더링
            setTimeout(() => {
                renderApp();
            }, 100);
        } finally {
            $('#loader').classList.add('hidden');
        }
    }
    
    // Firebase 에러 메시지 변환 함수
    function getFirebaseErrorMessage(error) {
        const errorCode = error.code || error.message;
        
        switch (errorCode) {
            case 'permission-denied':
                return '데이터에 접근할 권한이 없습니다.';
            case 'unavailable':
                return 'Firebase 서비스가 일시적으로 사용할 수 없습니다.';
            case 'unauthenticated':
                return '인증이 필요합니다. 다시 로그인해주세요.';
            case 'not-found':
                return '데이터를 찾을 수 없습니다.';
            case 'deadline-exceeded':
                return '요청 시간이 초과되었습니다.';
            case 'resource-exhausted':
                return '서버 리소스가 부족합니다.';
            case 'failed-precondition':
                return '요청 조건이 맞지 않습니다.';
            case 'aborted':
                return '요청이 중단되었습니다.';
            case 'out-of-range':
                return '요청 범위를 벗어났습니다.';
            case 'unimplemented':
                return '구현되지 않은 기능입니다.';
            case 'internal':
                return '내부 서버 오류가 발생했습니다.';
            case 'data-loss':
                return '데이터 손실이 발생했습니다.';
            default:
                if (error.message.includes('timeout')) {
                    return '연결 시간이 초과되었습니다. 인터넷 연결을 확인해주세요.';
                } else if (error.message.includes('network')) {
                    return '네트워크 연결을 확인해주세요.';
                } else {
                    return error.message || '알 수 없는 오류가 발생했습니다.';
                }
        }
    }


    // ========================================
    // 데이터 새로고침
    // ========================================
    function refreshData() {
        console.log('=== 수동 데이터 새로고침 시작 ===');
        
        if (!currentUser) {
            console.log('사용자가 로그인되지 않음, 새로고침 불가');
            alert('로그인이 필요합니다.');
            return;
        }
        
        console.log('사용자 UID:', currentUser.uid);
        console.log('데이터 새로고침 시작...');
        
        // 로딩 표시
        $('#loader').classList.remove('hidden');
        
        // 데이터 새로고침
        loadDataFromFirestore(currentUser.uid, 0);
    }

    // ========================================
    // 로컬 스토리지 저장 (로그인하지 않은 사용자용)
    // ========================================
    function saveToLocalStorage() {
        try {
            console.log('로컬 스토리지에 데이터 저장 시작');
            
            // 각 데이터를 로컬 스토리지에 저장
            localStorage.setItem('leagueData', JSON.stringify(leagueData));
            localStorage.setItem('tournamentData', JSON.stringify(tournamentData));
            localStorage.setItem('papsData', JSON.stringify(papsData));
            localStorage.setItem('progressData', JSON.stringify({
                classes: progressClasses,
                selectedClassId: progressSelectedClassId
            }));
            
            console.log('로컬 스토리지에 데이터 저장 완료');
        } catch (error) {
            console.error('로컬 스토리지 저장 실패:', error);
        }
    }

    // ========================================
    // 로컬 데이터 로딩 (로그인하지 않은 사용자용)
    // ========================================
    function loadLocalData() {
        console.log('로컬 데이터 로딩 시작');
        try {
            // 로컬 스토리지에서 데이터 로드
            const localLeagueData = localStorage.getItem('leagueData');
            const localTournamentData = localStorage.getItem('tournamentData');
            const localPapsData = localStorage.getItem('papsData');
            const localProgressData = localStorage.getItem('progressData');
            
            if (localLeagueData) {
                leagueData = JSON.parse(localLeagueData);
                console.log('로컬 스토리지에서 leagueData 로드됨');
            }
            
            if (localTournamentData) {
                tournamentData = JSON.parse(localTournamentData);
                console.log('로컬 스토리지에서 tournamentData 로드됨');
            }
            
            if (localPapsData) {
                papsData = JSON.parse(localPapsData);
                console.log('로컬 스토리지에서 papsData 로드됨');
            }
            
            if (localProgressData) {
                const parsed = JSON.parse(localProgressData);
                progressClasses = parsed.classes || [];
                progressSelectedClassId = parsed.selectedClassId || '';
                console.log('로컬 스토리지에서 progressData 로드됨');
            }
            
            console.log('로컬 데이터 로딩 완료');
            console.log('leagueData:', leagueData);
            console.log('tournamentData:', tournamentData);
            console.log('papsData:', papsData);
            console.log('progressClasses:', progressClasses);
            
        } catch (error) {
            console.error('로컬 데이터 로딩 실패:', error);
            // 빈 데이터로 초기화
            leagueData = { classes: [], students: [], games: [], selectedClassId: null };
            tournamentData = { tournaments: [], activeTournamentId: null };
            papsData = { classes: [], activeClassId: null };
            progressClasses = [];
            progressSelectedClassId = '';
        }
    }

    // ========================================
    // 폴백 데이터 로딩
    // ========================================
    function loadFallbackData() {
        console.log('=== 폴백 데이터 로딩 시작 ===');
        
        try {
            // 로컬 스토리지에서 데이터 시도
            const localLeagueData = localStorage.getItem('leagueData');
            const localTournamentData = localStorage.getItem('tournamentData');
            const localPapsData = localStorage.getItem('papsData');
            const localProgressData = localStorage.getItem('progressData');
            
            if (localLeagueData) {
                leagueData = JSON.parse(localLeagueData);
                console.log('로컬 스토리지에서 leagueData 로드됨');
            } else {
                leagueData = { classes: [], students: [], games: [], selectedClassId: null };
            }
            
            if (localTournamentData) {
                tournamentData = JSON.parse(localTournamentData);
                console.log('로컬 스토리지에서 tournamentData 로드됨');
            } else {
                tournamentData = { tournaments: [], activeTournamentId: null };
            }
            
            if (localPapsData) {
                papsData = JSON.parse(localPapsData);
                console.log('로컬 스토리지에서 papsData 로드됨');
            } else {
                papsData = { classes: [], activeClassId: null };
            }
            
            if (localProgressData) {
                const parsed = JSON.parse(localProgressData);
                progressClasses = parsed.classes || [];
                progressSelectedClassId = parsed.selectedClassId || '';
                console.log('로컬 스토리지에서 progressData 로드됨');
            } else {
                progressClasses = [];
                progressSelectedClassId = '';
            }
            
            console.log('=== 폴백 데이터 로딩 완료 ===');
            console.log('leagueData:', leagueData);
            console.log('tournamentData:', tournamentData);
            console.log('papsData:', papsData);
            console.log('progressClasses:', progressClasses);
            
        } catch (error) {
            console.error('폴백 데이터 로딩 실패:', error);
            // 최종 폴백: 빈 데이터로 초기화
            leagueData = { classes: [], students: [], games: [], selectedClassId: null };
            tournamentData = { tournaments: [], activeTournamentId: null };
            papsData = { classes: [], activeClassId: null };
            progressClasses = [];
            progressSelectedClassId = '';
            console.log('빈 데이터로 초기화 완료');
        }
    }


    // ========================================
    // 데이터 유효성 검사
    // ========================================
    function validateLoadedData() {
        console.log('=== 데이터 유효성 검사 시작 ===');
        
        const issues = [];
        
        // leagueData 검사
        if (!leagueData || typeof leagueData !== 'object') {
            issues.push('leagueData가 유효하지 않음');
        } else {
            if (!Array.isArray(leagueData.classes)) {
                issues.push('leagueData.classes가 배열이 아님');
            }
            if (!Array.isArray(leagueData.students)) {
                issues.push('leagueData.students가 배열이 아님');
            }
            if (!Array.isArray(leagueData.games)) {
                issues.push('leagueData.games가 배열이 아님');
            }
        }
        
        // tournamentData 검사
        if (!tournamentData || typeof tournamentData !== 'object') {
            issues.push('tournamentData가 유효하지 않음');
        } else {
            if (!Array.isArray(tournamentData.tournaments)) {
                issues.push('tournamentData.tournaments가 배열이 아님');
            }
        }
        
        // papsData 검사
        if (!papsData || typeof papsData !== 'object') {
            issues.push('papsData가 유효하지 않음');
        } else {
            if (!Array.isArray(papsData.classes)) {
                issues.push('papsData.classes가 배열이 아님');
            }
        }
        
        // progressClasses 검사
        if (!Array.isArray(progressClasses)) {
            issues.push('progressClasses가 배열이 아님');
        }
        
        if (issues.length > 0) {
            console.warn('데이터 유효성 검사에서 문제 발견:', issues);
            console.log('데이터 복구 시도...');
            
            // 데이터 복구
            if (!leagueData || typeof leagueData !== 'object') {
                leagueData = { classes: [], students: [], games: [], selectedClassId: null };
            }
            if (!tournamentData || typeof tournamentData !== 'object') {
                tournamentData = { tournaments: [], activeTournamentId: null };
            }
            if (!papsData || typeof papsData !== 'object') {
                papsData = { classes: [], activeClassId: null };
            }
            if (!Array.isArray(progressClasses)) {
                progressClasses = [];
                progressSelectedClassId = '';
            }
            
            console.log('데이터 복구 완료');
        } else {
            console.log('데이터 유효성 검사 통과');
        }
        
        console.log('=== 데이터 유효성 검사 완료 ===');
    }

    // ========================================
    // 사이드바 정리 함수
    // ========================================
    function cleanupSidebar() {
        console.log('사이드바 정리 시작');
        
        // 기존 동적으로 추가된 요소들 제거
        const progressClassList = $('#progressClassList');
        if (progressClassList) {
            progressClassList.remove();
        }
        
        
        // 사이드바 폼 컨테이너 초기화
        $('#sidebar-form-container').innerHTML = '';
        $('#sidebar-list-container').innerHTML = '';
        
        console.log('사이드바 정리 완료');
    }

    // ========================================
    // 모드 전환 및 메인 렌더링
    // ========================================
    function switchMode(mode) {
        console.log('모드 전환:', appMode, '->', mode);
        
        appMode = mode;
        $$('.mode-switch-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        $('#league-excel-actions').style.display = mode === 'league' ? 'flex' : 'none';
        $('#paps-excel-actions').style.display = mode === 'paps' ? 'flex' : 'none';
        $('#liveRankingBtn').classList.toggle('hidden', mode !== 'league' || !leagueData.selectedClassId);
        
        // 리그전 수업 모드일 때 body에 league-mode 클래스 추가
        document.body.classList.toggle('league-mode', mode === 'league');
        // PAPS 수업 모드일 때 body에 paps-mode 클래스 추가
        document.body.classList.toggle('paps-mode', mode === 'paps');
        
        // 수업 진도표 모드일 때 body에 클래스 추가
        if (mode === 'progress') {
            document.body.classList.add('progress-mode');
        } else {
            document.body.classList.remove('progress-mode');
        }
        
        // 모드 전환 시 사이드바 정리
        cleanupSidebar();
        
        renderApp();
    }

    function renderApp() {
        console.log('renderApp 호출됨');
        console.log('currentUser:', currentUser);
        console.log('appMode:', appMode);
        console.log('leagueData:', leagueData);
        console.log('tournamentData:', tournamentData);
        console.log('papsData:', papsData);
        console.log('progressClasses:', progressClasses);
        
        // 로그인하지 않은 사용자도 모든 기능 사용 가능
        if (!currentUser) {
            console.log('사용자가 로그인되지 않음, 로컬 모드로 모든 기능 제공');
            $('#auth-container').classList.add('hidden');
            $('#app-root').classList.remove('hidden');
            // 로컬 스토리지에서 데이터 로드
            loadLocalData();
        }
        
        // 로그인 상태 UI 업데이트
        updateLoginStatus();
        
        // 데이터 로딩 상태 확인
        const hasData = leagueData.classes.length > 0 || 
                       tournamentData.tournaments.length > 0 || 
                       papsData.classes.length > 0 || 
                       progressClasses.length > 0;
        
        console.log('데이터 존재 여부:', hasData);
        console.log('리그 클래스 수:', leagueData.classes.length);
        console.log('토너먼트 수:', tournamentData.tournaments.length);
        console.log('PAPS 클래스 수:', papsData.classes.length);
        console.log('진도표 클래스 수:', progressClasses.length);
        
        if (appMode === 'league') {
            console.log('리그 UI 렌더링 시작');
            renderLeagueUI();
        } else if (appMode === 'tournament') {
            console.log('토너먼트 UI 렌더링 시작');
            renderTournamentUI();
        } else if (appMode === 'paps') {
            console.log('PAPS UI 렌더링 시작');
            renderPapsUI();
        } else if (appMode === 'progress') {
            console.log('진도표 UI 렌더링 시작');
            renderProgressUI();
        } else {
            console.log('알 수 없는 모드:', appMode);
        }
    }

    // ========================================
    // 리그 UI 및 로직
    // ========================================
    function renderLeagueUI() {
        console.log('renderLeagueUI 시작');
        console.log('leagueData.classes.length:', leagueData.classes.length);
        console.log('leagueData:', leagueData);
        
        // 기존 요소들 정리
        cleanupSidebar();
        
        $('#sidebarTitle').textContent = '리그전 목록';
        
        const isFirstTimeUser = leagueData.classes.length === 0 && tournamentData.tournaments.length === 0;
        console.log('isFirstTimeUser:', isFirstTimeUser);
        
        let formHtml = `
            <div style="position: relative;" class="${isFirstTimeUser ? 'intro-container-active' : ''}">
                <div class="sidebar-form-group ${isFirstTimeUser ? 'intro-highlight' : ''}">
                    <input id="className" type="text" placeholder="새로운 반(팀) 이름">
                    <button onclick="createClass()" class="btn primary" data-tooltip="새로운 리그를 목록에 추가합니다.">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <div class="intro-arrow">
                    <svg viewBox="0 0 24 24" fill="#F44336">
                        <path d="M2 12l8-8v5h12v6H10v5l-8-8z"/>
                    </svg>
                </div>
            </div>
        `;
        $('#sidebar-form-container').innerHTML = formHtml;

        renderClassList();
        const selectedClass = leagueData.classes.find(c => c.id === leagueData.selectedClassId);
        if (selectedClass) {
            renderLeagueDashboard(selectedClass);
        } else {
            console.log('리그 데이터가 없음, 플레이스홀더 표시');
            $('#content-wrapper').innerHTML = `
                <div class="placeholder-view">
                    <div class="placeholder-content">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <h3>반을 선택하여 시작하세요</h3>
                        <p>왼쪽에서 반을 선택하거나 새로 만들어주세요.</p>
                        <div style="margin-top: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #666;">
                            <strong>디버그 정보:</strong><br>
                            • 리그 클래스 수: ${leagueData.classes.length}<br>
                            • 토너먼트 수: ${tournamentData.tournaments.length}<br>
                            • 선택된 클래스 ID: ${leagueData.selectedClassId}
                        </div>
                    </div>
                </div>`;
        }
    }

    function renderClassList() {
        $('#sidebar-list-container').innerHTML = leagueData.classes.map(c => `
            <div class="list-card ${c.id === leagueData.selectedClassId ? 'active' : ''}" onclick="selectClass(${c.id})">
                <div style="flex-grow: 1;">
                    <div class="name">${c.name}</div>
                    <div class="details">${leagueData.students.filter(s => s.classId === c.id).length}명</div>
                </div>
                <div class="action-buttons row">
                    <button class="${(c.note || '').trim() ? 'has-note' : ''}" onclick="event.stopPropagation(); editClassNote(${c.id})" data-tooltip="메모"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></button>
                    <button onclick="event.stopPropagation(); editClassName(${c.id})" data-tooltip="수정"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                    <button onclick="event.stopPropagation(); deleteClass(${c.id});" data-tooltip="삭제"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>
            </div>
        `).join('');
    }

    function renderLeagueDashboard(selectedClass) {
        $('#content-wrapper').innerHTML = `
            <h2>${selectedClass.name} - 참가자 관리</h2>
            <section class="section-box">
                <div class="row" style="align-items: flex-end;">
                    <div class="field" style="flex-grow:1; margin-bottom: 0;">
                         <label>신규 선수 추가</label>
                        <input id="studentName" type="text" placeholder="학생 이름 입력 후 엔터">
                    </div>
                    <button class="btn primary" onclick="addStudent()" data-tooltip="입력한 학생을 목록에 추가합니다."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>추가</button>
                    <button class="btn" onclick="bulkAddStudents()" data-tooltip="쉼표로 구분된 여러 학생을 한번에 추가합니다."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>일괄 추가</button>
                </div>
                <div id="studentListGrid" class="student-list-grid" style="margin-top: 1rem;"></div>
            </section>
            
            <div class="schedule-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div class="row">
                     <h2 class="schedule-title">경기 일정</h2>
                     <div id="gameStatsContainer"></div>
                  </div>
                  <div class="row">
                    <button class="btn" onclick="shareView('league', 'schedule')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                        일정 공유
                    </button>
                    <button class="btn" onclick="clearAllHighlights()" data-tooltip="모든 강조 표시를 해제합니다."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 5-8 8"/><path d="m12 19 8-8"/><path d="M20 13a2.5 2.5 0 0 0-3.54-3.54l-8.37 8.37A2.5 2.5 0 0 0 9.46 20l8.37-8.37a2.5 2.5 0 0 0 2.17-6.38Z"/></svg>모든 강조 해제</button>
                    <button id="generateGamesBtn" class="btn" onclick="generateGames()" style="background:var(--win); color:white;" data-tooltip="현재 학생 명단으로 새 경기 일정을 생성합니다."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>일정 생성</button>
                  </div>
                </div>
            </div>
            <div id="gamesTableContainer" style="margin: 0 -24px; padding: 0 24px;">
                <div class="paps-table-wrap">
                    <div id="gamesTableContent"></div>
                </div>
            </div>
            
             <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>순위표</h2>
                <div class="row">
                    <button class="btn" onclick="shareView('league', 'standings')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                        공유
                    </button>
                    <button class="btn" onclick="printRankings()" data-tooltip="현재 순위표를 인쇄합니다.">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                        순위표 인쇄
                    </button>
                </div>
            </div>
            <div id="rankingsTableContainer" class="section-box" style="padding:0; overflow-x:auto;"></div>
        `;
        $('#studentName').addEventListener('keypress', e => e.key === 'Enter' && addStudent());
        renderStudentList();
        renderGamesTable();
        renderRankingsTable();
        renderGameStats();
        
        // 일정 생성 버튼 상태 초기화
        const classGames = leagueData.games.filter(g => g.classId === leagueData.selectedClassId);
        updateGenerateGamesButtonState(classGames.length > 0);
    }

    function renderGameStats() {
        const container = $('#gameStatsContainer');
        if (!container) return;
        const classId = leagueData.selectedClassId;
        const allGames = leagueData.games.filter(g => g.classId === classId);
        const total = allGames.length;
        const completed = allGames.filter(g => g.isCompleted).length;
        const pending = total - completed;

        if (total === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = `
            <div class="game-stats">
                <div class="stat-item">총경기수: <span class="stat-value stat-total">${total}</span></div>
                <div class="stat-item">완료: <span class="stat-value stat-completed">${completed}</span></div>
                <div class="stat-item">잔여: <span class="stat-value stat-pending">${pending}</span></div>
            </div>
        `;
    }
    
    function createClass() {
        const input = $('#className');
        const name = input.value.trim();
        if (name && !leagueData.classes.some(c => c.name === name)) {
            const newClass = { id: Date.now(), name, note: '' };
            leagueData.classes.push(newClass);
            input.value = '';
            selectClass(newClass.id);
            saveDataToFirestore();
        }
    }

    function selectClass(id) {
        leagueData.selectedClassId = id;
        $('#liveRankingBtn').classList.remove('hidden');
        renderApp();
        saveDataToFirestore();
    }

    function deleteClass(id) {
        showModal({
            title: '반 삭제', body: '반을 삭제하면 모든 학생과 경기 기록이 사라집니다. 정말 삭제하시겠습니까?',
            actions: [
                { text: '취소', callback: closeModal },
                { text: '삭제', type: 'danger', callback: () => {
                    leagueData.classes = leagueData.classes.filter(c => c.id !== id);
                    leagueData.students = leagueData.students.filter(s => s.classId !== id);
                    leagueData.games = leagueData.games.filter(g => g.classId !== id);
                    if (leagueData.selectedClassId === id) {
                        leagueData.selectedClassId = null;
                        $('#liveRankingBtn').classList.add('hidden');
                    }
                    saveDataToFirestore();
                    renderApp();
                    updateGenerateGamesButtonState(false);
                    closeModal();
                }}
            ]
        });
    }

    function addStudent() {
        const input = $('#studentName');
        if (!input) return;
        const name = input.value.trim();
        const classId = leagueData.selectedClassId;
        if (name && classId && !leagueData.students.some(s => s.name === name && s.classId === classId)) {
            leagueData.students.push({ id: Date.now(), name, classId, note: '' });
            input.value = '';
            saveDataToFirestore();
            renderStudentList();
        }
    }

    function bulkAddStudents() {
        showModal({
            title: '일괄 추가',
            body: `<p>참가자 이름을 쉼표(,)로 구분하여 입력하세요.</p><textarea id="modal-textarea" style="width:100%; height: 100px; margin-top: 8px;" class="field"></textarea>`,
            actions: [
                { text: '취소', callback: closeModal },
                { text: '추가', type: 'primary', callback: () => {
                    const namesStr = $('#modal-textarea').value;
                    const classId = leagueData.selectedClassId;
                    if (namesStr && classId) {
                        namesStr.split(',').map(n => n.trim()).filter(Boolean).forEach(name => {
                            if (!leagueData.students.some(s => s.name === name && s.classId === classId)) {
                                leagueData.students.push({ id: Date.now() + Math.random(), name, classId, note: '' });
                            }
                        });
                        saveDataToFirestore();
                        renderStudentList();
                    }
                    closeModal();
                }}
            ]
        });
    }
    
    function renderStudentList() {
        const grid = $('#studentListGrid');
        if (!grid) return;
        renderClassList(); // 학생 수 변경 반영
        const classStudents = leagueData.students.filter(s => s.classId === leagueData.selectedClassId);
        grid.innerHTML = classStudents.map(st => `
            <div class="student-item">
                <span>${st.name}</span>
                <div class="action-buttons row">
                    <button class="${(st.note || '').trim() ? 'has-note' : ''}" onclick="editStudentNote(${st.id})" data-tooltip="메모"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></button>
                    <button onclick="editStudentName(${st.id})" data-tooltip="수정"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                    <button onclick="removeStudent(${st.id})" data-tooltip="삭제"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>
            </div>
        `).join('');
    }
    
    function removeStudent(id) {
        leagueData.students = leagueData.students.filter(s => s.id !== id);
        leagueData.games = leagueData.games.filter(g => g.player1Id !== id && g.player2Id !== id);
        saveDataToFirestore();
        renderLeagueDashboard(leagueData.classes.find(c => c.id === leagueData.selectedClassId));
    }

    function generateGames() {
        const classId = leagueData.selectedClassId;
        const players = leagueData.students.filter(s => s.classId === classId);
        if (players.length < 2) return alert("선수가 2명 이상 필요합니다.");

        showModal({
            title: '일정 생성', body: '기존 경기 기록이 모두 사라집니다. 계속하시겠습니까?',
            actions: [
                { text: '취소', callback: closeModal },
                { text: '생성', type: 'danger', callback: () => {
                    leagueData.games = leagueData.games.filter(g => g.classId !== classId);
                    
                    let schedulePlayers = [...players];
                    if (schedulePlayers.length % 2 !== 0) {
                        schedulePlayers.push({ id: 'bye', name: 'BYE' });
                    }

                    const numPlayers = schedulePlayers.length;
                    const numRounds = numPlayers - 1;
                    const gamesPerRound = numPlayers / 2;
                    const newGames = [];

                    for (let r = 0; r < numRounds; r++) {
                        for (let i = 0; i < gamesPerRound; i++) {
                            const player1 = schedulePlayers[i];
                            const player2 = schedulePlayers[numPlayers - 1 - i];

                            if (player1.id !== 'bye' && player2.id !== 'bye') {
                                const p1_index = players.findIndex(p => p.id === player1.id);
                                const p2_index = players.findIndex(p => p.id === player2.id);

                                newGames.push({
                                    id: Date.now() + Math.random(),
                                    classId,
                                    player1Id: (p1_index < p2_index) ? player1.id : player2.id,
                                    player2Id: (p1_index < p2_index) ? player2.id : player1.id,
                                    player1Score: null, player2Score: null, isCompleted: false,
                                    completionDate: '', note: '', isHighlighted: false
                                });
                            }
                        }
                        const lastPlayer = schedulePlayers.pop();
                        schedulePlayers.splice(1, 0, lastPlayer);
                    }
                    
                    leagueData.games.push(...newGames);

                    saveDataToFirestore();
                    renderGamesTable();
                    updateGenerateGamesButtonState(true);
                    renderGameStats();
                    closeModal();
                }}
            ]
        });
    }

    function updateLeagueScore(gameId, player, score) {
        const game = leagueData.games.find(g => g.id === gameId);
        if (!game) return;
        
        const wasCompleted = game.isCompleted;
        game[player === 'player1' ? 'player1Score' : 'player2Score'] = score === '' ? null : Number(score);
        game.isCompleted = game.player1Score !== null && game.player2Score !== null;

        if (game.isCompleted && !wasCompleted) {
            game.completionDate = getFormattedDate();
        } else if (!game.isCompleted && wasCompleted) {
            game.completionDate = '';
        }

        saveDataToFirestore();
        renderGamesTable();
        renderRankingsTable();
        renderGameStats();
        if (!$('#rankingPopup').classList.contains('hidden')) {
             openRankingPopup(); // Refresh popup
        }
    }
    
    function updateGameNote(gameId, note) {
        const game = leagueData.games.find(g => g.id === gameId);
        if (game) {
            game.note = note.trim();
            saveDataToFirestore();
        }
    }
    
    function toggleGameHighlight(gameId) {
        const game = leagueData.games.find(g => g.id === gameId);
        if (game) {
            game.isHighlighted = !game.isHighlighted;
            saveDataToFirestore();
            renderGamesTable();
        }
    }

    function clearAllHighlights() {
        const classId = leagueData.selectedClassId;
        if (!classId) return;
        leagueData.games.forEach(g => {
            if (g.classId === classId) {
                g.isHighlighted = false;
            }
        });
        saveDataToFirestore();
        renderGamesTable();
    }

    function updateGenerateGamesButtonState(hasGames) {
        const button = $('#generateGamesBtn');
        if (!button) return;
        
        if (hasGames) {
            // 경기 일정이 있으면 버튼 비활성화
            button.disabled = true;
            button.style.background = 'var(--ink-muted)';
            button.style.cursor = 'not-allowed';
            button.setAttribute('data-tooltip', '이미 경기 일정이 생성되었습니다.');
        } else {
            // 경기 일정이 없으면 버튼 활성화
            button.disabled = false;
            button.style.background = 'var(--win)';
            button.style.cursor = 'pointer';
            button.setAttribute('data-tooltip', '현재 학생 명단으로 새 경기 일정을 생성합니다.');
        }
    }

    function renderGamesTable(isReadOnly = false) {
        const container = $('#gamesTableContent');
        if (!container) return;
        const classGames = leagueData.games.filter(g => g.classId === leagueData.selectedClassId);
        
        // 일정 생성 버튼 상태 업데이트
        updateGenerateGamesButtonState(classGames.length > 0);
        
        if (classGames.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding: 2rem; color: var(--ink-muted);">생성된 경기가 없습니다.</div>`;
            return;
        }

        let html = `<table class="styled-table" style="min-width: 1000px;">
            <thead>
                <tr>
                    <th style="width: 60px; text-align: center;">#</th>
                    <th style="width: 120px;">선수 1</th>
                    <th style="width: 90px; text-align: center;">점수</th>
                    <th style="width: 60px; text-align: center;">vs</th>
                    <th style="width: 90px; text-align: center;">점수</th>
                    <th style="width: 120px;">선수 2</th>
                    <th style="width: 100px; text-align: center;">상태</th>
                    <th style="width: 150px; text-align: center;">입력 일시</th>
                    <th style="min-width: 200px;">메모</th>
                </tr>
            </thead>
            <tbody>`;
        
        html += classGames.map((game, i) => {
            const p1 = leagueData.students.find(s => s.id === game.player1Id);
            const p2 = leagueData.students.find(s => s.id === game.player2Id);
            if (!p1 || !p2) return '';
            
            const score1 = game.player1Score ?? '';
            const score2 = game.player2Score ?? '';
            const note = game.note || '';

            return `<tr class="${game.isHighlighted ? 'highlighted-row' : ''}" data-game-id="${game.id}">
                <td style="text-align: center;" ${!isReadOnly ? `onclick="toggleGameHighlight(${game.id})"` : ''} data-tooltip="경기 번호 강조" data-tooltip-align="left">
                    <span class="game-number ${game.isHighlighted ? 'highlighted-number' : ''}">${i+1}</span>
                </td>
                <td style="font-weight: 500;">${p1.name}</td>
                <td style="text-align: center;">
                    ${isReadOnly ? 
                        `<span style="font-weight: 500; color: var(--ink);">${score1}</span>` : 
                        `<input type="number" class="score" value="${score1}" onchange="updateLeagueScore(${game.id}, 'player1', this.value)">`
                    }
                </td>
                <td style="text-align: center; font-weight: bold; color: var(--ink-muted); font-size: 0.9rem;">vs</td>
                <td style="text-align: center;">
                    ${isReadOnly ? 
                        `<span style="font-weight: 500; color: var(--ink);">${score2}</span>` : 
                        `<input type="number" class="score" value="${score2}" onchange="updateLeagueScore(${game.id}, 'player2', this.value)">`
                    }
                </td>
                <td style="font-weight: 500;">${p2.name}</td>
                <td style="text-align: center;">
                    <span class="status-badge ${game.isCompleted ? 'completed' : 'pending'}" style="font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; font-weight: 600;">
                        ${game.isCompleted ? '완료' : '대기'}
                    </span>
                </td>
                <td style="text-align: center; font-size: 0.8rem; color: var(--ink-muted);">${game.completionDate || ''}</td>
                <td>
                    ${isReadOnly ? 
                        `<span style="font-size: 0.8rem; color: var(--ink-muted);" title="${note}">${note}</span>` : 
                        `<input type="text" class="field" placeholder="메모..." value="${note}" onchange="updateGameNote(${game.id}, this.value)" style="width: 100%; padding: 6px 8px; font-size: 0.8rem; border: 1px solid var(--line); border-radius: 4px; background: var(--card-bg); transition: all 0.2s ease;">`
                    }
                </td>
            </tr>`;
        }).join('');
        
        html += `</tbody></table>`;
        container.innerHTML = html;
    }
    
    function renderRankingsTable(targetEl = $('#rankingsTableContainer')) {
        if(!targetEl) return;
        
        const classId = leagueData.selectedClassId;
        if (!classId) {
            targetEl.innerHTML = `<div style="text-align:center; padding: 2rem;">반을 선택해주세요.</div>`;
            return;
        }

        const ranks = getRankingsData(classId);

        let currentRank = 0;
        let lastPoints = -1;
        let lastWins = -1;
        ranks.forEach((r, i) => {
            if (r.points !== lastPoints || r.wins !== lastWins) {
                currentRank = i + 1;
                lastPoints = r.points;
                lastWins = r.wins;
            }
            r.rank = currentRank;
        });

        let tableContent = `<thead><tr><th>순위</th><th>이름</th><th>경기</th><th>승</th><th>무</th><th>패</th><th>승점</th></tr></thead><tbody>`;
        
        ranks.forEach(r => {
            tableContent += `<tr><td>${r.rank}</td><td>${r.name}</td><td>${r.gamesPlayed}</td><td class="rank-wins">${r.wins}</td><td>${r.draws}</td><td class="rank-losses">${r.losses}</td><td class="rank-points">${r.points}</td></tr>`;
        });
        tableContent += `</tbody>`;

        if (ranks.length === 0) {
             targetEl.innerHTML = `<div style="text-align:center; padding: 2rem;">참가자가 없습니다.</div>`;
        } else {
            if (targetEl.tagName.toLowerCase() === 'table') {
                 targetEl.innerHTML = tableContent;
            } else {
                 targetEl.innerHTML = `<table class="styled-table">${tableContent}</table>`;
            }
        }
    }

    function getRankingsData(classId) {
        if (!classId) return [];
        const players = leagueData.students.filter(s => s.classId === classId);
        const games = leagueData.games.filter(g => g.classId === classId && g.isCompleted);
        
        return players.map(p => {
            const stats = { wins: 0, losses: 0, draws: 0, points: 0, gamesPlayed: 0 };
            games.forEach(g => {
                let p1Score, p2Score;
                if (g.player1Id === p.id) { stats.gamesPlayed++; p1Score = g.player1Score; p2Score = g.player2Score; } 
                else if (g.player2Id === p.id) { stats.gamesPlayed++; p1Score = g.player2Score; p2Score = g.player1Score; } 
                else return;
                if (p1Score > p2Score) { stats.wins++; stats.points += 3; } 
                else if (p1Score < p2Score) { stats.losses++; } 
                else { stats.draws++; stats.points += 1; }
            });
            return { name: p.name, ...stats };
        }).sort((a,b) => b.points - a.points || b.wins - a.wins);
    }

    function exportAllLeaguesToExcel() {
        if (leagueData.classes.length === 0) return alert('내보낼 반이 없습니다.');
        const wb = XLSX.utils.book_new();

        leagueData.classes.forEach(cls => {
            const ranks = getRankingsData(cls.id);
            const rankingsData = ranks.map((r, i) => [i + 1, r.name, r.gamesPlayed, r.wins, r.draws, r.losses, r.points]);
            rankingsData.unshift(['순위', '이름', '경기', '승', '무', '패', '승점']);
            const wsRankings = XLSX.utils.aoa_to_sheet(rankingsData);
            const safeSheetNameRank = (cls.name.replace(/[\\/*?:"<>|]/g, "").substring(0, 25) + " 순위").trim();
            XLSX.utils.book_append_sheet(wb, wsRankings, safeSheetNameRank);

            const classGames = leagueData.games.filter(g => g.classId === cls.id);
            const gamesData = classGames.map((game, i) => {
                const p1 = leagueData.students.find(s => s.id === game.player1Id);
                const p2 = leagueData.students.find(s => s.id === game.player2Id);
                return [i + 1, p1?.name, game.player1Score, game.player2Score, p2?.name, game.isCompleted ? '완료' : '대기', game.completionDate, game.note];
            });
            gamesData.unshift(['#', '선수 1', '점수1', '점수2', '선수 2', '상태', '입력 일시', '메모']);
            const wsGames = XLSX.utils.aoa_to_sheet(gamesData);
            const safeSheetNameGames = (cls.name.replace(/[\\/*?:"<>|]/g, "").substring(0, 25) + " 일정").trim();
            XLSX.utils.book_append_sheet(wb, wsGames, safeSheetNameGames);
        });

        XLSX.writeFile(wb, `전체_반_리그전_결과_${getFormattedDate()}.xlsx`);
    }

    function editClassName(id) {
        const cls = leagueData.classes.find(c => c.id === id);
        if (!cls) return;
        showModal({
            title: '반 이름 수정',
            body: `<input id="modal-input" class="field" style="width:100%" value="${cls.name}">`,
            actions: [
                { text: '취소', callback: closeModal },
                { text: '저장', type: 'primary', callback: () => {
                    const newName = $('#modal-input').value.trim();
                    if (newName) {
                        cls.name = newName;
                        saveDataToFirestore();
                        renderLeagueUI();
                    }
                    closeModal();
                }}
            ]
        });
    }

    function editClassNote(id) {
        const cls = leagueData.classes.find(c => c.id === id);
        if (!cls) return;
        showModal({
            title: `${cls.name} - 메모`,
            body: `<textarea id="modal-textarea" style="width:100%; height: 100px;" class="field">${cls.note || ''}</textarea>`,
            actions: [
                { text: '취소', callback: closeModal },
                { text: '저장', type: 'primary', callback: () => {
                    cls.note = $('#modal-textarea').value.trim();
                    saveDataToFirestore();
                    renderClassList();
                    closeModal();
                }}
            ]
        });
    }

    function editStudentName(id) {
        const student = leagueData.students.find(s => s.id === id);
        if (!student) return;
        showModal({
            title: '학생 이름 수정',
            body: `<input id="modal-input" class="field" style="width:100%" value="${student.name}">`,
            actions: [
                { text: '취소', callback: closeModal },
                { text: '저장', type: 'primary', callback: () => {
                    const newName = $('#modal-input').value.trim();
                    if (newName) {
                        student.name = newName;
                        saveDataToFirestore();
                        renderLeagueDashboard(leagueData.classes.find(c => c.id === leagueData.selectedClassId));
                    }
                    closeModal();
                }}
            ]
        });
    }

    function editStudentNote(id) {
        const student = leagueData.students.find(s => s.id === id);
        if (!student) return;
        showModal({
            title: `${student.name} - 메모`,
            body: `<textarea id="modal-textarea" style="width:100%; height: 100px;" class="field">${student.note || ''}</textarea>`,
            actions: [
                { text: '취소', callback: closeModal },
                { text: '저장', type: 'primary', callback: () => {
                    student.note = $('#modal-textarea').value.trim();
                    saveDataToFirestore();
                    renderStudentList();
                    closeModal();
                }}
            ]
        });
    }

    // ========================================
    // 토너먼트 UI 및 로직
    // ========================================
    function renderTournamentUI() {
        // 기존 요소들 정리
        cleanupSidebar();
        
        $('#sidebarTitle').textContent = '토너먼트 목록';
        
        const isFirstTimeUser = leagueData.classes.length === 0 && tournamentData.tournaments.length === 0;

        let formHtml = `
            <div style="position: relative;" class="${isFirstTimeUser ? 'intro-container-active' : ''}">
                <div class="sidebar-form-group ${isFirstTimeUser ? 'intro-highlight' : ''}">
                    <input id="tournamentNameInput" type="text" placeholder="새로운 토너먼트 이름">
                    <button onclick="createTournament()" class="btn primary" data-tooltip="새로운 토너먼트를 목록에 추가합니다.">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <div class="intro-arrow">
                    <svg viewBox="0 0 24 24" fill="#F44336">
                       <path d="M2 12l8-8v5h12v6H10v5l-8-8z"/>
                    </svg>
                </div>
            </div>
        `;
        $('#sidebar-form-container').innerHTML = formHtml;
        
        renderTournamentList();
        const activeTournament = tournamentData.tournaments.find(t => t.id === tournamentData.activeTournamentId);
        if (activeTournament) {
            renderTournamentDashboard(activeTournament);
        } else {
            $('#content-wrapper').innerHTML = `
                <div class="placeholder-view">
                    <div class="placeholder-content">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <h3>토너먼트를 선택하여 시작하세요</h3>
                        <p>왼쪽에서 토너먼트를 선택하거나 새로 만들어주세요.</p>
                    </div>
                </div>`;
        }
    }
    
    function renderTournamentList() {
        const list = $('#sidebar-list-container');
        list.innerHTML = '';
        if (tournamentData.tournaments.length === 0) {
            list.innerHTML = `<p style="text-align:center; color: var(--ink-muted);">저장된 토너먼트가 없습니다.</p>`;
        }
        tournamentData.tournaments.forEach(t => {
            const card = document.createElement('div');
            card.className = `list-card ${t.id === tournamentData.activeTournamentId ? 'active' : ''}`;
            card.onclick = () => selectTournament(t.id);
            card.innerHTML =`
                <div>
                    <div class="name">${t.name}</div>
                    <div class="details">${t.sport || '종목 미지정'} · ${t.teams.length}팀</div>
                </div>
                 <div class="action-buttons row">
                    <button onclick="event.stopPropagation(); showTournamentSettings('${t.id}');" data-tooltip="설정 수정"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button onclick="event.stopPropagation(); deleteTournament('${t.id}');" data-tooltip="토너먼트를 삭제합니다."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>`;
            list.appendChild(card);
        });
    }

    function renderTournamentDashboard(tourney) {
        $('#content-wrapper').innerHTML = `
            <h2 style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                토너먼트 설정
            </h2>
            <section class="section-box">
                <div class="settings-grid">
                    <div class="field"><label for="tourneyName">토너먼트 이름*</label><input id="tourneyName" type="text" value="${tourney.name || ''}"></div>
                    <div class="field"><label for="tourneySport">경기 종목*</label><input id="tourneySport" type="text" value="${tourney.sport || ''}" placeholder="예) 족구, 피구"></div>
                    <div class="field"><label>토너먼트 형식*</label><div class="chip-group"><label><input type="radio" name="format" value="single" ${tourney.format === 'single' ? 'checked' : ''}> 싱글</label><label><input type="radio" name="format" value="double" disabled data-tooltip="준비 중인 기능입니다."> 더블(준비중)</label></div></div>
                    <div class="field"><label>시드 배정</label><div class="chip-group"><label><input type="radio" name="seeding" value="input" ${tourney.seeding !== 'random' ? 'checked' : ''}> 입력 순</label><label><input type="radio" name="seeding" value="random" ${tourney.seeding === 'random' ? 'checked' : ''}> 무작위</label></div></div>
                    <button onclick="updateTournamentSettings()" class="btn" style="background:var(--win); color:white;">설정 저장</button>
                </div>
            </section>

            <h2 style="margin-top: 1.5rem;">참가 팀 관리 (${tourney.teams.length}팀)</h2>
            <section class="section-box">
                 <div class="row" style="align-items: flex-end;">
                    <div class="field" style="flex-grow:1; margin-bottom: 0;">
                        <label for="teamNameInput">신규 팀 추가</label>
                        <div class="form-group">
                            <input id="teamNameInput" type="text" placeholder="팀(선수) 이름 입력 후 엔터" style="ime-mode: active;">
                            <button onclick="addTeamToTournament()" class="btn primary" data-tooltip="팀 추가">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="teamsList" class="student-list-grid" style="margin-top: 1rem;">
                    ${tourney.teams.map(team => `
                        <div class="student-item">
                            <span>${team}</span>
                            <div class="action-buttons">
                                <button onclick="removeTeamFromTournament('${team}')" data-tooltip="삭제">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </section>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                 <h2 style="margin-top: 1.5rem;">대진표</h2>
                 <div class="row">
                     <button class="btn" onclick="shareView('tournament', 'bracket')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                        대진표 공유
                    </button>
                    <button class="btn" onclick="printBracket()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                        인쇄
                    </button>
                 </div>
            </div>
            <div id="bracket-container" class="bracket-wrap">
                <div id="rounds" class="rounds"></div>
                <svg id="svgLayer" class="svg-layer"></svg>
            </div>
             <div style="font-size: 12px; color: var(--ink-muted); text-align: right; padding-top: 8px;">팀 추가/삭제 시 대진표는 자동 저장됩니다.</div>
        `;

        $('#teamNameInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTeamToTournament();
            }
        });

        renderBracket(tourney, false);
    }
    
    function createTournament() {
        const input = $('#tournamentNameInput');
        const name = input.value.trim();
        if(name) {
            const newTourney = { id: 't_'+Date.now(), name, teams: [], rounds: [], sport: '', format: 'single', seeding: 'input' };
            tournamentData.tournaments.unshift(newTourney);
            input.value = '';
            selectTournament(newTourney.id);
            saveDataToFirestore();
        }
    }
    
    function selectTournament(id) {
        tournamentData.activeTournamentId = id;
        const tourney = tournamentData.tournaments.find(t => t.id === id);
        if (tourney) {
            renderTournamentView(tourney);
        }
        saveDataToFirestore();
    }

    function deleteTournament(id) {
        showModal({
            title: '토너먼트 삭제', body: '이 토너먼트의 모든 데이터가 삭제됩니다. 계속하시겠습니까?',
            actions: [
                { text: '취소', callback: closeModal },
                { text: '삭제', type: 'danger', callback: () => {
                    tournamentData.tournaments = tournamentData.tournaments.filter(t => t.id !== id);
                    if (tournamentData.activeTournamentId === id) {
                        tournamentData.activeTournamentId = null;
                    }
                    saveDataToFirestore();
                    renderApp();
                    closeModal();
                }}
            ]
        });
    }
    
    function showTournamentSettings(tournamentId) {
        tournamentData.activeTournamentId = tournamentId;
        const tourney = tournamentData.tournaments.find(t => t.id === tournamentId);
        if (tourney) {
            renderTournamentDashboard(tourney);
        }
    }

    function renderTournamentView(tourney) {
        $('#content-wrapper').innerHTML = `
            <h2 style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                <span>${tourney.name}</span>
            </h2>

            <h2 style="margin-top: 1.5rem;">참가 팀 관리 (${tourney.teams.length}팀)</h2>
            <section class="section-box">
                 <div class="row" style="align-items: flex-end;">
                    <div class="field" style="flex-grow:1; margin-bottom: 0;">
                        <label for="teamNameInput">신규 팀 추가</label>
                        <div class="sidebar-form-group">
                            <input id="teamNameInput" type="text" placeholder="팀(선수) 이름 입력 후 엔터" style="ime-mode: active;">
                            <button onclick="addTeamToTournament()" class="btn primary" data-tooltip="팀을 추가합니다.">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="teamsList" class="student-list-grid" style="margin-top: 1rem;">
                    ${tourney.teams.map(team => `
                        <div class="student-item">
                            <span>${team}</span>
                            <div class="action-buttons">
                                <button onclick="removeTeamFromTournament('${team}')" data-tooltip="삭제">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </section>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                 <h2 style="margin-top: 1.5rem;">대진표</h2>
                 <div class="row">
                     <button class="btn" onclick="shareView('tournament', 'bracket')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                        대진표 공유
                    </button>
                    <button class="btn" onclick="printBracket()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                        인쇄
                    </button>
                </div>
            </div>
            <div id="bracket-container" class="bracket-wrap">
                <div id="rounds" class="rounds"></div>
                <svg id="svgLayer" class="svg-layer"></svg>
            </div>
             <div style="font-size: 12px; color: var(--ink-muted); text-align: right; padding-top: 8px;">팀 추가/삭제 시 대진표는 자동 저장됩니다.</div>
        `;
        
        // 팀 추가 이벤트 리스너
        $('#teamNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTeamToTournament();
            }
        });
        
        // 대진표 렌더링
        renderBracket(tourney);
    }

    function updateTournamentSettings() {
        const tourney = tournamentData.tournaments.find(t => t.id === tournamentData.activeTournamentId);
        if (!tourney) return;

        const oldSeeding = tourney.seeding;
        
        tourney.name = $('#tourneyName').value.trim() || '이름 없는 토너먼트';
        tourney.sport = $('#tourneySport').value.trim();
        tourney.format = $$('input[name="format"]:checked')[0]?.value || 'single';
        tourney.seeding = $$('input[name="seeding"]:checked')[0]?.value || 'input';
        
        if (tourney.seeding !== oldSeeding && tourney.teams.length > 0) {
            buildBracket(tourney);
            renderBracket(tourney);
        }
        
        saveDataToFirestore();
        renderTournamentList();
        
        // 설정 저장 후 토너먼트 설정 카드만 숨기고 나머지는 유지
        renderTournamentView(tourney);
        
        showModal({ title: '저장 완료', body: '토너먼트 설정이 저장되었습니다.', actions: [{ text: '확인', type: 'primary', callback: closeModal }] });
    }

    function addTeamToTournament() {
        const tourney = tournamentData.tournaments.find(t => t.id === tournamentData.activeTournamentId);
        if (!tourney) return;
        
        const input = $('#teamNameInput');
        const teamName = input.value.trim();
        
        console.log('입력된 팀 이름:', teamName);
        console.log('현재 팀 목록:', tourney.teams);
        
        // 더 안전한 중복 체크 (대소문자 무시, 공백 제거)
        const isDuplicate = tourney.teams.some(team => 
            team.trim().toLowerCase() === teamName.toLowerCase()
        );
        
        console.log('중복 체크 결과:', isDuplicate);
        
        if (teamName && !isDuplicate) {
            tourney.teams.push(teamName);
            console.log('팀 추가 후 배열:', tourney.teams);
            
            buildBracket(tourney);
            saveDataToFirestore();
            renderTournamentView(tourney);
            renderTournamentList(); // Update team count in sidebar

            input.value = ''; // 입력 필드 초기화
            $('#teamNameInput').focus();

        } else if (teamName) {
            alert("이미 존재하는 팀 이름입니다.");
            input.select();
            input.focus();
        } else {
             input.focus();
        }
    }

    function removeTeamFromTournament(teamNameToRemove) {
        const tourney = tournamentData.tournaments.find(t => t.id === tournamentData.activeTournamentId);
        if (!tourney) return;
        
        tourney.teams = tourney.teams.filter(team => team !== teamNameToRemove);
        
        buildBracket(tourney);
        saveDataToFirestore();
        renderTournamentView(tourney);
        renderTournamentList();
    }

    function buildBracket(tourney) {
        if (!tourney) return;

        const teams = tourney.teams;
        let roundsData = [];

        if (teams.length > 0) {
            let matchIdSeq = 1;
            const makeMatch = (roundIdx, slotIdx, teamA, teamB) => ({
                id: 'm_' + tourney.id + '_' + (Date.now() + matchIdSeq++), roundIdx, slotIdx,
                teamA: teamA || null, teamB: teamB || null,
                scoreA: null, scoreB: null, winner: null, parentId: null,
                isBye: false, // 부전승 매치 표시를 위한 플래그
                matchNumber: null // 매치 번호 추가
            });

            const numTeams = teams.length;
            let seededTeams = tourney.seeding === 'random' ? [...teams].sort(() => 0.5 - Math.random()) : [...teams];
            
            // 팀 수에 따른 특별한 대진표 생성
            if (numTeams === 3) {
                // 3팀: 1팀 부전승, 2팀 경기 → 결승
                roundsData.push([
                    makeMatch(0, 0, seededTeams[1], seededTeams[2])
                ]);
                roundsData[0][0].matchNumber = 1;
                
                roundsData.push([
                    makeMatch(1, 0, null, null) // A팀 vs ROUND1 승자
                ]);
                // 연결선을 위한 parentId 설정
                roundsData[0][0].parentId = roundsData[1][0].id;
                
            } else if (numTeams === 4) {
                // 4팀: 2경기 → 결승
                roundsData.push([
                    makeMatch(0, 0, seededTeams[0], seededTeams[3]),
                    makeMatch(0, 1, seededTeams[1], seededTeams[2])
                ]);
                roundsData[0][0].matchNumber = 1;
                roundsData[0][1].matchNumber = 2;
                
                roundsData.push([
                    makeMatch(1, 0, null, null)
                ]);
                // 연결선을 위한 parentId 설정
                roundsData[0][0].parentId = roundsData[1][0].id;
                roundsData[0][1].parentId = roundsData[1][0].id;
                
            } else if (numTeams === 5) {
                // 5팀: 1경기 → 2라운드(3팀 부전승) → 결승
                roundsData.push([
                    makeMatch(0, 0, seededTeams[3], seededTeams[4])
                ]);
                roundsData[0][0].matchNumber = 1;
                
                roundsData.push([
                    makeMatch(1, 0, null, null), // #1 vs ROUND1 승자
                    makeMatch(1, 1, seededTeams[1], seededTeams[2]) // #2 vs #3
                ]);
                roundsData[1][1].matchNumber = 2;
                
                roundsData.push([
                    makeMatch(2, 0, null, null)
                ]);
                // 연결선을 위한 parentId 설정
                roundsData[0][0].parentId = roundsData[1][0].id;
                roundsData[1][0].parentId = roundsData[2][0].id;
                roundsData[1][1].parentId = roundsData[2][0].id;
                
            } else if (numTeams === 6) {
                // 6팀: 2경기 → 2라운드(2팀 부전승) → 결승
                roundsData.push([
                    makeMatch(0, 0, seededTeams[3], seededTeams[4]),
                    makeMatch(0, 1, seededTeams[2], seededTeams[5])
                ]);
                roundsData[0][0].matchNumber = 1;
                roundsData[0][1].matchNumber = 2;
                
                roundsData.push([
                    makeMatch(1, 0, null, null), // #1 vs ROUND1-1승자
                    makeMatch(1, 1, null, null)  // #2 vs ROUND1-2승자
                ]);
                
                roundsData.push([
                    makeMatch(2, 0, null, null)
                ]);
                // 연결선을 위한 parentId 설정
                roundsData[0][0].parentId = roundsData[1][0].id;
                roundsData[0][1].parentId = roundsData[1][1].id;
                roundsData[1][0].parentId = roundsData[2][0].id;
                roundsData[1][1].parentId = roundsData[2][0].id;
                
            } else if (numTeams === 7) {
                // 7팀: 3경기 → 2라운드(1팀 부전승) → 결승
                roundsData.push([
                    makeMatch(0, 0, seededTeams[3], seededTeams[4]),
                    makeMatch(0, 1, seededTeams[1], seededTeams[6]),
                    makeMatch(0, 2, seededTeams[2], seededTeams[5])
                ]);
                roundsData[0][0].matchNumber = 1;
                roundsData[0][1].matchNumber = 2;
                roundsData[0][2].matchNumber = 3;
                
                roundsData.push([
                    makeMatch(1, 0, null, null), // #1 vs ROUND1-1승자
                    makeMatch(1, 1, null, null)  // ROUND1-2승자 vs ROUND1-3승자
                ]);
                
                roundsData.push([
                    makeMatch(2, 0, null, null)
                ]);
                // 연결선을 위한 parentId 설정
                roundsData[0][0].parentId = roundsData[1][0].id;
                roundsData[0][1].parentId = roundsData[1][1].id;
                roundsData[0][2].parentId = roundsData[1][1].id;
                roundsData[1][0].parentId = roundsData[2][0].id;
                roundsData[1][1].parentId = roundsData[2][0].id;
                
            } else if (numTeams === 8) {
                // 8팀: 4경기 → 2라운드 → 결승
                roundsData.push([
                    makeMatch(0, 0, seededTeams[0], seededTeams[7]),
                    makeMatch(0, 1, seededTeams[3], seededTeams[4]),
                    makeMatch(0, 2, seededTeams[1], seededTeams[6]),
                    makeMatch(0, 3, seededTeams[2], seededTeams[5])
                ]);
                roundsData[0][0].matchNumber = 1;
                roundsData[0][1].matchNumber = 2;
                roundsData[0][2].matchNumber = 3;
                roundsData[0][3].matchNumber = 4;
                
                roundsData.push([
                    makeMatch(1, 0, null, null),
                    makeMatch(1, 1, null, null)
                ]);
                
                roundsData.push([
                    makeMatch(2, 0, null, null)
                ]);
                // 연결선을 위한 parentId 설정
                roundsData[0][0].parentId = roundsData[1][0].id;
                roundsData[0][1].parentId = roundsData[1][0].id;
                roundsData[0][2].parentId = roundsData[1][1].id;
                roundsData[0][3].parentId = roundsData[1][1].id;
                roundsData[1][0].parentId = roundsData[2][0].id;
                roundsData[1][1].parentId = roundsData[2][0].id;
                
            } else if (numTeams === 16) {
                // 16팀: 표준 토너먼트 (모든 팀이 1라운드부터 시작)
                const firstRoundMatches = [];
                for (let i = 0; i < seededTeams.length; i += 2) {
                    const teamA = seededTeams[i];
                    const teamB = seededTeams[i + 1];
                    const match = makeMatch(0, i / 2, teamA, teamB);
                    match.matchNumber = Math.floor(i / 2) + 1;
                    firstRoundMatches.push(match);
                }
                roundsData.push(firstRoundMatches);
                
                // 나머지 라운드들 생성
                let currentRoundMatches = firstRoundMatches;
                let roundIdx = 1;
                while (currentRoundMatches.length > 1) {
                    const nextRoundMatches = [];
                    for (let i = 0; i < currentRoundMatches.length; i += 2) {
                        const parent = makeMatch(roundIdx, i / 2, null, null);
                        if(currentRoundMatches[i]) currentRoundMatches[i].parentId = parent.id;
                        if(currentRoundMatches[i+1]) currentRoundMatches[i+1].parentId = parent.id;
                        nextRoundMatches.push(parent);
                    }
                    roundsData.push(nextRoundMatches);
                    currentRoundMatches = nextRoundMatches;
                    roundIdx++;
                }
            } else {
                // 17팀 이상: 특별한 부전승 로직
                const totalSlots = 1 << (Math.ceil(Math.log2(numTeams)));
                const byeCount = totalSlots - numTeams;
                
                // 부전승 팀들 (상위 시드)과 1라운드 팀들 (하위 시드) 분리
                const byeTeams = seededTeams.slice(0, byeCount); // 부전승 팀들
                const firstRoundTeams = seededTeams.slice(byeCount); // 1라운드 팀들
                
                // 1라운드: 하위 시드 팀들끼리 경기
                const firstRoundMatches = [];
                for (let i = 0; i < firstRoundTeams.length; i += 2) {
                    const teamA = firstRoundTeams[i];
                    const teamB = firstRoundTeams[i + 1];
                    const match = makeMatch(0, i / 2, teamA, teamB);
                    match.matchNumber = Math.floor(i / 2) + 1;
                    firstRoundMatches.push(match);
                }
                roundsData.push(firstRoundMatches);
                
                // 2라운드: 부전승 팀들과 1라운드 승자들
                const secondRoundMatches = [];
                let matchIdx = 0;
                
                if (numTeams === 10) {
                    // 10팀 특별 배치: 1반 vs (8반vs9반 승자), 4반 vs 5반, 2반 vs (7반vs10반 승자), 3반 vs 6반
                    const match1 = makeMatch(1, matchIdx, byeTeams[0], null); // 1반 vs (8반vs9반 승자)
                    secondRoundMatches.push(match1);
                    matchIdx++;
                    
                    const match2 = makeMatch(1, matchIdx, byeTeams[3], byeTeams[4]); // 4반 vs 5반
                    secondRoundMatches.push(match2);
                    matchIdx++;
                    
                    const match3 = makeMatch(1, matchIdx, byeTeams[1], null); // 2반 vs (7반vs10반 승자)
                    secondRoundMatches.push(match3);
                    matchIdx++;
                    
                    const match4 = makeMatch(1, matchIdx, byeTeams[2], byeTeams[5]); // 3반 vs 6반
                    secondRoundMatches.push(match4);
                    matchIdx++;
                } else if (numTeams === 11) {
                    // 11팀 특별 배치: 1반 vs (8반vs9반 승자), 4반 vs 5반, 2반 vs (7반vs10반 승자), 3반 vs (6반vs11반 승자)
                    const match1 = makeMatch(1, matchIdx, byeTeams[0], null); // 1반 vs (8반vs9반 승자)
                    secondRoundMatches.push(match1);
                    matchIdx++;
                    
                    const match2 = makeMatch(1, matchIdx, byeTeams[3], byeTeams[4]); // 4반 vs 5반
                    secondRoundMatches.push(match2);
                    matchIdx++;
                    
                    const match3 = makeMatch(1, matchIdx, byeTeams[1], null); // 2반 vs (7반vs10반 승자)
                    secondRoundMatches.push(match3);
                    matchIdx++;
                    
                    const match4 = makeMatch(1, matchIdx, byeTeams[2], null); // 3반 vs (6반vs11반 승자)
                    secondRoundMatches.push(match4);
                    matchIdx++;
                } else if (numTeams === 12) {
                    // 12팀 특별 배치: 1반 vs (5반vs6반 승자), 4반 vs (11반vs12반 승자), 2반 vs (7반vs8반 승자), 3반 vs (9반vs10반 승자)
                    const match1 = makeMatch(1, matchIdx, byeTeams[0], null); // 1반 vs (5반vs6반 승자)
                    secondRoundMatches.push(match1);
                    matchIdx++;
                    
                    const match2 = makeMatch(1, matchIdx, byeTeams[3], null); // 4반 vs (11반vs12반 승자)
                    secondRoundMatches.push(match2);
                    matchIdx++;
                    
                    const match3 = makeMatch(1, matchIdx, byeTeams[1], null); // 2반 vs (7반vs8반 승자)
                    secondRoundMatches.push(match3);
                    matchIdx++;
                    
                    const match4 = makeMatch(1, matchIdx, byeTeams[2], null); // 3반 vs (9반vs10반 승자)
                    secondRoundMatches.push(match4);
                    matchIdx++;
                } else if (numTeams === 13) {
                    // 13팀 특별 배치: 1반 vs (8반vs9반 승자), (4반vs13반 승자) vs (5반vs12반 승자), 2반 vs (7반vs10반 승자), 3반 vs (6반vs11반 승자)
                    const match1 = makeMatch(1, matchIdx, byeTeams[0], null); // 1반 vs (8반vs9반 승자)
                    secondRoundMatches.push(match1);
                    matchIdx++;
                    
                    const match2 = makeMatch(1, matchIdx, null, null); // (4반vs13반 승자) vs (5반vs12반 승자)
                    secondRoundMatches.push(match2);
                    matchIdx++;
                    
                    const match3 = makeMatch(1, matchIdx, byeTeams[1], null); // 2반 vs (7반vs10반 승자)
                    secondRoundMatches.push(match3);
                    matchIdx++;
                    
                    const match4 = makeMatch(1, matchIdx, byeTeams[2], null); // 3반 vs (6반vs11반 승자)
                    secondRoundMatches.push(match4);
                    matchIdx++;
                } else if (numTeams === 14) {
                    // 14팀 특별 배치: 1반 vs (8반vs9반 승자), (4반vs13반 승자) vs (5반vs12반 승자), 2반 vs (7반vs10반 승자), (3반vs14반 승자) vs (6반vs11반 승자)
                    const match1 = makeMatch(1, matchIdx, byeTeams[0], null); // 1반 vs (8반vs9반 승자)
                    secondRoundMatches.push(match1);
                    matchIdx++;
                    
                    const match2 = makeMatch(1, matchIdx, null, null); // (4반vs13반 승자) vs (5반vs12반 승자)
                    secondRoundMatches.push(match2);
                    matchIdx++;
                    
                    const match3 = makeMatch(1, matchIdx, byeTeams[1], null); // 2반 vs (7반vs10반 승자)
                    secondRoundMatches.push(match3);
                    matchIdx++;
                    
                    const match4 = makeMatch(1, matchIdx, null, null); // (3반vs14반 승자) vs (6반vs11반 승자)
                    secondRoundMatches.push(match4);
                    matchIdx++;
                } else if (numTeams === 9) {
                    // 9팀 특별 배치: 1반 vs (8반vs9반 승자), 2반 vs 3반, 4반 vs 5반, 6반 vs 7반
                    const match1 = makeMatch(1, matchIdx, byeTeams[0], null); // 1반 vs (8반vs9반 승자)
                    secondRoundMatches.push(match1);
                    matchIdx++;
                    
                    const match2 = makeMatch(1, matchIdx, byeTeams[1], byeTeams[2]); // 2반 vs 3반
                    secondRoundMatches.push(match2);
                    matchIdx++;
                    
                    const match3 = makeMatch(1, matchIdx, byeTeams[3], byeTeams[4]); // 4반 vs 5반
                    secondRoundMatches.push(match3);
                    matchIdx++;
                    
                    const match4 = makeMatch(1, matchIdx, byeTeams[5], byeTeams[6]); // 6반 vs 7반
                    secondRoundMatches.push(match4);
                    matchIdx++;
                } else if (numTeams === 15) {
                    // 15팀 특별 배치: 1반 vs (8반vs9반 승자), (4반vs13반 승자) vs (5반vs12반 승자), (2반vs15반 승자) vs (7반vs10반 승자), (3반vs14반 승자) vs (6반vs11반 승자)
                    const match1 = makeMatch(1, matchIdx, byeTeams[0], null); // 1반 vs (8반vs9반 승자)
                    secondRoundMatches.push(match1);
                    matchIdx++;
                    
                    const match2 = makeMatch(1, matchIdx, null, null); // (4반vs13반 승자) vs (5반vs12반 승자)
                    secondRoundMatches.push(match2);
                    matchIdx++;
                    
                    const match3 = makeMatch(1, matchIdx, null, null); // (2반vs15반 승자) vs (7반vs10반 승자)
                    secondRoundMatches.push(match3);
                    matchIdx++;
                    
                    const match4 = makeMatch(1, matchIdx, null, null); // (3반vs14반 승자) vs (6반vs11반 승자)
                    secondRoundMatches.push(match4);
                    matchIdx++;
                } else {
                    // 9팀 또는 16팀 이상: 기존 로직
                    // 1라운드 승자와 첫 번째 부전승 팀 매치
                    const firstMatch = makeMatch(1, matchIdx, byeTeams[0], null);
                    secondRoundMatches.push(firstMatch);
                    matchIdx++;
                    
                    // 나머지 부전승 팀들을 2개씩 묶어서 배치
                    for (let i = 1; i < byeTeams.length; i += 2) {
                        const teamA = byeTeams[i];
                        const teamB = byeTeams[i + 1] || null; // 홀수개면 null
                        const match = makeMatch(1, matchIdx, teamA, teamB);
                        secondRoundMatches.push(match);
                        matchIdx++;
                    }
                }
                
                roundsData.push(secondRoundMatches);
                
                // 연결선 설정
                if (numTeams === 10) {
                    // 10팀: 7반vs10반 승자 -> 2라운드 3번째 매치, 8반vs9반 승자 -> 2라운드 1번째 매치
                    firstRoundMatches[0].parentId = secondRoundMatches[2].id; // 7반vs10반 -> 2반 vs (7반vs10반 승자)
                    firstRoundMatches[1].parentId = secondRoundMatches[0].id; // 8반vs9반 -> 1반 vs (8반vs9반 승자)
                } else if (numTeams === 11) {
                    // 11팀: 8반vs9반 승자 -> 2라운드 1번째 매치, 7반vs10반 승자 -> 2라운드 3번째 매치, 6반vs11반 승자 -> 2라운드 4번째 매치
                    firstRoundMatches[0].parentId = secondRoundMatches[0].id; // 8반vs9반 -> 1반 vs (8반vs9반 승자)
                    firstRoundMatches[1].parentId = secondRoundMatches[2].id; // 7반vs10반 -> 2반 vs (7반vs10반 승자)
                    firstRoundMatches[2].parentId = secondRoundMatches[3].id; // 6반vs11반 -> 3반 vs (6반vs11반 승자)
                } else if (numTeams === 12) {
                    // 12팀: 5반vs6반 승자 -> 2라운드 1번째 매치, 7반vs8반 승자 -> 2라운드 3번째 매치, 9반vs10반 승자 -> 2라운드 4번째 매치, 11반vs12반 승자 -> 2라운드 2번째 매치
                    firstRoundMatches[0].parentId = secondRoundMatches[0].id; // 5반vs6반 -> 1반 vs (5반vs6반 승자)
                    firstRoundMatches[1].parentId = secondRoundMatches[2].id; // 7반vs8반 -> 2반 vs (7반vs8반 승자)
                    firstRoundMatches[2].parentId = secondRoundMatches[3].id; // 9반vs10반 -> 3반 vs (9반vs10반 승자)
                    firstRoundMatches[3].parentId = secondRoundMatches[1].id; // 11반vs12반 -> 4반 vs (11반vs12반 승자)
                } else if (numTeams === 13) {
                    // 13팀: 8반vs9반 승자 -> 2라운드 1번째 매치, 4반vs13반 승자 -> 2라운드 2번째 매치, 5반vs12반 승자 -> 2라운드 2번째 매치, 7반vs10반 승자 -> 2라운드 3번째 매치, 6반vs11반 승자 -> 2라운드 4번째 매치
                    firstRoundMatches[0].parentId = secondRoundMatches[0].id; // 8반vs9반 -> 1반 vs (8반vs9반 승자)
                    firstRoundMatches[1].parentId = secondRoundMatches[1].id; // 4반vs13반 -> (4반vs13반 승자) vs (5반vs12반 승자)
                    firstRoundMatches[2].parentId = secondRoundMatches[1].id; // 5반vs12반 -> (4반vs13반 승자) vs (5반vs12반 승자)
                    firstRoundMatches[3].parentId = secondRoundMatches[2].id; // 7반vs10반 -> 2반 vs (7반vs10반 승자)
                    firstRoundMatches[4].parentId = secondRoundMatches[3].id; // 6반vs11반 -> 3반 vs (6반vs11반 승자)
                } else if (numTeams === 14) {
                    // 14팀: 8반vs9반 승자 -> 2라운드 1번째 매치, 4반vs13반 승자 -> 2라운드 2번째 매치, 5반vs12반 승자 -> 2라운드 2번째 매치, 7반vs10반 승자 -> 2라운드 3번째 매치, 3반vs14반 승자 -> 2라운드 4번째 매치, 6반vs11반 승자 -> 2라운드 4번째 매치
                    firstRoundMatches[0].parentId = secondRoundMatches[0].id; // 8반vs9반 -> 1반 vs (8반vs9반 승자)
                    firstRoundMatches[1].parentId = secondRoundMatches[1].id; // 4반vs13반 -> (4반vs13반 승자) vs (5반vs12반 승자)
                    firstRoundMatches[2].parentId = secondRoundMatches[1].id; // 5반vs12반 -> (4반vs13반 승자) vs (5반vs12반 승자)
                    firstRoundMatches[3].parentId = secondRoundMatches[2].id; // 7반vs10반 -> 2반 vs (7반vs10반 승자)
                    firstRoundMatches[4].parentId = secondRoundMatches[3].id; // 3반vs14반 -> (3반vs14반 승자) vs (6반vs11반 승자)
                    firstRoundMatches[5].parentId = secondRoundMatches[3].id; // 6반vs11반 -> (3반vs14반 승자) vs (6반vs11반 승자)
                } else if (numTeams === 9) {
                    // 9팀: 8반vs9반 승자 -> 2라운드 1번째 매치 (1반 vs (8반vs9반 승자))
                    firstRoundMatches[0].parentId = secondRoundMatches[0].id; // 8반vs9반 -> 1반 vs (8반vs9반 승자)
                } else if (numTeams === 15) {
                    // 15팀: 8반vs9반 승자 -> 2라운드 1번째 매치, 4반vs13반 승자 -> 2라운드 2번째 매치, 5반vs12반 승자 -> 2라운드 2번째 매치, 2반vs15반 승자 -> 2라운드 3번째 매치, 7반vs10반 승자 -> 2라운드 3번째 매치, 3반vs14반 승자 -> 2라운드 4번째 매치, 6반vs11반 승자 -> 2라운드 4번째 매치
                    firstRoundMatches[0].parentId = secondRoundMatches[0].id; // 8반vs9반 -> 1반 vs (8반vs9반 승자)
                    firstRoundMatches[1].parentId = secondRoundMatches[1].id; // 4반vs13반 -> (4반vs13반 승자) vs (5반vs12반 승자)
                    firstRoundMatches[2].parentId = secondRoundMatches[1].id; // 5반vs12반 -> (4반vs13반 승자) vs (5반vs12반 승자)
                    firstRoundMatches[3].parentId = secondRoundMatches[2].id; // 2반vs15반 -> (2반vs15반 승자) vs (7반vs10반 승자)
                    firstRoundMatches[4].parentId = secondRoundMatches[2].id; // 7반vs10반 -> (2반vs15반 승자) vs (7반vs10반 승자)
                    firstRoundMatches[5].parentId = secondRoundMatches[3].id; // 3반vs14반 -> (3반vs14반 승자) vs (6반vs11반 승자)
                    firstRoundMatches[6].parentId = secondRoundMatches[3].id; // 6반vs11반 -> (3반vs14반 승자) vs (6반vs11반 승자)
                } else {
                    // 9팀 또는 16팀 이상: 기존 로직
                    for (let i = 0; i < firstRoundMatches.length; i++) {
                        const parentIndex = Math.floor(byeTeams.length / 2) + Math.floor(i / 2);
                        if (parentIndex < secondRoundMatches.length) {
                            firstRoundMatches[i].parentId = secondRoundMatches[parentIndex].id;
                        }
                    }
                }

                // 나머지 라운드들 생성
                let currentRoundMatches = secondRoundMatches;
                let roundIdx = 2;
                while (currentRoundMatches.length > 1) {
                    const nextRoundMatches = [];
                    for (let i = 0; i < currentRoundMatches.length; i += 2) {
                        const parent = makeMatch(roundIdx, i / 2, null, null);
                        if(currentRoundMatches[i]) currentRoundMatches[i].parentId = parent.id;
                        if(currentRoundMatches[i+1]) currentRoundMatches[i+1].parentId = parent.id;
                        nextRoundMatches.push(parent);
                    }
                    roundsData.push(nextRoundMatches);
                    currentRoundMatches = nextRoundMatches;
                    roundIdx++;
                }
            }
        }
        
        tourney.rounds = roundsData;
        propagateWinners(tourney);
    }
    
    function onScoreInputTournament(matchId, side, value) {
        const tourney = tournamentData.tournaments.find(t => t.id === tournamentData.activeTournamentId);
        if (!tourney || !Array.isArray(tourney.rounds)) return;
        
        // 빈 값이거나 유효한 숫자인지 확인
        const numValue = value === '' ? null : Number(value);
        if (value !== '' && (isNaN(numValue) || numValue < 0)) {
            alert('올바른 점수를 입력해주세요. (0 이상의 숫자)');
            return;
        }
        
        for (const round of tourney.rounds) {
            const match = round.find(m => m.id === matchId);
            if (match) {
                match[side === 'A' ? 'scoreA' : 'scoreB'] = numValue;
                break;
            }
        }
        propagateWinners(tourney);
        saveDataToFirestore();
        renderBracket(tourney);
    }

    function propagateWinners(tourney) {
        if (!tourney || !Array.isArray(tourney.rounds)) return;

        const numTeams = tourney.teams.length;
        
        // 3팀, 4팀, 5팀, 6팀, 7팀, 8팀, 9팀 이상의 특별한 로직 처리
        if (numTeams === 3 || numTeams === 4 || numTeams === 5 || numTeams === 6 || numTeams === 7 || numTeams === 8 || numTeams === 16 || numTeams >= 9) {
            tourney.rounds.forEach((round, rIdx) => {
                round.forEach(match => {
                    if (rIdx === 0) {
                        // 첫 라운드는 이미 팀이 배정되어 있음
                        match.winner = null;
                        if (match.teamA && !match.teamB) { match.winner = match.teamA; }
                        else if (!match.teamA && match.teamB) { match.winner = match.teamB; }
                        else if (match.scoreA !== null && match.scoreB !== null && match.teamA && match.teamB) {
                            if (Number(match.scoreA) > Number(match.scoreB)) match.winner = match.teamA;
                            else if (Number(match.scoreB) > Number(match.scoreA)) match.winner = match.teamB;
                        }
                    } else if (rIdx === 1) {
                        // 두 번째 라운드: 부전승 팀과 이전 라운드 승자들 매칭
                        if (numTeams === 3) {
                            // 3팀: #1 vs ROUND1 승자
                            match.teamA = tourney.teams[0]; // #1
                            match.teamB = tourney.rounds[0][0].winner; // ROUND1 승자
                        } else if (numTeams === 4) {
                            // 4팀: ROUND1 승자들끼리
                            match.teamA = tourney.rounds[0][0].winner; // ROUND1-1승자
                            match.teamB = tourney.rounds[0][1].winner; // ROUND1-2승자
                        } else if (numTeams === 5) {
                            if (match.slotIdx === 0) {
                                // #1 vs ROUND1 승자
                                match.teamA = tourney.teams[0]; // #1
                                match.teamB = tourney.rounds[0][0].winner; // ROUND1 승자
                            } else {
                                // #2 vs #3
                                match.teamA = tourney.teams[1]; // #2
                                match.teamB = tourney.teams[2]; // #3
                            }
                        } else if (numTeams === 6) {
                            if (match.slotIdx === 0) {
                                // #1 vs ROUND1-1승자
                                match.teamA = tourney.teams[0]; // #1
                                match.teamB = tourney.rounds[0][0].winner; // ROUND1-1승자
                            } else {
                                // #2 vs ROUND1-2승자
                                match.teamA = tourney.teams[1]; // #2
                                match.teamB = tourney.rounds[0][1].winner; // ROUND1-2승자
                            }
                        } else if (numTeams === 7) {
                            if (match.slotIdx === 0) {
                                // #1 vs ROUND1-1승자
                                match.teamA = tourney.teams[0]; // #1
                                match.teamB = tourney.rounds[0][0].winner; // ROUND1-1승자
                            } else {
                                // ROUND1-2승자 vs ROUND1-3승자
                                match.teamA = tourney.rounds[0][1].winner; // ROUND1-2승자
                                match.teamB = tourney.rounds[0][2].winner; // ROUND1-3승자
                            }
                        } else if (numTeams === 8) {
                            if (match.slotIdx === 0) {
                                // ROUND1-1승자 vs ROUND1-2승자
                                match.teamA = tourney.rounds[0][0].winner; // ROUND1-1승자
                                match.teamB = tourney.rounds[0][1].winner; // ROUND1-2승자
                            } else {
                                // ROUND1-3승자 vs ROUND1-4승자
                                match.teamA = tourney.rounds[0][2].winner; // ROUND1-3승자
                                match.teamB = tourney.rounds[0][3].winner; // ROUND1-4승자
                            }
                        } else if (numTeams === 9) {
                            // 9팀: 2라운드에서 1라운드 승자들을 배정
                            if (match.slotIdx === 0) {
                                // 1반 vs (8반vs9반 승자)
                                match.teamB = tourney.rounds[0][0].winner; // 8반vs9반 승자
                            }
                            // 나머지 매치들(2반vs3반, 4반vs5반, 6반vs7반)은 부전승 팀들이 이미 배정되어 있음
                        } else if (numTeams === 10) {
                            // 10팀: 2라운드에서 1라운드 승자들을 배정
                            if (match.slotIdx === 0) {
                                // 1반 vs (8반vs9반 승자)
                                match.teamB = tourney.rounds[0][1].winner; // 8반vs9반 승자
                            } else if (match.slotIdx === 2) {
                                // 2반 vs (7반vs10반 승자)
                                match.teamB = tourney.rounds[0][0].winner; // 7반vs10반 승자
                            }
                            // 나머지 매치들(4반vs5반, 3반vs6반)은 부전승 팀들이 이미 배정되어 있음
                        } else if (numTeams === 11) {
                            // 11팀: 2라운드에서 1라운드 승자들을 배정
                            if (match.slotIdx === 0) {
                                // 1반 vs (8반vs9반 승자)
                                match.teamB = tourney.rounds[0][0].winner; // 8반vs9반 승자
                            } else if (match.slotIdx === 2) {
                                // 2반 vs (7반vs10반 승자)
                                match.teamB = tourney.rounds[0][1].winner; // 7반vs10반 승자
                            } else if (match.slotIdx === 3) {
                                // 3반 vs (6반vs11반 승자)
                                match.teamB = tourney.rounds[0][2].winner; // 6반vs11반 승자
                            }
                            // 나머지 매치들(4반vs5반)은 부전승 팀들이 이미 배정되어 있음
                        } else if (numTeams === 12) {
                            // 12팀: 2라운드에서 1라운드 승자들을 배정
                            if (match.slotIdx === 0) {
                                // 1반 vs (5반vs6반 승자)
                                match.teamB = tourney.rounds[0][0].winner; // 5반vs6반 승자
                            } else if (match.slotIdx === 1) {
                                // 4반 vs (11반vs12반 승자)
                                match.teamB = tourney.rounds[0][3].winner; // 11반vs12반 승자
                            } else if (match.slotIdx === 2) {
                                // 2반 vs (7반vs8반 승자)
                                match.teamB = tourney.rounds[0][1].winner; // 7반vs8반 승자
                            } else if (match.slotIdx === 3) {
                                // 3반 vs (9반vs10반 승자)
                                match.teamB = tourney.rounds[0][2].winner; // 9반vs10반 승자
                            }
                        } else if (numTeams === 13) {
                            // 13팀: 2라운드에서 1라운드 승자들을 배정
                            if (match.slotIdx === 0) {
                                // 1반 vs (8반vs9반 승자)
                                match.teamB = tourney.rounds[0][0].winner; // 8반vs9반 승자
                            } else if (match.slotIdx === 1) {
                                // (4반vs13반 승자) vs (5반vs12반 승자)
                                match.teamA = tourney.rounds[0][1].winner; // 4반vs13반 승자
                                match.teamB = tourney.rounds[0][2].winner; // 5반vs12반 승자
                            } else if (match.slotIdx === 2) {
                                // 2반 vs (7반vs10반 승자)
                                match.teamB = tourney.rounds[0][3].winner; // 7반vs10반 승자
                            } else if (match.slotIdx === 3) {
                                // 3반 vs (6반vs11반 승자)
                                match.teamB = tourney.rounds[0][4].winner; // 6반vs11반 승자
                            }
                        } else if (numTeams === 14) {
                            // 14팀: 2라운드에서 1라운드 승자들을 배정
                            if (match.slotIdx === 0) {
                                // 1반 vs (8반vs9반 승자)
                                match.teamB = tourney.rounds[0][0].winner; // 8반vs9반 승자
                            } else if (match.slotIdx === 1) {
                                // (4반vs13반 승자) vs (5반vs12반 승자)
                                match.teamA = tourney.rounds[0][1].winner; // 4반vs13반 승자
                                match.teamB = tourney.rounds[0][2].winner; // 5반vs12반 승자
                            } else if (match.slotIdx === 2) {
                                // 2반 vs (7반vs10반 승자)
                                match.teamB = tourney.rounds[0][3].winner; // 7반vs10반 승자
                            } else if (match.slotIdx === 3) {
                                // (3반vs14반 승자) vs (6반vs11반 승자)
                                match.teamA = tourney.rounds[0][4].winner; // 3반vs14반 승자
                                match.teamB = tourney.rounds[0][5].winner; // 6반vs11반 승자
                            }
                        } else if (numTeams === 15) {
                            // 15팀: 2라운드에서 1라운드 승자들을 배정
                            if (match.slotIdx === 0) {
                                // 1반 vs (8반vs9반 승자)
                                match.teamB = tourney.rounds[0][0].winner; // 8반vs9반 승자
                            } else if (match.slotIdx === 1) {
                                // (4반vs13반 승자) vs (5반vs12반 승자)
                                match.teamA = tourney.rounds[0][1].winner; // 4반vs13반 승자
                                match.teamB = tourney.rounds[0][2].winner; // 5반vs12반 승자
                            } else if (match.slotIdx === 2) {
                                // (2반vs15반 승자) vs (7반vs10반 승자)
                                match.teamA = tourney.rounds[0][3].winner; // 2반vs15반 승자
                                match.teamB = tourney.rounds[0][4].winner; // 7반vs10반 승자
                            } else if (match.slotIdx === 3) {
                                // (3반vs14반 승자) vs (6반vs11반 승자)
                                match.teamA = tourney.rounds[0][5].winner; // 3반vs14반 승자
                                match.teamB = tourney.rounds[0][6].winner; // 6반vs11반 승자
                            }
                        } else if (numTeams === 16) {
                            // 16팀: 표준 토너먼트 로직 (모든 라운드에서 이전 라운드 승자들 배정)
                            if (rIdx > 0) {
                                const prevRound = tourney.rounds[rIdx - 1];
                                const matchIndex = match.slotIdx;
                                const teamAIndex = matchIndex * 2;
                                const teamBIndex = matchIndex * 2 + 1;
                                
                                match.teamA = prevRound[teamAIndex] ? (prevRound[teamAIndex].winner || null) : null;
                                match.teamB = prevRound[teamBIndex] ? (prevRound[teamBIndex].winner || null) : null;
                            }
                        } else if (numTeams >= 9) {
                            // 9팀 또는 16팀 이상: 2라운드에서 1라운드 승자들을 배정
                            const totalSlots = 1 << (Math.ceil(Math.log2(numTeams)));
                            const byeCount = totalSlots - numTeams;
                            const firstRoundMatchCount = (numTeams - byeCount) / 2;
                            
                            // 첫 번째 매치: 1라운드 승자 vs 첫 번째 부전승 팀
                            if (match.slotIdx === 0) {
                                match.teamB = tourney.rounds[0][0].winner; // 1라운드 승자
                            }
                            // 나머지 매치들은 부전승 팀들이 이미 배정되어 있음
                        }
                        
                        match.winner = null;
                        // 6팀, 7팀, 8팀, 9팀 이상의 경우 부전승 팀이 자동으로 승자가 되지 않도록 함
                        if (numTeams === 6 || numTeams === 7 || numTeams === 8 || numTeams >= 9) {
                            // 부전승 팀이 있는 경우 실제 경기가 끝날 때까지 승자 결정하지 않음
                            if (match.teamA && match.teamB && match.scoreA !== null && match.scoreB !== null) {
                                if (Number(match.scoreA) > Number(match.scoreB)) match.winner = match.teamA;
                                else if (Number(match.scoreB) > Number(match.scoreA)) match.winner = match.teamB;
                            }
                        } else {
                            // 3팀, 4팀, 5팀의 경우 기존 로직 유지
                            if (match.teamA && !match.teamB) { match.winner = match.teamA; }
                            else if (!match.teamA && match.teamB) { match.winner = match.teamB; }
                            else if (match.scoreA !== null && match.scoreB !== null && match.teamA && match.teamB) {
                                if (Number(match.scoreA) > Number(match.scoreB)) match.winner = match.teamA;
                                else if (Number(match.scoreB) > Number(match.scoreA)) match.winner = match.teamB;
                            }
                        }
                    } else if (rIdx === 2) {
                        // Semi-Final: 이전 라운드(8강) 승자들
                        if (tourney.rounds[1] && tourney.rounds[1].length > 0) {
                            // 8강 라운드의 승자들을 2개씩 묶어서 Semi-Final에 배정
                            const prevRound = tourney.rounds[1];
                            const matchIndex = match.slotIdx;
                            const teamAIndex = matchIndex * 2;
                            const teamBIndex = matchIndex * 2 + 1;
                            
                            match.teamA = prevRound[teamAIndex] ? (prevRound[teamAIndex].winner || null) : null;
                            match.teamB = prevRound[teamBIndex] ? (prevRound[teamBIndex].winner || null) : null;
                        }
                        
                        match.winner = null;
                        if (match.teamA && !match.teamB) { match.winner = match.teamA; }
                        else if (!match.teamA && match.teamB) { match.winner = match.teamB; }
                        else if (match.scoreA !== null && match.scoreB !== null && match.teamA && match.teamB) {
                            if (Number(match.scoreA) > Number(match.scoreB)) match.winner = match.teamA;
                            else if (Number(match.scoreB) > Number(match.scoreA)) match.winner = match.teamB;
                        }
                    } else if (rIdx === 3) {
                        // Final: 이전 라운드(Semi-Final) 승자들
                        if (tourney.rounds[2] && tourney.rounds[2].length > 0) {
                            // Semi-Final 라운드의 승자들을 2개씩 묶어서 Final에 배정
                            const prevRound = tourney.rounds[2];
                            const matchIndex = match.slotIdx;
                            const teamAIndex = matchIndex * 2;
                            const teamBIndex = matchIndex * 2 + 1;
                            
                            match.teamA = prevRound[teamAIndex] ? (prevRound[teamAIndex].winner || null) : null;
                            match.teamB = prevRound[teamBIndex] ? (prevRound[teamBIndex].winner || null) : null;
                        }
                        
                        match.winner = null;
                        if (match.teamA && !match.teamB) { match.winner = match.teamA; }
                        else if (!match.teamA && match.teamB) { match.winner = match.teamB; }
                        else if (match.scoreA !== null && match.scoreB !== null && match.teamA && match.teamB) {
                            if (Number(match.scoreA) > Number(match.scoreB)) match.winner = match.teamA;
                            else if (Number(match.scoreB) > Number(match.scoreA)) match.winner = match.teamB;
                        }
                    }
                });
            });
        } else {
            // 표준 토너먼트 로직
            tourney.rounds.forEach((round, rIdx) => {
                round.forEach(match => {
                    if(rIdx > 0) {
                        const prevRound = tourney.rounds[rIdx-1];
                        const child1 = prevRound[match.slotIdx * 2];
                        const child2 = prevRound[match.slotIdx * 2 + 1];
                        match.teamA = child1 ? child1.winner : null;
                        match.teamB = child2 ? child2.winner : null;
                    }
                    
                    match.winner = null;
                    if (match.teamA && !match.teamB) { match.winner = match.teamA; }
                    else if (!match.teamA && match.teamB) { match.winner = match.teamB; }
                    else if (match.scoreA !== null && match.scoreB !== null && match.teamA && match.teamB) {
                        if (Number(match.scoreA) > Number(match.scoreB)) match.winner = match.teamA;
                        else if (Number(match.scoreB) > Number(match.scoreA)) match.winner = match.teamB;
                    }
                });
            });
        }
    }

    function renderBracket(tourney, isReadOnly = false) {
        const roundsEl = $('#rounds');
        const svgEl = $('#svgLayer');
        const roundsData = tourney.rounds;

        if (!roundsEl || !svgEl || !Array.isArray(roundsData) || roundsData.length === 0) {
            if(roundsEl) roundsEl.innerHTML = '<div style="text-align:center; padding: 2rem; color: var(--ink-muted);">팀을 추가하여 대진표 생성을 시작하세요.</div>';
            if(svgEl) svgEl.innerHTML = '';
            return;
        }
        
        const roundLabels = makeRoundLabels(roundsData.length);
        roundsEl.innerHTML = roundsData.map((round, rIdx) => `
            <div class="round">
                <div class="round-title">${roundLabels[rIdx]}</div>
                <div class="match-group">
                    ${round.map(m => renderMatchCard(m, rIdx, tourney, isReadOnly)).join('')}
                </div>
            </div>
        `).join('');
        
        requestAnimationFrame(() => drawSvgLines(tourney));
    }


    function renderMatchCard(m, rIdx, tourney, isReadOnly = false) {
        // 부전승 팀 처리
        const teamA = m.teamA || (m.isBye ? '부전승' : '(미정)');
        const teamB = m.teamB || (m.isBye ? '부전승' : '(미정)');
        const isNext = m.teamA && m.teamB && !m.winner;
        
        let rankBadgeA = '', rankBadgeB = '';
        const winBadge = '<span style="color: var(--win); font-weight: bold; font-size: 12px; margin-left: auto;">승</span>';
        const byeBadge = '<span style="color: var(--ink-muted); font-style: italic; font-size: 11px;">부전승</span>';
        const isScoredMatch = m.scoreA !== null && m.scoreB !== null;
        const roundsData = tourney.rounds;

        const finalRoundIdx = roundsData.length - 1;

        if (finalRoundIdx >= 0 && roundsData[finalRoundIdx][0].winner) {
            const winner = roundsData[finalRoundIdx][0].winner;
            const runnerUp = winner === roundsData[finalRoundIdx][0].teamA ? roundsData[finalRoundIdx][0].teamB : roundsData[finalRoundIdx][0].teamA;
            
            if (rIdx === finalRoundIdx) {
                if (m.teamA === winner) rankBadgeA = getMedal('gold');
                if (m.teamB === winner) rankBadgeB = getMedal('gold');
                if (m.teamA === runnerUp) rankBadgeA = getMedal('silver');
                if (m.teamB === runnerUp) rankBadgeB = getMedal('silver');
            }

            if (roundsData.length > 1 && rIdx === finalRoundIdx - 1) {
                const semiFinalLosers = [roundsData[rIdx][0].teamA, roundsData[rIdx][0].teamB, roundsData[rIdx][1]?.teamA, roundsData[rIdx][1]?.teamB].filter(t => t && t !== winner && t !== runnerUp);
                if (semiFinalLosers.includes(m.teamA)) rankBadgeA = getMedal('bronze');
                if (semiFinalLosers.includes(m.teamB)) rankBadgeB = getMedal('bronze');
            }
        }
        
        // 부전승 매치인 경우 스타일링
        const isByeMatch = m.isBye;
        const byeMatchClass = isByeMatch ? 'bye-match' : '';
        
        // 원래 팀 렌더링 함수
        const renderTeam = (team, teamType, rankBadge, isWinner, isLoser, isBye) => {
            const isEmpty = !team || team === '(미정)';
            const isByeTeam = isBye && isEmpty;
            
            return `
                <div class="team ${m.winner === team ? 'win' : ''} ${m.winner && m.winner !== team ? 'lose' : ''} ${!team && m.isBye ? 'bye-team' : ''}"
                     data-match-id="${m.id}" 
                     data-team-type="${teamType}"
                     data-team-name="${team || ''}"
                     draggable="${isReadOnly || isByeMatch ? 'false' : 'true'}"
                     ondragstart="handleDragStart(event)"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event)"
                     ondragleave="handleDragLeave(event)">
                    <span class="team-name">
                        ${rankBadge}${team || (isByeTeam ? '부전승' : '(미정)')}
                    </span>
                    <input type="number" class="team-score" value="${teamType === 'A' ? (m.scoreA ?? '') : (m.scoreB ?? '')}" 
                           onchange="onScoreInputTournament('${m.id}', '${teamType}', this.value)" 
                           ${(!team || !m.teamA || !m.teamB || isReadOnly || isByeMatch) ? 'disabled' : ''} 
                           placeholder="점수" min="0"
                           title="${(!team || !m.teamA || !m.teamB || isReadOnly || isByeMatch) ? '점수를 입력할 수 없습니다' : '점수를 입력하세요. 승자는 자동으로 결정됩니다.'}">
                    <div class="team-actions">
                        ${isWinner && isScoredMatch ? winBadge : ''}
                        ${isByeTeam ? byeBadge : ''}
                    </div>
                </div>
            `;
        };
        
        return `
            <div class="match">
                ${renderTeam(teamA, 'A', rankBadgeA, m.winner === m.teamA, m.winner && m.winner !== m.teamA, !m.teamA && m.isBye)}
                ${renderTeam(teamB, 'B', rankBadgeB, m.winner === m.teamB, m.winner && m.winner !== m.teamB, !m.teamB && m.isBye)}
            </div>
        `;
    }

    // 현재 활성 토너먼트 가져오기
    function getCurrentTournament() {
        return tournamentData.tournaments.find(t => t.id === tournamentData.activeTournamentId);
    }

    // 드래그 앤 드롭 관련 변수
    let draggedElement = null;
    let draggedData = null;

    // 드래그 시작
    function handleDragStart(event) {
        draggedElement = event.target.closest('.team-item');
        if (!draggedElement) return;
        
        draggedData = {
            matchId: draggedElement.dataset.matchId,
            teamType: draggedElement.dataset.teamType,
            teamName: draggedElement.dataset.teamName
        };
        
        draggedElement.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/html', draggedElement.outerHTML);
    }

    // 드래그 오버
    function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        
        const team = event.target.closest('.team-item');
        if (team && team !== draggedElement) {
            team.classList.add('drag-over');
        }
    }

    // 드래그 리브
    function handleDragLeave(event) {
        const team = event.target.closest('.team-item');
        if (team) {
            team.classList.remove('drag-over');
        }
    }

    // 드롭
    function handleDrop(event) {
        event.preventDefault();
        
        const targetTeam = event.target.closest('.team-item');
        if (!targetTeam || !draggedElement || targetTeam === draggedElement) {
            return;
        }
        
        // 드래그된 팀과 타겟 팀의 정보
        const sourceMatchId = draggedData.matchId;
        const sourceTeamType = draggedData.teamType;
        const sourceTeamName = draggedData.teamName;
        
        const targetMatchId = targetTeam.dataset.matchId;
        const targetTeamType = targetTeam.dataset.teamType;
        const targetTeamName = targetTeam.dataset.teamName;
        
        // 같은 매치 내에서 팀 교체
        if (sourceMatchId === targetMatchId) {
            swapTeamsInSameMatch(sourceMatchId, sourceTeamType, targetTeamType);
        } else {
            // 다른 매치 간 팀 교체
            swapTeamsBetweenMatches(sourceMatchId, sourceTeamType, targetMatchId, targetTeamType);
        }
        
        // UI 업데이트
        const currentTourney = getCurrentTournament();
        if (currentTourney) {
            renderTournamentView(currentTourney);
        }
        
        // 클래스 정리
        targetTeam.classList.remove('drag-over');
        draggedElement.classList.remove('dragging');
        draggedElement = null;
        draggedData = null;
    }

    // 같은 매치 내에서 팀 교체
    function swapTeamsInSameMatch(matchId, teamTypeA, teamTypeB) {
        const currentTourney = getCurrentTournament();
        if (!currentTourney) return;
        
        // 매치 찾기
        let targetMatch = null;
        for (let round of currentTourney.rounds) {
            for (let match of round) {
                if (match.id === matchId) {
                    targetMatch = match;
                    break;
                }
            }
            if (targetMatch) break;
        }
        
        if (!targetMatch) return;
        
        // 팀 교체
        const tempTeam = teamTypeA === 'A' ? targetMatch.teamA : targetMatch.teamB;
        const tempScore = teamTypeA === 'A' ? targetMatch.scoreA : targetMatch.scoreB;
        
        if (teamTypeA === 'A') {
            targetMatch.teamA = teamTypeB === 'A' ? targetMatch.teamA : targetMatch.teamB;
            targetMatch.scoreA = teamTypeB === 'A' ? targetMatch.scoreA : targetMatch.scoreB;
        } else {
            targetMatch.teamB = teamTypeB === 'A' ? targetMatch.teamA : targetMatch.teamB;
            targetMatch.scoreB = teamTypeB === 'A' ? targetMatch.scoreA : targetMatch.scoreB;
        }
        
        if (teamTypeB === 'A') {
            targetMatch.teamA = tempTeam;
            targetMatch.scoreA = tempScore;
        } else {
            targetMatch.teamB = tempTeam;
            targetMatch.scoreB = tempScore;
        }
        
        // 승자 초기화
        targetMatch.winner = null;
    }

    // 다른 매치 간 팀 교체
    function swapTeamsBetweenMatches(sourceMatchId, sourceTeamType, targetMatchId, targetTeamType) {
        const currentTourney = getCurrentTournament();
        if (!currentTourney) return;
        
        // 소스 매치와 타겟 매치 찾기
        let sourceMatch = null;
        let targetMatch = null;
        
        for (let round of currentTourney.rounds) {
            for (let match of round) {
                if (match.id === sourceMatchId) {
                    sourceMatch = match;
                }
                if (match.id === targetMatchId) {
                    targetMatch = match;
                }
            }
        }
        
        if (!sourceMatch || !targetMatch) return;
        
        // 팀과 점수 교체
        const sourceTeam = sourceTeamType === 'A' ? sourceMatch.teamA : sourceMatch.teamB;
        const sourceScore = sourceTeamType === 'A' ? sourceMatch.scoreA : sourceMatch.scoreB;
        
        const targetTeam = targetTeamType === 'A' ? targetMatch.teamA : targetMatch.teamB;
        const targetScore = targetTeamType === 'A' ? targetMatch.scoreA : targetMatch.scoreB;
        
        // 교체 실행
        if (sourceTeamType === 'A') {
            sourceMatch.teamA = targetTeam;
            sourceMatch.scoreA = targetScore;
        } else {
            sourceMatch.teamB = targetTeam;
            sourceMatch.scoreB = targetScore;
        }
        
        if (targetTeamType === 'A') {
            targetMatch.teamA = sourceTeam;
            targetMatch.scoreA = sourceScore;
        } else {
            targetMatch.teamB = sourceTeam;
            targetMatch.scoreB = sourceScore;
        }
        
        // 승자 초기화
        sourceMatch.winner = null;
        targetMatch.winner = null;
    }

    function makeRoundLabels(count) {
      if(count<=0) return []; 
      if(count===1) return ["Final"]; 
      if(count===2) return ["Semi-Final","Final"];
      if(count===3) return ["8강","Semi-Final","Final"]; 
      if(count===4) return ["16강","8강","Semi-Final","Final"];
      if(count===5) return ["32강","16강","8강","Semi-Final","Final"];
      if(count===6) return ["64강","32강","16강","8강","Semi-Final","Final"];
      return Array.from({length:count}, (_,i)=> {
        if(i === count - 1) return "Final";
        if(i === count - 2) return "Semi-Final";
        if(i === count - 3) return "8강";
        if(i === count - 4) return "16강";
        if(i === count - 5) return "32강";
        if(i === count - 6) return "64강";
        return `${Math.pow(2, count - 1 - i)}강`;
      });
    }

    function getMedal(type) {
        const colors = { gold: '#FFD700', silver: '#C0C0C0', bronze: '#CD7F32' };
        const rank = { gold: '1위', silver: '2위', bronze: '공동 3위' };
        return `<span class="rank-badge" data-tooltip="${rank[type]}"><svg viewBox="0 0 24 24" fill="${colors[type]}"><path d="M12 2L9.5 7.5 4 8l4.5 4L7 18l5-3 5 3-1.5-6 4.5-4-5.5-.5z"/></svg></span>`;
    }
    
    function drawSvgLines() {
        const svg = $("#svgLayer");
        const roundsEl = $("#rounds");
        if(!svg || !roundsEl) return;
        svg.innerHTML = "";
        const scrollW = roundsEl.scrollWidth; const scrollH = roundsEl.scrollHeight;
        svg.setAttribute("viewBox", `0 0 ${scrollW} ${scrollH}`);
        svg.setAttribute("width", scrollW); svg.setAttribute("height", scrollH);
        
        const tourney = tournamentData.tournaments.find(t => t.id === tournamentData.activeTournamentId);
        if(!tourney || !Array.isArray(tourney.rounds)) return;

        for(let r=0; r < tourney.rounds.length-1; r++){
            const currentRound = tourney.rounds[r];
            currentRound.forEach(match => {
                if (!match || !match.parentId) return;

                const childCard = roundsEl.querySelector(`[data-match-id="${match.id}"]`);
                const parentCard = roundsEl.querySelector(`[data-match-id="${match.parentId}"]`);
                if (!childCard || !parentCard) return;

                const start = getBottomRight(childCard, roundsEl);
                const end = getBottomLeft(parentCard, roundsEl);
                
                // 곡선 연결선
                const path = document.createElementNS("http://www.w3.org/2000/svg","path");
                const gap = 40;
                const midX = start.x + gap;
                const d = `M ${start.x} ${start.y} 
                          C ${midX} ${start.y} ${midX} ${end.y} ${end.x} ${end.y}`;
                path.setAttribute("d", d);
                path.setAttribute("fill", "none");
                path.setAttribute("stroke", match.winner ? "var(--accent)" : "var(--line)");
                path.setAttribute("stroke-width", match.winner ? "2.5" : "1.5");
                path.setAttribute("stroke-linecap", "round");
                path.setAttribute("stroke-linejoin", "round");
                svg.appendChild(path);
            });
        }
    }
    function getCenterRight(el, container){ const r1 = el.getBoundingClientRect(); const rC = container.getBoundingClientRect(); return { x: (r1.right - rC.left) + container.scrollLeft, y: (r1.top - rC.top) + r1.height/2 + container.scrollTop }; }
    function getCenterLeft(el, container){ const r1 = el.getBoundingClientRect(); const rC = container.getBoundingClientRect(); return { x: (r1.left - rC.left) + container.scrollLeft, y: (r1.top - rC.top) + r1.height/2 + container.scrollTop }; }
    function getBottomRight(el, container){ const r1 = el.getBoundingClientRect(); const rC = container.getBoundingClientRect(); return { x: (r1.right - rC.left) + 15 + container.scrollLeft, y: (r1.bottom - rC.top) + 18 + container.scrollTop }; }
    function getBottomLeft(el, container){ const r1 = el.getBoundingClientRect(); const rC = container.getBoundingClientRect(); return { x: (r1.left - rC.left) + 15 + container.scrollLeft, y: (r1.bottom - rC.top) + 18 + container.scrollTop }; }

    // 드래그&드롭 이벤트 핸들러
    function handleDragStart(event) {
        const team = event.target.closest('.team');
        if (!team) return;
        
        team.classList.add('dragging');
        event.dataTransfer.setData('text/plain', JSON.stringify({
            matchId: team.dataset.matchId,
            teamType: team.dataset.teamType,
            teamName: team.dataset.teamName
        }));
        event.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        
        const team = event.target.closest('.team');
        if (team) {
            team.classList.add('drag-over');
        }
    }

    function handleDragLeave(event) {
        const team = event.target.closest('.team');
        if (team) {
            team.classList.remove('drag-over');
        }
    }

    function handleDrop(event) {
        event.preventDefault();
        
        const team = event.target.closest('.team');
        if (!team) return;
        
        team.classList.remove('drag-over');
        
        try {
            const dragData = JSON.parse(event.dataTransfer.getData('text/plain'));
            const sourceMatchId = dragData.matchId;
            const sourceTeamType = dragData.teamType;
            const targetMatchId = team.dataset.matchId;
            const targetTeamType = team.dataset.teamType;
            
            if (sourceMatchId === targetMatchId && sourceTeamType === targetTeamType) {
                return; // 같은 위치로 드롭한 경우 무시
            }
            
            swapTeams(sourceMatchId, sourceTeamType, targetMatchId, targetTeamType);
        } catch (error) {
            console.error('드래그&드롭 처리 중 오류:', error);
        }
    }

    function swapTeams(sourceMatchId, sourceTeamType, targetMatchId, targetTeamType) {
        const tourney = getCurrentTournament();
        if (!tourney) return;
        
        const sourceMatch = findMatchById(tourney, sourceMatchId);
        const targetMatch = findMatchById(tourney, targetMatchId);
        
        if (!sourceMatch || !targetMatch) return;
        
        // 팀 데이터 교환
        const sourceTeam = sourceTeamType === 'A' ? sourceMatch.teamA : sourceMatch.teamB;
        const sourceScore = sourceTeamType === 'A' ? sourceMatch.scoreA : sourceMatch.scoreB;
        const targetTeam = targetTeamType === 'A' ? targetMatch.teamA : targetMatch.teamB;
        const targetScore = targetTeamType === 'A' ? targetMatch.scoreA : targetMatch.scoreB;
        
        // 팀과 점수 교환
        if (sourceTeamType === 'A') {
            sourceMatch.teamA = targetTeam;
            sourceMatch.scoreA = targetScore;
        } else {
            sourceMatch.teamB = targetTeam;
            sourceMatch.scoreB = targetScore;
        }
        
        if (targetTeamType === 'A') {
            targetMatch.teamA = sourceTeam;
            targetMatch.scoreA = sourceScore;
        } else {
            targetMatch.teamB = sourceTeam;
            targetMatch.scoreB = sourceScore;
        }
        
        // 승자 재계산
        propagateWinners(tourney);
        
        // 대진표 다시 그리기
        renderBracket(tourney);
        drawSvgLines();
        saveDataToFirestore();
    }

    function findMatchById(tourney, matchId) {
        for (let round of tourney.rounds) {
            for (let match of round) {
                if (match.id === matchId) {
                    return match;
                }
            }
        }
        return null;
    }



    // ========================================
    // 데이터 가져오기/내보내기 및 공용
    // ========================================
    function getFormattedDate() {
        const now = new Date();
        const year = now.getFullYear().toString().slice(-2);
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ========================================
    // PAPS UI 및 로직
    // ========================================
    window.window.papsItems = {
        "심폐지구력": { id: "endurance", options: ["왕복오래달리기", "오래달리기", "스텝검사"] },
        "유연성": { id: "flexibility", options: ["앉아윗몸앞으로굽히기", "종합유연성검사"] },
        "근력/근지구력": { id: "strength", options: ["악력", "팔굽혀펴기", "윗몸말아올리기"] },
        "순발력": { id: "power", options: ["제자리멀리뛰기", "50m 달리기"] },
        "체지방": { id: "bodyfat", options: ["BMI"] }
    };

    // PAPS 평가 기준 데이터 (2024년 기준으로 업데이트)
    const papsCriteriaData = {
      "남자":{
        "초4":{"왕복오래달리기":[[96,9999,1],[69,95,2],[45,68,3],[26,44,4],[0,25,5]],"앉아윗몸앞으로굽히기":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"제자리멀리뛰기":[[170.1,9999,1],[149.1,170,2],[130.1,149,3],[100.1,130,4],[0,100,5]],"팔굽혀펴기":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"윗몸말아올리기":[[80,9999,1],[40,79,2],[22,39,3],[7,21,4],[0,6,5]],"악력":[[31,9999,1],[18.5,30.9,2],[15,18.4,3],[11.5,14.9,4],[0,11.4,5]],"50m 달리기":[[0,8.8,1],[8.81,9.7,2],[9.71,10.5,3],[10.51,13.2,4],[13.21,9999,5]],"오래달리기걷기":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[25,9999,1],[22,24.9,2],[19,21.9,3],[16,18.9,4],[0,15.9,5]]},
        "초5":{"왕복오래달리기":[[100,9999,1],[73,99,2],[50,72,3],[29,49,4],[0,28,5]],"앉아윗몸앞으로굽히기":[[8,9999,1],[5,7.9,2],[1,4.9,3],[-4,0.9,4],[-999,-4.1,5]],"제자리멀리뛰기":[[180.1,9999,1],[159.1,180,2],[141.1,159,3],[111.1,141,4],[0,111,5]],"팔굽혀펴기":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"윗몸말아올리기":[[80,9999,1],[40,79,2],[22,39,3],[10,21,4],[0,9,5]],"악력":[[31,9999,1],[23,30.9,2],[17,22.9,3],[12.5,16.9,4],[0,12.4,5]],"50m 달리기":[[0,8.5,1],[8.51,9.4,2],[9.41,10.2,3],[10.21,13.2,4],[13.21,9999,5]],"오래달리기걷기":[[0,281,1],[282,324,2],[325,409,3],[410,479,4],[480,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[28,9999,1],[25,27.9,2],[22,24.9,3],[19,21.9,4],[0,18.9,5]]},
        "초6":{"왕복오래달리기":[[104,9999,1],[78,103,2],[54,77,3],[32,53,4],[0,31,5]],"앉아윗몸앞으로굽히기":[[8,9999,1],[5,7.9,2],[1,4.9,3],[-4,0.9,4],[-999,-4.1,5]],"제자리멀리뛰기":[[200.1,9999,1],[167.1,200,2],[148.1,167,3],[122.1,148,4],[0,122,5]],"팔굽혀펴기":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"윗몸말아올리기":[[80,9999,1],[40,79,2],[22,39,3],[10,21,4],[0,9,5]],"악력":[[35,9999,1],[26.5,34.9,2],[19,26.4,3],[15,18.9,4],[0,14.9,5]],"50m 달리기":[[0,8.1,1],[8.11,9.1,2],[9.11,10,3],[10.01,12.5,4],[12.51,9999,5]],"오래달리기걷기":[[0,250,1],[251,314,2],[315,379,3],[380,449,4],[450,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[31,9999,1],[28,30.9,2],[25,27.9,3],[22,24.9,4],[0,21.9,5]]},
        "중1":{"왕복오래달리기":[[64,9999,1],[50,63,2],[36,49,3],[20,35,4],[0,19,5]],"앉아윗몸앞으로굽히기":[[10,9999,1],[6,9.9,2],[2,5.9,3],[-4,1.9,4],[-999,-4.1,5]],"제자리멀리뛰기":[[211.1,9999,1],[177.1,211,2],[159.1,177,3],[131.1,159,4],[0,131,5]],"팔굽혀펴기":[[34,9999,1],[25,33,2],[12,24,3],[4,11,4],[0,3,5]],"윗몸말아올리기":[[90,9999,1],[55,89,2],[33,54,3],[14,32,4],[0,13,5]],"악력":[[42,9999,1],[30,41.9,2],[22.5,29.9,3],[16.5,22.4,4],[0,16.4,5]],"50m 달리기":[[0,7.5,1],[7.51,8.4,2],[8.41,9.3,3],[9.31,11.5,4],[11.51,9999,5]],"오래달리기걷기":[[0,425,1],[426,502,2],[503,599,3],[600,699,4],[700,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[34,9999,1],[31,33.9,2],[28,30.9,3],[25,27.9,4],[0,24.9,5]]},
        "중2":{"왕복오래달리기":[[66,9999,1],[52,65,2],[38,51,3],[22,37,4],[0,21,5]],"앉아윗몸앞으로굽히기":[[10,9999,1],[7,9.9,2],[2,6.9,3],[-4,1.9,4],[-999,-4.1,5]],"제자리멀리뛰기":[[218.1,9999,1],[187.1,218,2],[169.1,187,3],[136.1,169,4],[0,136,5]],"팔굽혀펴기":[[34,9999,1],[25,33,2],[12,24,3],[4,11,4],[0,3,5]],"윗몸말아올리기":[[90,9999,1],[55,89,2],[33,54,3],[14,32,4],[0,13,5]],"악력":[[44.5,9999,1],[37,44.4,2],[28.5,36.9,3],[22,28.4,4],[0,21.9,5]],"50m 달리기":[[0,7.3,1],[7.31,8.2,2],[8.21,9,3],[9.01,11.5,4],[11.51,9999,5]],"오래달리기걷기":[[0,416,1],[417,487,2],[488,583,3],[584,679,4],[680,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[37,9999,1],[34,36.9,2],[31,33.9,3],[28,30.9,4],[0,27.9,5]]},
        "중3":{"왕복오래달리기":[[68,9999,1],[54,67,2],[40,53,3],[24,39,4],[0,23,5]],"앉아윗몸앞으로굽히기":[[10,9999,1],[7,9.9,2],[2.6,6.9,3],[-3,2.5,4],[-999,-3.1,5]],"제자리멀리뛰기":[[238.1,9999,1],[201.1,238,2],[180.1,201,3],[145.1,180,4],[0,145,5]],"팔굽혀펴기":[[34,9999,1],[25,33,2],[14,24,3],[4,13,4],[0,3,5]],"윗몸말아올리기":[[90,9999,1],[55,89,2],[33,54,3],[14,32,4],[0,13,5]],"악력":[[48.5,9999,1],[40.5,48.4,2],[33,40.4,3],[25,32.9,4],[0,24.9,5]],"50m 달리기":[[0,7,1],[7.01,7.8,2],[7.81,8.5,3],[8.51,11,4],[11.01,9999,5]],"오래달리기걷기":[[0,407,1],[408,472,2],[473,567,3],[568,659,4],[660,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[40,9999,1],[37,39.9,2],[34,36.9,3],[31,33.9,4],[0,30.9,5]]},
        "고1":{"왕복오래달리기":[[70,9999,1],[56,69,2],[42,55,3],[26,41,4],[0,25,5]],"앉아윗몸앞으로굽히기":[[13,9999,1],[9,12.9,2],[4,8.9,3],[-2,3.9,4],[-999,-2.1,5]],"제자리멀리뛰기":[[255.1,9999,1],[216.1,255,2],[195.1,216,3],[160.1,195,4],[0,160,5]],"팔굽혀펴기":[[46,9999,1],[30,45,2],[16,29,3],[7,15,4],[0,6,5]],"윗몸말아올리기":[[90,9999,1],[60,89,2],[35,59,3],[15,34,4],[0,14,5]],"악력":[[61,9999,1],[42.5,60.9,2],[35.5,42.4,3],[29,35.4,4],[0,28.9,5]],"50m 달리기":[[0,7,1],[7.01,7.6,2],[7.61,8.1,3],[8.11,10,4],[10.01,9999,5]],"오래달리기걷기":[[0,398,1],[399,457,2],[458,551,3],[552,639,4],[640,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[43,9999,1],[40,42.9,2],[37,39.9,3],[34,36.9,4],[0,33.9,5]]},
        "고2":{"왕복오래달리기":[[72,9999,1],[58,71,2],[44,57,3],[28,43,4],[0,27,5]],"앉아윗몸앞으로굽히기":[[16,9999,1],[11,15.9,2],[5,10.9,3],[0.1,4.9,4],[0,0,5]],"제자리멀리뛰기":[[258.1,9999,1],[228.1,258,2],[212.1,228,3],[177.1,212,4],[0,177,5]],"팔굽혀펴기":[[50,9999,1],[42,49,2],[25,41,3],[11,24,4],[0,10,5]],"윗몸말아올리기":[[90,9999,1],[60,89,2],[35,59,3],[17,34,4],[0,16,5]],"악력":[[61,9999,1],[46,60.9,2],[39,45.9,3],[31,38.9,4],[0,30.9,5]],"50m 달리기":[[0,6.7,1],[6.71,7.5,2],[7.51,7.9,3],[7.91,9.5,4],[9.51,9999,5]],"오래달리기걷기":[[0,389,1],[390,442,2],[443,535,3],[536,619,4],[620,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[46,9999,1],[43,45.9,2],[40,42.9,3],[37,39.9,4],[0,36.9,5]]},
        "고3":{"왕복오래달리기":[[74,9999,1],[60,73,2],[46,59,3],[30,45,4],[0,29,5]],"앉아윗몸앞으로굽히기":[[16,9999,1],[11,15.9,2],[6,10.9,3],[0.1,5.9,4],[0,0,5]],"제자리멀리뛰기":[[264.1,9999,1],[243.1,264,2],[221.1,243,3],[185.1,221,4],[0,185,5]],"팔굽혀펴기":[[56,9999,1],[46,55,2],[30,45,3],[17,29,4],[0,16,5]],"윗몸말아올리기":[[90,9999,1],[60,89,2],[35,59,3],[17,34,4],[0,16,5]],"악력":[[63.5,9999,1],[46,63.4,2],[39,45.9,3],[31,38.9,4],[0,30.9,5]],"50m 달리기":[[0,6.7,1],[6.71,7.5,2],[7.51,7.9,3],[7.91,8.7,4],[8.71,9999,5]],"오래달리기걷기":[[0,380,1],[381,427,2],[428,519,3],[520,599,4],[600,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[49,9999,1],[46,48.9,2],[43,45.9,3],[40,42.9,4],[0,39.9,5]]}
      },
      "여자":{
        "초4":{"왕복오래달리기":[[77,9999,1],[57,76,2],[40,56,3],[21,39,4],[0,20,5]],"앉아윗몸앞으로굽히기":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"제자리멀리뛰기":[[161.1,9999,1],[135.1,161,2],[119.1,135,3],[97.1,119,4],[0,97,5]],"무릎대고팔굽혀펴기":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"윗몸말아올리기":[[60,9999,1],[29,59,2],[18,28,3],[6,17,4],[0,5,5]],"악력":[[29,9999,1],[18,28.9,2],[13.5,17.9,3],[10.5,13.4,4],[0,10.4,5]],"50m 달리기":[[0,9.4,1],[9.41,10.4,2],[10.41,11,3],[11.01,13.3,4],[13.31,9999,5]],"오래달리기걷기":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[20,9999,1],[17,19.9,2],[14,16.9,3],[11,13.9,4],[0,10.9,5]]},
        "초5":{"왕복오래달리기":[[85,9999,1],[63,84,2],[45,62,3],[23,44,4],[0,22,5]],"앉아윗몸앞으로굽히기":[[10,9999,1],[7,9.9,2],[5,6.9,3],[1,4.9,4],[0,0.9,5]],"제자리멀리뛰기":[[170.1,9999,1],[139.1,170,2],[123.1,139,3],[100.1,123,4],[0,100,5]],"무릎대고팔굽혀펴기":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"윗몸말아올리기":[[60,9999,1],[36,59,2],[23,35,3],[7,22,4],[0,6,5]],"악력":[[29,9999,1],[19,28.9,2],[15.5,18.9,3],[12,15.4,4],[0,11.9,5]],"50m 달리기":[[0,8.9,1],[8.91,9.9,2],[9.91,10.7,3],[10.71,13.3,4],[13.31,9999,5]],"오래달리기걷기":[[0,299,1],[300,359,2],[360,441,3],[442,501,4],[502,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[23,9999,1],[20,22.9,2],[17,19.9,3],[14,16.9,4],[0,13.9,5]]},
        "초6":{"왕복오래달리기":[[93,9999,1],[69,92,2],[50,68,3],[25,49,4],[0,24,5]],"앉아윗몸앞으로굽히기":[[14,9999,1],[10,13.9,2],[5,9.9,3],[2,4.9,4],[0,1.9,5]],"제자리멀리뛰기":[[175.1,9999,1],[144.1,175,2],[127.1,144,3],[100.1,127,4],[0,100,5]],"무릎대고팔굽혀펴기":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"윗몸말아올리기":[[60,9999,1],[43,59,2],[23,42,3],[7,22,4],[0,6,5]],"악력":[[33,9999,1],[22,32.9,2],[19,21.9,3],[14,18.9,4],[0,13.9,5]],"50m 달리기":[[0,8.9,1],[8.91,9.8,2],[9.81,10.7,3],[10.71,12.9,4],[12.91,9999,5]],"오래달리기걷기":[[0,299,1],[300,353,2],[354,429,3],[430,479,4],[480,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[26,9999,1],[23,25.9,2],[20,22.9,3],[17,19.9,4],[0,16.9,5]]},
        "중1":{"왕복오래달리기":[[35,9999,1],[25,34,2],[19,24,3],[14,18,4],[0,13,5]],"앉아윗몸앞으로굽히기":[[15,9999,1],[11,14.9,2],[8,10.9,3],[2,7.9,4],[0,1.9,5]],"제자리멀리뛰기":[[175.1,9999,1],[144.1,175,2],[127.1,144,3],[100.1,127,4],[0,100,5]],"무릎대고팔굽혀펴기":[[45,9999,1],[24,44,2],[14,23,3],[6,13,4],[0,5,5]],"윗몸말아올리기":[[58,9999,1],[43,57,2],[22,42,3],[7,21,4],[0,6,5]],"악력":[[36,9999,1],[23,35.9,2],[19,22.9,3],[14,18.9,4],[0,13.9,5]],"50m 달리기":[[0,8.8,1],[8.81,9.8,2],[9.81,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"오래달리기걷기":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[29,9999,1],[26,28.9,2],[23,25.9,3],[20,22.9,4],[0,19.9,5]]},
        "중2":{"왕복오래달리기":[[40,9999,1],[29,39,2],[21,28,3],[15,20,4],[0,14,5]],"앉아윗몸앞으로굽히기":[[15,9999,1],[11,14.9,2],[8,10.9,3],[2,7.9,4],[0,1.9,5]],"제자리멀리뛰기":[[183.1,9999,1],[145.1,183,2],[127.1,145,3],[100.1,127,4],[0,100,5]],"무릎대고팔굽혀펴기":[[40,9999,1],[24,39,2],[14,23,3],[6,13,4],[0,5,5]],"윗몸말아올리기":[[58,9999,1],[39,57,2],[19,38,3],[7,18,4],[0,6,5]],"악력":[[36,9999,1],[25.5,35.9,2],[19.5,25.4,3],[14,19.4,4],[0,13.9,5]],"50m 달리기":[[0,8.8,1],[8.81,9.8,2],[9.81,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"오래달리기걷기":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[32,9999,1],[29,31.9,2],[26,28.9,3],[23,25.9,4],[0,22.9,5]]},
        "중3":{"왕복오래달리기":[[45,9999,1],[33,44,2],[23,32,3],[16,22,4],[0,15,5]],"앉아윗몸앞으로굽히기":[[16,9999,1],[11,15.9,2],[8,10.9,3],[2,7.9,4],[0,1.9,5]],"제자리멀리뛰기":[[183.1,9999,1],[145.1,183,2],[127.1,145,3],[100.1,127,4],[0,100,5]],"무릎대고팔굽혀펴기":[[40,9999,1],[24,39,2],[14,23,3],[6,13,4],[0,5,5]],"윗몸말아올리기":[[52,9999,1],[34,51,2],[17,33,3],[6,16,4],[0,5,5]],"악력":[[36,9999,1],[27.5,35.9,2],[19.5,27.4,3],[16,19.4,4],[0,15.9,5]],"50m 달리기":[[0,8.8,1],[8.81,9.8,2],[9.81,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"오래달리기걷기":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[35,9999,1],[32,34.9,2],[29,31.9,3],[26,28.9,4],[0,25.9,5]]},
        "고1":{"왕복오래달리기":[[50,9999,1],[37,49,2],[25,36,3],[17,24,4],[0,16,5]],"앉아윗몸앞으로굽히기":[[16,9999,1],[11,15.9,2],[8,10.9,3],[2,7.9,4],[0,1.9,5]],"제자리멀리뛰기":[[186.1,9999,1],[159.1,186,2],[139.1,159,3],[100.1,139,4],[0,100,5]],"무릎대고팔굽혀펴기":[[40,9999,1],[24,39,2],[14,23,3],[6,13,4],[0,5,5]],"윗몸말아올리기":[[40,9999,1],[30,39,2],[13,29,3],[4,12,4],[0,3,5]],"악력":[[36,9999,1],[29,35.9,2],[23,28.9,3],[16.5,22.9,4],[0,16.4,5]],"50m 달리기":[[0,8.8,1],[8.81,9.8,2],[9.81,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"오래달리기걷기":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[38,9999,1],[35,37.9,2],[32,34.9,3],[29,31.9,4],[0,28.9,5]]},
        "고2":{"왕복오래달리기":[[55,9999,1],[41,54,2],[27,40,3],[18,26,4],[0,17,5]],"앉아윗몸앞으로굽히기":[[17,9999,1],[12,16.9,2],[9,11.9,3],[5,8.9,4],[0,4.9,5]],"제자리멀리뛰기":[[186.1,9999,1],[159.1,186,2],[139.1,159,3],[100.1,139,4],[0,100,5]],"무릎대고팔굽혀펴기":[[40,9999,1],[30,39,2],[18,29,3],[9,17,4],[0,8,5]],"윗몸말아올리기":[[40,9999,1],[30,39,2],[13,29,3],[4,12,4],[0,3,5]],"악력":[[37.5,9999,1],[29.5,37.4,2],[25,29.4,3],[18,24.9,4],[0,17.9,5]],"50m 달리기":[[0,8.8,1],[8.81,9.5,2],[9.51,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"오래달리기걷기":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[41,9999,1],[38,40.9,2],[35,37.9,3],[32,34.9,4],[0,31.9,5]]},
        "고3":{"왕복오래달리기":[[55,9999,1],[41,54,2],[27,40,3],[18,26,4],[0,17,5]],"앉아윗몸앞으로굽히기":[[17,9999,1],[12,16.9,2],[9,11.9,3],[5,8.9,4],[0,4.9,5]],"제자리멀리뛰기":[[186.1,9999,1],[159.1,186,2],[139.1,159,3],[100.1,139,4],[0,100,5]],"무릎대고팔굽혀펴기":[[40,9999,1],[30,39,2],[18,29,3],[9,17,4],[0,8,5]],"윗몸말아올리기":[[40,9999,1],[30,39,2],[13,29,3],[4,12,4],[0,3,5]],"악력":[[37.5,9999,1],[29.5,37.4,2],[25,29.4,3],[18,24.9,4],[0,17.9,5]],"50m 달리기":[[0,8.8,1],[8.81,9.5,2],[9.51,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"오래달리기걷기":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"스텝검사":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"던지기":[[44,9999,1],[41,43.9,2],[38,40.9,3],[35,37.9,4],[0,34.9,5]]}
      },
      "BMI":{
        "남자":{
          "초4":[[14.1,20.1,"정상"],[20.2,22.3,"과체중"],[0,14,"마름"],[22.4,24.7,"경도비만"],[24.8,9999,"고도비만"]],
          "초5":[[14.4,20.9,"정상"],[21,23.2,"과체중"],[0,14.3,"마름"],[23.3,25.8,"경도비만"],[25.9,9999,"고도비만"]],
          "초6":[[15,21.7,"정상"],[21.8,24,"과체중"],[0,14.9,"마름"],[24.1,26.8,"경도비만"],[26.9,9999,"고도비만"]],
          "중1":[[15.4,23.2,"정상"],[23.3,24.9,"과체중"],[0,15.3,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]],
          "중2":[[15.8,23.8,"정상"],[23.9,24.9,"과체중"],[0,15.7,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]],
          "중3":[[16.3,24.3,"정상"],[24.4,24.9,"과체중"],[0,16.2,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]],
          "고1":[[16.8,24.6,"정상"],[24.7,24.9,"과체중"],[0,16.7,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]],
          "고2":[[17.3,24.9,"정상"],[25,29.9,"과체중"],[0,17.2,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]],
          "고3":[[17.8,24.9,"정상"],[25,29.9,"과체중"],[0,17.7,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]]
        },
        "여자":{
          "초4":[[13.9,19.9,"정상"],[20,22.1,"과체중"],[0,13.8,"마름"],[22.2,24.7,"경도비만"],[24.8,9999,"고도비만"]],
          "초5":[[14.2,20.8,"정상"],[20.9,23.2,"과체중"],[0,14.1,"마름"],[23.3,25.8,"경도비만"],[25.9,9999,"고도비만"]],
          "초6":[[14.8,21.8,"정상"],[21.9,24.2,"과체중"],[0,14.7,"마름"],[24.3,26.8,"경도비만"],[26.9,9999,"고도비만"]],
          "중1":[[15.2,22.1,"정상"],[22.2,24.7,"과체중"],[0,15.1,"마름"],[24.8,29.9,"경도비만"],[30,9999,"고도비만"]],
          "중2":[[15.7,22.7,"정상"],[22.8,24.9,"과체중"],[0,15.6,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]],
          "중3":[[16.3,23.2,"정상"],[23.3,24.9,"과체중"],[0,16.2,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]],
          "고1":[[16.8,23.6,"정상"],[23.7,24.9,"과체중"],[0,16.7,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]],
          "고2":[[17.3,23.8,"정상"],[23.9,24.9,"과체중"],[0,17.2,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]],
          "고3":[[17.7,23.9,"정상"],[24,24.9,"과체중"],[0,17.6,"마름"],[25,29.9,"경도비만"],[30,9999,"고도비만"]]
        }
      }
    };

    function renderPapsUI() {
        // 기존 요소들 정리
        cleanupSidebar();
        
        $('#sidebarTitle').textContent = 'PAPS 반 목록';
        const formHtml = `
            <div class="sidebar-form-group">
                <input id="papsClassName" type="text" placeholder="새로운 반 이름">
                <button onclick="createPapsClass()" class="btn primary" data-tooltip="새로운 반을 추가합니다.">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>`;
        $('#sidebar-form-container').innerHTML = formHtml;
        renderPapsClassList();

        const selected = papsData.classes.find(c => c.id === papsData.activeClassId);
        if (!selected) {
            $('#content-wrapper').innerHTML = `
                <div class="placeholder-view"><div class="placeholder-content">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/><path d="M7 12h6"/></svg>
                    <h3>PAPS 반을 선택하거나 추가하세요</h3>
                    <p>왼쪽에서 반을 선택하거나 생성해주세요.</p>
                </div></div>`;
        } else {
            renderPapsDashboard(selected);
        }
        
        // PAPS 엑셀 버튼 이벤트 리스너 (중복 방지)
        const exportBtn = $('#exportAllPapsBtn');
        if (exportBtn && !exportBtn.dataset.listenerAdded) {
            exportBtn.addEventListener('click', exportAllPapsToExcel);
            exportBtn.dataset.listenerAdded = 'true';
        }
        
        const importInput = $('#importAllPapsExcel');
        if (importInput && !importInput.dataset.listenerAdded) {
            importInput.addEventListener('change', handleAllPapsExcelUpload);
            importInput.dataset.listenerAdded = 'true';
        }
    }

    function renderPapsClassList() {
        $('#sidebar-list-container').innerHTML = papsData.classes.map(c => `
            <div class="list-card ${c.id === papsData.activeClassId ? 'active' : ''}" onclick="selectPapsClass(${c.id})">
                <div style="flex-grow:1;">
                    <div class="name">${c.name}</div>
                    <div class="details">${(c.students||[]).length}명 · ${c.gradeLevel||'학년 미설정'}</div>
                </div>
                <div class="action-buttons row">
                    <button onclick="event.stopPropagation(); showPapsSettings()" data-tooltip="설정 수정"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button onclick="event.stopPropagation(); deletePapsClass(${c.id})" data-tooltip="삭제"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>
            </div>
        `).join('');
    }

    function createPapsClass() {
        const input = $('#papsClassName');
        const name = input.value.trim();
        if (!name) return;
        const newClass = { id: Date.now(), name, gradeLevel: '', eventSettings: {}, students: [] };
        papsData.classes.push(newClass);
        papsData.activeClassId = newClass.id;
        input.value = '';
        saveDataToFirestore();
        renderPapsUI();
    }

    function editPapsClass(id) {
        const cls = papsData.classes.find(c => c.id === id);
        if (!cls) return;
        showModal({
            title: 'PAPS 반 정보',
            body: `<label>반 이름</label><input id="modal-input-name" class="field" style="width:100%" value="${cls.name}">\
                  <label style="margin-top:8px; display:block;">학년</label><select id="modal-input-grade" class="field" style="width:100%">
                    <option value="">학년 선택</option>
                    <option value="초4">초4</option><option value="초5">초5</option><option value="초6">초6</option>
                    <option value="중1">중1</option><option value="중2">중2</option><option value="중3">중3</option>
                    <option value="고1">고1</option><option value="고2">고2</option><option value="고3">고3</option>
                  </select>`,
            actions: [
                { text: '취소', callback: closeModal },
                { text: '저장', type: 'primary', callback: () => {
                    cls.name = $('#modal-input-name').value.trim() || cls.name;
                    cls.gradeLevel = $('#modal-input-grade').value;
                    saveDataToFirestore();
                    renderPapsUI();
                    // 좌측 사이드바의 반 카드도 실시간으로 업데이트
                    renderPapsClassList();
                    closeModal();
                }}
            ]
        });
        setTimeout(() => { $('#modal-input-grade').value = cls.gradeLevel || ''; }, 0);
    }

    function deletePapsClass(id) {
        showModal({ title: '반 삭제', body: '이 반의 모든 PAPS 데이터가 삭제됩니다. 진행하시겠습니까?', actions: [
            { text: '취소', callback: closeModal },
            { text: '삭제', type: 'danger', callback: () => {
                papsData.classes = papsData.classes.filter(c => c.id !== id);
                if (papsData.activeClassId === id) papsData.activeClassId = null;
                saveDataToFirestore(); renderPapsUI(); closeModal();
            }}
        ]});
    }

    function selectPapsClass(id) { papsData.activeClassId = id; saveDataToFirestore(); renderPapsUI(); }

    function renderPapsDashboard(cls) {
        // 설정이 완료되었는지 확인 (학년과 이벤트 설정이 모두 있는지)
        const hasSettings = cls.gradeLevel && cls.eventSettings && 
                           Object.keys(cls.eventSettings).length > 0;
        
        let settingsCardHtml = '';
        if (!hasSettings) {
            // 설정이 완료되지 않은 경우에만 설정 카드 표시
            settingsCardHtml = `
            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <div class="paps-toolbar" style="justify-content: space-between;">
                        <h3 style="margin: 0;">PAPS 설정</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn primary" id="paps-save-settings-btn">설정 저장</button>
                            <button class="btn" id="paps-download-template-btn">학생 명렬표 양식</button>
                            <input type="file" id="paps-student-upload" class="hidden" accept=".xlsx,.xls,.csv"/>
                            <button class="btn primary" id="paps-load-list-btn">명렬표 불러오기</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="paps-grid">
                        <div class="paps-event-group"><label style="min-width:90px; color: var(--ink-muted);">학년 설정</label>
                            <select id="paps-grade-select">
                                <option value="">학년 선택</option>
                                <option value="초4">초4</option><option value="초5">초5</option><option value="초6">초6</option>
                                <option value="중1">중1</option><option value="중2">중2</option><option value="중3">중3</option>
                                <option value="고1">고1</option><option value="고2">고2</option><option value="고3">고3</option>
                            </select>
                        </div>
                        ${Object.keys(window.papsItems).filter(k=>k!=="체지방").map(category => {
                            const item = window.papsItems[category];
                            const current = cls.eventSettings[item.id] || item.options[0];
                            return `<div class="paps-event-group"><label style="min-width:90px; color: var(--ink-muted);">${category}</label><select data-paps-category="${item.id}">${item.options.map(o => `<option value="${o}" ${o===current?'selected':''}>${o}</option>`).join('')}</select></div>`;
                        }).join('')}
                    </div>
                </div>
            </div>`;
        }
        
        $('#content-wrapper').innerHTML = `
            <div class="paps-toolbar">
                <h2 style="margin:0;">${cls.name} PAPS 설정</h2>
                <div class="row">
                    <span class="paps-chip">학년: ${cls.gradeLevel || '미설정'}</span>
                </div>
            </div>
            ${settingsCardHtml}
            <section class="section-box">
                <div class="paps-toolbar">
                    <h2 style="margin:0;">기록 입력</h2>
                    <div class="row">
                        <button class="btn" id="paps-add-student-btn">학생 추가</button>
                        
                        <button class="btn danger" id="paps-delete-selected-btn">선택 삭제</button>
                    </div>
                </div>
                <div class="paps-table-wrap">
                    <table id="paps-record-table" class="styled-table">
                        <thead id="paps-record-head"></thead>
                        <tbody id="paps-record-body"></tbody>
                    </table>
                </div>
                <div class="paps-toolbar" style="margin-top: 16px; justify-content: center;">
                    <button class="btn primary" id="paps-show-charts-btn">그래프로 보기</button>
                </div>
            </section>
            <section class="section-box" id="paps-chart-section" style="display:none;">
                <div class="paps-toolbar" style="margin-bottom: 0;">
                    <h2 style="margin:0;">등급 빈도 그래프</h2>
                    <div class="row">
                        <div class="paps-legend">
                            <span class="paps-chip grade-1">1등급</span>
                            <span class="paps-chip grade-2">2등급</span>
                            <span class="paps-chip grade-3">3등급</span>
                            <span class="paps-chip grade-4">4등급</span>
                            <span class="paps-chip grade-5">5등급</span>
                            <span class="paps-chip grade-정상">BMI 정상</span>
                        </div>
                        <button class="btn" id="paps-hide-charts-btn">그래프 닫기</button>
                    </div>
                </div>
                <div id="paps-charts" class="paps-chart-grid"></div>
            </section>
        `;

        // Wire up selectors and actions
        if (!hasSettings) {
            // 설정 카드가 있을 때만 설정 관련 이벤트 리스너 추가
            $('#paps-grade-select').value = cls.gradeLevel || '';
            $$('#content-wrapper select[data-paps-category]').forEach(sel => sel.addEventListener('change', e => {
                cls.eventSettings[e.target.dataset.papsCategory] = e.target.value;
                saveDataToFirestore();
                buildPapsTable(cls);
            }));
            $('#paps-grade-select').addEventListener('change', e => { 
                cls.gradeLevel = e.target.value; 
                saveDataToFirestore(); 
                buildPapsTable(cls);
                // 좌측 사이드바의 반 카드도 실시간으로 업데이트
                renderPapsClassList();
            });
            $('#paps-download-template-btn').addEventListener('click', papsDownloadTemplate);
            $('#paps-load-list-btn').addEventListener('click', () => $('#paps-student-upload').click());
            $('#paps-student-upload').addEventListener('change', e => handlePapsStudentUpload(e, cls));
            // 설정 저장 버튼 이벤트 리스너
            const saveSettingsBtn = $('#paps-save-settings-btn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', savePapsSettings);
            }
        }
        
        $('#paps-add-student-btn').addEventListener('click', () => { addPapsStudent(cls); buildPapsTable(cls); saveDataToFirestore(); });
        $('#paps-delete-selected-btn').addEventListener('click', () => deleteSelectedPapsStudents(cls));
        $('#paps-show-charts-btn').addEventListener('click', () => { 
            console.log('그래프로 보기 버튼 클릭됨');
            console.log('현재 클래스:', cls);
            console.log('테이블 행 수:', $('#paps-record-body').querySelectorAll('tr').length);
            
            try {
                renderPapsCharts(cls); 
                $('#paps-chart-section').style.display = 'block';
                console.log('차트 섹션 표시됨');
            } catch (error) {
                console.error('차트 렌더링 중 오류 발생:', error);
                alert('차트를 표시하는 중 오류가 발생했습니다: ' + error.message);
            }
        });
        $('#paps-hide-charts-btn').addEventListener('click', () => { 
            $('#paps-chart-section').style.display = 'none'; 
        });

        buildPapsTable(cls);
    }

    function buildPapsTable(cls) {
        const head = $('#paps-record-head');
        const body = $('#paps-record-body');
        // Header build
        let header1 = '<tr><th rowspan="2"><input type="checkbox" id="paps-select-all"></th><th rowspan="2">번호</th><th rowspan="2">이름</th><th rowspan="2">성별</th>'; let header2 = '<tr>';
        Object.keys(window.papsItems).filter(k=>k!=="체지방").forEach(category => {
            const item = window.papsItems[category]; 
            let eventName = cls.eventSettings[item.id] || item.options[0];
            // 성별에 따라 팔굽혀펴기 종목명 변경
            if (eventName === '팔굽혀펴기') {
                eventName = '팔굽혀펴기/무릎대고 팔굽혀펴기';
            }
            // 악력 종목은 왼손/오른손으로 분리
            if (eventName === '악력') {
                header1 += `<th colspan="4">${eventName}</th>`; 
                header2 += '<th>왼손(kg)</th><th>왼손등급</th><th>오른손(kg)</th><th>오른손등급</th>';
            } else {
                header1 += `<th colspan="2">${eventName}</th>`; 
                header2 += '<th>기록</th><th>등급</th>';
            }
        });
        header1 += '<th colspan="4">체지방</th>'; header2 += '<th>신장(cm)</th><th>체중(kg)</th><th>BMI</th><th>등급</th>';
        header1 += '<th rowspan="2">종합 등급</th></tr>'; header2 += '</tr>';
        head.innerHTML = header1 + header2;
        $('#paps-select-all').addEventListener('change', function(){ body.querySelectorAll('.paps-row-checkbox').forEach(cb => cb.checked = this.checked); });

        // Body
        body.innerHTML = '';
        const students = (cls.students||[]).slice().sort((a,b)=> (a.number||0)-(b.number||0));
        students.forEach(st => {
            const tr = document.createElement('tr'); tr.dataset.sid = st.id;
            tr.innerHTML = `
                <td><input type="checkbox" class="paps-row-checkbox"></td>
                <td><input type="number" class="paps-input number" value="${st.number||''}"></td>
                <td><input type="text" class="paps-input name" value="${st.name||''}"></td>
                <td><select class="paps-input gender"><option value="남자" ${st.gender==='남자'?'selected':''}>남</option><option value="여자" ${st.gender==='여자'?'selected':''}>여</option></select></td>
                ${Object.keys(window.papsItems).filter(k=>k!=="체지방").map(k => {
                    const id = window.papsItems[k].id; 
                    const eventName = cls.eventSettings[id] || window.papsItems[k].options[0];
                    
                    // 악력 종목은 왼손/오른손으로 분리
                    if (eventName === '악력') {
                        const leftVal = (st.records||{})[`${id}_left`]||'';
                        const rightVal = (st.records||{})[`${id}_right`]||'';
                        return `<td><input type=\"number\" step=\"any\" class=\"paps-input rec\" data-id=\"${id}_left\" value=\"${leftVal}\"></td><td class=\"grade-cell\" data-id=\"${id}_left\"></td><td><input type=\"number\" step=\"any\" class=\"paps-input rec\" data-id=\"${id}_right\" value=\"${rightVal}\"></td><td class=\"grade-cell\" data-id=\"${id}_right\"></td>`;
                    } else {
                        const val = (st.records||{})[id]||''; 
                        return `<td><input type=\"number\" step=\"any\" class=\"paps-input rec\" data-id=\"${id}\" value=\"${val}\"></td><td class=\"grade-cell\" data-id=\"${id}\"></td>`;
                    }
                }).join('')}
                <td><input type="number" step="any" class="paps-input height" value="${(st.records||{}).height||''}"></td>
                <td><input type="number" step="any" class="paps-input weight" value="${(st.records||{}).weight||''}"></td>
                <td class="bmi-cell"></td>
                <td class="grade-cell" data-id="bodyfat"></td>
                <td class="overall-grade-cell"></td>
            `;
            body.appendChild(tr);
            updatePapsRowGrades(tr, cls);
        });

        body.addEventListener('input', e => onPapsInput(e, cls));
        body.addEventListener('keydown', e => {
            if (e.key !== 'Enter' || !e.target.matches('input')) return; e.preventDefault();
            const cell = e.target.closest('td'); const row = e.target.closest('tr'); if(!cell||!row) return; const idx = Array.from(row.children).indexOf(cell); const next = row.nextElementSibling; if(next){ const ncell = next.children[idx]; const ninp = ncell?.querySelector('input'); if(ninp){ ninp.focus(); ninp.select(); }}
        });
    }

    function onPapsInput(e, cls) {
        const tr = e.target.closest('tr'); if (!tr) return; const sid = Number(tr.dataset.sid); const st = cls.students.find(s=>s.id===sid); if(!st){ return; }
        st.records = st.records || {};
        if (e.target.classList.contains('rec')) { 
            st.records[e.target.dataset.id] = e.target.value; 
        }
        else if (e.target.classList.contains('height')) { st.records.height = e.target.value; }
        else if (e.target.classList.contains('weight')) { st.records.weight = e.target.value; }
        else if (e.target.classList.contains('name')) { st.name = e.target.value; }
        else if (e.target.classList.contains('number')) { st.number = e.target.value; }
        else if (e.target.classList.contains('gender')) { st.gender = e.target.value; }
        updatePapsRowGrades(tr, cls); saveDataToFirestore();
    }

    function updatePapsRowGrades(tr, cls) {
        // BMI
        const h = parseFloat(tr.querySelector('.height')?.value||''); const w = parseFloat(tr.querySelector('.weight')?.value||'');
        const bmiCell = tr.querySelector('.bmi-cell'); let bmi = null; if (h>0 && w>0){ const m = h/100; bmi = w/(m*m); bmiCell.textContent = bmi.toFixed(2); } else { bmiCell.textContent = ''; }
        // Each category
        const studentGender = tr.querySelector('.gender')?.value || '남자'; const gradeLevel = cls.gradeLevel || '';
        tr.querySelectorAll('.grade-cell').forEach(td => { td.textContent=''; td.className='grade-cell'; });
        Object.keys(window.papsItems).forEach(k => {
            const id = window.papsItems[k].id; 
            const eventName = cls.eventSettings[id] || window.papsItems[k].options[0];
            
            if (id === 'bodyfat') { 
                const value = bmi;
                const td = tr.querySelector(`.grade-cell[data-id="${id}"]`);
                const gradeText = calcPapsGrade(id, value, studentGender, gradeLevel, cls);
                if (td) { td.textContent = gradeText||''; if(gradeText){ td.classList.add(`grade-${gradeText}`); } }
            } else if (eventName === '악력') {
                // 악력은 왼손과 오른손 각각 처리
                const leftValue = parseFloat(tr.querySelector(`.rec[data-id="${id}_left"]`)?.value||'');
                const rightValue = parseFloat(tr.querySelector(`.rec[data-id="${id}_right"]`)?.value||'');
                
                const leftTd = tr.querySelector(`.grade-cell[data-id="${id}_left"]`);
                const rightTd = tr.querySelector(`.grade-cell[data-id="${id}_right"]`);
                
                const leftGradeText = calcPapsGrade(id, leftValue, studentGender, gradeLevel, cls);
                const rightGradeText = calcPapsGrade(id, rightValue, studentGender, gradeLevel, cls);
                
                if (leftTd) { leftTd.textContent = leftGradeText||''; if(leftGradeText){ leftTd.classList.add(`grade-${leftGradeText}`); } }
                if (rightTd) { rightTd.textContent = rightGradeText||''; if(rightGradeText){ rightTd.classList.add(`grade-${rightGradeText}`); } }
            } else {
                const value = parseFloat(tr.querySelector(`.rec[data-id="${id}"]`)?.value||'');
                const td = tr.querySelector(`.grade-cell[data-id="${id}"]`);
                const gradeText = calcPapsGrade(id, value, studentGender, gradeLevel, cls);
                if (td) { td.textContent = gradeText||''; if(gradeText){ td.classList.add(`grade-${gradeText}`); } }
            }
        });
        // Overall
        const overall = tr.querySelector('.overall-grade-cell'); overall.textContent = calcOverallGrade(tr) || '';
    }

    function calcPapsGrade(categoryId, value, gender, gradeLevel, cls){
        if (value==null || value==='' || isNaN(value) || !gender || !gradeLevel) return '';
        let selectedTest = null;
        if (categoryId === 'bodyfat') selectedTest = 'BMI';
        else {
            const catKey = Object.keys(window.papsItems).find(k => window.papsItems[k].id === categoryId);
            selectedTest = cls.eventSettings[categoryId] || window.papsItems[catKey].options[0];
            
            // 성별에 따라 팔굽혀펴기 종목명 변경
            if (selectedTest === '팔굽혀펴기' && gender === '여자') {
                selectedTest = '무릎대고팔굽혀펴기';
            }
        }
        let criteria;
        if (selectedTest === 'BMI') criteria = papsCriteriaData?.BMI?.[gender]?.[gradeLevel];
        else criteria = papsCriteriaData?.[gender]?.[gradeLevel]?.[selectedTest];
        if (!criteria) return '';
        for (const [a,b,g] of criteria){ const min = Math.min(a,b), max=Math.max(a,b); if (value>=min && value<=max) return typeof g==='number'? String(g): g; }
        return '';
    }

    function calcOverallGrade(tr){
        const grades = []; tr.querySelectorAll('.grade-cell').forEach(td => { const t = td.textContent.trim(); if(!t) return; const n = parseInt(t); if(!isNaN(n)) grades.push(n); else { if(t==='정상') grades.push(1); if(t==='과체중') grades.push(3); if(t==='마름') grades.push(4); if(t==='경도비만') grades.push(4); if(t==='고도비만') grades.push(5); } });
        if (grades.length===0) return '';
        const avg = grades.reduce((a,b)=>a+b,0)/grades.length; return Math.round(avg)+"등급";
    }

    function addPapsStudent(cls){ const id = Date.now(); cls.students.push({ id, number: (cls.students?.length||0)+1, name: '', gender: '남자', records: {} }); }
    function deleteSelectedPapsStudents(cls){ const rows = Array.from($('#paps-record-body').querySelectorAll('tr')); const keep = []; rows.forEach(r => { const checked = r.querySelector('.paps-row-checkbox')?.checked; const sid = Number(r.dataset.sid); if(!checked) keep.push(sid); }); cls.students = (cls.students||[]).filter(s=>keep.includes(s.id)); buildPapsTable(cls); saveDataToFirestore(); }

    function papsDownloadTemplate(){ const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet([["번호","이름","성별"],[1,'김체육','남자'],[2,'박건강','여자']]); ws['!cols']=[{wch:8},{wch:14},{wch:8}]; XLSX.utils.book_append_sheet(wb, ws, '학생 명렬표'); XLSX.writeFile(wb, 'PAPS_학생명렬표_양식.xlsx'); }

    // PAPS 설정 저장 및 수정 기능
    function savePapsSettings() {
        const selectedClass = papsData.classes.find(c => c.id === papsData.activeClassId);
        if (!selectedClass) return;
        
        // 학년 설정 저장
        const gradeSelect = $('#paps-grade-select');
        if (gradeSelect) {
            selectedClass.gradeLevel = gradeSelect.value;
        }
        
        // 이벤트 설정 저장
        const eventSelects = document.querySelectorAll('[data-paps-category]');
        eventSelects.forEach(select => {
            const category = select.dataset.papsCategory;
            selectedClass.eventSettings = selectedClass.eventSettings || {};
            selectedClass.eventSettings[category] = select.value;
        });
        
        // 데이터 저장
        saveDataToFirestore();
        
        // 설정 카드 완전히 제거
        const settingsCard = document.querySelector('.card');
        if (settingsCard) {
            settingsCard.remove();
        }
        
        // 좌측 사이드바 업데이트
        renderPapsClassList();
        
        alert('설정이 저장되었습니다.');
    }

    function showPapsSettings() {
        const selectedClass = papsData.classes.find(c => c.id === papsData.activeClassId);
        if (!selectedClass) return;
        
        // 설정 카드가 이미 있는지 확인하고 제거
        const existingCard = document.querySelector('.card');
        if (existingCard) {
            existingCard.remove();
        }
        
        // 설정 카드 강제 생성 (설정 완료 여부와 관계없이)
        const settingsCardHtml = `
            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <div class="paps-toolbar" style="justify-content: space-between;">
                        <h3 style="margin: 0;">PAPS 설정</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn primary" id="paps-save-settings-btn">설정 저장</button>
                            <button class="btn" id="paps-download-template-btn">학생 명렬표 양식</button>
                            <input type="file" id="paps-student-upload" class="hidden" accept=".xlsx,.xls,.csv"/>
                            <button class="btn primary" id="paps-load-list-btn">명렬표 불러오기</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="paps-grid">
                        <div class="paps-event-group"><label style="min-width:90px; color: var(--ink-muted);">학년 설정</label>
                            <select id="paps-grade-select">
                                <option value="">학년 선택</option>
                                <option value="초4">초4</option><option value="초5">초5</option><option value="초6">초6</option>
                                <option value="중1">중1</option><option value="중2">중2</option><option value="중3">중3</option>
                                <option value="고1">고1</option><option value="고2">고2</option><option value="고3">고3</option>
                            </select>
                        </div>
                        ${Object.keys(window.papsItems).filter(k=>k!=="체지방").map(category => {
                            const item = window.papsItems[category];
                            const current = selectedClass.eventSettings[item.id] || item.options[0];
                            return `<div class="paps-event-group"><label style="min-width:90px; color: var(--ink-muted);">${category}</label><select data-paps-category="${item.id}">${item.options.map(o => `<option value="${o}" ${o===current?'selected':''}>${o}</option>`).join('')}</select></div>`;
                        }).join('')}
                    </div>
                </div>
            </div>`;
        
        // 설정 카드를 메인 컨텐츠 상단에 삽입
        const contentWrapper = $('#content-wrapper');
        const firstSection = contentWrapper.querySelector('section');
        if (firstSection) {
            firstSection.insertAdjacentHTML('beforebegin', settingsCardHtml);
        } else {
            contentWrapper.insertAdjacentHTML('beforeend', settingsCardHtml);
        }
        
        // 이벤트 리스너 추가
        $('#paps-grade-select').value = selectedClass.gradeLevel || '';
        $$('#content-wrapper select[data-paps-category]').forEach(sel => sel.addEventListener('change', e => {
            selectedClass.eventSettings[e.target.dataset.papsCategory] = e.target.value;
            saveDataToFirestore();
            buildPapsTable(selectedClass);
        }));
        $('#paps-grade-select').addEventListener('change', e => { 
            selectedClass.gradeLevel = e.target.value; 
            saveDataToFirestore(); 
            buildPapsTable(selectedClass);
            renderPapsClassList();
        });
        $('#paps-download-template-btn').addEventListener('click', papsDownloadTemplate);
        $('#paps-load-list-btn').addEventListener('click', () => $('#paps-student-upload').click());
        $('#paps-student-upload').addEventListener('change', e => handlePapsStudentUpload(e, selectedClass));
        $('#paps-save-settings-btn').addEventListener('click', savePapsSettings);
    }

    function handlePapsStudentUpload(event, cls){ const file = event.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = e => { try { const data = new Uint8Array(e.target.result); const wb = XLSX.read(data,{type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(ws,{header:1}); const newStudents=[]; for(let i=1;i<json.length;i++){ const row = json[i]; if(!row||row.length===0) continue; const num=row[0]; const name=row[1]; let gender=row[2]||'남자'; if(typeof gender==='string'){ if(gender.includes('여')) gender='여자'; else gender='남자'; } else gender='남자'; newStudents.push({ id: Date.now()+i, number: num, name, gender, records:{} }); } cls.students = newStudents; buildPapsTable(cls); saveDataToFirestore(); alert('학생 명렬표를 불러왔습니다.'); } catch(err){ alert('파일 처리 중 오류가 발생했습니다.'); } finally { event.target.value=''; } }; reader.readAsArrayBuffer(file); }

    // ========================================
    // 수업 진도표 UI 및 로직
    // ========================================
    
    // 수업 진도표 데이터 저장 키
    const LS_PROGRESS_KEY = 'progressClasses';
    const LS_PROGRESS_SELECTED = 'progressSelectedClassId';
    const LS_PROGRESS_SETTING_COLLAPSED = 'progressSettingCollapsed';

    function renderProgressUI() {
        console.log('renderProgressUI 시작');
        console.log('progressClasses.length:', progressClasses.length);
        console.log('progressClasses:', progressClasses);
        
        // 기존 요소들 정리
        cleanupSidebar();
        
        $('#sidebarTitle').textContent = '수업 진도 관리';
        
        // 사이드바에 반 목록과 시간표 표시
        const formHtml = `
            <div class="sidebar-form-group">
                <input id="progressClassNameInput" type="text" placeholder="새로운 반 이름">
                <button id="progressAddClassBtn" class="btn primary" data-tooltip="새로운 반을 추가합니다.">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>
            <div id="progressClassList" class="progress-class-list"></div>
        `;
        $('#sidebar-form-container').innerHTML = formHtml;
        
        // 사이드바 푸터에 방문자 수와 저작권 추가
        const sidebarFooter = $('.sidebar-footer');
        if (sidebarFooter) {
            sidebarFooter.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <div class="visitor-info" style="justify-content: center; font-size: 0.8rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px;">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>총 방문자 수 : <span id="progress-visitor-count" style="font-weight: 600; color: var(--accent);">-</span></span>
                    </div>
                </div>
                <div>만든이: 김신회(laguyo87@gmail.com)</div>
            `;
            
            // 방문자 수 업데이트
            updateProgressVisitorCount();
        }
        
        // 클래스 목록 렌더링
        console.log('진도표 클래스 목록 렌더링 시작');
        renderProgressClassList();
        
        // 메인 콘텐츠 영역에 진도표만 표시
        console.log('진도표 메인 콘텐츠 렌더링');
        $('#content-wrapper').innerHTML = `
            <div class="progress-main-content">
                <div class="progress-right">
                    <div class="progress-right-header">
                        <div class="progress-setting-header" id="progressSettingHeader">
                            <div class="title">수업 설정</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                디버그: 진도표 클래스 수 ${progressClasses.length}, 선택된 ID: ${progressSelectedClassId}
                            </div>
                        </div>
                        <div class="progress-setting-bar">
                            <div class="progress-setting-controls" id="progressSettingControls">
                                <label for="progressTeacherName">담당교사</label>
                                <input id="progressTeacherName" type="text" placeholder="담당교사명 입력" />
                                <label for="progressUnitContent">단원 내용</label>
                                <input id="progressUnitContent" type="text" placeholder="단원 내용 입력" />
                                <label for="progressWeeklyHours">주당 시간</label>
                                <select id="progressWeeklyHours">
                                    <option value="1">1시간</option>
                                    <option value="2">2시간</option>
                                    <option value="3">3시간</option>
                                    <option value="4">4시간</option>
                                    <option value="5">5시간</option>
                                </select>
                                <button id="progressSaveSettingBtn" class="save">설정 저장</button>
                            </div>
                        </div>
                    </div>
                    <div class="progress-right-body">
                        <div class="progress-sheet-header">
                            <h2>수업 기록 관리</h2>
                        </div>
                        <div id="progressSheetArea" class="progress-sheet">
                            <div class="progress-empty">반을 선택하고 "설정 저장"을 누르면 진도표가 생성됩니다.</div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 데이터 로드 및 초기화 (Firebase에서 이미 로드됨)
        // loadProgressClasses(); // Firebase에서 이미 로드했으므로 제거
        loadProgressSelected();
        renderProgressClassList();
        
        
        
        // 이벤트 리스너 등록 (DOM이 생성된 후)
        setTimeout(() => {
            setupProgressEventListeners();
        }, 0);
        
        if(progressSelectedClassId) {
            loadProgressToRight(progressSelectedClassId);
        } else {
            // 선택된 반이 없을 때도 제목 업데이트
            updateProgressSheetTitle();
        }
    }

    function setupProgressEventListeners() {
        // 반 추가
        $('#progressClassNameInput').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                e.preventDefault();
                addProgressClass();
            }
        });
        $('#progressAddClassBtn').addEventListener('click', addProgressClass);

        // 설정 저장
        $('#progressSaveSettingBtn').addEventListener('click', () => {
            console.log('설정 저장 버튼 클릭됨');
            const c = getProgressSelected();
            if(!c) {
                console.log('선택된 반이 없음');
                return alert('반을 먼저 선택하세요.');
            }
            console.log('선택된 반:', c);
            const hours = parseInt($('#progressWeeklyHours').value, 10);
            const teacherName = $('#progressTeacherName').value.trim();
            const unitContent = $('#progressUnitContent').value.trim();
            console.log('설정값:', { hours, teacherName, unitContent });
            
            c.weeklyHours = hours;
            c.teacherName = teacherName;
            c.unitContent = unitContent;

            // 주차가 없다면 1주 생성
            if(!c.weeks || c.weeks.length === 0){
                c.weeks = [ makeProgressWeek(hours) ];
                console.log('새 주차 생성:', c.weeks);
            } else {
                // 기존 주차들의 차시 수를 현재 설정에 맞게 보정
                c.weeks = c.weeks.map(w => normalizeProgressWeek(w, hours));
                console.log('기존 주차 보정:', c.weeks);
            }
            saveProgressClasses();
            renderProgressClassList();
            renderProgressSheet(c);
            
            
            // 수업 설정 카드 전체 숨기기
            $('#progressSettingHeader').parentElement.style.display = 'none';
            
            console.log('진도표 렌더링 완료');
        });


    }


    function loadProgressClasses(){
        try {
            const raw = localStorage.getItem(LS_PROGRESS_KEY);
            progressClasses = raw ? JSON.parse(raw) : [];
        } catch(e){ 
            progressClasses = []; 
        }
    }

    function saveProgressClasses(){
        localStorage.setItem(LS_PROGRESS_KEY, JSON.stringify(progressClasses));
        renderProgressClassList();
        saveDataToFirestore();
    }

    function loadProgressSelected(){
        progressSelectedClassId = localStorage.getItem(LS_PROGRESS_SELECTED) || '';
    }

    function saveProgressSelected(id){
        progressSelectedClassId = id;
        localStorage.setItem(LS_PROGRESS_SELECTED, id || '');
        saveDataToFirestore();
    }






    function uuid(){
        return 'c-' + Math.random().toString(36).slice(2,9);
    }


    function renderProgressClassList(){
        console.log('=== renderProgressClassList 시작 ===');
        console.log('progressClasses.length:', progressClasses.length);
        console.log('progressClasses:', progressClasses);
        
        $('#progressClassList').innerHTML = '';
        if(progressClasses.length === 0){
            console.log('클래스가 없음, 빈 상태 메시지 표시');
            const empty = document.createElement('div');
            empty.className = 'empty';
            empty.textContent = '아직 생성된 반이 없습니다.';
            $('#progressClassList').appendChild(empty);
            return;
        }
        
        console.log('클래스 목록 렌더링 시작, 클래스 수:', progressClasses.length);
        progressClasses.forEach(c => {
            const card = document.createElement('div');
            card.className = 'btn' + (c.id === progressSelectedClassId ? ' active' : '');
            card.style.justifyContent = 'space-between';
            card.style.marginBottom = '8px';
            card.addEventListener('click', () => {
                saveProgressSelected(c.id);
                renderProgressClassList();
                loadProgressToRight(c.id);
            });

            const leftContent = document.createElement('div');
            leftContent.style.display = 'flex';
            leftContent.style.flexDirection = 'column';
            leftContent.style.flexGrow = '1';

            const title = document.createElement('span');
            title.textContent = c.name;

            const meta = document.createElement('span');
            meta.style.fontSize = '0.8rem';
            // 활성화된 카드의 메타 텍스트는 흰색으로, 비활성화된 카드는 회색으로
            meta.style.color = c.id === progressSelectedClassId ? 'white' : 'var(--ink-muted)';
            const parts = [];
            if(c.weeklyHours) parts.push(`주당 ${c.weeklyHours}시간`);
            if(c.teacherName) parts.push(`${c.teacherName} 선생님`);
            if(c.unitContent) parts.push(c.unitContent);
            
            if(parts.length > 0){
                meta.textContent = parts.join(' • ');
            } else {
                meta.textContent = '설정 미정';
            }

            leftContent.appendChild(title);
            leftContent.appendChild(meta);

            // 버튼 컨테이너
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '4px';

            // 수정 버튼
            const editBtn = document.createElement('button');
            editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
            editBtn.style.background = 'none';
            editBtn.style.border = 'none';
            editBtn.style.padding = '4px';
            editBtn.style.cursor = 'pointer';
            editBtn.style.borderRadius = '4px';
            editBtn.style.color = c.id === progressSelectedClassId ? 'white' : 'var(--ink-muted)';
            editBtn.style.transition = 'all 0.2s ease';
            editBtn.title = '수업 설정 수정';
            
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                editProgressClassSettings(c.id);
            });

            editBtn.addEventListener('mouseenter', () => {
                editBtn.style.background = 'rgba(59, 130, 246, 0.1)';
                editBtn.style.color = '#3b82f6';
            });

            editBtn.addEventListener('mouseleave', () => {
                editBtn.style.background = 'none';
                editBtn.style.color = c.id === progressSelectedClassId ? 'white' : 'var(--ink-muted)';
            });

            // 삭제 버튼
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>';
            deleteBtn.style.background = 'none';
            deleteBtn.style.border = 'none';
            deleteBtn.style.padding = '4px';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.style.borderRadius = '4px';
            deleteBtn.style.color = c.id === progressSelectedClassId ? 'white' : 'var(--ink-muted)';
            deleteBtn.style.transition = 'all 0.2s ease';
            deleteBtn.title = '반 삭제';
            
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if(confirm(`"${c.name}" 반을 삭제하시겠습니까?`)) {
                    deleteProgressClass(c.id);
                }
            });

            deleteBtn.addEventListener('mouseenter', () => {
                deleteBtn.style.background = 'rgba(220, 38, 38, 0.1)';
                deleteBtn.style.color = '#dc2626';
            });

            deleteBtn.addEventListener('mouseleave', () => {
                deleteBtn.style.background = 'none';
                deleteBtn.style.color = c.id === progressSelectedClassId ? 'white' : 'var(--ink-muted)';
            });

            buttonContainer.appendChild(editBtn);
            buttonContainer.appendChild(deleteBtn);
            
            card.appendChild(leftContent);
            card.appendChild(buttonContainer);
            $('#progressClassList').appendChild(card);
        });
        
        console.log('=== renderProgressClassList 완료 ===');
        console.log('렌더링된 클래스 수:', progressClasses.length);
    }

    function editProgressClassSettings(classId) {
        // 해당 반을 선택
        saveProgressSelected(classId);
        renderProgressClassList();
        loadProgressToRight(classId);
        
        // 수업 설정 카드 전체 다시 표시
        $('#progressSettingHeader').parentElement.style.display = 'block';
    }

    function updateProgressSheetTitle() {
        const selectedClass = getProgressSelected();
        const titleElement = document.querySelector('.progress-sheet-header h2');
        if (selectedClass) {
            titleElement.textContent = `${selectedClass.name} - 수업 기록 관리`;
        } else {
            titleElement.textContent = '수업 기록 관리';
        }
    }

    function getProgressSelected(){
        return progressClasses.find(c => c.id === progressSelectedClassId);
    }

    function loadProgressToRight(id){
        const c = progressClasses.find(c => c.id === id);
        if(!c){
            $('#progressSelectedClassInfo').innerHTML = '선택된 반 없음';
            $('#progressTeacherName').value = '';
            $('#progressUnitContent').value = '';
            $('#progressWeeklyHours').value = '1';
            $('#progressSheetArea').innerHTML = '<div class="progress-empty">반을 선택하고 "설정 저장"을 누르면 진도표가 생성됩니다.</div>';
            // 제목 업데이트 (반이 선택되지 않았을 때)
            updateProgressSheetTitle();
            return;
        }
        
        
        // 제목 업데이트
        updateProgressSheetTitle();
        
        // 수업 설정 폼에 값 설정
        $('#progressTeacherName').value = c.teacherName || '';
        $('#progressUnitContent').value = c.unitContent || '';
        if(c.weeklyHours){
            $('#progressWeeklyHours').value = String(c.weeklyHours);
            renderProgressSheet(c);
            // 설정이 저장된 반이면 수업 설정 카드 숨기기
            $('#progressSettingHeader').parentElement.style.display = 'none';
        } else {
            $('#progressWeeklyHours').value = '1';
            $('#progressSheetArea').innerHTML = '<div class="progress-empty">"수업 설정"에서 주당 시간을 저장하면 진도표가 생성됩니다.</div>';
            // 설정이 저장되지 않은 반이면 수업 설정 카드 표시
            $('#progressSettingHeader').parentElement.style.display = 'block';
        }
    }

    function addProgressClass(){
        const name = $('#progressClassNameInput').value.trim();
        if(!name) return;
        const newClass = { id: uuid(), name, teacherName: '', unitContent: '', weeklyHours: 0, weeks: [] };
        progressClasses.push(newClass);
        saveProgressClasses();
        $('#progressClassNameInput').value = '';
        saveProgressSelected(newClass.id);
        renderProgressClassList();
        loadProgressToRight(newClass.id);
        
        // 새로운 반 생성 시 수업 설정 카드 표시
        $('#progressSettingHeader').parentElement.style.display = 'block';
    }
    
    function deleteProgressClass(classId) {
        const classIndex = progressClasses.findIndex(c => c.id === classId);
        if (classIndex === -1) return;
        
        // 삭제할 반이 현재 선택된 반이면 선택 해제
        if (progressSelectedClassId === classId) {
            progressSelectedClassId = '';
            saveProgressSelected('');
        }
        
        // 반 삭제
        progressClasses.splice(classIndex, 1);
        saveProgressClasses();
        renderProgressClassList();
        
        // 선택된 반이 삭제되었으면 우측 영역 완전 초기화
        if (progressSelectedClassId === '') {
            // 수업 설정 폼 초기화
            $('#progressTeacherName').value = '';
            $('#progressUnitContent').value = '';
            $('#progressWeeklyHours').value = '1';
            
            // 수업 기록 테이블 초기화
            $('#progressSheetArea').innerHTML = '<div class="progress-empty">반을 선택하고 "설정 저장"을 누르면 진도표가 생성됩니다.</div>';
            
            // 제목 초기화
            updateProgressSheetTitle();
            
            // 수업 설정 카드 표시
            $('#progressSettingHeader').parentElement.style.display = 'block';
        }
    }
    
    // 전역 함수로 등록
    window.addProgressClass = addProgressClass;
    window.deleteProgressClass = deleteProgressClass;
    window.refreshData = refreshData;

    function makeProgressWeek(hours){
        return {
            sessions: Array.from({length: hours}, (_, i) => ({ date: '', note: '' }))
        };
    }

    function normalizeProgressWeek(week, hours){
        const cur = week.sessions || [];
        if(cur.length === hours) return week;
        if(cur.length > hours){
            week.sessions = cur.slice(0, hours);
        } else {
            const add = Array.from({length: hours - cur.length}, () => ({ date:'', note:'' }));
            week.sessions = cur.concat(add);
        }
        return week;
    }

    function renderProgressSheet(c){
        const hours = c.weeklyHours || 0;

        const wrapper = document.createElement('div');
        wrapper.className = 'progress-sheet-weeks';

        // 주차 컬럼들
        const weeksWrap = document.createElement('div');
        weeksWrap.className = 'progress-weeks';

        // 보정: 최소 1주는 있어야 "+"가 동작 의미가 분명
        if(!c.weeks || c.weeks.length === 0){
            c.weeks = [ makeProgressWeek(hours) ];
        }

        c.weeks.forEach((w, wi) => {
            w = normalizeProgressWeek(w, hours);
            const col = document.createElement('div');
            col.className = 'progress-week-col';

            const head = document.createElement('div');
            head.className = 'week-head';
            const title = document.createElement('div');
            title.className = 'title';
            title.textContent = `${wi+1}주`;
            head.appendChild(title);

            // 요구사항: "1주 제목 옆에 '+'" → 첫 컬럼 헤드에 배치
            if(wi === c.weeks.length - 1){
                // 버튼 컨테이너
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'buttons';
                
                // '+' 버튼
                const addNextBtn = document.createElement('button');
                addNextBtn.className = 'add-next';
                addNextBtn.textContent = '＋';
                addNextBtn.title = '다음 주 추가';
                addNextBtn.addEventListener('click', () => {
                    c.weeks.push(makeProgressWeek(c.weeklyHours));
                    saveProgressClasses();
                    renderProgressSheet(c);
                });
                buttonsContainer.appendChild(addNextBtn);
                
                // '-' 버튼 (주차가 2개 이상일 때만)
                if(c.weeks.length > 1){
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-week';
                    removeBtn.textContent = '－';
                    removeBtn.title = '이 주차 삭제';
                    removeBtn.addEventListener('click', () => {
                        if(confirm('이 주차를 삭제하시겠습니까?')){
                            c.weeks.splice(wi, 1);
                            saveProgressClasses();
                            renderProgressSheet(c);
                        }
                    });
                    buttonsContainer.appendChild(removeBtn);
                }
                
                head.appendChild(buttonsContainer);
            } else {
                const spacer = document.createElement('div');
                spacer.style.width = '24px';
                head.appendChild(spacer);
            }
            col.appendChild(head);

            // 세션 행들
            w.sessions.forEach((s, si) => {
                const ses = document.createElement('div');
                ses.className = 'progress-session';

                const titleRow = document.createElement('div');
                titleRow.className = 'session-title-row';
                
                const sesTitle = document.createElement('div');
                sesTitle.className = 'session-title';
                // 전체 차시 수 계산: 이전 주차들의 차시 수 + 현재 주차의 차시 순서
                const totalSessionNumber = (wi * hours) + si + 1;
                sesTitle.textContent = `${totalSessionNumber}차시`;

                const dateInput = document.createElement('input');
                dateInput.type = 'date';
                dateInput.className = 'session-date';
                if(s.date) dateInput.value = s.date;
                
                // 요일 표시 요소
                const dayOfWeek = document.createElement('span');
                dayOfWeek.className = 'day-of-week';
                if(s.date) {
                    const date = new Date(s.date);
                    const dayNames = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
                    dayOfWeek.textContent = dayNames[date.getDay()];
                }
                
                dateInput.addEventListener('change', () => {
                    s.date = dateInput.value;
                    if(s.date) {
                        const date = new Date(s.date);
                        const dayNames = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
                        dayOfWeek.textContent = dayNames[date.getDay()];
                    } else {
                        dayOfWeek.textContent = '';
                    }
                    saveProgressClasses();
                });

                titleRow.appendChild(sesTitle);
                titleRow.appendChild(dateInput);
                titleRow.appendChild(dayOfWeek);

                const ta = document.createElement('textarea');
                ta.maxLength = 300;
                ta.placeholder = '수업 기록';
                ta.value = s.note || '';

                ta.addEventListener('input', () => {
                    s.note = ta.value;
                    saveProgressClasses();
                });

                ses.appendChild(titleRow);
                ses.appendChild(ta);
                col.appendChild(ses);
            });

            weeksWrap.appendChild(col);
        });

        wrapper.appendChild(weeksWrap);

        // 최종 렌더
        $('#progressSheetArea').innerHTML = '';
        $('#progressSheetArea').appendChild(wrapper);
    }


    function exportPapsToExcel(cls){ 
        if(!cls || !cls.students || cls.students.length===0){ alert('내보낼 데이터가 없습니다.'); return; } 
        const header1=["번호","이름","성별"], header2=["","",""]; 
        const merges=[]; let col=3; 
        Object.keys(window.papsItems).filter(k=>k!=="체지방").forEach(k=>{ 
            const id=window.papsItems[k].id; 
            let name=cls.eventSettings[id]||window.papsItems[k].options[0]; 
            if (name === '팔굽혀펴기') { 
                name = '팔굽혀펴기/무릎대고 팔굽혀펴기'; 
            }
            // 악력 종목은 왼손/오른손으로 분리
            if (name === '악력') {
                header1.push(name,"","",""); 
                header2.push("왼손(kg)","왼손등급","오른손(kg)","오른손등급"); 
                merges.push({s:{r:0,c:col},e:{r:0,c:col+3}}); 
                col+=4; 
            } else {
                header1.push(name,""); 
                header2.push("기록","등급"); 
                merges.push({s:{r:0,c:col},e:{r:0,c:col+1}}); 
                col+=2; 
            }
        }); 
        header1.push("체지방","","",""); 
        header2.push("신장(cm)","체중(kg)","BMI","등급"); 
        merges.push({s:{r:0,c:col},e:{r:0,c:col+3}}); 
        col+=4; 
        header1.push("종합 등급"); 
        const data=[header1,header2]; 
        $('#paps-record-body').querySelectorAll('tr').forEach(tr=>{ 
            const row=[]; 
            row.push(tr.querySelector('.number')?.value||''); 
            row.push(tr.querySelector('.name')?.value||''); 
            const gsel = tr.querySelector('.gender'); 
            row.push(gsel?.options[gsel.selectedIndex].text||''); 
            
            // 종목별 데이터 처리
            Object.keys(window.papsItems).filter(k=>k!=="체지방").forEach(k => {
                const id = window.papsItems[k].id;
                const eventName = cls.eventSettings[id] || window.papsItems[k].options[0];
                
                if (eventName === '악력') {
                    // 악력은 왼손/오른손 각각 처리
                    const leftInput = tr.querySelector(`.rec[data-id="${id}_left"]`);
                    const rightInput = tr.querySelector(`.rec[data-id="${id}_right"]`);
                    const leftGrade = tr.querySelector(`.grade-cell[data-id="${id}_left"]`);
                    const rightGrade = tr.querySelector(`.grade-cell[data-id="${id}_right"]`);
                    
                    row.push(leftInput?.value || '');
                    row.push(leftGrade?.textContent || '');
                    row.push(rightInput?.value || '');
                    row.push(rightGrade?.textContent || '');
                } else {
                    const input = tr.querySelector(`.rec[data-id="${id}"]`);
                    const grade = input?.closest('td').nextElementSibling;
                    row.push(input?.value || '');
                    row.push(grade?.textContent || '');
                }
            });
            
            row.push(tr.querySelector('.height')?.value||''); 
            row.push(tr.querySelector('.weight')?.value||''); 
            row.push(tr.querySelector('.bmi-cell')?.textContent||''); 
            row.push(tr.querySelector('.grade-cell[data-id="bodyfat"]')?.textContent||''); 
            row.push(tr.querySelector('.overall-grade-cell')?.textContent||''); 
            data.push(row); 
        }); 
        const ws = XLSX.utils.aoa_to_sheet(data); 
        ws['!merges']=merges; 
        const wb=XLSX.utils.book_new(); 
        XLSX.utils.book_append_sheet(wb, ws, `${cls.name} PAPS 기록`); 
        XLSX.writeFile(wb, `${cls.name}_PAPS_기록.xlsx`); 
    }

    function exportAllPapsToExcel() {
        if (!papsData || !papsData.classes || papsData.classes.length === 0) {
            alert('내보낼 PAPS 데이터가 없습니다.');
            return;
        }

        const wb = XLSX.utils.book_new();
        
        papsData.classes.forEach(cls => {
            if (!cls.students || cls.students.length === 0) return;
            
            const header1 = ["번호", "이름", "성별", "학년"];
            const header2 = ["", "", "", ""];
            const merges = [];
            let col = 4;
            
            // 종목별 헤더 생성 (기록만)
            Object.keys(window.papsItems).filter(k => k !== "체지방").forEach(k => {
                const id = window.papsItems[k].id;
                let name = cls.eventSettings[id] || window.papsItems[k].options[0];
                if (name === '팔굽혀펴기') {
                    name = '팔굽혀펴기/무릎대고 팔굽혀펴기';
                }
                // 악력 종목은 왼손/오른손으로 분리
                if (name === '악력') {
                    header1.push(name, name);
                    header2.push("왼손(kg)", "오른손(kg)");
                    col += 2;
                } else {
                    header1.push(name);
                    header2.push("기록");
                    col += 1;
                }
            });
            
            // 체지방 헤더 추가 (기록만)
            header1.push("신장(cm)", "체중(kg)");
            header2.push("", "");
            
            const data = [header1, header2];
            
            // 학생 데이터 추가
            cls.students.forEach(student => {
                const row = [];
                row.push(student.number || '');
                row.push(student.name || '');
                row.push(student.gender || '');
                row.push(cls.gradeLevel || '');
                
                // 종목별 기록만
                Object.keys(window.papsItems).filter(k => k !== "체지방").forEach(k => {
                    const id = window.papsItems[k].id;
                    const eventName = cls.eventSettings[id] || window.papsItems[k].options[0];
                    
                    if (eventName === '악력') {
                        // 악력은 왼손/오른손 각각 처리
                        const leftRecord = student.records?.[`${id}_left`] || '';
                        const rightRecord = student.records?.[`${id}_right`] || '';
                        row.push(leftRecord);
                        row.push(rightRecord);
                    } else {
                        const record = student.records?.[id] || '';
                        row.push(record);
                    }
                });
                
                // 체지방 관련 데이터 (기록만)
                const height = student.records?.height || '';
                const weight = student.records?.weight || '';
                row.push(height);
                row.push(weight);
                
                data.push(row);
            });
            
            // 워크시트 생성
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!merges'] = merges;
            ws['!cols'] = Array.from({length: data[0].length}, (_, i) => ({wch: i < 3 ? 8 : 12}));
            
            // 탭 이름을 반 이름으로 설정 (최대 31자)
            const sheetName = cls.name.length > 31 ? cls.name.substring(0, 31) : cls.name;
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        });
        
        // 파일명에 날짜 추가
        const now = new Date();
        const dateStr = now.getFullYear() + 
                       String(now.getMonth() + 1).padStart(2, '0') + 
                       String(now.getDate()).padStart(2, '0');
        
        XLSX.writeFile(wb, `PAPS_전체반_기록_${dateStr}.xlsx`);
    }

    function handlePapsRecordUpload(event, cls){ 
        const file = event.target.files[0]; 
        if(!file) return; 
        
        const reader = new FileReader(); 
        reader.onload = e => { 
            try { 
                const data = new Uint8Array(e.target.result); 
                const wb = XLSX.read(data,{type:'array'}); 
                
                // 첫 번째 시트를 읽어서 현재 반에 적용
                const ws = wb.Sheets[wb.SheetNames[0]]; 
                const arr = XLSX.utils.sheet_to_json(ws,{header:1}); 
                
                if(arr.length < 2){ 
                    alert('데이터가 부족합니다.'); 
                    return; 
                } 
                
                const header = arr[0]; // 첫 번째 행이 헤더
                const colMap = { 
                    number: header.indexOf('번호'), 
                    name: header.indexOf('이름'), 
                    gender: header.indexOf('성별'),
                    gradeLevel: header.indexOf('학년'),
                    records: {} 
                }; 
                
                // 종목별 컬럼 매핑 (엑셀 내보내기와 동일한 형식)
                Object.keys(window.papsItems).filter(k => k !== "체지방").forEach(k => {
                    const id = window.papsItems[k].id;
                    let eventName = cls.eventSettings[id] || window.papsItems[k].options[0];
                    if (eventName === '팔굽혀펴기') {
                        eventName = '팔굽혀펴기/무릎대고 팔굽혀펴기';
                    }
                    const colIndex = header.indexOf(eventName);
                    if (colIndex !== -1) {
                        colMap.records[id] = colIndex;
                    }
                });
                
                // 체지방 관련 컬럼 매핑 (BMI 제외)
                colMap.records.height = header.indexOf('신장(cm)');
                colMap.records.weight = header.indexOf('체중(kg)');
                
                // 학년 정보 업데이트 (첫 번째 행에서 학년 정보 읽기)
                if (colMap.gradeLevel !== -1 && arr.length > 1) {
                    const firstRow = arr[1];
                    const gradeFromFile = firstRow[colMap.gradeLevel];
                    if (gradeFromFile && gradeFromFile !== '') {
                        cls.gradeLevel = gradeFromFile;
                    }
                }
                
                // 기존 학생 목록을 완전히 교체
                cls.students = [];
                let added = 0;
                
                arr.slice(1).forEach((row, index) => { 
                    if(!row || row.length === 0) return; 
                    
                    const num = colMap.number !== -1 ? row[colMap.number] : null; 
                    const name = colMap.name !== -1 ? row[colMap.name] : null; 
                    const gender = colMap.gender !== -1 ? row[colMap.gender] : '남자';
                    
                    if (!num && !name) return; // 번호와 이름이 모두 없으면 스킵
                    
                    // 새 학생 추가
                    const student = {
                        id: Date.now() + index,
                        number: num || (index + 1),
                        name: name || `학생${index + 1}`,
                        gender: gender.includes('여') ? '여자' : '남자',
                        records: {}
                    };
                    
                    // 기록 데이터 추가
                    Object.keys(colMap.records).forEach(id => { 
                        const idx = colMap.records[id]; 
                        if (idx !== -1) {
                            const value = row[idx]; 
                            if(value !== undefined && value !== null && value !== '') {
                                // 숫자 데이터인 경우 숫자로 변환
                                if (id !== 'height' && id !== 'weight' && !isNaN(parseFloat(value))) {
                                    student.records[id] = parseFloat(value);
                                } else {
                                    student.records[id] = value; 
                                }
                            } 
                        }
                    }); 
                    
                    cls.students.push(student);
                    added++;
                }); 
                
                // 테이블 다시 그리기 (등급 자동 계산됨)
                buildPapsTable(cls); 
                saveDataToFirestore(); 
                
                // 학년 설정 UI 업데이트
                const gradeSelect = document.querySelector('#paps-grade-select');
                if (gradeSelect && cls.gradeLevel) {
                    gradeSelect.value = cls.gradeLevel;
                }
                
                // 좌측 창의 반 카드 업데이트
                renderPapsUI();
                
                let message = `${added}명의 학생 기록을 불러왔습니다.`;
                if (cls.gradeLevel) {
                    message += `\n학년이 ${cls.gradeLevel}로 설정되었습니다.`;
                }
                alert(message);
                
            } catch(err){ 
                alert('기록 파일 처리 중 오류가 발생했습니다: ' + err.message); 
            } finally { 
                event.target.value=''; 
            } 
        }; 
        reader.readAsArrayBuffer(file); 
    }

    function handleAllPapsExcelUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        console.log('PAPS 엑셀 파일 업로드 시작:', file.name);
        
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                
                console.log('엑셀 파일 시트 목록:', wb.SheetNames);
                
                // 모든 시트를 순회하며 반 데이터 복원
                let totalClasses = 0;
                let totalStudents = 0;
                let processedSheets = [];
                
                wb.SheetNames.forEach(sheetName => {
                    console.log(`시트 처리 중: ${sheetName}`);
                    
                    const ws = wb.Sheets[sheetName];
                    const arr = XLSX.utils.sheet_to_json(ws, {header: 1});
                    
                    console.log(`${sheetName} 시트 데이터:`, arr);
                    
                    if (arr.length < 2) {
                        console.log(`${sheetName} 시트: 데이터 부족 (헤더만 있음)`);
                        return; // 헤더만 있으면 스킵
                    }
                    
                    const header = arr[0];
                    console.log(`${sheetName} 시트 헤더:`, header);
                    
                    const colMap = { 
                        number: header.indexOf('번호'), 
                        name: header.indexOf('이름'), 
                        gender: header.indexOf('성별'),
                        gradeLevel: header.indexOf('학년'),
                        records: {} 
                    };
                    
                    console.log(`${sheetName} 시트 컬럼 매핑:`, colMap);
                    
                    // 종목별 컬럼 매핑 (엑셀 내보내기 형식에 맞춤)
                    Object.keys(window.papsItems).filter(k => k !== "체지방").forEach(k => {
                        const id = window.papsItems[k].id;
                        let eventName = window.papsItems[k].options[0];
                        
                        // 엑셀 내보내기에서 사용하는 종목명으로 변경
                        if (eventName === '팔굽혀펴기') {
                            eventName = '팔굽혀펴기/무릎대고 팔굽혀펴기';
                        }
                        
                        const colIndex = header.indexOf(eventName);
                        if (colIndex !== -1) {
                            colMap.records[id] = colIndex;
                            console.log(`${sheetName} 시트: ${eventName} 컬럼 찾음 (인덱스: ${colIndex})`);
                        } else {
                            console.log(`${sheetName} 시트: ${eventName} 컬럼을 찾을 수 없음`);
                        }
                    });
                    
                    // 체지방 관련 컬럼 매핑
                    colMap.records.height = header.indexOf('신장(cm)');
                    colMap.records.weight = header.indexOf('체중(kg)');
                    
                    console.log(`${sheetName} 시트 최종 컬럼 매핑:`, colMap);
                    
                    // 기존 반 찾기 또는 새로 생성
                    let cls = papsData.classes.find(c => c.name === sheetName);
                    if (!cls) {
                        cls = {
                            id: Date.now() + Math.random(),
                            name: sheetName,
                            gradeLevel: '',
                            eventSettings: {},
                            students: []
                        };
                        papsData.classes.push(cls);
                        console.log(`새 반 생성: ${sheetName}`);
                    } else {
                        console.log(`기존 반 찾음: ${sheetName}`);
                    }
                    
                    // 학년 정보 업데이트
                    if (colMap.gradeLevel !== -1 && arr.length > 1) {
                        const firstRow = arr[1];
                        const gradeFromFile = firstRow[colMap.gradeLevel];
                        if (gradeFromFile && gradeFromFile !== '') {
                            cls.gradeLevel = gradeFromFile;
                            console.log(`${sheetName} 시트 학년 설정: ${gradeFromFile}`);
                        }
                    }
                    
                    // 학생 데이터 복원
                    cls.students = [];
                    let sheetStudents = 0;
                    
                    arr.slice(1).forEach((row, index) => { 
                        if(!row || row.length === 0) return; 
                        
                        const num = colMap.number !== -1 ? row[colMap.number] : null; 
                        const name = colMap.name !== -1 ? row[colMap.name] : null; 
                        const gender = colMap.gender !== -1 ? row[colMap.gender] : '남자';
                        
                        if (!num && !name) return;
                        
                        const student = {
                            id: Date.now() + index + Math.random(),
                            number: num || (index + 1),
                            name: name || `학생${index + 1}`,
                            gender: gender.includes('여') ? '여자' : '남자',
                            records: {}
                        };
                        
                        // 기록 데이터 복원
                        Object.keys(colMap.records).forEach(id => { 
                            const idx = colMap.records[id]; 
                            if (idx !== -1) {
                                const value = row[idx]; 
                                if(value !== undefined && value !== null && value !== '') {
                                    if (id !== 'height' && id !== 'weight' && !isNaN(parseFloat(value))) {
                                        student.records[id] = parseFloat(value);
                                    } else {
                                        student.records[id] = value; 
                                    }
                                    console.log(`${sheetName} 시트 학생 ${student.name}: ${id} = ${value}`);
                                } 
                            }
                        }); 
                        
                        cls.students.push(student);
                        sheetStudents++;
                        totalStudents++;
                    });
                    
                    console.log(`${sheetName} 시트 처리 완료: ${sheetStudents}명의 학생`);
                    processedSheets.push({name: sheetName, students: sheetStudents});
                    
                    if (cls.students.length > 0) {
                        totalClasses++;
                    }
                });
                
                console.log('전체 처리 결과:', {
                    totalClasses,
                    totalStudents,
                    processedSheets,
                    papsDataClasses: papsData.classes.length
                });
                
                // 데이터 저장 및 UI 업데이트
                saveDataToFirestore();
                renderPapsUI();
                
                let message = `${totalClasses}개 반, 총 ${totalStudents}명의 학생 데이터를 불러왔습니다.\n\n`;
                message += `처리된 시트:\n`;
                processedSheets.forEach(sheet => {
                    message += `- ${sheet.name}: ${sheet.students}명\n`;
                });
                
                alert(message);
                
            } catch(err) {
                console.error('PAPS 엑셀 파일 처리 오류:', err);
                alert('파일 처리 중 오류가 발생했습니다: ' + err.message);
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }


    function renderPapsCharts(cls) {
        console.log('=== renderPapsCharts 시작 ===');
        console.log('클래스:', cls);
        
        const chartsWrap = $('#paps-charts');
        const card = $('#paps-chart-section');
        
        if (!chartsWrap) {
            console.error('paps-charts 요소를 찾을 수 없습니다');
            return;
        }
        
        if (!card) {
            console.error('paps-chart-section 요소를 찾을 수 없습니다');
            return;
        }
        
        console.log('차트 컨테이너 요소들 확인 완료');
        
        // 기존 차트 정리
        chartsWrap.innerHTML = '';
        
        // 테이블 행들 가져오기
        const rows = Array.from($('#paps-record-body').querySelectorAll('tr'));
        console.log('테이블 행 수:', rows.length);
        
        if (rows.length === 0) {
            console.log('데이터가 없어서 차트 섹션을 숨깁니다');
            card.style.display = 'none';
            return;
        }
        
        console.log('차트 섹션을 표시합니다');
        card.style.display = 'block';
        
        // 등급 데이터 수집
        const gradeData = {};
        console.log('등급 데이터 수집 시작');
        
        rows.forEach((tr, rowIndex) => {
            const gradeCells = tr.querySelectorAll('.grade-cell');
            console.log(`행 ${rowIndex + 1}의 등급 셀 수:`, gradeCells.length);
            
            gradeCells.forEach((td, cellIndex) => {
                const gradeText = td.textContent.trim();
                if (!gradeText) {
                    console.log(`행 ${rowIndex + 1}, 셀 ${cellIndex + 1}: 빈 값`);
                    return;
                }
                
                const id = td.dataset.id;
                console.log(`행 ${rowIndex + 1}, 셀 ${cellIndex + 1}: ${id} = ${gradeText}`);
                
                let eventName;
                if (id === 'bodyfat') {
                    eventName = 'BMI';
                } else {
                    const catKey = Object.keys(window.window.papsItems).find(k => window.window.papsItems[k].id === id);
                    if (catKey && window.window.papsItems[catKey]) {
                        eventName = cls.eventSettings[id] || window.window.papsItems[catKey].options[0];
                    } else {
                        console.warn(`window.papsItems에서 카테고리를 찾을 수 없습니다: ${id}`);
                        eventName = id; // 기본값으로 id 사용
                    }
                }
                
                const key = id === 'bodyfat' ? gradeText : `${gradeText}등급`;
                gradeData[eventName] = gradeData[eventName] || {};
                gradeData[eventName][key] = (gradeData[eventName][key] || 0) + 1;
                
                console.log(`이벤트: ${eventName}, 키: ${key}, 카운트: ${gradeData[eventName][key]}`);
            });
        });
        
        console.log('수집된 등급 데이터:', gradeData);
        
        // 데이터가 있는지 확인
        const hasData = Object.keys(gradeData).some(eventName => 
            Object.values(gradeData[eventName]).some(count => count > 0)
        );
        
        if (!hasData) {
            console.log('차트에 표시할 데이터가 없습니다');
            chartsWrap.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--ink-muted);">등급 데이터가 없습니다. 학생들의 기록을 먼저 입력해주세요.</div>';
            card.style.display = 'block';
            return;
        }
        
        // Chart.js가 로드되었는지 확인
        if (typeof Chart === 'undefined') {
            console.error('Chart.js가 로드되지 않았습니다');
            alert('차트 라이브러리가 로드되지 않았습니다. 페이지를 새로고침해주세요.');
            return;
        }
        
        console.log('Chart.js 확인 완료, 차트 생성 시작');
        
        // 각 이벤트별로 차트 생성
        Object.keys(gradeData).forEach(eventName => {
            console.log(`차트 생성 중: ${eventName}`);
            
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 300;
            canvas.style.maxWidth = '100%';
            canvas.style.height = 'auto';
            
            const box = document.createElement('div');
            box.style.marginBottom = '20px';
            box.appendChild(canvas);
            chartsWrap.appendChild(box);
            
            const isBmi = (eventName === 'BMI');
            let displayName = eventName;
            if (eventName === '팔굽혀펴기') {
                displayName = '팔굽혀펴기/무릎대고 팔굽혀펴기';
            }
            
            const labels = isBmi ? 
                ['마름', '정상', '과체중', '경도비만', '고도비만'] : 
                ['1등급', '2등급', '3등급', '4등급', '5등급'];
            
            const colors = isBmi ? 
                ['#6c757d', '#28a745', '#ffc107', '#fd7e14', '#dc3545'] : 
                ['#28a745', '#17a2b8', '#ffc107', '#fd7e14', '#dc3545'];
            
            const counts = labels.map(l => gradeData[eventName][l] || 0);
            console.log(`${eventName} 차트 데이터:`, { labels, counts });
            
            try {
                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '학생 수',
                            data: counts,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: displayName,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45
                                }
                            }
                        }
                    }
                });
                console.log(`${eventName} 차트 생성 완료`);
            } catch (error) {
                console.error(`${eventName} 차트 생성 실패:`, error);
            }
        });
        
        console.log('=== renderPapsCharts 완료 ===');
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                let importType = 'unknown';

                if (data.leagues && data.tournaments) importType = 'v2';
                else if (data.classes && data.students) importType = 'league_legacy';
                else if (Array.isArray(data) && data.length > 0 && data[0].hasOwnProperty('rounds')) importType = 'tournament_legacy';
                
                if(importType === 'unknown') throw new Error('알 수 없는 파일 형식');

                showModal({
                    title: '데이터 복원', body: `'${file.name}' 파일 데이터를 복원하시겠습니까? 현재 클라우드 데이터는 덮어씌워집니다.`,
                    actions: [
                        { text: '취소', callback: closeModal },
                        { text: '복원', type: 'danger', callback: () => {
                            if (importType === 'v2') {
                                leagueData = data.leagues;
                                tournamentData = data.tournaments;
                            } else if (importType === 'league_legacy') {
                                leagueData.classes = data.classes || [];
                                leagueData.students = data.students || [];
                                leagueData.games = data.games || [];
                                leagueData.games.forEach(g => { if (g.isHighlighted === undefined) g.isHighlighted = false; });
                                leagueData.selectedClassId = null;
                                tournamentData = { tournaments: [], activeTournamentId: null };
                                appMode = 'league';
                            } else if (importType === 'tournament_legacy') {
                                tournamentData.tournaments = data;
                                tournamentData.activeTournamentId = null;
                                leagueData = { classes: [], students: [], games: [], selectedClassId: null };
                                appMode = 'tournament';
                            }
                            if (tournamentData.tournaments) {
                                tournamentData.tournaments.forEach(t => {
                                    if (t.rounds && typeof t.rounds === 'string') {
                                        t.rounds = JSON.parse(t.rounds);
                                    }
                                });
                            }
                            saveDataToFirestore();
                            switchMode(appMode);
                            closeModal();
                        }}
                    ]
                });

            } catch (err) {
                alert('파일 형식이 잘못되었거나 손상되었습니다.');
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }
    
    // ========================================
    // 사이드바 토글 기능
    // ========================================
    function initializeSidebarToggle() {
        const sidebar = $('#sidebar');
        const sidebarToggle = $('#sidebar-toggle');
        const appContainer = $('.app-container');
        
        if (!sidebar || !sidebarToggle) {
            console.log('사이드바 또는 토글 버튼을 찾을 수 없습니다.');
            return;
        }
        
        console.log('사이드바 토글 기능 초기화 중...');
        console.log('app-container:', appContainer);
        
        // 토글 버튼이 보이도록 강제로 스타일 설정
        sidebarToggle.style.cssText = `
            position: fixed !important;
            top: 50% !important;
            left: 0 !important;
            transform: translateY(-50%) !important;
            width: 12px !important;
            height: 30px !important;
            background: #2563eb !important;
            border: 1px solid #ffffff !important;
            border-radius: 0 4px 4px 0 !important;
            color: white !important;
            cursor: pointer !important;
            z-index: 1000 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease !important;
            box-shadow: 1px 0 4px rgba(0,0,0,0.1) !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            font-size: 10px !important;
            font-weight: bold !important;
        `;
        
        console.log('토글 버튼 스타일 강제 설정 완료');
        
        // 토글 버튼이 실제로 보이는지 확인
        const toggleRect = sidebarToggle.getBoundingClientRect();
        console.log('토글 버튼 위치 정보:', {
            left: toggleRect.left,
            top: toggleRect.top,
            width: toggleRect.width,
            height: toggleRect.height,
            visible: toggleRect.width > 0 && toggleRect.height > 0
        });
        
        // 토글 버튼에 눈에 띄는 배경색 설정
        sidebarToggle.style.backgroundColor = '#2563eb';
        console.log('토글 버튼에 파란색 배경 설정');
        
        // 로컬 스토리지에서 사이드바 상태 로드 (기본값은 펼친 상태)
        const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
        
        // 초기 상태 설정
        if (isCollapsed) {
            sidebar.classList.add('collapsed');
            if (appContainer) appContainer.classList.add('sidebar-collapsed');
            // 강제로 접힌 상태 스타일 적용
            sidebar.style.cssText = `
                width: 0 !important;
                min-width: 0 !important;
                max-width: 0 !important;
                padding: 0 !important;
                border-right: none !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 0 !important;
                background: var(--sidebar-bg) !important;
                flex-shrink: 0 !important;
                position: relative !important;
                transition: width 0.3s ease !important;
            `;
            // 토글 버튼 위치 설정
            sidebarToggle.style.left = '0px';
            sidebarToggle.style.zIndex = '1000';
            // 화살표 방향 설정 (접힌 상태에서는 오른쪽 화살표)
            sidebarToggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="6,4 18,12 6,20"/></svg>';
            console.log('사이드바 초기 상태: 접힘');
        } else {
            if (appContainer) appContainer.classList.remove('sidebar-collapsed');
            // 강제로 펼친 상태 스타일 적용
            sidebar.style.cssText = `
                width: 340px !important;
                min-width: 340px !important;
                max-width: 340px !important;
                padding: 24px !important;
                border-right: 1px solid var(--line) !important;
                overflow: visible !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 20px !important;
                background: var(--sidebar-bg) !important;
                flex-shrink: 0 !important;
                position: relative !important;
                transition: width 0.3s ease !important;
            `;
            // 토글 버튼 위치 설정
            sidebarToggle.style.left = '340px';
            sidebarToggle.style.zIndex = '1000';
            // 화살표 방향 설정 (펼친 상태에서는 왼쪽 화살표)
            sidebarToggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="18,4 6,12 18,20"/></svg>';
            console.log('사이드바 초기 상태: 펼침');
        }
        
        // 토글 버튼 클릭 이벤트
        sidebarToggle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const isCurrentlyCollapsed = sidebar.classList.contains('collapsed');
            console.log('토글 버튼 클릭됨. 현재 상태:', isCurrentlyCollapsed ? '접힘' : '펼침');
            console.log('사이드바 요소:', sidebar);
            console.log('사이드바 클래스 목록:', sidebar.className);
            
            if (isCurrentlyCollapsed) {
                // 사이드바 열기
                console.log('사이드바 펼치기 시도...');
                sidebar.classList.remove('collapsed');
                if (appContainer) appContainer.classList.remove('sidebar-collapsed');
                
                // 강제로 스타일 적용 - 모든 CSS 규칙을 덮어쓰기
                sidebar.style.cssText = `
                    width: 340px !important;
                    min-width: 340px !important;
                    max-width: 340px !important;
                    padding: 24px !important;
                    border-right: 1px solid var(--line) !important;
                    overflow: visible !important;
                    display: flex !important;
                    flex-direction: column !important;
                    gap: 20px !important;
                    background: var(--sidebar-bg) !important;
                    flex-shrink: 0 !important;
                    position: relative !important;
                    transition: width 0.3s ease !important;
                `;
                
                // 토글 버튼 위치 조정
                sidebarToggle.style.left = '340px';
                sidebarToggle.style.zIndex = '1000';
                // 화살표 방향 변경 (펼친 상태에서는 왼쪽 화살표)
                sidebarToggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="18,4 6,12 18,20"/></svg>';
                
                localStorage.setItem('sidebar-collapsed', 'false');
                console.log('사이드바 펼침 완료');
                console.log('사이드바 클래스 목록 (펼침 후):', sidebar.className);
                console.log('app-container 클래스 목록 (펼침 후):', appContainer ? appContainer.className : '없음');
            } else {
                // 사이드바 닫기
                console.log('사이드바 접기 시도...');
                sidebar.classList.add('collapsed');
                if (appContainer) appContainer.classList.add('sidebar-collapsed');
                
                // 강제로 스타일 적용 - 모든 CSS 규칙을 덮어쓰기
                sidebar.style.cssText = `
                    width: 0 !important;
                    min-width: 0 !important;
                    max-width: 0 !important;
                    padding: 0 !important;
                    border-right: none !important;
                    overflow: hidden !important;
                    display: flex !important;
                    flex-direction: column !important;
                    gap: 0 !important;
                    background: var(--sidebar-bg) !important;
                    flex-shrink: 0 !important;
                    position: relative !important;
                    transition: width 0.3s ease !important;
                `;
                
                // 토글 버튼 위치 조정
                sidebarToggle.style.left = '0px';
                sidebarToggle.style.zIndex = '1000';
                // 화살표 방향 변경 (접힌 상태에서는 오른쪽 화살표)
                sidebarToggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="6,4 18,12 6,20"/></svg>';
                
                localStorage.setItem('sidebar-collapsed', 'true');
                console.log('사이드바 접음 완료');
                console.log('사이드바 클래스 목록 (접음 후):', sidebar.className);
                console.log('app-container 클래스 목록 (접음 후):', appContainer ? appContainer.className : '없음');
            }
        });
        
        // 키보드 단축키 지원 (Ctrl + B)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                console.log('키보드 단축키로 토글 실행');
                sidebarToggle.click();
            }
        });
        
        console.log('사이드바 토글 기능 초기화 완료');
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (handleShareView()) {
            return;
        }
        
        // 방문자 수 로드 및 업데이트 (Firebase 초기화 완료 후)
        setTimeout(async () => {
            await loadVisitorCount();
            await updateVisitorCount();
        }, 100);
        
        // 사이드바 토글 기능 초기화
        initializeSidebarToggle();
        
        // 네트워크 상태 모니터링 초기화
        initializeNetworkMonitoring();
        
        // Firebase 초기화 대기
        let firebaseCheckCount = 0;
        const maxFirebaseChecks = 50; // 5초 대기 (100ms * 50)
        
        const checkFirebase = setInterval(() => {
            firebaseCheckCount++;
            
            if (window.firebase) {
                clearInterval(checkFirebase);
                console.log('Firebase 초기화 완료, 앱 시작');
                initialize_app();
            } else if (firebaseCheckCount >= maxFirebaseChecks) {
                clearInterval(checkFirebase);
                console.error('Firebase 초기화 시간 초과');
                alert('Firebase 초기화에 실패했습니다. 페이지를 새로고침해주세요.');
            } else {
                console.log(`Firebase 초기화 대기 중... (${firebaseCheckCount}/${maxFirebaseChecks})`);
            }
        }, 100);
        
        // Firebase 이벤트 리스너 추가
        window.addEventListener('firebaseReady', async () => {
            console.log('Firebase Ready 이벤트 수신');
            if (checkFirebase) {
                clearInterval(checkFirebase);
            }
            initialize_app();
            
            // Firebase 초기화 완료 후 방문자 수 업데이트
            setTimeout(async () => {
                await loadVisitorCount();
                await updateVisitorCount();
            }, 500);
        });
        
        window.addEventListener('firebaseError', (event) => {
            console.error('Firebase Error 이벤트 수신:', event.detail);
            if (checkFirebase) {
                clearInterval(checkFirebase);
            }
            alert('Firebase 초기화에 실패했습니다: ' + event.detail.message);
        });
    });
    
    // ========================================
    // 네트워크 상태 모니터링
    // ========================================
    function initializeNetworkMonitoring() {
        // 온라인/오프라인 상태 감지
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            console.log('네트워크 상태:', isOnline ? '온라인' : '오프라인');
            
            // 오프라인 시 데이터 동기화 시도
            if (isOnline && currentUser) {
                console.log('온라인 상태 복구, 데이터 동기화 시도');
                loadDataFromFirestore(currentUser.uid);
            }
        }
        
        // 이벤트 리스너 등록
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // 초기 상태 설정
        updateOnlineStatus();
        
        // 주기적 연결 상태 확인 (30초마다)
        setInterval(() => {
            if (navigator.onLine && currentUser && window.firebase) {
                // 간단한 연결 테스트
                const testDoc = window.firebase.doc(window.firebase.db, 'test', 'connection');
                window.firebase.getDoc(testDoc).catch(error => {
                    console.warn('Firebase 연결 테스트 실패:', error);
                });
            }
        }, 30000);
    }
    
    // ========================================
    // 공유 기능 관련
    // ========================================
    function handleShareView() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('share') === 'true') {
            const uid = urlParams.get('uid');
            const id = urlParams.get('id');
            const mode = urlParams.get('mode');
            const view = urlParams.get('view');

            if (!uid || !id || !mode || !view) return false;
            
            document.body.innerHTML = `
                <div id="loader" class="loader"><div >데이터를 불러오는 중...</div></div>
                <header class="top-bar">
                    <h1>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                        <span>체육 수업 도우미 (공유 모드)</span>
                    </h1>
                </header>
                <main id="share-view-content" class="main-content" style="padding: 24px;"></main>
                <footer class="sidebar-footer" style="padding: 12px; flex-shrink:0;">만든이: 김신회(laguyo87@gmail.com)</footer>
            `;
            
            const checkFirebase = setInterval(() => {
                if (window.firebase) {
                    clearInterval(checkFirebase);
                    loadSharedData(uid, id, mode, view);
                }
            }, 100);

            return true;
        }
        return false;
    }

    async function loadSharedData(uid, id, mode, view) {
        $('#loader').classList.remove('hidden');
        try {
            const userDocRef = window.firebase.doc(window.firebase.db, "users", uid);
            const docSnap = await window.firebase.getDoc(userDocRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                leagueData = data.leagues || { classes: [], students: [], games: [], selectedClassId: null };
                tournamentData = data.tournaments || { tournaments: [], activeTournamentId: null };

                if (tournamentData.tournaments) {
                    tournamentData.tournaments.forEach(t => {
                        if (t.rounds && typeof t.rounds === 'string') {
                            t.rounds = JSON.parse(t.rounds);
                        } else if (t.rounds === undefined) {
                            t.rounds = [];
                        }
                    });
                }
                renderSharedView(id, mode, view); // id가 문자열일 수 있으므로 Number() 제거
            } else {
                 $('#share-view-content').innerHTML = '<h2>공유된 데이터를 찾을 수 없습니다.</h2>';
            }
        } catch (error) {
            console.error("Firestore 불러오기 실패:", error);
            $('#share-view-content').innerHTML = '<h2>데이터를 불러오는 중 오류가 발생했습니다.</h2>';
        } finally {
            $('#loader').classList.add('hidden');
        }
    }

    function renderSharedView(id, mode, view) {
        const container = $('#share-view-content');
        
        if (mode === 'league') {
            leagueData.selectedClassId = Number(id);
            const selectedClass = leagueData.classes.find(c => c.id === Number(id));
            if (!selectedClass) {
                container.innerHTML = '<h2>클래스를 찾을 수 없습니다.</h2>';
                return;
            }
            if (view === 'schedule') {
                container.innerHTML = `<h2>${selectedClass.name} - 경기 일정</h2><div id="gamesTableContainer" style="margin: 0 -24px; padding: 0 24px;"><div class="paps-table-wrap"><div id="gamesTableContent"></div></div></div>`;
                renderGamesTable(true);
            } else if (view === 'standings') {
                container.innerHTML = `<h2>${selectedClass.name} - 순위표</h2><div id="rankingsTableContainer" class="section-box" style="padding:0; overflow-x:auto;"></div>`;
                renderRankingsTable();
            }
        } else if (mode === 'tournament') {
            const tourney = tournamentData.tournaments.find(t => t.id === id);
             if (!tourney) {
                container.innerHTML = '<h2>토너먼트를 찾을 수 없습니다.</h2>';
                return;
            }
            if (view === 'bracket') {
                container.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                      <h2>${tourney.name} - 대진표</h2>
                      <span style="color:var(--ink-muted);">${tourney.sport || ''}</span>
                    </div>
                    <div id="bracket-container" class="bracket-wrap">
                        <div id="rounds" class="rounds"></div>
                        <svg id="svgLayer" class="svg-layer"></svg>
                    </div>
                `;
                renderBracket(tourney, true);
            }
        }
    }

    function shareView(mode, view) {
        if (!currentUser) return;
        let id;
        if (mode === 'league') {
            id = leagueData.selectedClassId;
            if (!id) { showModal({ title: '오류', body: '먼저 반을 선택해주세요.', actions: [{ text: '확인', type: 'primary', callback: closeModal }] }); return; }
        } else if (mode === 'tournament') {
            id = tournamentData.activeTournamentId;
             if (!id) { showModal({ title: '오류', body: '먼저 토너먼트를 선택해주세요.', actions: [{ text: '확인', type: 'primary', callback: closeModal }] }); return; }
        }

        const url = `${window.location.origin}${window.location.pathname}?share=true&uid=${currentUser.uid}&id=${id}&mode=${mode}&view=${view}`;
        copyToClipboard(url);
    }
    
    function copyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.top = '0';
        textArea.style.left = '0';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showModal({ title: '공유 링크 복사됨', body: '링크가 클립보드에 복사되었습니다. 원하는 곳에 붙여넣기 하세요.', actions: [{ text: '확인', type: 'primary', callback: closeModal }] });
        } catch (err) {
             showModal({ title: '복사 실패', body: '링크를 복사하는 데 실패했습니다.', actions: [{ text: '확인', type: 'danger', callback: closeModal }] });
        }
        document.body.removeChild(textArea);
    }

    // ========================================

    function initialize_app() {
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful: ', registration);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        // 초기 화면을 수업 진도 관리 모드로 설정
        appMode = 'progress';
        $('#auth-container').classList.add('hidden');
        $('#app-root').classList.remove('hidden');
        renderApp();
        
        const { auth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } = window.firebase;

        onAuthStateChanged(auth, user => {
            console.log('=== Firebase 인증 상태 변경 ===');
            console.log('상태:', user ? '로그인됨' : '로그아웃됨');
            console.log('사용자 정보:', user);
            console.log('사용자 UID:', user ? user.uid : '없음');
            console.log('사용자 이메일:', user ? user.email : '없음');
            
            if (user) {
                currentUser = user;
                console.log('=== 사용자 로그인 처리 시작 ===');
                $('#auth-container').classList.add('hidden');
                $('#app-root').classList.remove('hidden');
                console.log('사용자 이메일 표시:', user.displayName || user.email);
                console.log('데이터 로딩 시작, UID:', user.uid);
                loadDataFromFirestore(user.uid);
                // 로그인 상태 UI 업데이트
                updateLoginStatus();
            } else {
                console.log('사용자 로그아웃 처리 시작');
                currentUser = null;
                // 로그아웃 시에도 모든 기능 유지
                $('#auth-container').classList.add('hidden');
                $('#app-root').classList.remove('hidden');
                
                // 로컬 스토리지에서 데이터 로드
                loadLocalData();
                
                // 사이드바 정리
                cleanupSidebar();
                
                // 앱 다시 렌더링
                renderApp();
            }
        });

        $('#signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = $('#signup-email').value;
            const password = $('#signup-password').value;
            try { await createUserWithEmailAndPassword(auth, email, password); } 
            catch (error) { handleAuthError(error, 'signup'); }
        });

        $('#login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = $('#login-email').value;
            const password = $('#login-password').value;
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (error) { handleAuthError(error, 'login'); }
        });

        $('#reset-form').addEventListener('submit', handlePasswordReset);
        
        $('#forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            showAuthForm('reset');
        });

        $('#back-to-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            showAuthForm('login');
        });

        $('#google-login-btn').addEventListener('click', signInWithGoogle);

        $('#logout-btn').addEventListener('click', () => { signOut(auth); });
        
        const savedTheme = localStorage.getItem("theme") || "light";
        document.body.dataset.theme = savedTheme;
        switchMode(appMode);

        $$('.mode-switch-btn').forEach(btn => btn.addEventListener('click', () => switchMode(btn.dataset.mode)));
        $('#exportAllLeaguesBtn').addEventListener('click', exportAllLeaguesToExcel);
        $('#importAllLeaguesExcel').addEventListener('change', importAllLeaguesFromExcel);
        $('#theme-toggle-btn').addEventListener('click', () => {
            const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = newTheme;
            localStorage.setItem("theme", newTheme);
        });
    }

    function importAllLeaguesFromExcel(event) {
        const file = event.target.files[0];
        if (!file) return;

        showModal({
            title: '전체 리그 가져오기',
            body: `'${file.name}' 파일에서 모든 리그 데이터를 가져옵니다. 이 작업은 현재 리그전 데이터를 모두 덮어씁니다. 계속하시겠습니까?`,
            actions: [
                { text: '취소', callback: () => {
                    event.target.value = ''; // 파일 선택 초기화
                    closeModal();
                }},
                { text: '가져오기', type: 'danger', callback: () => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });

                            const newLeagueData = { classes: [], students: [], games: [], selectedClassId: null };
                            const classMap = new Map();

                            workbook.SheetNames.forEach(sheetName => {
                                const isRankingSheet = sheetName.endsWith(' 순위');
                                const isScheduleSheet = sheetName.endsWith(' 일정');
                                if (!isRankingSheet && !isScheduleSheet) return;

                                const className = isRankingSheet ? sheetName.replace(' 순위', '') : sheetName.replace(' 일정', '');
                                if (!classMap.has(className)) {
                                    const newClass = { id: Date.now() + classMap.size, name: className, note: '' };
                                    classMap.set(className, { classInfo: newClass, students: new Map(), games: [] });
                                    newLeagueData.classes.push(newClass);
                                }

                                const classData = classMap.get(className);
                                const worksheet = workbook.Sheets[sheetName];
                                const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                                if (isRankingSheet && sheetData.length > 1) {
                                    sheetData.slice(1).forEach(row => {
                                        const studentName = row[1];
                                        if (studentName && !classData.students.has(studentName)) {
                                            const newStudent = { id: Date.now() + Math.random(), name: studentName, classId: classData.classInfo.id, note: '' };
                                            classData.students.set(studentName, newStudent);
                                        }
                                    });
                                } else if (isScheduleSheet && sheetData.length > 1) {
                                    sheetData.slice(1).forEach(row => {
                                        const [, p1Name, p1Score, p2Score, p2Name, status, completionDate, note] = row;
                                        if (!p1Name || !p2Name) return;
                                        
                                        const p1 = Array.from(classData.students.values()).find(s => s.name === p1Name);
                                        const p2 = Array.from(classData.students.values()).find(s => s.name === p2Name);
                                        if (!p1 || !p2) return;

                                        classData.games.push({
                                            id: Date.now() + Math.random(), classId: classData.classInfo.id,
                                            player1Id: p1.id, player2Id: p2.id,
                                            player1Score: p1Score === undefined ? null : Number(p1Score),
                                            player2Score: p2Score === undefined ? null : Number(p2Score),
                                            isCompleted: status === '완료', completionDate: completionDate || '', note: note || '', isHighlighted: false
                                        });
                                    });
                                }
                            });

                            classMap.forEach(data => newLeagueData.students.push(...data.students.values()));
                            classMap.forEach(data => newLeagueData.games.push(...data.games));

                            leagueData = newLeagueData;
                            saveDataToFirestore();
                            renderApp();
                        } catch (error) {
                            console.error("엑셀 파일 처리 중 오류 발생:", error);
                            alert('파일을 처리하는 중 오류가 발생했습니다. 파일 형식을 확인해주세요.');
                        } finally {
                            event.target.value = '';
                            closeModal();
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }}
            ]
        });
    }

    function printLiveRankings() {
        const popupTitle = $('#popupTitle').textContent;
        const tableContainer = $('#popupRankingsTable').parentElement.innerHTML;

        const printWindow = window.open('', '', 'height=800,width=800');
        printWindow.document.write('<html><head><title>순위표 인쇄</title>');
        printWindow.document.write('<style>body{font-family: "Noto Sans KR", sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ddd; padding:8px; text-align:center;} th{background:#f2f2f2;} .rank-wins{color:green;} .rank-losses{color:red;} .rank-points{color:blue; font-weight:bold;}</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(`<h2>${popupTitle}</h2>`);
        printWindow.document.write(tableContainer);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
    }

    function printBracket() {
        const tourney = tournamentData.tournaments.find(t => t.id === tournamentData.activeTournamentId);
        if (!tourney) return;

        const printWindow = window.open('', '', 'height=800,width=1200');
        printWindow.document.write('<html><head><title>대진표 인쇄</title>');
        
        const styles = document.head.querySelectorAll('style');
        styles.forEach(style => {
            printWindow.document.write(style.outerHTML);
        });
        
        printWindow.document.write(`
            <style>
                body { background: #fff !important; color: #000 !important; }
                .bracket-wrap { overflow: visible !important; border: none !important; }
                .main-content { padding: 0 !important; }
                .btn { display: none !important; }
                @media print {
                  body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                }
            </style>
        `);
        printWindow.document.write('</head><body>');
        printWindow.document.write(`<h2>${tourney.name} - 대진표</h2>`);
        
        // 대진표 HTML 생성
        const roundsData = tourney.rounds;
        const roundLabels = makeRoundLabels(roundsData.length);
        const bracketHtml = `
            <div class="bracket-wrap">
                <div class="rounds">
                    ${roundsData.map((round, rIdx) => `
                        <div class="round">
                            <div class="round-title">${roundLabels[rIdx]}</div>
                            <div class="match-group">
                                ${round.map(m => renderMatchCard(m, rIdx, tourney, true)).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <svg id="printSvgLayer" class="svg-layer"></svg>
            </div>
        `;
        
        printWindow.document.write(bracketHtml);
        printWindow.document.close();
        
        // 인쇄 창에서 연결선 그리기
        setTimeout(() => {
            drawSvgLinesForPrint(printWindow, tourney);
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }, 1000);
    }
    
    function drawSvgLinesForPrint(printWindow, tourney) {
        const svg = printWindow.document.getElementById('printSvgLayer');
        const roundsEl = printWindow.document.querySelector('.rounds');
        if(!svg || !roundsEl) return;
        
        svg.innerHTML = "";
        const scrollW = roundsEl.scrollWidth; 
        const scrollH = roundsEl.scrollHeight;
        svg.setAttribute("viewBox", `0 0 ${scrollW} ${scrollH}`);
        svg.setAttribute("width", scrollW); 
        svg.setAttribute("height", scrollH);
        
        if(!tourney || !Array.isArray(tourney.rounds)) return;

        // 인쇄 창용 좌표 계산 함수들
        const getBottomRightForPrint = (el, container) => { 
            const r1 = el.getBoundingClientRect(); 
            const rC = container.getBoundingClientRect(); 
            return { x: (r1.right - rC.left) + 15 + container.scrollLeft, y: (r1.bottom - rC.top) + 18 + container.scrollTop }; 
        };
        const getBottomLeftForPrint = (el, container) => { 
            const r1 = el.getBoundingClientRect(); 
            const rC = container.getBoundingClientRect(); 
            return { x: (r1.left - rC.left) + 15 + container.scrollLeft, y: (r1.bottom - rC.top) + 18 + container.scrollTop }; 
        };

        for(let r=0; r < tourney.rounds.length-1; r++){
            const currentRound = tourney.rounds[r];
            currentRound.forEach(match => {
                if (!match || !match.parentId) return;

                const childCard = roundsEl.querySelector(`[data-match-id="${match.id}"]`);
                const parentCard = roundsEl.querySelector(`[data-match-id="${match.parentId}"]`);
                if (!childCard || !parentCard) return;

                const start = getBottomRightForPrint(childCard, roundsEl);
                const end = getBottomLeftForPrint(parentCard, roundsEl);
                
                // 곡선 연결선
                const path = printWindow.document.createElementNS("http://www.w3.org/2000/svg","path");
                const gap = 40;
                const midX = start.x + gap;
                const d = `M ${start.x} ${start.y} 
                          C ${midX} ${start.y} ${midX} ${end.y} ${end.x} ${end.y}`;
                path.setAttribute("d", d);
                path.setAttribute("fill", "none");
                path.setAttribute("stroke", match.winner ? "#1971c2" : "#dee2e6");
                path.setAttribute("stroke-width", match.winner ? "2.5" : "1.5");
                path.setAttribute("stroke-linecap", "round");
                path.setAttribute("stroke-linejoin", "round");
                svg.appendChild(path);
            });
        }
    }

    function printRankings() {
        const classId = leagueData.selectedClassId;
        if (!classId) return;
        const currentClass = leagueData.classes.find(c => c.id === classId);
        const tableContainer = document.createElement('div');
        renderRankingsTable(tableContainer);

        const printWindow = window.open('', '', 'height=800,width=800');
        printWindow.document.write('<html><head><title>순위표 인쇄</title>');
        printWindow.document.write('<style>body{font-family: "Noto Sans KR", sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ddd; padding:8px; text-align:center;} th{background:#f2f2f2;} .rank-wins{color:green;} .rank-losses{color:red;} .rank-points{color:blue; font-weight:bold;}</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(`<h2>${currentClass.name} 순위표</h2>`);
        printWindow.document.write(tableContainer.innerHTML);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
    }
    
    function openRankingPopup() {
        const classId = leagueData.selectedClassId;
        if (!classId) return;
        const currentClass = leagueData.classes.find(c => c.id === classId);
        $('#popupTitle').textContent = `${currentClass.name} - 실시간 순위표`;
        renderRankingsTable($('#popupRankingsTable'));
        $('#rankingPopup').classList.remove('hidden');
    }
    
    function closeRankingPopup() {
        $('#rankingPopup').classList.add('hidden');
    }

    function openHelpPopup() {
        $('#helpPopup').classList.remove('hidden');
    }
    
    function closeHelpPopup() {
        $('#helpPopup').classList.add('hidden');
    }



    function showModal({ title, body, actions }) {
        $('#modal-title').textContent = title;
        $('#modal-body').innerHTML = body;
        const actionsEl = $('#modal-actions');
        actionsEl.innerHTML = '';
        actions.forEach(action => {
            const button = document.createElement('button');
            button.textContent = action.text;
            button.className = `btn ${action.type || ''}`;
            button.onclick = action.callback;
            actionsEl.appendChild(button);
        });
        $('#modal-container').classList.remove('hidden');
    }
    function closeModal() { $('#modal-container').classList.add('hidden'); }

  
  </script>
</body>
</html>

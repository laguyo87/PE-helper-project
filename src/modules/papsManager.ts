/**
 * PAPS ìˆ˜ì—… ê´€ë¦¬ ëª¨ë“ˆ
 * 
 * ì´ ëª¨ë“ˆì€ PAPS(Physical Activity Promotion System) ìˆ˜ì—…ì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
 * PAPS ë°˜ ìƒì„±/ì‚­ì œ, í•™ìƒ ê´€ë¦¬, ê¸°ë¡ ì…ë ¥, ë“±ê¸‰ ê³„ì‚°, ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ë“±ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
 * 
 * í˜„ì¬ ì§€ì›í•˜ëŠ” ê¸°ëŠ¥:
 * - PAPS ë°˜ ê´€ë¦¬ (ìƒì„±, í¸ì§‘, ì‚­ì œ, ì„ íƒ)
 * - í•™ìƒ ëª…ë‹¨ ê´€ë¦¬ (ì¶”ê°€, ì‚­ì œ, ì—‘ì…€ ì—…ë¡œë“œ)
 * - PAPS ê¸°ë¡ ì…ë ¥ ë° ë“±ê¸‰ ê³„ì‚°
 * - ì—‘ì…€ ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°
 * 
 * @author PE Helper Online
 * @version 2.2.1
 * @since 2024-01-01
 */

import { validateData, PapsClassSchema } from './validators.js';
import { showError, showSuccess } from './errorHandler.js';
import { setInnerHTMLSafe } from './utils.js';
import { logger, logInfo, logWarn, logError } from './logger.js';

// íƒ€ì… ì •ì˜
export interface PapsStudent {
    id: number;
    number: number;
    name: string;
    gender: 'ë‚¨ì' | 'ì—¬ì';
    records: Record<string, number>;
}

export interface PapsClass {
    id: number;
    name: string;
    gradeLevel: string;
    students: PapsStudent[];
    settings?: PapsSettings;
    eventSettings?: Record<string, string>;
}

export interface PapsSettings {
    gradeLevel: string;
    customCategories?: Record<string, any>;
}

export interface PapsData {
    classes: PapsClass[];
    activeClassId: number | null;
}

// PAPS í•­ëª© ì •ì˜
const PAPS_ITEMS: Record<string, { id: string; options: string[] }> = {
        "ì‹¬íì§€êµ¬ë ¥": { id: "endurance", options: ["ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°", "ì˜¤ë˜ë‹¬ë¦¬ê¸°", "ìŠ¤í…ê²€ì‚¬"] },
        "ìœ ì—°ì„±": { id: "flexibility", options: ["ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°", "ì¢…í•©ìœ ì—°ì„±ê²€ì‚¬"] },
        "ê·¼ë ¥/ê·¼ì§€êµ¬ë ¥": { id: "strength", options: ["ì•…ë ¥", "íŒ”êµ½í˜€í´ê¸°", "ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°"] },
    "ìˆœë°œë ¥": { id: "power", options: ["ì œìë¦¬ë©€ë¦¬ë›°ê¸°", "50m ë‹¬ë¦¬ê¸°"] },
        "ì²´ì§€ë°©": { id: "bodyfat", options: ["BMI"] }
    };

// PAPS í‰ê°€ ê¸°ì¤€ ë°ì´í„° (ì›ë³¸: main.js ì˜ papsCriteriaData ì „ì²´ ì´ê´€)
const PAPS_CRITERIA_DATA: Record<string, any> = {
        "ë‚¨ì": {
    "ì´ˆ4": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[96,9999,1],[69,95,2],[45,68,3],[26,44,4],[0,25,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[170.1,9999,1],[149.1,170,2],[130.1,149,3],[100.1,130,4],[0,100,5]],"íŒ”êµ½í˜€í´ê¸°":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[80,9999,1],[40,79,2],[22,39,3],[7,21,4],[0,6,5]],"ì•…ë ¥":[[31,9999,1],[18.5,30.9,2],[15,18.4,3],[11.5,14.9,4],[0,11.4,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.8,1],[8.81,9.7,2],[9.71,10.5,3],[10.51,13.2,4],[13.21,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[25,9999,1],[22,24.9,2],[19,21.9,3],[16,18.9,4],[0,15.9,5]]},
    "ì´ˆ5": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[100,9999,1],[73,99,2],[50,72,3],[29,49,4],[0,28,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[8,9999,1],[5,7.9,2],[1,4.9,3],[-4,0.9,4],[-999,-4.1,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[180.1,9999,1],[159.1,180,2],[141.1,159,3],[111.1,141,4],[0,111,5]],"íŒ”êµ½í˜€í´ê¸°":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[80,9999,1],[40,79,2],[22,39,3],[10,21,4],[0,9,5]],"ì•…ë ¥":[[31,9999,1],[23,30.9,2],[17,22.9,3],[12.5,16.9,4],[0,12.4,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.5,1],[8.51,9.4,2],[9.41,10.2,3],[10.21,13.2,4],[13.21,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,281,1],[282,324,2],[325,409,3],[410,479,4],[480,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[28,9999,1],[25,27.9,2],[22,24.9,3],[19,21.9,4],[0,18.9,5]]},
    "ì´ˆ6": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[104,9999,1],[78,103,2],[54,77,3],[32,53,4],[0,31,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[8,9999,1],[5,7.9,2],[1,4.9,3],[-4,0.9,4],[-999,-4.1,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[200.1,9999,1],[167.1,200,2],[148.1,167,3],[122.1,148,4],[0,122,5]],"íŒ”êµ½í˜€í´ê¸°":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[80,9999,1],[40,79,2],[22,39,3],[10,21,4],[0,9,5]],"ì•…ë ¥":[[35,9999,1],[26.5,34.9,2],[19,26.4,3],[15,18.9,4],[0,14.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.1,1],[8.11,9.1,2],[9.11,10,3],[10.01,12.5,4],[12.51,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,250,1],[251,314,2],[315,379,3],[380,449,4],[450,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[31,9999,1],[28,30.9,2],[25,27.9,3],[22,24.9,4],[0,21.9,5]]},
    "ì¤‘1": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[64,9999,1],[50,63,2],[36,49,3],[20,35,4],[0,19,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[10,9999,1],[6,9.9,2],[2,5.9,3],[-4,1.9,4],[-999,-4.1,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[211.1,9999,1],[177.1,211,2],[159.1,177,3],[131.1,159,4],[0,131,5]],"íŒ”êµ½í˜€í´ê¸°":[[34,9999,1],[25,33,2],[12,24,3],[4,11,4],[0,3,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[90,9999,1],[55,89,2],[33,54,3],[14,32,4],[0,13,5]],"ì•…ë ¥":[[42,9999,1],[30,41.9,2],[22.5,29.9,3],[16.5,22.4,4],[0,16.4,5]],"50m ë‹¬ë¦¬ê¸°":[[0,7.5,1],[7.51,8.4,2],[8.41,9.3,3],[9.31,11.5,4],[11.51,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,425,1],[426,502,2],[503,599,3],[600,699,4],[700,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[34,9999,1],[31,33.9,2],[28,30.9,3],[25,27.9,4],[0,24.9,5]]},
    "ì¤‘2": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[66,9999,1],[52,65,2],[38,51,3],[22,37,4],[0,21,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[10,9999,1],[7,9.9,2],[2,6.9,3],[-4,1.9,4],[-999,-4.1,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[218.1,9999,1],[187.1,218,2],[169.1,187,3],[136.1,169,4],[0,136,5]],"íŒ”êµ½í˜€í´ê¸°":[[34,9999,1],[25,33,2],[12,24,3],[4,11,4],[0,3,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[90,9999,1],[55,89,2],[33,54,3],[14,32,4],[0,13,5]],"ì•…ë ¥":[[44.5,9999,1],[37,44.4,2],[28.5,36.9,3],[22,28.4,4],[0,21.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,7.3,1],[7.31,8.2,2],[8.21,9,3],[9.01,11.5,4],[11.51,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,416,1],[417,487,2],[488,583,3],[584,679,4],[680,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[37,9999,1],[34,36.9,2],[31,33.9,3],[28,30.9,4],[0,27.9,5]]},
    "ì¤‘3": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[68,9999,1],[54,67,2],[40,53,3],[24,39,4],[0,23,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[10,9999,1],[7,9.9,2],[2.6,6.9,3],[-3,2.5,4],[-999,-3.1,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[238.1,9999,1],[201.1,238,2],[180.1,201,3],[145.1,180,4],[0,145,5]],"íŒ”êµ½í˜€í´ê¸°":[[34,9999,1],[25,33,2],[14,24,3],[4,13,4],[0,3,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[90,9999,1],[55,89,2],[33,54,3],[14,32,4],[0,13,5]],"ì•…ë ¥":[[48.5,9999,1],[40.5,48.4,2],[33,40.4,3],[25,32.9,4],[0,24.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,7,1],[7.01,7.8,2],[7.81,8.5,3],[8.51,11,4],[11.01,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,407,1],[408,472,2],[473,567,3],[568,659,4],[660,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[40,9999,1],[37,39.9,2],[34,36.9,3],[31,33.9,4],[0,30.9,5]]},
    "ê³ 1": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[70,9999,1],[56,69,2],[42,55,3],[26,41,4],[0,25,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[13,9999,1],[9,12.9,2],[4,8.9,3],[-2,3.9,4],[-999,-2.1,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[255.1,9999,1],[216.1,255,2],[195.1,216,3],[160.1,195,4],[0,160,5]],"íŒ”êµ½í˜€í´ê¸°":[[46,9999,1],[30,45,2],[16,29,3],[7,15,4],[0,6,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[90,9999,1],[60,89,2],[35,59,3],[15,34,4],[0,14,5]],"ì•…ë ¥":[[61,9999,1],[42.5,60.9,2],[35.5,42.4,3],[29,35.4,4],[0,28.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,7,1],[7.01,7.6,2],[7.61,8.1,3],[8.11,10,4],[10.01,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,398,1],[399,457,2],[458,551,3],[552,639,4],[640,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[43,9999,1],[40,42.9,2],[37,39.9,3],[34,36.9,4],[0,33.9,5]]},
    "ê³ 2": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[72,9999,1],[58,71,2],[44,57,3],[28,43,4],[0,27,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[16,9999,1],[11,15.9,2],[5,10.9,3],[0.1,4.9,4],[0,0,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[258.1,9999,1],[228.1,258,2],[212.1,228,3],[177.1,212,4],[0,177,5]],"íŒ”êµ½í˜€í´ê¸°":[[50,9999,1],[42,49,2],[25,41,3],[11,24,4],[0,10,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[90,9999,1],[60,89,2],[35,59,3],[17,34,4],[0,16,5]],"ì•…ë ¥":[[61,9999,1],[46,60.9,2],[39,45.9,3],[31,38.9,4],[0,30.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,6.7,1],[6.71,7.5,2],[7.51,7.9,3],[7.91,9.5,4],[9.51,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,389,1],[390,442,2],[443,535,3],[536,619,4],[620,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[46,9999,1],[43,45.9,2],[40,42.9,3],[37,39.9,4],[0,36.9,5]]},
    "ê³ 3": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[74,9999,1],[60,73,2],[46,59,3],[30,45,4],[0,29,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[16,9999,1],[11,15.9,2],[6,10.9,3],[0.1,5.9,4],[0,0,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[264.1,9999,1],[243.1,264,2],[221.1,243,3],[185.1,221,4],[0,185,5]],"íŒ”êµ½í˜€í´ê¸°":[[56,9999,1],[46,55,2],[30,45,3],[17,29,4],[0,16,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[90,9999,1],[60,89,2],[35,59,3],[17,34,4],[0,16,5]],"ì•…ë ¥":[[63.5,9999,1],[46,63.4,2],[39,45.9,3],[31,38.9,4],[0,30.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,6.7,1],[6.71,7.5,2],[7.51,7.9,3],[7.91,8.7,4],[8.71,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,380,1],[381,427,2],[428,519,3],[520,599,4],[600,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[49,9999,1],[46,48.9,2],[43,45.9,3],[40,42.9,4],[0,39.9,5]]}
  },
  "ì—¬ì": {
    "ì´ˆ4": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[77,9999,1],[57,76,2],[40,56,3],[21,39,4],[0,20,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[161.1,9999,1],[135.1,161,2],[119.1,135,3],[97.1,119,4],[0,97,5]],"ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[60,9999,1],[29,59,2],[18,28,3],[6,17,4],[0,5,5]],"ì•…ë ¥":[[29,9999,1],[18,28.9,2],[13.5,17.9,3],[10.5,13.4,4],[0,10.4,5]],"50m ë‹¬ë¦¬ê¸°":[[0,9.4,1],[9.41,10.4,2],[10.41,11,3],[11.01,13.3,4],[13.31,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[20,9999,1],[17,19.9,2],[14,16.9,3],[11,13.9,4],[0,10.9,5]]},
    "ì´ˆ5": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[85,9999,1],[63,84,2],[45,62,3],[23,44,4],[0,22,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[10,9999,1],[7,9.9,2],[5,6.9,3],[1,4.9,4],[0,0.9,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[170.1,9999,1],[139.1,170,2],[123.1,139,3],[100.1,123,4],[0,100,5]],"ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[60,9999,1],[36,59,2],[23,35,3],[7,22,4],[0,6,5]],"ì•…ë ¥":[[29,9999,1],[19,28.9,2],[15.5,18.9,3],[12,15.4,4],[0,11.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.9,1],[8.91,9.9,2],[9.91,10.7,3],[10.71,13.3,4],[13.31,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,299,1],[300,359,2],[360,441,3],[442,501,4],[502,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[23,9999,1],[20,22.9,2],[17,19.9,3],[14,16.9,4],[0,13.9,5]]},
    "ì´ˆ6": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[93,9999,1],[69,92,2],[50,68,3],[25,49,4],[0,24,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[14,9999,1],[10,13.9,2],[5,9.9,3],[2,4.9,4],[0,1.9,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[175.1,9999,1],[144.1,175,2],[127.1,144,3],[100.1,127,4],[0,100,5]],"ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°":[[0,0,1],[0,0,2],[0,0,3],[0,0,4],[0,0,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[60,9999,1],[43,59,2],[23,42,3],[7,22,4],[0,6,5]],"ì•…ë ¥":[[33,9999,1],[22,32.9,2],[19,21.9,3],[14,18.9,4],[0,13.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.9,1],[8.91,9.8,2],[9.81,10.7,3],[10.71,12.9,4],[12.91,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,299,1],[300,353,2],[354,429,3],[430,479,4],[480,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[26,9999,1],[23,25.9,2],[20,22.9,3],[17,19.9,4],[0,16.9,5]]},
    "ì¤‘1": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[35,9999,1],[25,34,2],[19,24,3],[14,18,4],[0,13,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[15,9999,1],[11,14.9,2],[8,10.9,3],[2,7.9,4],[0,1.9,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[175.1,9999,1],[144.1,175,2],[127.1,144,3],[100.1,127,4],[0,100,5]],"ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°":[[45,9999,1],[24,44,2],[14,23,3],[6,13,4],[0,5,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[58,9999,1],[43,57,2],[22,42,3],[7,21,4],[0,6,5]],"ì•…ë ¥":[[36,9999,1],[23,35.9,2],[19,22.9,3],[14,18.9,4],[0,13.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.8,1],[8.81,9.8,2],[9.81,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[29,9999,1],[26,28.9,2],[23,25.9,3],[20,22.9,4],[0,19.9,5]]},
    "ì¤‘2": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[40,9999,1],[29,39,2],[21,28,3],[15,20,4],[0,14,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[15,9999,1],[11,14.9,2],[8,10.9,3],[2,7.9,4],[0,1.9,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[183.1,9999,1],[145.1,183,2],[127.1,145,3],[100.1,127,4],[0,100,5]],"ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°":[[40,9999,1],[24,39,2],[14,23,3],[6,13,4],[0,5,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[58,9999,1],[39,57,2],[19,38,3],[7,18,4],[0,6,5]],"ì•…ë ¥":[[36,9999,1],[25.5,35.9,2],[19.5,25.4,3],[14,19.4,4],[0,13.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.8,1],[8.81,9.8,2],[9.81,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[32,9999,1],[29,31.9,2],[26,28.9,3],[23,25.9,4],[0,22.9,5]]},
    "ì¤‘3": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[45,9999,1],[33,44,2],[23,32,3],[16,22,4],[0,15,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[16,9999,1],[11,15.9,2],[8,10.9,3],[2,7.9,4],[0,1.9,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[183.1,9999,1],[145.1,183,2],[127.1,145,3],[100.1,127,4],[0,100,5]],"ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°":[[40,9999,1],[24,39,2],[14,23,3],[6,13,4],[0,5,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[52,9999,1],[34,51,2],[17,33,3],[6,16,4],[0,5,5]],"ì•…ë ¥":[[36,9999,1],[27.5,35.9,2],[19.5,27.4,3],[16,19.4,4],[0,15.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.8,1],[8.81,9.8,2],[9.81,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[35,9999,1],[32,34.9,2],[29,31.9,3],[26,28.9,4],[0,25.9,5]]},
    "ê³ 1": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[50,9999,1],[37,49,2],[25,36,3],[17,24,4],[0,16,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[16,9999,1],[11,15.9,2],[8,10.9,3],[2,7.9,4],[0,1.9,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[186.1,9999,1],[159.1,186,2],[139.1,159,3],[100.1,139,4],[0,100,5]],"ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°":[[40,9999,1],[24,39,2],[14,23,3],[6,13,4],[0,5,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[40,9999,1],[30,39,2],[13,29,3],[4,12,4],[0,3,5]],"ì•…ë ¥":[[36,9999,1],[29,35.9,2],[23,28.9,3],[16.5,22.9,4],[0,16.4,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.8,1],[8.81,9.8,2],[9.81,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[38,9999,1],[35,37.9,2],[32,34.9,3],[29,31.9,4],[0,28.9,5]]},
    "ê³ 2": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[55,9999,1],[41,54,2],[27,40,3],[18,26,4],[0,17,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[17,9999,1],[12,16.9,2],[9,11.9,3],[5,8.9,4],[0,4.9,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[186.1,9999,1],[159.1,186,2],[139.1,159,3],[100.1,139,4],[0,100,5]],"ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°":[[40,9999,1],[30,39,2],[18,29,3],[9,17,4],[0,8,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[40,9999,1],[30,39,2],[13,29,3],[4,12,4],[0,3,5]],"ì•…ë ¥":[[37.5,9999,1],[29.5,37.4,2],[25,29.4,3],[18,24.9,4],[0,17.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.8,1],[8.81,9.5,2],[9.51,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[41,9999,1],[38,40.9,2],[35,37.9,3],[32,34.9,4],[0,31.9,5]]},
    "ê³ 3": {"ì™•ë³µì˜¤ë˜ë‹¬ë¦¬ê¸°":[[55,9999,1],[41,54,2],[27,40,3],[18,26,4],[0,17,5]],"ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°":[[17,9999,1],[12,16.9,2],[9,11.9,3],[5,8.9,4],[0,4.9,5]],"ì œìë¦¬ë©€ë¦¬ë›°ê¸°":[[186.1,9999,1],[159.1,186,2],[139.1,159,3],[100.1,139,4],[0,100,5]],"ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°":[[40,9999,1],[30,39,2],[18,29,3],[9,17,4],[0,8,5]],"ìœ—ëª¸ë§ì•„ì˜¬ë¦¬ê¸°":[[40,9999,1],[30,39,2],[13,29,3],[4,12,4],[0,3,5]],"ì•…ë ¥":[[37.5,9999,1],[29.5,37.4,2],[25,29.4,3],[18,24.9,4],[0,17.9,5]],"50m ë‹¬ë¦¬ê¸°":[[0,8.8,1],[8.81,9.5,2],[9.51,10.5,3],[10.51,12.2,4],[12.21,9999,5]],"ì˜¤ë˜ë‹¬ë¦¬ê¸°ê±·ê¸°":[[0,379,1],[380,442,2],[443,517,3],[518,608,4],[609,9999,5]],"ìŠ¤í…ê²€ì‚¬":[[76,9999,1],[62,75.9,2],[52,61.9,3],[47,51.9,4],[0,46.9,5]],"ë˜ì§€ê¸°":[[44,9999,1],[41,43.9,2],[38,40.9,3],[35,37.9,4],[0,34.9,5]]}
  },
  "BMI": {
    "ë‚¨ì": {
      "ì´ˆ4":[[14.1,20.1,"ì •ìƒ"],[20.2,22.3,"ê³¼ì²´ì¤‘"],[0,14,"ë§ˆë¦„"],[22.4,24.7,"ê²½ë„ë¹„ë§Œ"],[24.8,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ì´ˆ5":[[14.4,20.9,"ì •ìƒ"],[21,23.2,"ê³¼ì²´ì¤‘"],[0,14.3,"ë§ˆë¦„"],[23.3,25.8,"ê²½ë„ë¹„ë§Œ"],[25.9,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ì´ˆ6":[[15,21.7,"ì •ìƒ"],[21.8,24,"ê³¼ì²´ì¤‘"],[0,14.9,"ë§ˆë¦„"],[24.1,26.8,"ê²½ë„ë¹„ë§Œ"],[26.9,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ì¤‘1":[[15.4,23.2,"ì •ìƒ"],[23.3,24.9,"ê³¼ì²´ì¤‘"],[0,15.3,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ì¤‘2":[[15.8,23.8,"ì •ìƒ"],[23.9,24.9,"ê³¼ì²´ì¤‘"],[0,15.7,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ì¤‘3":[[16.3,24.3,"ì •ìƒ"],[24.4,24.9,"ê³¼ì²´ì¤‘"],[0,16.2,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ê³ 1":[[16.8,24.6,"ì •ìƒ"],[24.7,24.9,"ê³¼ì²´ì¤‘"],[0,16.7,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ê³ 2":[[17.3,24.9,"ì •ìƒ"],[25,29.9,"ê³¼ì²´ì¤‘"],[0,17.2,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ê³ 3":[[17.8,24.9,"ì •ìƒ"],[25,29.9,"ê³¼ì²´ì¤‘"],[0,17.7,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]]
        },
        "ì—¬ì": {
      "ì´ˆ4":[[13.9,19.9,"ì •ìƒ"],[20,22.1,"ê³¼ì²´ì¤‘"],[0,13.8,"ë§ˆë¦„"],[22.2,24.7,"ê²½ë„ë¹„ë§Œ"],[24.8,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ì´ˆ5":[[14.2,20.8,"ì •ìƒ"],[20.9,23.2,"ê³¼ì²´ì¤‘"],[0,14.1,"ë§ˆë¦„"],[23.3,25.8,"ê²½ë„ë¹„ë§Œ"],[25.9,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ì´ˆ6":[[14.8,21.8,"ì •ìƒ"],[21.9,24.2,"ê³¼ì²´ì¤‘"],[0,14.7,"ë§ˆë¦„"],[24.3,26.8,"ê²½ë„ë¹„ë§Œ"],[26.9,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ì¤‘1":[[15.2,22.1,"ì •ìƒ"],[22.2,24.7,"ê³¼ì²´ì¤‘"],[0,15.1,"ë§ˆë¦„"],[24.8,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ì¤‘2":[[15.7,22.7,"ì •ìƒ"],[22.8,24.9,"ê³¼ì²´ì¤‘"],[0,15.6,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ì¤‘3":[[16.3,23.2,"ì •ìƒ"],[23.3,24.9,"ê³¼ì²´ì¤‘"],[0,16.2,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ê³ 1":[[16.8,23.6,"ì •ìƒ"],[23.7,24.9,"ê³¼ì²´ì¤‘"],[0,16.7,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ê³ 2":[[17.3,23.8,"ì •ìƒ"],[23.9,24.9,"ê³¼ì²´ì¤‘"],[0,17.2,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]],
      "ê³ 3":[[17.7,23.9,"ì •ìƒ"],[24,24.9,"ê³¼ì²´ì¤‘"],[0,17.6,"ë§ˆë¦„"],[25,29.9,"ê²½ë„ë¹„ë§Œ"],[30,9999,"ê³ ë„ë¹„ë§Œ"]]
    }
  }
};

export class PapsManager {
    private papsData: PapsData;
    
    private $: (id: string) => HTMLElement;
    private saveDataToFirestore: () => void;
    
    // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê´€ë ¨ ì†ì„±
    private currentRankingData: { event: string; grade: string; gender: string; studentName: string } | null;
    private updateInterval: NodeJS.Timeout | null;
    private currentRankingPage: number;
    private selectedStudentForChart: string | null = null; // ê·¸ë˜í”„ì—ì„œ ì„ íƒëœ í•™ìƒ
    private currentRankingRecords: {record: number, name: string}[] | null = null; // í˜„ì¬ ë­í‚¹ ë°ì´í„° ì €ì¥

    constructor(
        papsData: PapsData,
        $: (id: string) => HTMLElement,
        saveDataToFirestore: () => void,
        cleanupSidebar?: () => void  // ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
    ) {
        this.papsData = papsData;
        this.$ = $;
        this.saveDataToFirestore = saveDataToFirestore;
        // cleanupSidebarëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ìì²´ ë©”ì„œë“œ ì‚¬ìš©)
        
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê´€ë ¨ ì†ì„±
        this.currentRankingData = null;
        this.updateInterval = null;
        this.currentRankingPage = 1;
    }

    /**
     * ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
     * íƒ€ì´ë¨¸ì™€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.
     */
    public cleanup(): void {
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘ì§€
        this.stopRealtimeUpdate();
        
        // updateIntervalì´ ë‚¨ì•„ìˆìœ¼ë©´ ê°•ì œë¡œ ì •ë¦¬
        if (this.updateInterval !== null) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
            logger.debug('PapsManager: ë‚¨ì•„ìˆë˜ updateInterval ì •ë¦¬ ì™„ë£Œ');
        }
        
        // ì¶”ê°€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ê°€ í•„ìš”í•œ ê²½ìš° ì—¬ê¸°ì— ì¶”ê°€
        logger.debug('PapsManager ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ');
    }

    /**
     * PAPS ë°ì´í„°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
     * @param data PAPS ë°ì´í„°
     */
    public setPapsData(data: PapsData): void {
        this.papsData = data;
    }

    /**
     * PAPS ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
     * @returns PAPS ë°ì´í„°
     */
    public getPapsData(): PapsData {
        return this.papsData;
    }

    /**
     * PAPS UIë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    public renderPapsUI(): void {
        // ê¸°ì¡´ ìš”ì†Œë“¤ ì •ë¦¬
        this.cleanupSidebar();
        
        this.$('#sidebarTitle').textContent = 'PAPS ë°˜ ëª©ë¡';
        const formHtml = `
            <div class="sidebar-form-group">
                <input id="papsClassName" type="text" placeholder="ìƒˆë¡œìš´ ë°˜ ì´ë¦„">
                <button onclick="papsManager.createPapsClass()" class="btn primary" data-tooltip="ìƒˆë¡œìš´ ë°˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤.">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>`;
        this.$('#sidebar-form-container').innerHTML = formHtml;
        
        
        // Progress, League ëª¨ë“œ ì „ìš© ì—‘ì…€ ë²„íŠ¼ ì œê±°
        const progressExcelActions = document.querySelector('.progress-excel-actions');
        if (progressExcelActions) {
            progressExcelActions.remove();
        }
        const leagueExcelActions = document.querySelector('.league-excel-actions');
        if (leagueExcelActions) {
            leagueExcelActions.remove();
        }
        
        // sidebar-list-containerê°€ Progress ëª¨ë“œì—ì„œ ìˆ¨ê²¨ì¡Œì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ í‘œì‹œ
        // CSSì˜ !importantë¥¼ overrideí•˜ê¸° ìœ„í•´ setProperty ì‚¬ìš©
        const sidebarListContainer = document.querySelector('#sidebar-list-container') as HTMLElement | null;
        if (sidebarListContainer) {
            // ì¦‰ì‹œ í‘œì‹œ
            sidebarListContainer.style.setProperty('display', 'flex', 'important');
            
            // ì•½ê°„ì˜ ì§€ì—° í›„ì—ë„ ë‹¤ì‹œ í™•ì¸ (ëª¨ë“œ ì „í™˜ í›„ CSSê°€ ì¬ì ìš©ë  ìˆ˜ ìˆìŒ)
            setTimeout(() => {
                const el = document.querySelector('#sidebar-list-container') as HTMLElement | null;
                if (el && !document.body.classList.contains('progress-mode')) {
                    el.style.setProperty('display', 'flex', 'important');
                }
            }, 50);
        }
        
        this.renderPapsClassList();

        // PAPS Excel ë²„íŠ¼ ì¶”ê°€ (sidebar-footer ì•)
        const sidebarFooter = document.querySelector('.sidebar-footer');
        if (sidebarFooter) {
            // ê¸°ì¡´ PAPS Excel ë²„íŠ¼ì´ ìˆìœ¼ë©´ ì œê±°
            const existingActions = document.querySelector('.paps-excel-actions');
            if (existingActions) {
                existingActions.remove();
            }
            
            // PAPS Excel ë²„íŠ¼ ì¶”ê°€
            const papsExcelActions = document.createElement('div');
            papsExcelActions.className = 'paps-excel-actions';
            papsExcelActions.style.cssText = 'padding: 16px; border-top: 1px solid var(--line); margin-top: auto;';
            papsExcelActions.innerHTML = `
                <button class="btn" onclick="papsManager.exportAllPapsToExcel()" style="width: 100%; margin-bottom: 8px; justify-content: center; background:var(--win); color:white;" data-tooltip="ëª¨ë“  ë°˜ì˜ PAPS ê¸°ë¡ì„ ì—‘ì…€ íŒŒì¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; margin-right: 8px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    ëª¨ë“  ë°˜ PAPS ê¸°ë¡ ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°
                </button>
                <input type="file" id="paps-all-excel-upload" accept=".xlsx,.xls" style="display: none;" onchange="papsManager.handleAllPapsExcelUpload(event)">
                <button class="btn" onclick="document.getElementById('paps-all-excel-upload').click()" style="width: 100%; justify-content: center;" data-tooltip="ì—‘ì…€ íŒŒì¼ì—ì„œ ëª¨ë“  ë°˜ì˜ PAPS ê¸°ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; margin-right: 8px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    ëª¨ë“  ë°˜ PAPS ê¸°ë¡ ì—‘ì…€ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                </button>
            `;
            sidebarFooter.parentNode?.insertBefore(papsExcelActions, sidebarFooter);
        }

        const selected = this.papsData.classes.find(c => c.id === this.papsData.activeClassId);
        if (!selected) {
            this.$('#content-wrapper').innerHTML = `
                <div class="placeholder-view"><div class="placeholder-content">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/><path d="M7 12h6"/></svg>
                    <h3>PAPS ë°˜ì„ ì„ íƒí•˜ê±°ë‚˜ ì¶”ê°€í•˜ì„¸ìš”</h3>
                    <p>ì™¼ìª½ì—ì„œ ë°˜ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒì„±í•´ì£¼ì„¸ìš”.</p>
                </div></div>`;
        } else {
            this.renderPapsDashboard(selected);
        }
        
    }

    /**
     * PAPS ë°˜ ëª©ë¡ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    public renderPapsClassList(): void {
        const sidebarList = this.$('#sidebar-list-container');
        if (sidebarList) {
            const html = this.papsData.classes.map(c => `
            <div class="list-card ${c.id === this.papsData.activeClassId ? 'active' : ''}" onclick="papsManager.selectPapsClass(${c.id})">
                <div style="flex-grow:1;">
                    <div class="name">${c.name}</div>
                    <div class="details">${(c.students||[]).length}ëª… Â· ${c.gradeLevel||'í•™ë…„ ë¯¸ì„¤ì •'}</div>
                </div>
                <div class="action-buttons row">
                    <button onclick="event.stopPropagation(); papsManager.showPapsSettings()" data-tooltip="ì„¤ì • ìˆ˜ì •"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button onclick="event.stopPropagation(); papsManager.editPapsClass(${c.id})" data-tooltip="ë°˜ í¸ì§‘"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button onclick="event.stopPropagation(); papsManager.deletePapsClass(${c.id})" data-tooltip="ë°˜ ì‚­ì œ"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3,6 5,6 21,6"></polyline><path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path></svg></button>
                </div>
            </div>
        `).join('');
            setInnerHTMLSafe(sidebarList, html);
        }
    }

    /**
     * PAPS ë°˜ì„ ìƒì„±í•©ë‹ˆë‹¤.
     */
    public createPapsClass(): void {
        const name = (this.$('#papsClassName') as HTMLInputElement).value.trim();
        
        // ì´ë¦„ ìœ íš¨ì„± ê²€ì‚¬
        if (!name) {
            showError(new Error('ë°˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'));
            return;
        }
        
        // ì¤‘ë³µ ê²€ì‚¬
        if (this.papsData.classes.some(c => c.name === name)) {
            showError(new Error('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°˜ ì´ë¦„ì…ë‹ˆë‹¤.'));
            return;
        }
        
        // ë°ì´í„° ìƒì„± ë° ê²€ì¦
        const newClassData = {
            id: Date.now(),
            name,
            gradeLevel: '1í•™ë…„',
            students: []
        };
        
        const validation = validateData(PapsClassSchema, newClassData);
        if (!validation.success) {
            if (validation.errors) {
                showError(validation.errors);
            } else if (validation.formattedErrors) {
                showError(new Error(validation.formattedErrors.join(', ')));
            } else {
                showError(new Error('ë°ì´í„° ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
            }
            return;
        }
        
        // ê²€ì¦ í†µê³¼ í›„ ì¶”ê°€
        const newClass = validation.data!;
        this.papsData.classes.push(newClass);
        
        (this.$('#papsClassName') as HTMLInputElement).value = '';
        this.saveDataToFirestore();
        this.renderPapsUI();
        showSuccess('ë°˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    /**
     * PAPS ë°˜ì„ í¸ì§‘í•©ë‹ˆë‹¤.
     */
    public editPapsClass(id: number): void {
        const cls = this.papsData.classes.find(c => c.id === id);
        if (!cls) return;

        const newName = prompt('ë°˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', cls.name);
        if (newName && newName.trim() && newName.trim() !== cls.name) {
            cls.name = newName.trim();
            this.saveDataToFirestore();
        this.renderPapsUI();
        }
    }

    /**
     * PAPS ë°˜ì„ ì‚­ì œí•©ë‹ˆë‹¤.
     */
    public deletePapsClass(id: number): void {
        if (!confirm('ì •ë§ë¡œ ì´ ë°˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
                        this.papsData.classes = this.papsData.classes.filter(c => c.id !== id);
                        if (this.papsData.activeClassId === id) {
                            this.papsData.activeClassId = null;
                        }
        this.saveDataToFirestore();
                        this.renderPapsUI();
    }

    /**
     * PAPS ë°˜ì„ ì„ íƒí•©ë‹ˆë‹¤.
     */
    public selectPapsClass(id: number): void {
        this.papsData.activeClassId = id;
        this.saveDataToFirestore();
        this.renderPapsUI();
    }

    /**
     * PAPS ëŒ€ì‹œë³´ë“œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    public renderPapsDashboard(cls: PapsClass): void {
        // ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸ (í•™ë…„ê³¼ ì´ë²¤íŠ¸ ì„¤ì •ì´ ëª¨ë‘ ìˆëŠ”ì§€)
        const hasSettings = cls.gradeLevel && cls.eventSettings && 
                           Object.keys(cls.eventSettings).length > 0;

        // ì„¤ì • ì»¨í…Œì´ë„ˆë¥¼ í•­ìƒ í‘œì‹œí•˜ë„ë¡ ìˆ˜ì • (ì„¤ì •ì´ ì™„ë£Œëœ ê²½ìš°ì—ëŠ” ìˆ¨ê¹€)
        let settingsCardHtml = `
            <div class="card" style="margin-bottom: 2rem; ${hasSettings ? 'display: none;' : ''}">
                <div class="card-header">
                    <div class="paps-toolbar" style="justify-content: space-between;">
                        <h3 style="margin: 0;">PAPS ì„¤ì •</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn primary" id="paps-save-settings-btn">ì„¤ì • ì €ì¥</button>
                            <button class="btn" id="paps-download-template-btn">í•™ìƒ ëª…ë ¬í‘œ ì–‘ì‹</button>
                            <input type="file" id="paps-student-upload" class="hidden" accept=".xlsx,.xls,.csv"/>
                            <button class="btn primary" id="paps-load-list-btn">ëª…ë ¬í‘œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="paps-grid">
                        <div class="paps-event-group"><label style="min-width:90px; color: var(--ink-muted);">í•™ë…„ ì„¤ì •</label>
                            <select id="paps-grade-select">
                                <option value="">í•™ë…„ ì„ íƒ</option>
                                <option value="ì´ˆ4">ì´ˆ4</option><option value="ì´ˆ5">ì´ˆ5</option><option value="ì´ˆ6">ì´ˆ6</option>
                                <option value="ì¤‘1">ì¤‘1</option><option value="ì¤‘2">ì¤‘2</option><option value="ì¤‘3">ì¤‘3</option>
                                <option value="ê³ 1">ê³ 1</option><option value="ê³ 2">ê³ 2</option><option value="ê³ 3">ê³ 3</option>
                            </select>
                        </div>
                        ${Object.keys(PAPS_ITEMS).filter(k=>k!=="ì²´ì§€ë°©").map(category => {
                            const item = PAPS_ITEMS[category];
                                    const current = cls.eventSettings?.[item.id] || item.options[0];
                            return `<div class="paps-event-group"><label style="min-width:90px; color: var(--ink-muted);">${category}</label><select data-paps-category="${item.id}">${item.options.map(o => `<option value="${o}" ${o===current?'selected':''}>${o}</option>`).join('')}</select></div>`;
                                }).join('')}
                            </div>
                        </div>
            </div>`;
        
            this.$('#content-wrapper').innerHTML = `
            <div class="paps-toolbar">
                <h2 style="margin:0;">${cls.name} PAPS ì„¤ì •</h2>
                <div class="row" style="gap: 8px;">
                    <span class="paps-chip">í•™ë…„: ${cls.gradeLevel || 'ë¯¸ì„¤ì •'}</span>
                    <button class="btn primary" id="generate-qr-codes-btn" style="padding: 8px 16px;">
                        ğŸ“± ê°œì¸ ê¸°ë¡ ì¡°íšŒ QR ì½”ë“œ ìƒì„±
                    </button>
                </div>
            </div>
            ${settingsCardHtml}
            <section class="section-box">
                <div class="paps-toolbar">
                    <h2 style="margin:0;">ê¸°ë¡ ì…ë ¥</h2>
                    <div class="row">
                        <button class="btn" id="paps-add-student-btn">í•™ìƒ ì¶”ê°€</button>
                        <button class="btn danger" id="paps-delete-selected-btn">ì„ íƒ ì‚­ì œ</button>
                </div>
                        </div>
                <div class="paps-table-wrap">
                    <table id="paps-record-table" class="styled-table">
                            <thead id="paps-record-head"></thead>
                            <tbody id="paps-record-body"></tbody>
                        </table>
                    </div>
            </section>
            
            <!-- ë‚˜ì˜ ê¸°ë¡ ë­í‚¹ ì„¹ì…˜ -->
            <section class="section-box">
                <div class="paps-toolbar">
                    <h2 style="margin:0;">ğŸ‘‘ ìš°ë¦¬ í•™êµ PAPS ì¢…ëª©ë³„ ë­í‚¹ ğŸ†</h2>
                </div>
                <div class="ranking-controls" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                    <div class="form-group">
                        <label>ì¢…ëª©</label>
                        <select id="ranking-event-select">
                            <option value="">ì¢…ëª© ì„ íƒ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>í•™ë…„</label>
                        <select id="ranking-grade-select">
                            <option value="">í•™ë…„ ì„ íƒ</option>
                            <option value="ì´ˆ4">ì´ˆ4</option>
                            <option value="ì´ˆ5">ì´ˆ5</option>
                            <option value="ì´ˆ6">ì´ˆ6</option>
                            <option value="ì¤‘1">ì¤‘1</option>
                            <option value="ì¤‘2">ì¤‘2</option>
                            <option value="ì¤‘3">ì¤‘3</option>
                            <option value="ê³ 1">ê³ 1</option>
                            <option value="ê³ 2">ê³ 2</option>
                            <option value="ê³ 3">ê³ 3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì„±ë³„</label>
                        <select id="ranking-gender-select">
                            <option value="">ì„±ë³„ ì„ íƒ</option>
                            <option value="ë‚¨ì">ë‚¨ì</option>
                            <option value="ì—¬ì">ì—¬ì</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì´ë¦„ (ì„ íƒì‚¬í•­)</label>
                        <input type="text" id="ranking-name-input" placeholder="í•™ìƒ ì´ë¦„ ì…ë ¥">
                    </div>
                    <div class="form-group" style="align-self: end;">
                        <button class="btn primary" id="ranking-search-btn">ë­í‚¹ ì¡°íšŒ</button>
                    </div>
                </div>
            <div id="ranking-results" style="display: none;">
                <div class="ranking-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    <div class="stat-card" id="personal-rank-card" style="display: none;">
                        <div class="stat-label">ë‚˜ì˜ ìˆœìœ„</div>
                        <div class="stat-value" id="personal-rank">-</div>
                    </div>
                </div>
                <div class="ranking-content-container">
                    <div class="ranking-table-container">
                        <div class="ranking-table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <h3 style="margin: 0;">ìˆœìœ„í‘œ</h3>
                                <span id="avg-record-display" style="font-size: 14px; color: #666; font-weight: 500;">í‰ê·  ê¸°ë¡: -</span>
                            </div>
                            <div class="pagination-controls" style="display: flex; gap: 8px; align-items: center;">
                                <button id="prev-page" class="btn btn-sm" style="display: none;">ì´ì „</button>
                                <span id="page-info" style="font-size: 14px; color: #666;"></span>
                                <button id="next-page" class="btn btn-sm" style="display: none;">ë‹¤ìŒ</button>
                                <button id="print-ranking-btn" class="btn btn-sm" style="background-color: #007bff; color: white;">
                                    ğŸ–¨ï¸ ì¸ì‡„
                                </button>
                                <div class="dropdown" style="margin-left: 8px;">
                                    <button id="share-btn" class="btn btn-sm" style="background-color: #28a745; color: white;">
                                        ğŸ“¤ ê³µìœ 
                                    </button>
                                    <div id="share-menu" class="dropdown-menu" style="display: none; position: absolute; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000; min-width: 150px;">
                                        <button id="realtime-share-btn" class="dropdown-item" style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; text-align: left; cursor: pointer;">ğŸ”— ì‹¤ì‹œê°„ ê³µìœ </button>
                                        <div style="border-top: 1px solid #eee; margin: 4px 0;"></div>
                                        <button id="copy-text-btn" class="dropdown-item" style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; text-align: left; cursor: pointer;">ğŸ“‹ í…ìŠ¤íŠ¸ ë³µì‚¬</button>
                                        <button id="copy-image-btn" class="dropdown-item" style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; text-align: left; cursor: pointer;">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì €ì¥</button>
                                    </div>
                                </div>
                                <button id="close-ranking-btn" class="btn btn-sm" style="background-color: #dc3545; color: white; margin-left: 8px;">
                                    âœ• ë‹«ê¸°
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="ranking-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">ìˆœìœ„</th>
                                        <th style="width: 200px;">ì´ë¦„</th>
                                        <th style="width: 120px;">ê¸°ë¡</th>
                                        <th style="width: 100px;">%</th>
                                    </tr>
                                </thead>
                                <tbody id="ranking-table-body">
                                </tbody>
                            </table>
                            <div style="margin-top: 12px; font-size: 12px; color: #666; text-align: center; font-style: italic;">
                                ğŸ’¡ ì´ë¦„ì„ í´ë¦­í•˜ë©´ ê·¸ë˜í”„ì—ì„œ í•™ìƒì˜ ìœ„ì¹˜ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                            </div>
                        </div>
                    </div>
                    <div class="ranking-chart-container">
                        <canvas id="ranking-distribution-chart" width="800" height="600"></canvas>
                    </div>
                </div>
            </div>
            </section>
        `;

        // Wire up selectors and actions
        // ì„¤ì • ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•­ìƒ ì¶”ê°€
            (this.$('#paps-grade-select') as HTMLSelectElement).value = cls.gradeLevel || '';
            this.$('#content-wrapper').querySelectorAll('select[data-paps-category]').forEach(sel => {
                sel.addEventListener('change', e => {
                    const target = e.target as HTMLSelectElement;
                    if (!cls.eventSettings) cls.eventSettings = {};
                    cls.eventSettings[target.dataset.papsCategory!] = target.value;
                    this.saveDataToFirestore();
                    this.buildPapsTable(cls);
                });
            });
            (this.$('#paps-grade-select') as HTMLSelectElement).addEventListener('change', e => { 
                const target = e.target as HTMLSelectElement;
                cls.gradeLevel = target.value; 
                this.saveDataToFirestore(); 
                this.buildPapsTable(cls);
                // ì¢Œì¸¡ ì‚¬ì´ë“œë°”ì˜ ë°˜ ì¹´ë“œë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                this.renderPapsClassList();
            });
            this.$('#paps-download-template-btn').addEventListener('click', () => this.papsDownloadTemplate());
            this.$('#paps-load-list-btn').addEventListener('click', () => this.$('#paps-student-upload').click());
            (this.$('#paps-student-upload') as HTMLInputElement).addEventListener('change', e => this.handlePapsStudentUpload(e, cls));
            // ì„¤ì • ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const saveSettingsBtn = this.$('#paps-save-settings-btn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', () => this.savePapsSettings());
            }
        
        // QR ì½”ë“œ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const generateQRCodesBtn = this.$('#generate-qr-codes-btn');
        if (generateQRCodesBtn) {
            generateQRCodesBtn.addEventListener('click', async () => {
                // ìœ íš¨ ê¸°ê°„ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
                const days = await this.showExpiresDaysModal();
                if (days !== null) {
                    await this.generateClassQRCodes(days);
                }
            });
        }

        this.$('#paps-add-student-btn').addEventListener('click', () => { 
            this.addPapsStudent(cls); 
            this.buildPapsTable(cls); 
            this.saveDataToFirestore(); 
        });
        this.$('#paps-delete-selected-btn').addEventListener('click', () => this.deleteSelectedPapsStudents(cls));
        
        // ë­í‚¹ ì¡°íšŒ ê¸°ëŠ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        this.setupRankingControls(cls);

        this.buildPapsTable(cls);
    }

    /**
     * PAPS í…Œì´ë¸”ì„ êµ¬ì„±í•©ë‹ˆë‹¤.
     */
    public buildPapsTable(cls: PapsClass): void {
        const head = this.$('#paps-record-head');
        const body = this.$('#paps-record-body');
        
        if (!head || !body) {
            logger.error('[PAPS í…Œì´ë¸”] í…Œì´ë¸” ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', { head: !!head, body: !!body });
            return;
        }
        
        logger.debug('[PAPS í…Œì´ë¸”] í…Œì´ë¸” êµ¬ì„± ì‹œì‘', { 
            className: cls.name, 
            studentCount: cls.students?.length || 0 
        });
        
        // Header build
        let header1 = '<tr><th rowspan="2"><input type="checkbox" id="paps-select-all"></th><th rowspan="2">ë²ˆí˜¸</th><th rowspan="2">ì´ë¦„</th><th rowspan="2">ì„±ë³„</th>';
        let header2 = '<tr>';
        
        Object.keys(PAPS_ITEMS).filter(k=>k!=="ì²´ì§€ë°©").forEach(category => {
            const item = PAPS_ITEMS[category]; 
            let eventName = cls.eventSettings?.[item.id] || item.options[0];
            // ì„±ë³„ì— ë”°ë¼ íŒ”êµ½í˜€í´ê¸° ì¢…ëª©ëª… ë³€ê²½
            if (eventName === 'íŒ”êµ½í˜€í´ê¸°') {
                eventName = 'íŒ”êµ½í˜€í´ê¸°/ë¬´ë¦ëŒ€ê³  íŒ”êµ½í˜€í´ê¸°';
            }
            // ì•…ë ¥ ì¢…ëª©ì€ ì™¼ì†/ì˜¤ë¥¸ì†ìœ¼ë¡œ ë¶„ë¦¬
            if (eventName === 'ì•…ë ¥') {
                header1 += `<th colspan="4">${eventName}</th>`; 
                header2 += '<th>ì™¼ì†(kg)</th><th>ì™¼ì†ë“±ê¸‰</th><th>ì˜¤ë¥¸ì†(kg)</th><th>ì˜¤ë¥¸ì†ë“±ê¸‰</th>';
            } else {
                header1 += `<th colspan="2">${eventName}</th>`; 
                header2 += '<th>ê¸°ë¡</th><th>ë“±ê¸‰</th>';
            }
        });
        header1 += '<th colspan="4">ì²´ì§€ë°©</th>'; 
        header2 += '<th>ì‹ ì¥(cm)</th><th>ì²´ì¤‘(kg)</th><th>BMI</th><th>ë“±ê¸‰</th>';
        header1 += '<th rowspan="2">ì¢…í•© ë“±ê¸‰</th></tr>'; 
        header2 += '</tr>';
        head.innerHTML = header1 + header2;
        
        (this.$('#paps-select-all') as HTMLInputElement).addEventListener('change', function(){ 
            body.querySelectorAll('.paps-row-checkbox').forEach(cb => (cb as HTMLInputElement).checked = this.checked); 
        });

        // Body
        body.innerHTML = ''; // ë¹ˆ ë¬¸ìì—´ì€ ì•ˆì „
        const students = (cls.students||[]).slice();
        
        if (students.length === 0) {
            logger.debug('[PAPS í…Œì´ë¸”] í•™ìƒ ë°ì´í„°ê°€ ì—†ìŒ - ë¹ˆ í…Œì´ë¸” í‘œì‹œ');
            // ë¹ˆ í…Œì´ë¸” ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒì‚¬í•­)
            // body.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 2rem; color: var(--ink-muted);">í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }
        
        // numberê°€ ì—†ëŠ” í•™ìƒë“¤ì—ê²Œ ìë™ìœ¼ë¡œ ë²ˆí˜¸ í• ë‹¹
        students.forEach((st, index) => {
            if (!st.number) {
                st.number = index + 1;
                logger.debug(`[PAPS í…Œì´ë¸”] í•™ìƒ ${st.id}ì—ê²Œ ë²ˆí˜¸ ${st.number} í• ë‹¹`);
            }
        });
        
        students.sort((a,b)=> (a.number||0)-(b.number||0));
        logger.debug('[PAPS í…Œì´ë¸”] í•™ìƒ ë°ì´í„°:', students.map(s => ({ 
            id: s.id, 
            number: s.number, 
            name: s.name,
            records: s.records,
            recordsKeys: s.records ? Object.keys(s.records) : []
        })));
        students.forEach(st => {
            const tr = document.createElement('tr'); 
            tr.dataset.sid = st.id.toString();
            
            // í•™ìƒ ë ˆì½”ë“œ ë°ì´í„° í™•ì¸
            const records = st.records || {};
            logger.debug(`[PAPS í…Œì´ë¸”] í•™ìƒ ${st.id} ë ˆì½”ë“œ:`, records);
            
            // ì²´í¬ë°•ìŠ¤
            const tdCheckbox = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'paps-row-checkbox';
            tdCheckbox.appendChild(checkbox);
            tr.appendChild(tdCheckbox);
            
            // ë²ˆí˜¸
            const tdNumber = document.createElement('td');
            const inputNumber = document.createElement('input');
            inputNumber.type = 'number';
            inputNumber.className = 'paps-input number';
            inputNumber.value = String(st.number || '');
            inputNumber.onchange = (e) => this.onPapsInput(e, cls);
            tdNumber.appendChild(inputNumber);
            tr.appendChild(tdNumber);
            
            // ì´ë¦„
            const tdName = document.createElement('td');
            const inputName = document.createElement('input');
            inputName.type = 'text';
            inputName.className = 'paps-input name';
            inputName.value = st.name || '';
            inputName.onchange = (e) => this.onPapsInput(e, cls);
            tdName.appendChild(inputName);
            tr.appendChild(tdName);
            
            // ì„±ë³„
            const tdGender = document.createElement('td');
            const selectGender = document.createElement('select');
            selectGender.className = 'paps-input gender';
            selectGender.onchange = (e) => this.onPapsInput(e, cls);
            const optionMale = document.createElement('option');
            optionMale.value = 'ë‚¨ì';
            optionMale.textContent = 'ë‚¨';
            if (st.gender === 'ë‚¨ì') optionMale.selected = true;
            const optionFemale = document.createElement('option');
            optionFemale.value = 'ì—¬ì';
            optionFemale.textContent = 'ì—¬';
            if (st.gender === 'ì—¬ì') optionFemale.selected = true;
            selectGender.appendChild(optionMale);
            selectGender.appendChild(optionFemale);
            tdGender.appendChild(selectGender);
            tr.appendChild(tdGender);
            
            // ê° ì¢…ëª©ë³„ ì…ë ¥ í•„ë“œ
            Object.keys(PAPS_ITEMS).filter(k=>k!=="ì²´ì§€ë°©").forEach(k => {
                const id = PAPS_ITEMS[k].id; 
                const eventName = cls.eventSettings?.[id] || PAPS_ITEMS[k].options[0];
                
                // ì•…ë ¥ ì¢…ëª©ì€ ì™¼ì†/ì˜¤ë¥¸ì†ìœ¼ë¡œ ë¶„ë¦¬
                if (eventName === 'ì•…ë ¥') {
                    // ì™¼ì† ì…ë ¥
                    const tdLeftInput = document.createElement('td');
                    const inputLeft = document.createElement('input');
                    inputLeft.type = 'number';
                    inputLeft.step = 'any';
                    inputLeft.className = 'paps-input rec';
                    inputLeft.dataset.id = `${id}_left`;
                    inputLeft.value = String(records[`${id}_left`] || '');
                    inputLeft.onchange = (e) => this.onPapsInput(e, cls);
                    tdLeftInput.appendChild(inputLeft);
                    tr.appendChild(tdLeftInput);
                    
                    // ì™¼ì† ë“±ê¸‰
                    const tdLeftGrade = document.createElement('td');
                    tdLeftGrade.className = 'grade-cell';
                    tdLeftGrade.dataset.id = `${id}_left`;
                    tr.appendChild(tdLeftGrade);
                    
                    // ì˜¤ë¥¸ì† ì…ë ¥
                    const tdRightInput = document.createElement('td');
                    const inputRight = document.createElement('input');
                    inputRight.type = 'number';
                    inputRight.step = 'any';
                    inputRight.className = 'paps-input rec';
                    inputRight.dataset.id = `${id}_right`;
                    inputRight.value = String(records[`${id}_right`] || '');
                    inputRight.onchange = (e) => this.onPapsInput(e, cls);
                    tdRightInput.appendChild(inputRight);
                    tr.appendChild(tdRightInput);
                    
                    // ì˜¤ë¥¸ì† ë“±ê¸‰
                    const tdRightGrade = document.createElement('td');
                    tdRightGrade.className = 'grade-cell';
                    tdRightGrade.dataset.id = `${id}_right`;
                    tr.appendChild(tdRightGrade);
                } else {
                    // ê¸°ë¡ ì…ë ¥
                    const tdInput = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.className = 'paps-input rec';
                    input.dataset.id = id;
                    input.value = String(records[id] || '');
                    input.onchange = (e) => this.onPapsInput(e, cls);
                    tdInput.appendChild(input);
                    tr.appendChild(tdInput);
                    
                    // ë“±ê¸‰
                    const tdGrade = document.createElement('td');
                    tdGrade.className = 'grade-cell';
                    tdGrade.dataset.id = id;
                    tr.appendChild(tdGrade);
                }
            });
            
            // ì‹ ì¥
            const tdHeight = document.createElement('td');
            const inputHeight = document.createElement('input');
            inputHeight.type = 'number';
            inputHeight.step = 'any';
            inputHeight.className = 'paps-input height';
            inputHeight.value = String(records.height || '');
            inputHeight.onchange = (e) => this.onPapsInput(e, cls);
            tdHeight.appendChild(inputHeight);
            tr.appendChild(tdHeight);
            
            // ì²´ì¤‘
            const tdWeight = document.createElement('td');
            const inputWeight = document.createElement('input');
            inputWeight.type = 'number';
            inputWeight.step = 'any';
            inputWeight.className = 'paps-input weight';
            inputWeight.value = String(records.weight || '');
            inputWeight.onchange = (e) => this.onPapsInput(e, cls);
            tdWeight.appendChild(inputWeight);
            tr.appendChild(tdWeight);
            
            // BMI ì…€
            const tdBMI = document.createElement('td');
            tdBMI.className = 'bmi-cell';
            tr.appendChild(tdBMI);
            
            // ì²´ì§€ë°© ë“±ê¸‰
            const tdBodyfatGrade = document.createElement('td');
            tdBodyfatGrade.className = 'grade-cell';
            tdBodyfatGrade.dataset.id = 'bodyfat';
            tr.appendChild(tdBodyfatGrade);
            
            // ì¢…í•© ë“±ê¸‰
            const tdOverallGrade = document.createElement('td');
            tdOverallGrade.className = 'overall-grade-cell';
            tr.appendChild(tdOverallGrade);
            
            body.appendChild(tr);
            
            // DOMì´ ì¶”ê°€ëœ ì§í›„ ë°”ë¡œ ë“±ê¸‰ ì—…ë°ì´íŠ¸
            this.updatePapsRowGrades(tr, cls);
        });
        
        // ëª¨ë“  í–‰ì´ ì¶”ê°€ëœ í›„ ë“±ê¸‰ ì—…ë°ì´íŠ¸ (DOMì´ ì™„ì „íˆ ì¤€ë¹„ëœ í›„)
        // ë‘ ë²ˆì˜ requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ DOMì´ ì™„ì „íˆ ë Œë”ë§ëœ í›„ ì‹¤í–‰
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                const rows = body.querySelectorAll('tr[data-sid]') as NodeListOf<HTMLTableRowElement>;
                logger.debug('[PAPS í…Œì´ë¸”] ë“±ê¸‰ ì—…ë°ì´íŠ¸ ì‹œì‘ (2ì°¨)', { rowCount: rows.length });
                rows.forEach(row => {
                    if (row.dataset.sid) {
                        this.updatePapsRowGrades(row, cls);
                    }
                });
            });
        });
        
        logger.debug('[PAPS í…Œì´ë¸”] í…Œì´ë¸” êµ¬ì„± ì™„ë£Œ', { 
            rowCount: body.querySelectorAll('tr').length 
        });

        // Enter í‚¤ ì²˜ë¦¬ë¥¼ ìœ„í•œ keydown ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„)
        body.addEventListener('keydown', e => {
            if (e.key !== 'Enter' || !(e.target as HTMLElement).matches('input')) return; 
            e.preventDefault();
            const cell = (e.target as HTMLElement).closest('td'); 
            const row = (e.target as HTMLElement).closest('tr'); 
            if(!cell||!row) return; 
            const idx = Array.from(row.children).indexOf(cell); 
            const next = row.nextElementSibling as HTMLTableRowElement | null; 
            if(next){ 
                const ncell = next.children[idx]; 
                const ninp = ncell?.querySelector('input'); 
                if(ninp){ 
                    (ninp as HTMLInputElement).focus(); 
                    (ninp as HTMLInputElement).select(); 
                }
            } else {
                const first = body.querySelector('tr') as HTMLTableRowElement | null; 
                if(first){ 
                    const fcell = first.children[idx]; 
                    const finp = fcell?.querySelector('input'); 
                    if(finp){ 
                        (finp as HTMLInputElement).focus(); 
                        (finp as HTMLInputElement).select(); 
                    }
                }
            }
        });
    }

    /**
     * PAPS ì…ë ¥ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
     */
    public onPapsInput(e: Event, cls: PapsClass): void {
        const target = e.target as HTMLElement;
        const tr = target.closest('tr'); 
        if (!tr) return;
        const sid = Number(tr.dataset.sid);
        const st = cls.students.find(s=>s.id===sid); 
        if(!st){ return; }

        st.records = st.records || {};
        if (target.classList.contains('rec')) { 
            st.records[(target as HTMLInputElement).dataset.id!] = Number((target as HTMLInputElement).value); 
        }
        else if (target.classList.contains('height')) { 
            st.records.height = Number((target as HTMLInputElement).value);
        }
        else if (target.classList.contains('weight')) { 
            st.records.weight = Number((target as HTMLInputElement).value);
        }
        else if (target.classList.contains('name')) { 
            st.name = (target as HTMLInputElement).value; 
        }
        else if (target.classList.contains('number')) { 
            st.number = Number((target as HTMLInputElement).value); 
        }
        else if (target.classList.contains('gender')) { 
            st.gender = (target as HTMLSelectElement).value as 'ë‚¨ì' | 'ì—¬ì'; 
        }
        this.updatePapsRowGrades(tr as HTMLTableRowElement, cls); 
        this.saveDataToFirestore();
        
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±° (ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ)
        if (this.currentRankingData) {
            this.updateRankingData(cls);
        }
    }

    /**
     * PAPS í–‰ ë“±ê¸‰ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    public updatePapsRowGrades(tr: HTMLTableRowElement, cls: PapsClass): void {
        // BMI
        const h = parseFloat((tr.querySelector('.height') as HTMLInputElement)?.value||''); 
        const w = parseFloat((tr.querySelector('.weight') as HTMLInputElement)?.value||'');
        const bmiCell = tr.querySelector('.bmi-cell'); 
        let bmi = null; 
        if (bmiCell) {
            if (h>0 && w>0){ 
                const m = h/100; 
                bmi = w/(m*m); 
                bmiCell.textContent = bmi.toFixed(2); 
            } else { 
                bmiCell.textContent = ''; 
            }
        } else {
            logger.warn('[PAPS ë“±ê¸‰ ì—…ë°ì´íŠ¸] BMI ì…€ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        }
        
        // Each category
        const studentGender = (tr.querySelector('.gender') as HTMLSelectElement)?.value || 'ë‚¨ì'; 
        const gradeLevel = cls.gradeLevel || '';
        
        // grade-cell ìš”ì†Œë“¤ì„ ì°¾ì•„ì„œ ì´ˆê¸°í™”
        const gradeCells = tr.querySelectorAll('.grade-cell');
        if (gradeCells.length === 0) {
            logger.warn('[PAPS ë“±ê¸‰ ì—…ë°ì´íŠ¸] grade-cell ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', { 
                rowId: tr.dataset.sid,
                hasRow: !!tr,
                rowChildrenCount: tr.children.length
            });
            return;
        }
        
        gradeCells.forEach(td => {
            td.textContent=''; 
            td.className='grade-cell'; 
        });
        
        logger.debug(`[PAPS ë“±ê¸‰ ì—…ë°ì´íŠ¸] í•™ìƒ ì„±ë³„: ${studentGender}, í•™ë…„: ${gradeLevel}`);
        
        Object.keys(PAPS_ITEMS).forEach(k => {
            const id = PAPS_ITEMS[k].id; 
            const eventName = cls.eventSettings?.[id] || PAPS_ITEMS[k].options[0];
            
            logger.debug(`[PAPS ë“±ê¸‰ ì—…ë°ì´íŠ¸] ì¹´í…Œê³ ë¦¬: ${k}, ID: ${id}, ì´ë²¤íŠ¸ëª…: ${eventName}`);

            if (id === 'bodyfat') {
                const value = bmi;
                const td = tr.querySelector(`.grade-cell[data-id="${id}"]`);
                const gradeText = value ? this.calcPapsGrade(id, value, studentGender, gradeLevel, cls) : '';
                if (td) {
                    td.textContent = gradeText||''; 
                    if(gradeText){ 
                        td.classList.add(`grade-${gradeText}`);
                    }
                }
            } else if (eventName === 'ì•…ë ¥') {
                // ì•…ë ¥ì€ ì™¼ì†ê³¼ ì˜¤ë¥¸ì† ê°ê° ì²˜ë¦¬
                const leftValue = parseFloat((tr.querySelector(`.rec[data-id="${id}_left"]`) as HTMLInputElement)?.value||'');
                const rightValue = parseFloat((tr.querySelector(`.rec[data-id="${id}_right"]`) as HTMLInputElement)?.value||'');
                
                if (!isNaN(leftValue)) {
                    const leftGrade = this.calcPapsGrade(`${id}_left`, leftValue, studentGender, gradeLevel, cls);
                const leftTd = tr.querySelector(`.grade-cell[data-id="${id}_left"]`);
                if (leftTd) {
                    leftTd.textContent = leftGrade || '';
                    if (leftGrade) {
                        // ê¸°ì¡´ ë“±ê¸‰ í´ë˜ìŠ¤ ì œê±°
                        leftTd.classList.remove('grade-1ë“±ê¸‰', 'grade-2ë“±ê¸‰', 'grade-3ë“±ê¸‰', 'grade-4ë“±ê¸‰', 'grade-5ë“±ê¸‰');
                        // ìƒˆë¡œìš´ ë“±ê¸‰ í´ë˜ìŠ¤ ì¶”ê°€ (ìˆ«ìë§Œ ì¶”ì¶œ)
                        const gradeNumber = leftGrade.replace('ë“±ê¸‰', '');
                        leftTd.classList.add(`grade-${gradeNumber}`);
                    }
                }
                }
                
                if (!isNaN(rightValue)) {
                    const rightGrade = this.calcPapsGrade(`${id}_right`, rightValue, studentGender, gradeLevel, cls);
                    const rightTd = tr.querySelector(`.grade-cell[data-id="${id}_right"]`);
                if (rightTd) {
                    rightTd.textContent = rightGrade || '';
                    if (rightGrade) {
                        // ê¸°ì¡´ ë“±ê¸‰ í´ë˜ìŠ¤ ì œê±°
                        rightTd.classList.remove('grade-1ë“±ê¸‰', 'grade-2ë“±ê¸‰', 'grade-3ë“±ê¸‰', 'grade-4ë“±ê¸‰', 'grade-5ë“±ê¸‰');
                        // ìƒˆë¡œìš´ ë“±ê¸‰ í´ë˜ìŠ¤ ì¶”ê°€ (ìˆ«ìë§Œ ì¶”ì¶œ)
                        const gradeNumber = rightGrade.replace('ë“±ê¸‰', '');
                        rightTd.classList.add(`grade-${gradeNumber}`);
                    }
                    }
                }
            } else {
                const value = parseFloat((tr.querySelector(`.rec[data-id="${id}"]`) as HTMLInputElement)?.value||'');
                logger.debug(`[PAPS ë“±ê¸‰ ì—…ë°ì´íŠ¸] ${k} - ì…ë ¥ê°’: ${value}, isNaN: ${isNaN(value)}`);
                if (!isNaN(value)) {
                    const grade = this.calcPapsGrade(id, value, studentGender, gradeLevel, cls);
                const td = tr.querySelector(`.grade-cell[data-id="${id}"]`);
                    logger.debug(`[PAPS ë“±ê¸‰ ì—…ë°ì´íŠ¸] ${k} - ê³„ì‚°ëœ ë“±ê¸‰: ${grade}, TD ìš”ì†Œ:`, td);
                if (td) {
                    td.textContent = grade || '';
                    if (grade) {
                        // ê¸°ì¡´ ë“±ê¸‰ í´ë˜ìŠ¤ ì œê±°
                        td.classList.remove('grade-1ë“±ê¸‰', 'grade-2ë“±ê¸‰', 'grade-3ë“±ê¸‰', 'grade-4ë“±ê¸‰', 'grade-5ë“±ê¸‰');
                        // ìƒˆë¡œìš´ ë“±ê¸‰ í´ë˜ìŠ¤ ì¶”ê°€ (ìˆ«ìë§Œ ì¶”ì¶œ)
                        const gradeNumber = grade.replace('ë“±ê¸‰', '');
                        td.classList.add(`grade-${gradeNumber}`);
                    }
                    logger.debug(`[PAPS ë“±ê¸‰ ì—…ë°ì´íŠ¸] ${k} - UI ì ìš© ì™„ë£Œ: ${td.textContent}`);
                    }
                }
            }
        });

        // ì¢…í•© ë“±ê¸‰ ê³„ì‚°
        const overallGrade = this.calcOverallGrade(tr);
        const overallTd = tr.querySelector('.overall-grade-cell');
        if (overallTd) {
            overallTd.textContent = overallGrade || '';
            if (overallGrade) {
                // ê¸°ì¡´ ë“±ê¸‰ í´ë˜ìŠ¤ ì œê±°
                overallTd.classList.remove('grade-1ë“±ê¸‰', 'grade-2ë“±ê¸‰', 'grade-3ë“±ê¸‰', 'grade-4ë“±ê¸‰', 'grade-5ë“±ê¸‰');
                // ìƒˆë¡œìš´ ë“±ê¸‰ í´ë˜ìŠ¤ ì¶”ê°€ (ìˆ«ìë§Œ ì¶”ì¶œ)
                const gradeNumber = overallGrade.replace('ë“±ê¸‰', '');
                overallTd.classList.add(`grade-${gradeNumber}`);
            }
        }
    }

    /**
     * PAPS ë“±ê¸‰ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
     */
    public calcPapsGrade(categoryId: string, value: number, gender: string, gradeLevel: string, cls: PapsClass): string {
        logger.debug(`[calcPapsGrade í˜¸ì¶œ] categoryId: ${categoryId}, value: ${value}, gender: ${gender}, gradeLevel: ${gradeLevel}`);
        if (value==null || isNaN(value) || !gender || !gradeLevel) {
            logger.debug(`[calcPapsGrade ì¡°ê¸° ì¢…ë£Œ] value: ${value}, gender: ${gender}, gradeLevel: ${gradeLevel}`);
            return '';
        }
        let selectedTest: string | null = null;
        if (categoryId === 'bodyfat') {
            selectedTest = 'BMI';
        } else {
            const baseCategoryId = /_(left|right)$/.test(categoryId)
                ? categoryId.replace(/_(left|right)$/, '')
                : categoryId;
            const catKey = Object.keys(PAPS_ITEMS).find(k => PAPS_ITEMS[k].id === baseCategoryId);
            const itemDef = catKey ? PAPS_ITEMS[catKey] : undefined;
            selectedTest = (cls.eventSettings?.[baseCategoryId]) || (itemDef ? itemDef.options[0] : null);
            if (!selectedTest) return '';
            if (selectedTest === 'íŒ”êµ½í˜€í´ê¸°' && gender === 'ì—¬ì') selectedTest = 'ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°';
        }
        let ranges: Array<[number,number,string|number]> | undefined;
        if (selectedTest === 'BMI') {
            ranges = PAPS_CRITERIA_DATA?.BMI?.[gender]?.[gradeLevel];
        } else {
            ranges = PAPS_CRITERIA_DATA?.[gender]?.[gradeLevel]?.[selectedTest];
            if (!ranges) {
                const genderCriteria = (PAPS_CRITERIA_DATA as any)?.[gender] || {};
                for (const anyGrade of Object.keys(genderCriteria)) {
                    const candidate = genderCriteria[anyGrade]?.[selectedTest!];
                    if (candidate) { ranges = candidate; break; }
                }
            }
        }
        if (!ranges) return '';
        
        // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
        logger.debug(`[PAPS ë“±ê¸‰ ê³„ì‚°] ì¢…ëª©: ${selectedTest}, ì„±ë³„: ${gender}, í•™ë…„: ${gradeLevel}, ê°’: ${value}`);
        logger.debug(`[PAPS ë“±ê¸‰ ê³„ì‚°] ê¸°ì¤€í‘œ:`, ranges);
        
        // ë²”ìœ„ë¥¼ ì—­ìˆœìœ¼ë¡œ í™•ì¸ (ë†’ì€ ê°’ë¶€í„° í™•ì¸í•˜ì—¬ ìµœê³  ë“±ê¸‰ë¶€í„° ë§¤ì¹­)
        for (let i = ranges.length - 1; i >= 0; i--) {
            const [a,b,g] = ranges[i];
            const min = Math.min(a,b), max = Math.max(a,b);
            logger.debug(`[PAPS ë“±ê¸‰ ê³„ì‚°] ë²”ìœ„ í™•ì¸: ${min} <= ${value} <= ${max} ? ${value >= min && value <= max} â†’ ${g}ë“±ê¸‰`);
            if (value >= min && value <= max) return typeof g === 'number' ? `${g}ë“±ê¸‰` : String(g);
        }
        return '';
    }

    /**
     * ì „ì²´ ë“±ê¸‰ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
     */
    public calcOverallGrade(tr: HTMLTableRowElement): string {
        const grades = Array.from(tr.querySelectorAll('.grade-cell')).map(td => td.textContent).filter(g => g && g !== '');
        if (grades.length === 0) return '';
        
        // ë“±ê¸‰ë³„ ì ìˆ˜ ê³„ì‚° (1ë“±ê¸‰=5ì , 2ë“±ê¸‰=4ì , ..., 5ë“±ê¸‰=1ì )
        const gradeScores: number[] = grades.map(grade => {
            if (grade === '1ë“±ê¸‰') return 5;
            if (grade === '2ë“±ê¸‰') return 4;
            if (grade === '3ë“±ê¸‰') return 3;
            if (grade === '4ë“±ê¸‰') return 2;
            if (grade === '5ë“±ê¸‰') return 1;
            if (grade === 'ì •ìƒ') return 4; // BMI ì •ìƒì€ 2ë“±ê¸‰ ìˆ˜ì¤€
            if (grade === 'ê³¼ì²´ì¤‘') return 3; // BMI ê³¼ì²´ì¤‘ì€ 3ë“±ê¸‰ ìˆ˜ì¤€
            if (grade === 'ë¹„ë§Œ') return 1; // BMI ë¹„ë§Œì€ 5ë“±ê¸‰ ìˆ˜ì¤€
            return 0;
        });
        
        const averageScore = gradeScores.reduce((sum, score) => sum + score, 0) / gradeScores.length;
        
        if (averageScore >= 4.5) return '1ë“±ê¸‰';
        if (averageScore >= 3.5) return '2ë“±ê¸‰';
        if (averageScore >= 2.5) return '3ë“±ê¸‰';
        if (averageScore >= 1.5) return '4ë“±ê¸‰';
        return '5ë“±ê¸‰';
    }

    /**
     * PAPS í•™ìƒì„ ì¶”ê°€í•©ë‹ˆë‹¤.
     */
    public addPapsStudent(cls: PapsClass): void {
        const id = Date.now();
        cls.students.push({
            id,
            number: (cls.students?.length||0)+1, 
            name: '',
            gender: 'ë‚¨ì',
            records: {}
        });
    }

    /**
     * ì„ íƒëœ PAPS í•™ìƒì„ ì‚­ì œí•©ë‹ˆë‹¤.
     */
    public deleteSelectedPapsStudents(cls: PapsClass): void {
        const rows = Array.from(this.$('#paps-record-body').querySelectorAll('tr'));
        const keep: number[] = [];
        rows.forEach(r => {
            const checked = (r.querySelector('.paps-row-checkbox') as HTMLInputElement)?.checked;
            const sid = Number(r.dataset.sid);
            if (!checked) keep.push(sid);
        });
        cls.students = (cls.students||[]).filter(s => keep.includes(s.id));
        this.buildPapsTable(cls);
        this.saveDataToFirestore();
    }

    /**
     * PAPS í…œí”Œë¦¿ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
     */
    public papsDownloadTemplate(): void {
        // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤
        if (typeof window !== 'undefined' && (window as any).XLSX) {
            const wb = (window as any).XLSX.utils.book_new();
            const ws = (window as any).XLSX.utils.aoa_to_sheet([
                ["ë²ˆí˜¸","ì´ë¦„","ì„±ë³„"],
                [1,'ê¹€ì²´ìœ¡','ë‚¨ì'],
                [2,'ë°•ê±´ê°•','ì—¬ì']
            ]);
            ws['!cols'] = [{wch:8},{wch:14},{wch:8}];
            (window as any).XLSX.utils.book_append_sheet(wb, ws, 'í•™ìƒ ëª…ë ¬í‘œ');
            (window as any).XLSX.writeFile(wb, 'PAPS_í•™ìƒëª…ë ¬í‘œ_ì–‘ì‹.xlsx');
        } else {
            alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
    }

    /**
     * PAPS ì„¤ì •ì„ ì €ì¥í•©ë‹ˆë‹¤.
     */
    public savePapsSettings(): void {
        // ì„¤ì •ì´ ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì¶”ê°€ ì‘ì—… ë¶ˆí•„ìš”
        alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // ì„¤ì • ì €ì¥ í›„ ì„¤ì • ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
        const settingsCard = this.$('#content-wrapper').querySelector('.card') as HTMLElement;
        if (settingsCard) {
            settingsCard.style.display = 'none';
        }
    }

    /**
     * PAPS ì„¤ì •ì„ í‘œì‹œí•©ë‹ˆë‹¤.
     */
    public showPapsSettings(): void {
        // ì„¤ì • ì»¨í…Œì´ë„ˆ ë‹¤ì‹œ í‘œì‹œ
        const settingsCard = this.$('#content-wrapper').querySelector('.card') as HTMLElement;
        if (settingsCard) {
            settingsCard.style.display = 'block';
        }
    }

    /**
     * ë­í‚¹ ì¡°íšŒ ì»¨íŠ¸ë¡¤ì„ ì„¤ì •í•©ë‹ˆë‹¤.
     */
    private setupRankingControls(cls: PapsClass): void {
        // ì¢…ëª© ì„ íƒ ì˜µì…˜ ì±„ìš°ê¸°
        const eventSelect = this.$('#ranking-event-select') as HTMLSelectElement;
        if (eventSelect) {
            Object.keys(PAPS_ITEMS).forEach(category => {
                const item = PAPS_ITEMS[category];
                const eventName = cls.eventSettings?.[item.id] || item.options[0];
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = eventName;
                eventSelect.appendChild(option);
            });
        }
        
        // ë­í‚¹ ì¡°íšŒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const searchBtn = this.$('#ranking-search-btn');
        if (searchBtn) {
            searchBtn.addEventListener('click', () => this.searchRanking(cls));
        }
        
        // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const closeBtn = this.$('#close-ranking-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.closeRanking());
        }
    }
    
    /**
     * ë­í‚¹ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
     */
    private searchRanking(cls: PapsClass): void {
        const eventId = (this.$('#ranking-event-select') as HTMLSelectElement).value;
        const grade = (this.$('#ranking-grade-select') as HTMLSelectElement).value;
        const gender = (this.$('#ranking-gender-select') as HTMLSelectElement).value;
        const studentName = (this.$('#ranking-name-input') as HTMLInputElement).value.trim();
        
        if (!eventId || !grade || !gender) {
            alert('ì¢…ëª©, í•™ë…„, ì„±ë³„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” í•™ìƒë“¤ì˜ ê¸°ë¡ ìˆ˜ì§‘ (ì´ë¦„ê³¼ í•¨ê»˜)
        const recordsWithNames: {record: number, name: string}[] = [];
        let personalRecord: number | null = null;
        
        this.papsData.classes.forEach(c => {
            if (c.gradeLevel === grade) {
                c.students.forEach(student => {
                    if (student.gender === gender) {
                        const record = student.records?.[eventId];
                        // ìœ íš¨í•œ ìˆ«ìì¸ì§€ ë” ì—„ê²©í•˜ê²Œ ê²€ì¦
                        if (record !== undefined && record !== null && 
                            typeof record === 'number' && !isNaN(record) && 
                            isFinite(record) && record > 0) {
                            recordsWithNames.push({record, name: student.name});
                            
                            // ê°œì¸ ê¸°ë¡ì´ ìˆëŠ” ê²½ìš°
                            if (studentName && student.name === studentName) {
                                personalRecord = record;
                            }
                        }
                }
            });
        }
        });
        
        if (recordsWithNames.length === 0) {
            alert('í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ë””ë²„ê¹…: ìˆ˜ì§‘ëœ ë°ì´í„° í™•ì¸
        logger.debug('ìˆ˜ì§‘ëœ ê¸°ë¡ ë°ì´í„°:', recordsWithNames);
        
        // í†µê³„ ê³„ì‚°
        const records = recordsWithNames.map(item => item.record);
        records.sort((a, b) => b - a); // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ë†’ì€ ê¸°ë¡ì´ ì¢‹ì€ ê²½ìš°)
        
        // ë””ë²„ê¹…: ì •ë ¬ëœ ê¸°ë¡ í™•ì¸
        logger.debug('ì •ë ¬ëœ ê¸°ë¡:', records);
        logger.debug('ê¸°ë¡ í•©ê³„:', records.reduce((sum, record) => sum + record, 0));
        logger.debug('ê¸°ë¡ ê°œìˆ˜:', records.length);
        
        // í‰ê·  ê¸°ë¡ ê³„ì‚° (ëª¨ë“  ê¸°ë¡ì˜ í•©ì„ ì¸ì›ìˆ˜ë¡œ ë‚˜ëˆ„ê¸°)
        const avgRecord = records.reduce((sum, record) => sum + record, 0) / records.length;
        
        // ë””ë²„ê¹…: í‰ê·  ê³„ì‚° ê²°ê³¼ í™•ì¸
        logger.debug('ê³„ì‚°ëœ í‰ê· :', avgRecord);
        
        // í‰ê·  ê¸°ë¡ì„ ìˆœìœ„í‘œ ì œëª©ì— í‘œì‹œ
        const avgRecordDisplay = this.$('#avg-record-display') as HTMLElement;
        if (avgRecordDisplay) {
            avgRecordDisplay.textContent = `í‰ê·  ê¸°ë¡: ${avgRecord.toFixed(2)}`;
        }
        
        // ê°œì¸ ê¸°ë¡ì´ ìˆëŠ” ê²½ìš° ìˆœìœ„ì™€ ìƒìœ„% ê³„ì‚°
        if (personalRecord !== null) {
            // ìˆœìœ„ ê³„ì‚°ì„ ìœ„í•´ ì •ë ¬ëœ ë°°ì—´ ìƒì„±
            const sortedRecords = recordsWithNames.sort((a, b) => b.record - a.record);
            const rank = this.findRankForRecord(sortedRecords, personalRecord);
            // ìƒìœ„% ê³„ì‚°: ì‘ì€ ìˆ«ìê°€ ì¢‹ì€ ê²½ìš° (ë‚®ì€ ìˆœìœ„ê°€ ì¢‹ìŒ)
            const percentile = ((records.length - rank + 1) / records.length * 100).toFixed(1);
            
            this.$('#personal-rank').textContent = `${rank}ìœ„`;
            
            (this.$('#personal-rank-card') as HTMLElement).style.display = 'block';
        } else {
            (this.$('#personal-rank-card') as HTMLElement).style.display = 'none';
        }
        
        // í˜„ì¬ ë­í‚¹ ë°ì´í„° ì €ì¥
        this.currentRankingRecords = recordsWithNames;
        this.selectedStudentForChart = null; // ì´ˆê¸°í™”
        
        // ìˆœìœ„ í…Œì´ë¸” ìƒì„±
        this.renderRankingTable(recordsWithNames, studentName);
        
        // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
        (this.$('#ranking-results') as HTMLElement).style.display = 'block';
        
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
        this.startRealtimeUpdate(eventId, grade, gender, studentName, cls);
    }
    
    /**
     * ê°™ì€ ê¸°ë¡ì„ ê°€ì§„ ê²½ìš° ë™ì¼í•œ ìˆœìœ„ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
     * @param sortedRecords ì •ë ¬ëœ ê¸°ë¡ ë°°ì—´ (ë‚´ë¦¼ì°¨ìˆœ)
     * @returns ê° í•­ëª©ì˜ ìˆœìœ„ë¥¼ í¬í•¨í•œ ë°°ì—´
     */
    private calculateRanks(sortedRecords: {record: number, name: string}[]): number[] {
        const ranks: number[] = [];
        
        for (let i = 0; i < sortedRecords.length; i++) {
            // ì²« ë²ˆì§¸ í•­ëª©ì´ê±°ë‚˜ ì´ì „ ê¸°ë¡ê³¼ ë‹¤ë¥¸ ê²½ìš° ìƒˆë¡œìš´ ìˆœìœ„ ì‹œì‘
            if (i === 0 || sortedRecords[i].record !== sortedRecords[i - 1].record) {
                // í˜„ì¬ ìœ„ì¹˜ê°€ ìˆœìœ„ (1ë¶€í„° ì‹œì‘)
                ranks.push(i + 1);
            } else {
                // ì´ì „ ê¸°ë¡ê³¼ ê°™ì€ ê²½ìš° ì´ì „ ìˆœìœ„ì™€ ë™ì¼
                ranks.push(ranks[i - 1]);
            }
        }
        
        return ranks;
    }

    /**
     * íŠ¹ì • ê¸°ë¡ì˜ ìˆœìœ„ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
     * @param sortedRecords ì •ë ¬ëœ ê¸°ë¡ ë°°ì—´ (ë‚´ë¦¼ì°¨ìˆœ)
     * @param targetRecord ì°¾ì„ ê¸°ë¡
     * @returns ìˆœìœ„ (1ë¶€í„° ì‹œì‘)
     */
    private findRankForRecord(sortedRecords: {record: number, name: string}[], targetRecord: number): number {
        const ranks = this.calculateRanks(sortedRecords);
        const index = sortedRecords.findIndex(item => item.record === targetRecord);
        return index >= 0 ? ranks[index] : 0;
    }

    /**
     * ìˆœìœ„ í…Œì´ë¸”ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
     * @param recordsWithNames ê¸°ë¡ê³¼ ì´ë¦„ ë°°ì—´
     * @param studentName í•™ìƒ ì´ë¦„ (ì„ íƒì‚¬í•­)
     * @param resetPage í˜ì´ì§€ë¥¼ 1ë¡œ ì´ˆê¸°í™”í• ì§€ ì—¬ë¶€ (ê¸°ë³¸ê°’: true)
     */
    private renderRankingTable(recordsWithNames: {record: number, name: string}[], studentName: string, resetPage: boolean = true): void {
        // ê¸°ë¡ì„ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
        const sortedRecords = recordsWithNames.sort((a, b) => b.record - a.record);
        // ìˆœìœ„ ê³„ì‚°
        const ranks = this.calculateRanks(sortedRecords);
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
        const itemsPerPage = 10;
        const totalPages = Math.ceil(sortedRecords.length / itemsPerPage);
        
        // í˜„ì¬ í˜ì´ì§€ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ë­í‚¹ ì¡°íšŒ ì‹œë§Œ)
        if (resetPage) {
            this.currentRankingPage = 1;
        }
        
        // í˜„ì¬ í˜ì´ì§€ê°€ ì´ í˜ì´ì§€ ìˆ˜ë¥¼ ì´ˆê³¼í•˜ëŠ” ê²½ìš° ì¡°ì •
        if (this.currentRankingPage > totalPages && totalPages > 0) {
            this.currentRankingPage = totalPages;
        }
        
        // í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜
        const renderTable = (page: number) => {
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, sortedRecords.length);
            const pageRecords = sortedRecords.slice(startIndex, endIndex);
            
            const tbody = this.$('#ranking-table-body') as HTMLElement;
            if (!tbody) return;
            
            // ê¸°ì¡´ ë‚´ìš© ì œê±°
            tbody.innerHTML = '';
            
            // DOM APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ì ‘ í–‰ ìƒì„±
            pageRecords.forEach((item, index) => {
                const globalIndex = startIndex + index;
                const rank = ranks[globalIndex];
                const isPersonalRecord = studentName && item.name === studentName;
                
                const tr = document.createElement('tr');
                tr.dataset.rank = String(rank);
                if (isPersonalRecord) {
                    tr.className = 'table-warning';
                }
                
                // ìˆœìœ„ ì…€
                const tdRank = document.createElement('td');
                tdRank.style.textAlign = 'center';
                tdRank.style.fontWeight = 'bold';
                tdRank.style.color = '#007bff';
                tdRank.textContent = String(rank);
                tr.appendChild(tdRank);
                
                // ì´ë¦„ ì…€ (í´ë¦­ ê°€ëŠ¥)
                const tdName = document.createElement('td');
                tdName.style.textAlign = 'center';
                tdName.style.fontWeight = '500';
                tdName.style.cursor = 'pointer';
                tdName.style.color = this.selectedStudentForChart === item.name ? '#dc3545' : 'inherit';
                tdName.style.textDecoration = 'underline';
                tdName.textContent = item.name || '';
                tdName.addEventListener('click', () => {
                    // ì„ íƒëœ í•™ìƒ ë³€ê²½
                    this.selectedStudentForChart = this.selectedStudentForChart === item.name ? null : item.name;
                    // ê·¸ë˜í”„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    if (this.currentRankingRecords) {
                        this.drawStandardDeviationChart(this.currentRankingRecords, studentName);
                    }
                    // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§ (ìƒ‰ìƒ ì—…ë°ì´íŠ¸)
                    renderTable(page);
                });
                tr.appendChild(tdName);
                
                // ê¸°ë¡ ì…€
                const tdRecord = document.createElement('td');
                tdRecord.style.textAlign = 'center';
                tdRecord.style.fontWeight = 'bold';
                tdRecord.style.color = '#28a745';
                tdRecord.textContent = String(item.record);
                tr.appendChild(tdRecord);
                
                // í¼ì„¼íŠ¸ ê³„ì‚°: ë‚®ì€ ìˆœìœ„ì¼ìˆ˜ë¡ ë†’ì€ í¼ì„¼íŠ¸ (1ìœ„ = 0%, ë§ˆì§€ë§‰ ìˆœìœ„ = 100%ì— ê°€ê¹Œì›€)
                const percentile = ((rank - 1) / sortedRecords.length * 100).toFixed(1);
                
                // í¼ì„¼íŠ¸ ì…€
                const tdPercent = document.createElement('td');
                tdPercent.style.textAlign = 'center';
                tdPercent.style.fontWeight = 'bold';
                tdPercent.style.color = '#6f42c1';
                tdPercent.textContent = `${percentile}%`;
                tr.appendChild(tdPercent);
                
                tbody.appendChild(tr);
            });
            
            // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
            const pageInfo = this.$('#page-info') as HTMLElement;
            if (pageInfo) {
                pageInfo.textContent = `${page} / ${totalPages} í˜ì´ì§€ (ì´ ${sortedRecords.length}ëª…)`;
            }
            
            // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const prevBtn = this.$('#prev-page') as HTMLButtonElement;
            const nextBtn = this.$('#next-page') as HTMLButtonElement;
            
            if (prevBtn) {
                prevBtn.style.display = page > 1 ? 'block' : 'none';
            }
            if (nextBtn) {
                nextBtn.style.display = page < totalPages ? 'block' : 'none';
            }
        };
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const prevBtn = this.$('#prev-page') as HTMLButtonElement;
        const nextBtn = this.$('#next-page') as HTMLButtonElement;
        
        if (prevBtn) {
            prevBtn.onclick = () => {
                if (this.currentRankingPage > 1) {
                    this.currentRankingPage--;
                    renderTable(this.currentRankingPage);
                }
            };
        }
        
        if (nextBtn) {
            nextBtn.onclick = () => {
                if (this.currentRankingPage < totalPages) {
                    this.currentRankingPage++;
                    renderTable(this.currentRankingPage);
                }
            };
        }
        
        // ì¸ì‡„ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const printBtn = this.$('#print-ranking-btn') as HTMLButtonElement;
        if (printBtn) {
            printBtn.onclick = () => {
                this.printRankingTable(sortedRecords, studentName);
            };
        }
        
        // ê³µìœ  ê¸°ëŠ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        this.setupShareControls(sortedRecords, studentName);
        
        // í‘œì¤€í¸ì°¨ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        this.drawStandardDeviationChart(sortedRecords, studentName);
        
        
        // ì´ˆê¸° í…Œì´ë¸” ë Œë”ë§
        renderTable(this.currentRankingPage);
    }


    /**
     * ê³µìœ  ê¸°ëŠ¥ ì»¨íŠ¸ë¡¤ì„ ì„¤ì •í•©ë‹ˆë‹¤.
     */
    private setupShareControls(sortedRecords: {record: number, name: string}[], studentName: string): void {
        const shareBtn = this.$('#share-btn') as HTMLButtonElement;
        const shareMenu = this.$('#share-menu') as HTMLElement;
        const realtimeShareBtn = this.$('#realtime-share-btn') as HTMLButtonElement;
        const copyTextBtn = this.$('#copy-text-btn') as HTMLButtonElement;
        const copyImageBtn = this.$('#copy-image-btn') as HTMLButtonElement;

        if (!shareBtn || !shareMenu || !realtimeShareBtn || !copyTextBtn || !copyImageBtn) return;

        // ê³µìœ  ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ í† ê¸€
        shareBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            shareMenu.style.display = shareMenu.style.display === 'none' ? 'block' : 'none';
        });

        // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ìˆ¨ê¸°ê¸°
        document.addEventListener('click', () => {
            shareMenu.style.display = 'none';
        });

        // ì‹¤ì‹œê°„ ê³µìœ  ê¸°ëŠ¥
        realtimeShareBtn.addEventListener('click', () => {
            this.createRealtimeShare(sortedRecords, studentName);
            shareMenu.style.display = 'none';
        });

        // í…ìŠ¤íŠ¸ ë³µì‚¬ ê¸°ëŠ¥
        copyTextBtn.addEventListener('click', () => {
            this.copyRankingAsText(sortedRecords, studentName);
            shareMenu.style.display = 'none';
        });

        // ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥
        copyImageBtn.addEventListener('click', () => {
            this.saveRankingAsImage(sortedRecords, studentName);
            shareMenu.style.display = 'none';
        });
    }

    /**
     * ì‹¤ì‹œê°„ ê³µìœ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private async createRealtimeShare(sortedRecords: {record: number, name: string}[], studentName: string): Promise<void> {
        try {
            // ê³µìœ  ID ìƒì„±
            const shareId = this.generateShareId();
            
            // ê³µìœ  ë°ì´í„° êµ¬ì„±
            const avgRecordDisplay = this.$('#avg-record-display') as HTMLElement;
            const avgText = avgRecordDisplay ? avgRecordDisplay.textContent : 'í‰ê·  ê¸°ë¡: -';
            
            const shareData = {
                id: shareId,
                title: 'PAPS ìˆœìœ„í‘œ',
                avgRecord: avgText,
                records: sortedRecords,
                personalName: studentName,
                createdAt: new Date().toISOString(),
                lastUpdated: new Date().toISOString()
            };

            // Firebaseì— ê³µìœ  ë°ì´í„° ì €ì¥ (window.firebase ì‚¬ìš©)
            const { db, setDoc, doc } = (window as any).firebase;
            
            // Firebaseì— ë°ì´í„° ì €ì¥
            await setDoc(doc(db, 'sharedRankings', shareId), {
                ...shareData,
                createdAt: new Date(),
                lastUpdated: new Date()
            });

            // ê³µìœ  ë§í¬ ìƒì„±
            const shareUrl = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
            
            // í´ë¦½ë³´ë“œì— ë§í¬ ë³µì‚¬
            await navigator.clipboard.writeText(shareUrl);
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            this.showShareSuccessModal(shareUrl, shareId);
            
        } catch (error) {
            logError('ì‹¤ì‹œê°„ ê³µìœ  ìƒì„± ì‹¤íŒ¨:', error);
            alert('ì‹¤ì‹œê°„ ê³µìœ  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    /**
     * ê³µìœ  IDë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private generateShareId(): string {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < 8; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    /**
     * ê³µìœ  ì„±ê³µ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
     */
    private showShareSuccessModal(shareUrl: string, shareId: string): void {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        
        const modalHtml = `
            <div style="background: white; padding: 24px; border-radius: 8px; max-width: 500px; width: 90%;">
                <h3 style="margin: 0 0 16px 0; color: #28a745;">âœ… ì‹¤ì‹œê°„ ê³µìœ  ìƒì„± ì™„ë£Œ!</h3>
                <p style="margin: 0 0 16px 0; color: #666;">ê³µìœ  ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; margin: 16px 0;">
                    <strong>ê³µìœ  ë§í¬:</strong><br>
                    <span style="word-break: break-all; font-family: monospace; font-size: 12px;">${shareUrl}</span>
                </div>
                <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; margin: 16px 0;">
                    <strong>ê³µìœ  ID:</strong> ${shareId}<br>
                    <small style="color: #666;">ì´ IDë¡œ ì–¸ì œë“ ì§€ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button id="close-modal" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">í™•ì¸</button>
                </div>
            </div>
        `;
        setInnerHTMLSafe(modal, modalHtml);
        
        document.body.appendChild(modal);
        
        // ëª¨ë‹¬ ë‹«ê¸°
        const closeBtn = modal.querySelector('#close-modal') as HTMLButtonElement;
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        
        // ë°°ê²½ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    /**
     * ìˆœìœ„í‘œë¥¼ ì¸ì‡„í•©ë‹ˆë‹¤.
     */
    private printRankingTable(sortedRecords: {record: number, name: string}[], studentName: string): void {
        // ìˆœìœ„ ê³„ì‚°
        const ranks = this.calculateRanks(sortedRecords);
        
        // ì¸ì‡„ìš© ì„ì‹œ ì»¨í…Œì´ë„ˆ ìƒì„±
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì–´ ì¸ì‡„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const avgRecordDisplay = this.$('#avg-record-display') as HTMLElement;
        const avgText = avgRecordDisplay ? avgRecordDisplay.textContent : 'í‰ê·  ê¸°ë¡: -';
        
        // ì¸ì‡„ìš© HTML ìƒì„±
        let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PAPS ìˆœìœ„í‘œ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .avg-record {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
        }
        th {
            background-color: #f8f9fa;
            padding: 12px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-weight: bold;
        }
        td {
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .personal-record {
            background-color: #fff3cd !important;
            font-weight: bold;
        }
        .rank {
            font-weight: bold;
            color: #007bff;
        }
        .record {
            font-weight: bold;
            color: #28a745;
        }
        .percent {
            font-weight: bold;
            color: #6f42c1;
        }
        @media print {
            body {
                margin: 0;
            }
            @page {
                margin: 1cm;
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ† PAPS ìˆœìœ„í‘œ</h1>
    <div class="avg-record">${avgText}</div>
    <table>
        <thead>
            <tr>
                <th style="width: 80px;">ìˆœìœ„</th>
                <th style="width: 200px;">ì´ë¦„</th>
                <th style="width: 120px;">ê¸°ë¡</th>
                <th style="width: 100px;">ìƒìœ„%</th>
            </tr>
        </thead>
        <tbody>
`;
        
        sortedRecords.forEach((item, index) => {
            const rank = ranks[index];
            const percentile = ((rank - 1) / sortedRecords.length * 100).toFixed(1);
            const isPersonalRecord = studentName && item.name === studentName;
            const rowClass = isPersonalRecord ? 'personal-record' : '';
            
            html += `
            <tr class="${rowClass}">
                <td class="rank">${rank}ìœ„</td>
                <td>${item.name || ''}</td>
                <td class="record">${item.record}</td>
                <td class="percent">${percentile}%</td>
            </tr>
`;
        });
        
        html += `
        </tbody>
    </table>
    <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #666;">
        ì¸ì‡„ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}
    </div>
</body>
</html>
`;
        
        printWindow.document.write(html);
        printWindow.document.close();
        
        // ì¸ì‡„ ëŒ€í™”ìƒì í‘œì‹œ
        setTimeout(() => {
            printWindow.print();
            // ì¸ì‡„ í›„ ì°½ ë‹«ê¸° (ì„ íƒì‚¬í•­)
            // printWindow.close();
        }, 250);
    }

    /**
     * ìˆœìœ„í‘œë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.
     */
    private copyRankingAsText(sortedRecords: {record: number, name: string}[], studentName: string): void {
        const avgRecordDisplay = this.$('#avg-record-display') as HTMLElement;
        const avgText = avgRecordDisplay ? avgRecordDisplay.textContent : 'í‰ê·  ê¸°ë¡: -';
        
        // ìˆœìœ„ ê³„ì‚°
        const ranks = this.calculateRanks(sortedRecords);
        
        let text = `ğŸ† PAPS ìˆœìœ„í‘œ\n`;
        text += `${avgText}\n\n`;
        text += `ìˆœìœ„ | ì´ë¦„ | ê¸°ë¡ | ìƒìœ„%\n`;
        text += `-----|------|------|------\n`;
        
        sortedRecords.forEach((item, index) => {
            const rank = ranks[index];
            const percentile = ((rank - 1) / sortedRecords.length * 100).toFixed(1);
            const highlight = studentName && item.name === studentName ? 'â­ ' : '';
            text += `${highlight}${rank}ìœ„ | ${item.name} | ${item.record} | ${percentile}%\n`;
        });
        
        navigator.clipboard.writeText(text).then(() => {
            alert('ìˆœìœ„í‘œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }).catch(() => {
            alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    }

    /**
     * ìˆœìœ„í‘œë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
     */
    private saveRankingAsImage(sortedRecords: {record: number, name: string}[], studentName: string): void {
        const table = this.$('#ranking-table') as HTMLTableElement;
        if (!table) return;

        // ìº”ë²„ìŠ¤ ìƒì„±
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        if (!ctx) return;

        // í…Œì´ë¸” í¬ê¸° ê³„ì‚°
        const rect = table.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height + 100; // ì œëª© ê³µê°„ ì¶”ê°€

        // ë°°ê²½ ê·¸ë¦¬ê¸°
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ì œëª© ê·¸ë¦¬ê¸°
        ctx.fillStyle = '#333333';
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ğŸ† PAPS ìˆœìœ„í‘œ', canvas.width / 2, 30);

        // í‰ê·  ê¸°ë¡ ê·¸ë¦¬ê¸°
        const avgRecordDisplay = this.$('#avg-record-display') as HTMLElement;
        if (avgRecordDisplay) {
            ctx.font = '14px Arial';
            ctx.fillStyle = '#666666';
            ctx.fillText(avgRecordDisplay.textContent || '', canvas.width / 2, 55);
        }

        // í…Œì´ë¸” ê·¸ë¦¬ê¸° (ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ í˜•íƒœ)
        ctx.font = '12px Arial';
        ctx.textAlign = 'left';
        ctx.fillStyle = '#333333';
        
        let y = 80;
        const rowHeight = 20;
        
        // í—¤ë”
        ctx.fillText('ìˆœìœ„', 20, y);
        ctx.fillText('ì´ë¦„', 80, y);
        ctx.fillText('ê¸°ë¡', 200, y);
        ctx.fillText('ìƒìœ„%', 280, y);
        y += rowHeight;
        
        // êµ¬ë¶„ì„ 
        ctx.strokeStyle = '#cccccc';
        ctx.beginPath();
        ctx.moveTo(20, y);
        ctx.lineTo(canvas.width - 20, y);
        ctx.stroke();
        y += 10;
        
        // ë°ì´í„° í–‰ (ìµœëŒ€ 10ê°œ)
        const displayRecords = sortedRecords.slice(0, 10);
        displayRecords.forEach((item, index) => {
            const rank = index + 1;
            const percentile = ((rank - 1) / sortedRecords.length * 100).toFixed(1);
            const highlight = studentName && item.name === studentName;
            
            if (highlight) {
                ctx.fillStyle = '#fff3cd';
                ctx.fillRect(15, y - 15, canvas.width - 30, rowHeight);
            }
            
            ctx.fillStyle = highlight ? '#856404' : '#333333';
            ctx.fillText(`${rank}ìœ„`, 20, y);
            ctx.fillText(item.name, 80, y);
            ctx.fillText(item.record.toString(), 200, y);
            ctx.fillText(`${percentile}%`, 280, y);
            y += rowHeight;
        });

        // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
        canvas.toBlob((blob) => {
            if (blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `PAPS_ìˆœìœ„í‘œ_${new Date().toISOString().split('T')[0]}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('ìˆœìœ„í‘œ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        });
    }

    /**
     * PAPS í•™ìƒ ì—…ë¡œë“œë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
     */
    public handlePapsStudentUpload(event: Event, cls: PapsClass): void {
        const target = event.target as HTMLInputElement;
        const file = target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            try {
                if (typeof window !== 'undefined' && (window as any).XLSX) {
                    const data = new Uint8Array(e.target?.result as ArrayBuffer);
                    const wb = (window as any).XLSX.read(data, {type:'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = (window as any).XLSX.utils.sheet_to_json(ws, {header:1});
                    const newStudents: PapsStudent[] = [];
                    
                    for(let i=1; i<json.length; i++){
                        const row = json[i];
                        if(!row || row.length === 0) continue;
                        const num = row[0];
                        const name = row[1];
                        let gender = row[2] || 'ë‚¨ì';
                        if(typeof gender === 'string'){
                            if(gender.includes('ì—¬')) gender = 'ì—¬ì';
                            else gender = 'ë‚¨ì';
                        } else gender = 'ë‚¨ì';
                        newStudents.push({ 
                            id: Date.now() + i, 
                            number: num, 
                            name, 
                            gender: gender as 'ë‚¨ì' | 'ì—¬ì', 
                            records: {} 
                        });
                    }
                    cls.students = newStudents;
                    this.buildPapsTable(cls);
                    this.saveDataToFirestore();
                    alert('í•™ìƒ ëª…ë ¬í‘œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
            } catch(err) {
                alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                target.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    /**
     * PAPSë¥¼ ì—‘ì…€ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.
     */
    public exportPapsToExcel(cls: PapsClass): void {
        if (!cls || !cls.students || cls.students.length === 0) {
            alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (typeof window !== 'undefined' && (window as any).XLSX) {
            // ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ë¡œì§ êµ¬í˜„
            alert('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.');
        } else {
            alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
    }

    /**
     * ëª¨ë“  PAPSë¥¼ ì—‘ì…€ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.
     */
    public exportAllPapsToExcel(): void {
        if (typeof window === 'undefined' || !(window as any).XLSX) {
            alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            const XLSX = (window as any).XLSX;
            const wb = XLSX.utils.book_new();

            if (this.papsData.classes.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ê° ë°˜ë³„ë¡œ ì‹œíŠ¸ ìƒì„±
            this.papsData.classes.forEach((cls) => {
                const data: any[][] = [
                    ['ë°˜ëª…', cls.name],
                    ['í•™ë…„', cls.gradeLevel || 'ë¯¸ì„¤ì •'],
                    ['', ''], // ë¹ˆ ì¤„
                ];

                // ì´ë²¤íŠ¸ ì„¤ì • ì •ë³´
                if (cls.eventSettings && Object.keys(cls.eventSettings).length > 0) {
                    data.push(['í•­ëª© ì„¤ì •', '']);
                    Object.keys(PAPS_ITEMS).filter(k => k !== 'ì²´ì§€ë°©').forEach(category => {
                        const item = PAPS_ITEMS[category];
                        const eventName = cls.eventSettings?.[item.id] || item.options[0];
                        data.push([category, eventName]);
                    });
                    data.push(['', '']); // ë¹ˆ ì¤„
                }

                // í—¤ë” ìƒì„±
                const headers = ['ë²ˆí˜¸', 'ì´ë¦„', 'ì„±ë³„', 'í‚¤', 'ëª¸ë¬´ê²Œ', 'BMI'];
                
                // PAPS í•­ëª© í—¤ë” ì¶”ê°€
                Object.keys(PAPS_ITEMS).forEach(category => {
                    const item = PAPS_ITEMS[category];
                    const eventName = cls.eventSettings?.[item.id] || item.options[0];
                    
                    if (item.id === 'bodyfat') {
                        headers.push('BMI');
                    } else if (eventName === 'ì•…ë ¥') {
                        headers.push('ì•…ë ¥(ì™¼)', 'ì•…ë ¥(ì˜¤)');
                    } else {
                        headers.push(eventName);
                    }
                });

                // ë“±ê¸‰ í—¤ë” ì¶”ê°€
                Object.keys(PAPS_ITEMS).forEach(category => {
                    const item = PAPS_ITEMS[category];
                    const eventName = cls.eventSettings?.[item.id] || item.options[0];
                    
                    if (item.id === 'bodyfat') {
                        headers.push('BMI ë“±ê¸‰');
                    } else if (eventName === 'ì•…ë ¥') {
                        headers.push('ì•…ë ¥(ì™¼) ë“±ê¸‰', 'ì•…ë ¥(ì˜¤) ë“±ê¸‰');
                    } else {
                        headers.push(`${eventName} ë“±ê¸‰`);
                    }
                });

                data.push(headers);

                // í•™ìƒ ë°ì´í„°
                if (cls.students && cls.students.length > 0) {
                    cls.students.forEach((student) => {
                        const row: any[] = [
                            student.number || '',
                            student.name || '',
                            student.gender || '',
                            student.records.height || '',
                            student.records.weight || '',
                            student.records.bmi || ''
                        ];

                        // PAPS í•­ëª© ë°ì´í„° ì¶”ê°€
                        Object.keys(PAPS_ITEMS).forEach(category => {
                            const item = PAPS_ITEMS[category];
                            const eventName = cls.eventSettings?.[item.id] || item.options[0];
                            
                            if (item.id === 'bodyfat') {
                                row.push(student.records.bmi || '');
                            } else if (eventName === 'ì•…ë ¥') {
                                row.push(student.records[`${item.id}_left`] || '', student.records[`${item.id}_right`] || '');
                            } else {
                                row.push(student.records[item.id] || '');
                            }
                        });

                        // ë“±ê¸‰ ë°ì´í„° ì¶”ê°€
                        Object.keys(PAPS_ITEMS).forEach(category => {
                            const item = PAPS_ITEMS[category];
                            const eventName = cls.eventSettings?.[item.id] || item.options[0];
                            
                            if (item.id === 'bodyfat') {
                                row.push(student.records[`${item.id}_grade`] || '');
                            } else if (eventName === 'ì•…ë ¥') {
                                row.push(student.records[`${item.id}_left_grade`] || '', student.records[`${item.id}_right_grade`] || '');
                            } else {
                                row.push(student.records[`${item.id}_grade`] || '');
                            }
                        });

                        data.push(row);
                    });
                } else {
                    data.push(['í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', '', '', '', '', '']);
                }

                // ì‹œíŠ¸ ìƒì„±
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
                const colWidths = headers.map(() => ({ wch: 15 }));
                ws['!cols'] = colWidths;

                // ì‹œíŠ¸ ì´ë¦„ (ë°˜ ì´ë¦„, ìµœëŒ€ 31ì)
                const sheetName = cls.name.length > 31 ? cls.name.substring(0, 31) : cls.name;
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });

            // íŒŒì¼ ì €ì¥
            const fileName = `PAPS_ê¸°ë¡_ì „ì²´_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showSuccess('ëª¨ë“  ë°˜ì˜ PAPS ê¸°ë¡ì´ ì—‘ì…€ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.');
        } catch (error) {
            logError('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
            showError(new Error('ì—‘ì…€ íŒŒì¼ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
        }
    }

    /**
     * PAPS ê¸°ë¡ ì—…ë¡œë“œë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
     */
    public handlePapsRecordUpload(event: Event, cls: PapsClass): void {
        // PAPS ê¸°ë¡ ì—…ë¡œë“œ ë¡œì§ êµ¬í˜„
        alert('PAPS ê¸°ë¡ ì—…ë¡œë“œ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.');
    }

    /**
     * ëª¨ë“  PAPS ì—‘ì…€ ì—…ë¡œë“œë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
     */
    public handleAllPapsExcelUpload(event: Event): void {
        const input = event.target as HTMLInputElement;
        if (!input.files || input.files.length === 0) {
            return;
        }

        const file = input.files[0];
        if (typeof window === 'undefined' || !(window as any).XLSX) {
            alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const XLSX = (window as any).XLSX;
                const data = new Uint8Array(e.target?.result as ArrayBuffer);
                const wb = XLSX.read(data, { type: 'array' });

                const importedClasses: PapsClass[] = [];

                // ê° ì‹œíŠ¸ë¥¼ ìˆœíšŒí•˜ë©´ì„œ ë°ì´í„° íŒŒì‹±
                wb.SheetNames.forEach((sheetName: string) => {
                    const ws = wb.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' }) as any[][];

                    if (json.length < 5) {
                        return;
                    }

                    // ë°˜ ì •ë³´ íŒŒì‹±
                    let className = '';
                    let gradeLevel = '';
                    
                    // ì²« ë²ˆì§¸ í–‰: ë°˜ëª…
                    if (json[0] && json[0].length >= 2) {
                        className = String(json[0][1] || sheetName).trim();
                    } else {
                        className = sheetName;
                    }
                    
                    // ë‘ ë²ˆì§¸ í–‰: í•™ë…„
                    if (json[1] && json[1].length >= 2) {
                        gradeLevel = String(json[1][1] || '').trim();
                    }

                    // ì´ë²¤íŠ¸ ì„¤ì • íŒŒì‹± (í•­ëª© ì„¤ì • ì„¹ì…˜ ì°¾ê¸°)
                    const eventSettings: Record<string, string> = {};
                    let headerRowIndex = -1;
                    
                    // í•­ëª© ì„¤ì • ì„¹ì…˜ ì°¾ê¸°
                    for (let i = 0; i < json.length; i++) {
                        if (json[i] && json[i][0] === 'í•­ëª© ì„¤ì •') {
                            // í•­ëª© ì„¤ì • ì„¹ì…˜ì—ì„œ ì´ë²¤íŠ¸ ì„¤ì • ì¶”ì¶œ
                            let j = i + 1;
                            while (j < json.length && json[j] && json[j][0] && json[j][0] !== '') {
                                const category = String(json[j][0] || '').trim();
                                const eventName = String(json[j][1] || '').trim();
                                
                                if (category && eventName) {
                                    // ì¹´í…Œê³ ë¦¬ ì´ë¦„ìœ¼ë¡œ ID ì°¾ê¸°
                                    const categoryKey = Object.keys(PAPS_ITEMS).find(k => k === category);
                                    if (categoryKey) {
                                        eventSettings[PAPS_ITEMS[categoryKey].id] = eventName;
                                    }
                                }
                                j++;
                            }
                        }
                        // í—¤ë” í–‰ ì°¾ê¸° (ë²ˆí˜¸ë¡œ ì‹œì‘)
                        if (json[i] && json[i][0] === 'ë²ˆí˜¸') {
                            headerRowIndex = i;
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        return;
                    }

                    // í—¤ë” í–‰ì—ì„œ í•­ëª© ì •ë³´ ì¶”ì¶œ
                    const headers = json[headerRowIndex];
                    if (!headers || headers.length < 6) {
                        return;
                    }

                    // í•™ìƒ ë°ì´í„° íŒŒì‹±
                    const students: PapsStudent[] = [];
                    let studentIdCounter = 1;

                    for (let i = headerRowIndex + 1; i < json.length; i++) {
                        const row = json[i];
                        if (!row || row.length < 3) continue;
                        
                        const number = row[0] ? parseInt(String(row[0]), 10) : studentIdCounter++;
                        const name = String(row[1] || '').trim();
                        const gender = (String(row[2] || '').trim() === 'ì—¬ì' || String(row[2] || '').trim() === 'ì—¬') ? 'ì—¬ì' : 'ë‚¨ì';
                        
                        if (!name) continue;

                        const records: Record<string, number> = {};
                        
                        // í‚¤, ëª¸ë¬´ê²Œ, BMI
                        records.height = row[3] ? parseFloat(String(row[3])) : 0;
                        records.weight = row[4] ? parseFloat(String(row[4])) : 0;
                        records.bmi = row[5] ? parseFloat(String(row[5])) : 0;

                        // PAPS í•­ëª© ë°ì´í„° íŒŒì‹± (í—¤ë”ë¥¼ ê¸°ë°˜ìœ¼ë¡œ)
                        let colIndex = 6;
                        Object.keys(PAPS_ITEMS).forEach(category => {
                            const item = PAPS_ITEMS[category];
                            const eventName = eventSettings[item.id] || item.options[0];
                            
                            if (item.id === 'bodyfat') {
                                if (colIndex < headers.length) {
                                    records[item.id] = row[colIndex] ? parseFloat(String(row[colIndex])) : 0;
                                    colIndex++;
                                }
                                // ë“±ê¸‰
                                if (colIndex < headers.length && headers[colIndex] && String(headers[colIndex]).includes('ë“±ê¸‰')) {
                                    records[`${item.id}_grade`] = row[colIndex] ? parseFloat(String(row[colIndex])) : 0;
                                    colIndex++;
                                }
                            } else if (eventName === 'ì•…ë ¥') {
                                // ì™¼ì†
                                if (colIndex < headers.length) {
                                    records[`${item.id}_left`] = row[colIndex] ? parseFloat(String(row[colIndex])) : 0;
                                    colIndex++;
                                }
                                // ì˜¤ë¥¸ì†
                                if (colIndex < headers.length) {
                                    records[`${item.id}_right`] = row[colIndex] ? parseFloat(String(row[colIndex])) : 0;
                                    colIndex++;
                                }
                                // ì™¼ì† ë“±ê¸‰
                                if (colIndex < headers.length && headers[colIndex] && String(headers[colIndex]).includes('ë“±ê¸‰')) {
                                    records[`${item.id}_left_grade`] = row[colIndex] ? parseFloat(String(row[colIndex])) : 0;
                                    colIndex++;
                                }
                                // ì˜¤ë¥¸ì† ë“±ê¸‰
                                if (colIndex < headers.length && headers[colIndex] && String(headers[colIndex]).includes('ë“±ê¸‰')) {
                                    records[`${item.id}_right_grade`] = row[colIndex] ? parseFloat(String(row[colIndex])) : 0;
                                    colIndex++;
                                }
                            } else {
                                // ì¼ë°˜ í•­ëª©
                                if (colIndex < headers.length) {
                                    records[item.id] = row[colIndex] ? parseFloat(String(row[colIndex])) : 0;
                                    colIndex++;
                                }
                                // ë“±ê¸‰
                                if (colIndex < headers.length && headers[colIndex] && String(headers[colIndex]).includes('ë“±ê¸‰')) {
                                    records[`${item.id}_grade`] = row[colIndex] ? parseFloat(String(row[colIndex])) : 0;
                                    colIndex++;
                                }
                            }
                        });

                        students.push({
                            id: Date.now() + Math.random() * 1000,
                            number: number,
                            name: name,
                            gender: gender,
                            records: records
                        });
                    }

                    // ë°˜ ìƒì„±
                    const classId = Date.now() + Math.random() * 1000;
                    const papsClass: PapsClass = {
                        id: classId,
                        name: className || sheetName,
                        gradeLevel: gradeLevel || '1í•™ë…„',
                        students: students,
                        eventSettings: Object.keys(eventSettings).length > 0 ? eventSettings : undefined
                    };
                    importedClasses.push(papsClass);
                });

                if (importedClasses.length === 0) {
                    alert('ì—‘ì…€ íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ê¸°ì¡´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ êµì²´
                this.papsData.classes = importedClasses;
                if (importedClasses.length > 0) {
                    this.papsData.activeClassId = importedClasses[0].id;
                }

                this.saveDataToFirestore();
                this.renderPapsUI();
                
                showSuccess(`${importedClasses.length}ê°œ ë°˜ì˜ PAPS ê¸°ë¡ì´ ê°€ì ¸ì™€ì¡ŒìŠµë‹ˆë‹¤.`);
            } catch (error) {
                logError('ì—‘ì…€ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                showError(new Error('ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
            }
        };

        reader.readAsArrayBuffer(file);
    }

    /**
     * PAPS ì°¨íŠ¸ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    public renderPapsCharts(cls: PapsClass): void {
        // PAPS ì°¨íŠ¸ ë Œë”ë§ ë¡œì§ êµ¬í˜„
        const chartsContainer = this.$('#paps-charts');
        chartsContainer.innerHTML = '<p>ì°¨íŠ¸ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.</p>';
    }
    /**
     * ì •ê·œ ë¶„í¬ ê³¡ì„ ê³¼ í‘œì¤€í¸ì°¨ë¥¼ í‘œì‹œí•˜ëŠ” ê·¸ë˜í”„ë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
     */
    private drawStandardDeviationChart(sortedRecords: {record: number, name: string}[], studentName: string): void {
        const canvas = this.$('#ranking-distribution-chart') as HTMLCanvasElement;
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        
        // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
        canvas.width = 800;
        canvas.height = 600;
        
        // ë°°ê²½ ê·¸ë¦¬ê¸°
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ì°¨íŠ¸ ì˜ì—­ ì„¤ì •
        const margin = { top: 60, right: 40, bottom: 90, left: 70 };
        const chartWidth = canvas.width - margin.left - margin.right;
        const chartHeight = canvas.height - margin.top - margin.bottom;
        
        const records = sortedRecords.map(item => item.record);
        if (records.length === 0) {
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ë°ì´í„° ì—†ìŒ', canvas.width / 2, canvas.height / 2);
            return;
        }

        // í†µê³„ ê³„ì‚°
        const mean = records.reduce((sum, record) => sum + record, 0) / records.length;
        const variance = records.reduce((sum, record) => sum + Math.pow(record - mean, 2), 0) / records.length;
        const stdDev = Math.sqrt(variance);
        const minRecord = Math.min(...records);
        const maxRecord = Math.max(...records);
        const recordRange = maxRecord - minRecord;
        
        // ì •ê·œ ë¶„í¬ í•¨ìˆ˜ (í™•ë¥  ë°€ë„ í•¨ìˆ˜)
        const normalPDF = (x: number, mu: number, sigma: number): number => {
            const coefficient = 1 / (sigma * Math.sqrt(2 * Math.PI));
            const exponent = -0.5 * Math.pow((x - mu) / sigma, 2);
            return coefficient * Math.exp(exponent);
        };
        
        // ê·¸ë˜í”„ ë²”ìœ„ ì„¤ì • (í‰ê·  Â± 4Ïƒ ë˜ëŠ” min/max ì¤‘ ë” ë„“ì€ ë²”ìœ„)
        const graphMin = Math.min(minRecord, mean - 4 * stdDev);
        const graphMax = Math.max(maxRecord, mean + 4 * stdDev);
        const graphRange = graphMax - graphMin;
        
        // ì •ê·œ ë¶„í¬ ê³¡ì„ ì˜ ìµœëŒ€ê°’ ê³„ì‚° (í‰ê· ì—ì„œì˜ PDF ê°’)
        const maxPDF = normalPDF(mean, mean, stdDev);
        
        // ê·¸ë¦¬ë“œ ë¼ì¸ ê·¸ë¦¬ê¸°
        ctx.strokeStyle = '#e9ecef';
        ctx.lineWidth = 1;
        
        // ìˆ˜í‰ ê·¸ë¦¬ë“œ ë¼ì¸
        for (let i = 0; i <= 5; i++) {
            const y = margin.top + (chartHeight / 5) * i;
            ctx.beginPath();
            ctx.moveTo(margin.left, y);
            ctx.lineTo(margin.left + chartWidth, y);
            ctx.stroke();
        }
        
        // í‘œì¤€í¸ì°¨ êµ¬ê°„ í‘œì‹œ (ë°°ê²½ìƒ‰)
        const sigmaColors = [
            { range: 1, color: 'rgba(255, 235, 59, 0.2)' },   // Â±1Ïƒ
            { range: 2, color: 'rgba(255, 152, 0, 0.15)' },   // Â±2Ïƒ
            { range: 3, color: 'rgba(255, 87, 34, 0.1)' }     // Â±3Ïƒ
        ];
        
        for (const { range, color } of sigmaColors) {
            const leftX = margin.left + ((mean - range * stdDev - graphMin) / graphRange) * chartWidth;
            const rightX = margin.left + ((mean + range * stdDev - graphMin) / graphRange) * chartWidth;
            const width = rightX - leftX;
            
            ctx.fillStyle = color;
            ctx.fillRect(leftX, margin.top, width, chartHeight);
        }
        
        // í‘œì¤€í¸ì°¨ êµ¬ê°„ ìˆ˜ì§ì„  í‘œì‹œ
        ctx.strokeStyle = '#dee2e6';
        ctx.lineWidth = 1;
        ctx.setLineDash([2, 2]);
        for (let sigma = -3; sigma <= 3; sigma++) {
            if (sigma === 0) continue; // í‰ê· ì„ ì€ ë‚˜ì¤‘ì— ë”°ë¡œ ê·¸ë¦¬ê¸°
            const x = margin.left + ((mean + sigma * stdDev - graphMin) / graphRange) * chartWidth;
            ctx.beginPath();
            ctx.moveTo(x, margin.top);
            ctx.lineTo(x, margin.top + chartHeight);
            ctx.stroke();
        }
        ctx.setLineDash([]);
        
        // ì •ê·œ ë¶„í¬ ê³¡ì„  ê·¸ë¦¬ê¸°
        const numPoints = 200;
        ctx.strokeStyle = '#007bff';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        for (let i = 0; i <= numPoints; i++) {
            const x = graphMin + (graphRange * i) / numPoints;
            const pdfValue = normalPDF(x, mean, stdDev);
            const normalizedValue = pdfValue / maxPDF; // 0~1ë¡œ ì •ê·œí™”
            
            const chartX = margin.left + ((x - graphMin) / graphRange) * chartWidth;
            const chartY = margin.top + chartHeight - (normalizedValue * chartHeight);
            
            if (i === 0) {
                ctx.moveTo(chartX, chartY);
            } else {
                ctx.lineTo(chartX, chartY);
            }
        }
        ctx.stroke();
        
        // ì •ê·œ ë¶„í¬ ê³¡ì„  ì•„ë˜ ì˜ì—­ ì±„ìš°ê¸°
        ctx.fillStyle = 'rgba(0, 123, 255, 0.1)';
        ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
        ctx.lineTo(margin.left, margin.top + chartHeight);
        ctx.closePath();
        ctx.fill();
        
        // í‰ê· ì„  ê·¸ë¦¬ê¸° (ìˆ˜ì§ì„ )
        const meanX = margin.left + ((mean - graphMin) / graphRange) * chartWidth;
        ctx.strokeStyle = '#ff6b6b';
        ctx.lineWidth = 3;
        ctx.setLineDash([8, 4]);
        ctx.beginPath();
        ctx.moveTo(meanX, margin.top);
        ctx.lineTo(meanX, margin.top + chartHeight);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // ì„ íƒëœ í•™ìƒ ê¸°ë¡ í‘œì‹œ (ë¹¨ê°„ìƒ‰ ì )
        if (this.selectedStudentForChart) {
            const selectedRecord = sortedRecords.find(item => item.name === this.selectedStudentForChart)?.record;
            if (selectedRecord !== undefined && selectedRecord >= graphMin && selectedRecord <= graphMax) {
                const selectedX = margin.left + ((selectedRecord - graphMin) / graphRange) * chartWidth;
                const selectedPDF = normalPDF(selectedRecord, mean, stdDev);
                const selectedNormalized = selectedPDF / maxPDF;
                const selectedY = margin.top + chartHeight - (selectedNormalized * chartHeight);
                
                // ìˆ˜ì§ ì ì„  (ìœ„ì—ì„œ ì•„ë˜ë¡œ)
                ctx.strokeStyle = '#dc3545';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(selectedX, margin.top);
                ctx.lineTo(selectedX, selectedY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // ë¹¨ê°„ìƒ‰ ì 
                ctx.fillStyle = '#dc3545';
                ctx.beginPath();
                ctx.arc(selectedX, selectedY, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // ì  í…Œë‘ë¦¬
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // ê¸°ë¡ ê°’ í‘œì‹œ
                ctx.fillStyle = '#dc3545';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${selectedRecord}`, selectedX, selectedY - 15);
                
                // í•™ìƒ ì´ë¦„ í‘œì‹œ
                ctx.font = 'bold 12px Arial';
                ctx.fillText(this.selectedStudentForChart, selectedX, selectedY - 35);
            }
        }
        
        // ê°œì¸ ê¸°ë¡ í‘œì‹œ (ê²€ìƒ‰í•œ í•™ìƒì´ ìˆëŠ” ê²½ìš°)
        if (studentName && !this.selectedStudentForChart) {
            const personalRecord = sortedRecords.find(item => item.name === studentName)?.record;
            if (personalRecord !== undefined && personalRecord >= graphMin && personalRecord <= graphMax) {
                const personalX = margin.left + ((personalRecord - graphMin) / graphRange) * chartWidth;
                const personalPDF = normalPDF(personalRecord, mean, stdDev);
                const personalNormalized = personalPDF / maxPDF;
                const personalY = margin.top + chartHeight - (personalNormalized * chartHeight);
                
                // ìˆ˜ì§ ì ì„ 
                ctx.strokeStyle = '#dc3545';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(personalX, margin.top);
                ctx.lineTo(personalX, personalY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // ë¹¨ê°„ìƒ‰ ì 
                ctx.fillStyle = '#dc3545';
                ctx.beginPath();
                ctx.arc(personalX, personalY, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // ì  í…Œë‘ë¦¬
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // ê¸°ë¡ ê°’ í‘œì‹œ
                ctx.fillStyle = '#dc3545';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${personalRecord}`, personalX, personalY - 15);
            }
        }
        
        // ì¶• ê·¸ë¦¬ê¸°
        ctx.strokeStyle = '#495057';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(margin.left, margin.top);
        ctx.lineTo(margin.left, margin.top + chartHeight);
        ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
        ctx.stroke();
        
        // Yì¶• ë ˆì´ë¸” (í™•ë¥  ë°€ë„ - ì •ê·œí™”ëœ ê°’)
        ctx.fillStyle = '#495057';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'right';
        for (let i = 0; i <= 5; i++) {
            const normalizedValue = i / 5; // 0~1
            const pdfValue = normalizedValue * maxPDF;
            const y = margin.top + chartHeight - (normalizedValue * chartHeight);
            ctx.fillText(pdfValue.toFixed(3), margin.left - 20, y + 5);
        }
        
        // Xì¶• ë ˆì´ë¸” (ê¸°ë¡ ê°’)
        ctx.textAlign = 'center';
        ctx.font = '11px Arial';
        const numXTicks = 8;
        for (let i = 0; i <= numXTicks; i++) {
            const value = graphMin + (graphRange * i) / numXTicks;
            const x = margin.left + ((value - graphMin) / graphRange) * chartWidth;
            
            // í‘œì¤€í¸ì°¨ êµ¬ê°„ í‘œì‹œ
            const sigmaValue = (value - mean) / stdDev;
            let label = value.toFixed(1);
            if (Math.abs(sigmaValue) < 0.1) {
                label = `Î¼ (${value.toFixed(1)})`;
            } else if (Math.abs(Math.abs(sigmaValue) - 1) < 0.1) {
                label = `Î¼${sigmaValue > 0 ? '+' : ''}Ïƒ (${value.toFixed(1)})`;
            } else if (Math.abs(Math.abs(sigmaValue) - 2) < 0.1) {
                label = `Î¼${sigmaValue > 0 ? '+' : ''}2Ïƒ (${value.toFixed(1)})`;
            } else if (Math.abs(Math.abs(sigmaValue) - 3) < 0.1) {
                label = `Î¼${sigmaValue > 0 ? '+' : ''}3Ïƒ (${value.toFixed(1)})`;
            }
            
            ctx.fillText(label, x, margin.top + chartHeight + 20);
        }
        
        // ì œëª©
        ctx.fillStyle = '#212529';
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ì •ê·œ ë¶„í¬ ê·¸ë˜í”„ (í‘œì¤€í¸ì°¨)', canvas.width / 2, 30);
        
        // ì¶• ì œëª©
        ctx.font = 'bold 14px Arial';
        ctx.save();
        ctx.translate(25, canvas.height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText('í™•ë¥  ë°€ë„', 0, 0);
        ctx.restore();
        
        ctx.textAlign = 'center';
        ctx.fillText('ê¸°ë¡ ê°’', canvas.width / 2, canvas.height - 20);
        
        // í†µê³„ ì •ë³´ í‘œì‹œ (ì˜¤ë¥¸ìª½ ìƒë‹¨)
        ctx.fillStyle = '#495057';
        ctx.font = 'bold 13px Arial';
        ctx.textAlign = 'right';
        ctx.fillText(`í‰ê· (Î¼): ${mean.toFixed(1)}`, margin.left + chartWidth - 10, margin.top - 25);
        ctx.fillText(`í‘œì¤€í¸ì°¨(Ïƒ): ${stdDev.toFixed(2)}`, margin.left + chartWidth - 10, margin.top - 10);
        ctx.fillText(`ìµœê³ : ${maxRecord}`, margin.left + chartWidth - 10, margin.top + 5);
        ctx.fillText(`ìµœì €: ${minRecord}`, margin.left + chartWidth - 10, margin.top + 20);
        
        // ë²”ë¡€ (ì™¼ìª½ ìƒë‹¨)
        const legendY = margin.top + 20;
        const legendX = margin.left + 10;
        const legendHeight = this.selectedStudentForChart ? 100 : 85;
        
        // ë²”ë¡€ ë°°ê²½
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        ctx.fillRect(legendX, legendY, 150, legendHeight);
        ctx.strokeStyle = '#dee2e6';
        ctx.lineWidth = 1;
        ctx.strokeRect(legendX, legendY, 150, legendHeight);
        
        // ë²”ë¡€ í•­ëª©ë“¤
        ctx.font = '11px Arial';
        ctx.textAlign = 'left';
        let legendItemY = legendY + 15;
        
        // ì •ê·œ ë¶„í¬ ê³¡ì„  ë²”ë¡€
        ctx.strokeStyle = '#007bff';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(legendX + 10, legendItemY);
        ctx.lineTo(legendX + 25, legendItemY);
        ctx.stroke();
        ctx.fillStyle = '#495057';
        ctx.fillText('ì •ê·œ ë¶„í¬ ê³¡ì„ ', legendX + 30, legendItemY + 4);
        
        legendItemY += 20;
        
        // í‰ê· ì„  ë²”ë¡€
        ctx.strokeStyle = '#ff6b6b';
        ctx.lineWidth = 2;
        ctx.setLineDash([4, 2]);
        ctx.beginPath();
        ctx.moveTo(legendX + 10, legendItemY);
        ctx.lineTo(legendX + 25, legendItemY);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = '#495057';
        ctx.fillText('í‰ê· (Î¼)', legendX + 30, legendItemY + 4);
        
        legendItemY += 20;
        
        // í‘œì¤€í¸ì°¨ êµ¬ê°„ ë²”ë¡€
        ctx.fillStyle = 'rgba(255, 235, 59, 0.3)';
        ctx.fillRect(legendX + 10, legendItemY - 5, 15, 10);
        ctx.fillStyle = '#495057';
        ctx.fillText('Â±1Ïƒ, Â±2Ïƒ, Â±3Ïƒ êµ¬ê°„', legendX + 30, legendItemY + 4);
        
        legendItemY += 20;
        
        // ì„ íƒëœ í•™ìƒ ë²”ë¡€
        if (this.selectedStudentForChart) {
            ctx.fillStyle = '#dc3545';
            ctx.beginPath();
            ctx.arc(legendX + 17, legendItemY, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = '#495057';
            ctx.fillText(`ì„ íƒ: ${this.selectedStudentForChart}`, legendX + 30, legendItemY + 4);
        } else if (studentName) {
            // ê°œì¸ ê¸°ë¡ ë²”ë¡€
            ctx.fillStyle = '#dc3545';
            ctx.beginPath();
            ctx.arc(legendX + 17, legendItemY, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = '#495057';
            ctx.fillText('ë‚˜ì˜ ê¸°ë¡', legendX + 30, legendItemY + 4);
        }
    }
    
    /**
     * ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
     */
    private startRealtimeUpdate(eventId: string, grade: string, gender: string, studentName: string, cls: PapsClass): void {
        // ê¸°ì¡´ ì—…ë°ì´íŠ¸ ì¤‘ì§€
        this.stopRealtimeUpdate();
        
        // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì •ë¦¬
        if (this.updateInterval !== null) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
            logger.debug('ê¸°ì¡´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì •ë¦¬');
        }
        
        // í˜„ì¬ ë­í‚¹ ë°ì´í„° ì €ì¥
        this.currentRankingData = { event: eventId, grade, gender, studentName };
        
        // 5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        this.updateInterval = setInterval(() => {
            this.updateRankingData(cls);
        }, 5000);
        
        logger.debug('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘:', this.currentRankingData);
    }
    
    /**
     * ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤.
     */
    private stopRealtimeUpdate(): void {
        if (this.updateInterval !== null) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
            logger.debug('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘ì§€: updateInterval ì •ë¦¬ ì™„ë£Œ');
        }
        this.currentRankingData = null;
    }
    
    /**
     * ë­í‚¹ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    private updateRankingData(cls: PapsClass): void {
        if (!this.currentRankingData) return;
        
        const { event: eventId, grade, gender, studentName } = this.currentRankingData;
        
        // í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” í•™ìƒë“¤ì˜ ê¸°ë¡ ìˆ˜ì§‘ (ì´ë¦„ê³¼ í•¨ê»˜)
        const recordsWithNames: {record: number, name: string}[] = [];
        let personalRecord: number | null = null;
        
        this.papsData.classes.forEach(classItem => {
            if (classItem.gradeLevel === grade) {
                classItem.students.forEach(student => {
                    if (student.gender === gender) {
                        let record: number | undefined;
                        
                        if (eventId === 'bodyfat') {
                            // BMI ê³„ì‚°
                            const height = student.records?.height;
                            const weight = student.records?.weight;
                            if (height && weight && height > 0 && weight > 0) {
                                record = weight / Math.pow(height / 100, 2);
                            }
                        } else {
                            record = student.records?.[eventId];
                        }
                        
                        if (record !== undefined && record !== null && 
                            typeof record === 'number' && !isNaN(record) && 
                            isFinite(record) && record > 0) {
                            recordsWithNames.push({record, name: student.name});
                            
                            if (studentName && student.name === studentName) {
                                personalRecord = record;
                            }
                        }
                    }
                });
            }
        });
        
        if (recordsWithNames.length === 0) {
            logger.debug('ì—…ë°ì´íŠ¸í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ê¸°ë¡ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
        const sortedRecords = recordsWithNames.sort((a, b) => b.record - a.record);
        const records = sortedRecords.map(item => item.record);
        
        // í‰ê·  ê¸°ë¡ ê³„ì‚°
        const avgRecord = records.reduce((sum, record) => sum + record, 0) / records.length;
        
        // í‰ê·  ê¸°ë¡ì„ ìˆœìœ„í‘œ ì œëª©ì— í‘œì‹œ
        const avgRecordDisplay = this.$('#avg-record-display') as HTMLElement;
        if (avgRecordDisplay) {
            avgRecordDisplay.textContent = `í‰ê·  ê¸°ë¡: ${avgRecord.toFixed(2)}`;
        }
        
        // ê°œì¸ ê¸°ë¡ì´ ìˆëŠ” ê²½ìš° ìˆœìœ„ì™€ ìƒìœ„% ê³„ì‚°
        if (personalRecord !== null) {
            const rank = this.findRankForRecord(sortedRecords, personalRecord);
            this.$('#personal-rank').textContent = `${rank}ìœ„`;
            (this.$('#personal-rank-card') as HTMLElement).style.display = 'block';
        } else {
            (this.$('#personal-rank-card') as HTMLElement).style.display = 'none';
        }
        
        // í˜„ì¬ ë­í‚¹ ë°ì´í„° ì—…ë°ì´íŠ¸
        this.currentRankingRecords = recordsWithNames;
        
        // ìˆœìœ„ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (í˜„ì¬ í˜ì´ì§€ ìœ ì§€)
        this.renderRankingTable(recordsWithNames, studentName, false);
        
        const personalRank = personalRecord ? this.findRankForRecord(sortedRecords, personalRecord) : null;
        
        logger.debug('ë­í‚¹ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ:', { 
            totalRecords: records.length, 
            avgRecord: avgRecord.toFixed(2),
            personalRank: personalRank
        });
    }
    
    /**
     * ë­í‚¹ì„ ë‹«ìŠµë‹ˆë‹¤.
     */
    private closeRanking(): void {
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘ì§€
        this.stopRealtimeUpdate();
        
        // ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        (this.$('#ranking-results') as HTMLElement).style.display = 'none';
        
        logger.debug('ë­í‚¹ ë‹«ê¸° ì™„ë£Œ');
    }

    /**
     * ì‚¬ì´ë“œë°”ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.
     * sidebar-list-containerëŠ” renderPapsClassList()ì—ì„œ ê´€ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ë¹„ìš°ì§€ ì•ŠìŠµë‹ˆë‹¤.
     */
    private cleanupSidebar(): void {
        // sidebar-form-containerë§Œ ë¹„ìš°ê³ , sidebar-list-containerëŠ” renderPapsClassListì—ì„œ ê´€ë¦¬
        const formContainer = this.$('#sidebar-form-container');
        if (formContainer) {
            formContainer.innerHTML = '';
        }
        // sidebar-list-containerëŠ” renderPapsClassList()ì—ì„œ ë‹¤ì‹œ ì±„ìš°ë¯€ë¡œ ì—¬ê¸°ì„œ ë¹„ìš°ì§€ ì•ŠìŒ
    }

    /**
     * ìœ íš¨ ê¸°ê°„ ì…ë ¥ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
     * @returns Promise<number | null> ì…ë ¥ëœ ì¼ìˆ˜ ë˜ëŠ” null (ì·¨ì†Œ ì‹œ)
     */
    private async showExpiresDaysModal(): Promise<number | null> {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.id = 'paps-expires-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 32px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h2 style="margin: 0 0 8px 0; text-align: center; color: #333;">ğŸ“… QR ì½”ë“œ ìœ íš¨ ê¸°ê°„ ì„¤ì •</h2>
                    <p style="margin: 0 0 24px 0; text-align: center; color: #666;">QR ì½”ë“œê°€ ìœ íš¨í•œ ê¸°ê°„ì„ ì„¤ì •í•˜ì„¸ìš”</p>
                    
                    <form id="expires-form" style="margin-bottom: 16px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ìœ íš¨ ê¸°ê°„ (ì¼)</label>
                            <input 
                                type="number" 
                                id="expires-days-input" 
                                required 
                                min="1"
                                max="3650"
                                value="365"
                                style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"
                                placeholder="ì˜ˆ: 365"
                            />
                            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                ê¶Œì¥: 365ì¼ (1ë…„)
                            </div>
                        </div>
                        <div id="expires-error" style="color: #dc3545; margin-bottom: 16px; text-align: center; display: none;"></div>
                        <button 
                            type="submit" 
                            style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;"
                        >
                            ìƒì„±í•˜ê¸°
                        </button>
                    </form>
                    <button 
                        id="close-expires-modal" 
                        style="width: 100%; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 8px;"
                    >
                        ì·¨ì†Œ
                    </button>
                </div>
            `;

            document.body.appendChild(modal);

            const form = modal.querySelector('#expires-form') as HTMLFormElement;
            const daysInput = modal.querySelector('#expires-days-input') as HTMLInputElement;
            const errorDiv = modal.querySelector('#expires-error') as HTMLElement;
            const closeBtn = modal.querySelector('#close-expires-modal') as HTMLElement;

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const days = parseInt(daysInput.value);
                
                if (isNaN(days) || days < 1 || days > 3650) {
                    errorDiv.textContent = '1ì¼ ì´ìƒ 3650ì¼ ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                    errorDiv.style.display = 'block';
                    return;
                }

                document.body.removeChild(modal);
                resolve(days);
            });

            closeBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
                resolve(null);
            });

            modal.addEventListener('click', (e: Event) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    resolve(null);
                }
            });
        });
    }

    /**
     * ë°˜ë³„ ëª¨ë“  í•™ìƒì˜ QR ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     * @param expiresInDays ìœ íš¨ ê¸°ê°„ (ì¼ ë‹¨ìœ„, ê¸°ë³¸ê°’: 365ì¼)
     */
    public async generateClassQRCodes(expiresInDays: number = 365): Promise<void> {
        const cls = this.papsData.classes.find(c => c.id === this.papsData.activeClassId);
        if (!cls) {
            showError('ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        if (cls.students.length === 0) {
            showError('í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
            if (!(window as any).firebase) {
                await new Promise<void>((resolve) => {
                    if ((window as any).firebase) {
                        resolve();
                        return;
                    }
                    const handler = () => {
                        window.removeEventListener('firebaseReady', handler);
                        resolve();
                    };
                    window.addEventListener('firebaseReady', handler, { once: true });
                    setTimeout(() => {
                        window.removeEventListener('firebaseReady', handler);
                        resolve();
                    }, 10000); // ìµœëŒ€ 10ì´ˆ ëŒ€ê¸°
                });
            }

            const { createShareManager } = await import('./shareManager.js');
            const shareManager = createShareManager({
                firebaseDb: typeof window !== 'undefined' ? (window as any).firebase?.db : undefined,
                $: (selector: string) => document.querySelector(selector)
            });

            const studentQRCodes: Array<{
                studentId: number;
                studentName: string;
                studentNumber: number;
                shareId: string;
                shareUrl: string;
                qrCodeUrl: string;
            }> = [];

            // ìœ íš¨ ê¸°ê°„ ê³„ì‚°
            const expiresAt = new Date();
            expiresAt.setDate(expiresAt.getDate() + expiresInDays);

            // ê° í•™ìƒë³„ë¡œ QR ì½”ë“œ ìƒì„± ë˜ëŠ” ì¬ì‚¬ìš©
            for (const student of cls.students) {
                const tr = document.querySelector(`tr[data-sid="${student.id}"]`) as HTMLTableRowElement;
                
                // í•™ìƒì˜ ë“±ê¸‰ ê³„ì‚°
                const grades: Record<string, string> = {};
                if (tr) {
                    const gradeCells = tr.querySelectorAll('.grade-cell');
                    gradeCells.forEach(cell => {
                        const dataId = (cell as HTMLElement).dataset.id;
                        const grade = cell.textContent?.trim() || '';
                        if (dataId && grade) {
                            grades[dataId] = grade;
                        }
                    });
                }

                // ì¢…í•© ë“±ê¸‰ ê³„ì‚°
                const overallGradeCell = tr?.querySelector('.overall-grade-cell');
                const overallGrade = overallGradeCell?.textContent?.trim() || '';

                // ì¢…ëª©ëª… ìˆ˜ì§‘ (eventSettingsì—ì„œ)
                const eventNames: Record<string, string> = {};
                Object.keys(PAPS_ITEMS).forEach(category => {
                    const item = PAPS_ITEMS[category];
                    const eventName = cls.eventSettings?.[item.id] || item.options[0];
                    // ì„±ë³„ì— ë”°ë¼ íŒ”êµ½í˜€í´ê¸° ì¢…ëª©ëª… ë³€ê²½
                    if (eventName === 'íŒ”êµ½í˜€í´ê¸°' && student.gender === 'ì—¬ì') {
                        eventNames[item.id] = 'ë¬´ë¦ëŒ€ê³ íŒ”êµ½í˜€í´ê¸°';
                    } else {
                        eventNames[item.id] = eventName;
                    }
                });
                // ì²´ì§€ë°©ì€ BMIë¡œ ê³ ì •
                eventNames['bodyfat'] = 'BMI';

                // ê¸°ì¡´ QR ì½”ë“œ í™•ì¸
                let shareId: string;
                const existingShare = await shareManager.findExistingPapsStudentShare(cls.id, student.id);
                
                if (existingShare && existingShare.shareId) {
                    // ê¸°ì¡´ QR ì½”ë“œ ì¬ì‚¬ìš©
                    shareId = existingShare.shareId;
                    logger.debug(`ê¸°ì¡´ QR ì½”ë“œ ì¬ì‚¬ìš©: ${student.name} (${shareId})`);
                } else {
                    // ìƒˆë¡œìš´ QR ì½”ë“œ ìƒì„±
                    shareId = shareManager.generateShareId(16);
                    logger.debug(`ìƒˆ QR ì½”ë“œ ìƒì„±: ${student.name} (${shareId})`);
                }

                // ê³µìœ  ë°ì´í„° ì €ì¥ (ê¸°ì¡´ ê²ƒì´ë©´ ì—…ë°ì´íŠ¸, ìƒˆ ê²ƒì´ë©´ ìƒì„±)
                await shareManager.saveSharedPapsStudent({
                    shareId,
                    classId: cls.id,
                    className: cls.name,
                    studentId: student.id,
                    studentName: student.name,
                    studentNumber: student.number,
                    studentGender: student.gender,
                    gradeLevel: cls.gradeLevel || '',
                    records: student.records || {},
                    grades,
                    eventNames,
                    overallGrade,
                    expiresAt
                });

                // ê³µìœ  ë§í¬ ìƒì„±
                const shareUrl = shareManager.generatePapsShareUrl(shareId);
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shareUrl)}`;

                studentQRCodes.push({
                    studentId: student.id,
                    studentName: student.name,
                    studentNumber: student.number,
                    shareId,
                    shareUrl,
                    qrCodeUrl
                });
            }

            // QR ì½”ë“œ ì¶œë ¥ ëª¨ë‹¬ í‘œì‹œ
            this.showQRPrintModal(cls.name, studentQRCodes, expiresAt);
        } catch (error) {
            logError('QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', error);
            showError('QR ì½”ë“œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    /**
     * QR ì½”ë“œ ì¶œë ¥ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
     * @param className ë°˜ ì´ë¦„
     * @param studentQRCodes í•™ìƒ QR ì½”ë“œ ëª©ë¡
     * @param expiresAt ë§Œë£Œì¼
     */
    private showQRPrintModal(
        className: string,
        studentQRCodes: Array<{
            studentId: number;
            studentName: string;
            studentNumber: number;
            shareId: string;
            shareUrl: string;
            qrCodeUrl: string;
        }>,
        expiresAt: Date
    ): void {
        const modal = document.createElement('div');
        modal.id = 'paps-qr-print-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
        `;

        modal.innerHTML = `
            <div style="background: white; border-radius: 12px; max-width: 1200px; width: 100%; max-height: calc(100vh - 40px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; overflow: hidden;">
                <!-- í—¤ë” ì˜ì—­ (ê³ ì •) -->
                <div style="padding: 24px 32px; border-bottom: 1px solid #e0e0e0; flex-shrink: 0;">
                    <h2 style="margin: 0 0 8px 0; text-align: center; color: #333; font-size: 24px;">ğŸ“± QR ì½”ë“œ ìƒì„± ì™„ë£Œ</h2>
                    <p style="margin: 0; text-align: center; color: #666; font-size: 16px;">${className} - ${studentQRCodes.length}ëª…</p>
                </div>
                
                <!-- ì»¨íŠ¸ë¡¤ ì˜ì—­ (ê³ ì •) -->
                <div style="padding: 16px 32px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; flex-shrink: 0;">
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center; margin-bottom: 16px;">
                        <div style="font-size: 14px;">
                            <strong>ìœ íš¨ ê¸°ê°„:</strong> ${expiresAt.toLocaleDateString()}ê¹Œì§€
                        </div>
                        <div style="flex: 1;"></div>
                        <button id="print-all-btn" class="btn primary" style="padding: 8px 16px; font-size: 14px;">ì „ì²´ ì¸ì‡„</button>
                        <button id="close-qr-modal-btn" class="btn" style="padding: 8px 16px; font-size: 14px;">ë‹«ê¸°</button>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">ì¸ì‡„ ì˜µì…˜:</label>
                        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; cursor: pointer;">
                                <input type="radio" name="print-option" value="6" checked>
                                <span>A4 í•œ í˜ì´ì§€ì— 6ëª…</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; cursor: pointer;">
                                <input type="radio" name="print-option" value="12">
                                <span>A4 í•œ í˜ì´ì§€ì— 12ëª…</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; cursor: pointer;">
                                <input type="radio" name="print-option" value="20">
                                <span>A4 í•œ í˜ì´ì§€ì— 20ëª…</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- QR ì½”ë“œ ëª©ë¡ ì˜ì—­ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
                <div id="qr-preview-container" style="flex: 1; overflow-y: auto; padding: 16px 32px; display: grid; gap: 12px;">
                    ${studentQRCodes.map((item, index) => `
                        <div class="qr-card" data-student-id="${item.studentId}" style="border: 1px solid #ddd; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px; background: #fff;">
                            <div style="flex-shrink: 0;">
                                <img src="${item.qrCodeUrl}" alt="QR Code" style="width: 100px; height: 100px; border: 1px solid #ddd; border-radius: 4px; display: block;">
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px; color: #333;">${item.studentName}</div>
                                <div style="color: #666; margin-bottom: 6px; font-size: 14px;">ë²ˆí˜¸: ${item.studentNumber}</div>
                                <div style="font-size: 11px; color: #999; word-break: break-all; line-height: 1.4;">${item.shareUrl}</div>
                            </div>
                            <div style="flex-shrink: 0;">
                                <button class="print-single-btn" data-index="${index}" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; white-space: nowrap;">ê°œë³„ ì¸ì‡„</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // ì¸ì‡„ ê¸°ëŠ¥
        const printAllBtn = modal.querySelector('#print-all-btn') as HTMLElement;
        const printSingleBtns = modal.querySelectorAll('.print-single-btn');
        const closeBtn = modal.querySelector('#close-qr-modal-btn') as HTMLElement;

        printAllBtn.addEventListener('click', () => {
            const selectedOption = (modal.querySelector('input[name="print-option"]:checked') as HTMLInputElement)?.value || '6';
            this.printQRCodes(studentQRCodes, className, parseInt(selectedOption));
        });

        printSingleBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const index = parseInt((btn as HTMLElement).dataset.index || '0');
                this.printQRCodes([studentQRCodes[index]], className, 6);
            });
        });

        closeBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });

        modal.addEventListener('click', (e: Event) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    /**
     * QR ì½”ë“œë¥¼ ì¸ì‡„í•©ë‹ˆë‹¤.
     * @param studentQRCodes í•™ìƒ QR ì½”ë“œ ëª©ë¡
     * @param className ë°˜ ì´ë¦„
     * @param perPage í˜ì´ì§€ë‹¹ í•™ìƒ ìˆ˜
     */
    private printQRCodes(
        studentQRCodes: Array<{
            studentId: number;
            studentName: string;
            studentNumber: number;
            shareId: string;
            shareUrl: string;
            qrCodeUrl: string;
        }>,
        className: string,
        perPage: number
    ): void {
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            showError('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ê·¸ë¦¬ë“œ ì„¤ì •
        const gridCols = perPage === 6 ? 2 : perPage === 12 ? 3 : 4;
        const gridRows = perPage === 6 ? 3 : perPage === 12 ? 4 : 5;
        
        // A4 ìš©ì§€ í¬ê¸°: 210mm x 297mm
        // ì¸ì‡„ ì—¬ë°±ì„ ìµœì†Œí™”í•˜ê³  ì •í™•í•œ í¬ê¸° ê³„ì‚°
        // ì—¬ë°± 5mm ì‚¬ìš© ì‹œ: 200mm x 287mm
        let qrSize, nameFontSize, numberFontSize, itemPadding, gapSize, pageWidth, pageHeight;
        if (perPage === 6) {
            // 2ì—´ x 3í–‰
            pageWidth = '200mm';
            pageHeight = '287mm';
            qrSize = '70mm';
            nameFontSize = '13pt';
            numberFontSize = '10pt';
            itemPadding = '3mm';
            gapSize = '2mm';
        } else if (perPage === 12) {
            // 3ì—´ x 4í–‰
            pageWidth = '200mm';
            pageHeight = '287mm';
            qrSize = '45mm';
            nameFontSize = '11pt';
            numberFontSize = '8pt';
            itemPadding = '2mm';
            gapSize = '1.5mm';
        } else {
            // 4ì—´ x 5í–‰
            pageWidth = '200mm';
            pageHeight = '287mm';
            qrSize = '32mm';
            nameFontSize = '9pt';
            numberFontSize = '7pt';
            itemPadding = '1.5mm';
            gapSize = '1mm';
        }

        let html = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>PAPS QR ì½”ë“œ - ${className}</title>
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    @page {
                        size: A4;
                        margin: 8mm;
                    }
                    @media print {
                        html, body {
                            margin: 0;
                            padding: 0;
                            width: 100%;
                        }
                        .page {
                            width: 100%;
                            min-height: calc(100vh - 16mm);
                            max-height: calc(100vh - 16mm);
                            page-break-after: always;
                            page-break-inside: avoid;
                            break-inside: avoid;
                            overflow: hidden;
                        }
                        .page:last-child {
                            page-break-after: auto;
                        }
                    }
                    html, body {
                        margin: 0;
                        padding: 0;
                        font-family: Arial, sans-serif;
                    }
                    .page {
                        width: 194mm;
                        min-height: 281mm;
                        max-height: 281mm;
                        margin: 0 auto;
                        padding: 3mm;
                        display: grid;
                        grid-template-columns: repeat(${gridCols}, 1fr);
                        grid-template-rows: repeat(${gridRows}, 1fr);
                        gap: ${gapSize};
                        box-sizing: border-box;
                    }
                    .qr-item {
                        border: 1px solid #ddd;
                        border-radius: 3px;
                        padding: ${itemPadding};
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        text-align: center;
                        overflow: hidden;
                        box-sizing: border-box;
                        min-height: 0;
                        min-width: 0;
                    }
                    .qr-item img {
                        width: ${qrSize};
                        height: ${qrSize};
                        max-width: 100%;
                        max-height: 100%;
                        margin-bottom: 1mm;
                        object-fit: contain;
                        flex-shrink: 1;
                    }
                    .qr-item .name {
                        font-size: ${nameFontSize};
                        font-weight: bold;
                        margin-bottom: 0.5mm;
                        line-height: 1.1;
                        word-break: keep-all;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        max-width: 100%;
                        flex-shrink: 0;
                    }
                    .qr-item .number {
                        font-size: ${numberFontSize};
                        color: #666;
                        line-height: 1.1;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        max-width: 100%;
                        flex-shrink: 0;
                    }
                </style>
            </head>
            <body>
        `;

        // í˜ì´ì§€ë³„ë¡œ ë‚˜ëˆ„ê¸°
        for (let i = 0; i < studentQRCodes.length; i += perPage) {
            html += '<div class="page">';
            const pageItems = studentQRCodes.slice(i, i + perPage);
            
            pageItems.forEach(item => {
                html += `
                    <div class="qr-item">
                        <img src="${item.qrCodeUrl}" alt="QR Code">
                        <div class="name">${item.studentName}</div>
                        <div class="number">${className} Â· ${item.studentNumber}ë²ˆ</div>
                    </div>
                `;
            });

            // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
            for (let j = pageItems.length; j < perPage; j++) {
                html += '<div class="qr-item"></div>';
            }

            html += '</div>';
        }

        html += `
            </body>
            </html>
        `;

        printWindow.document.write(html);
        printWindow.document.close();
        
        // ì¸ì‡„ ëŒ€í™”ìƒì ì—´ê¸°
        setTimeout(() => {
            printWindow.print();
        }, 500);
    }
}
